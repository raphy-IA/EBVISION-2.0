<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de bord TRS</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e9eafc 0%, #f4f6fa 100%);
            margin: 0;
        }
        .container {
            max-width: 1400px;
            margin: 30px auto;
            background: white;
            border-radius: 18px;
            box-shadow: 0 10px 40px rgba(102,126,234,0.10), 0 2px 8px rgba(118,75,162,0.06);
            padding: 0 0 40px 0;
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 30px 30px 30px;
            border-radius: 18px 18px 0 0;
            box-shadow: 0 4px 24px rgba(102,126,234,0.10);
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        .header-text {
            flex: 1;
        }
        .header-actions {
            flex-shrink: 0;
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 600;
            letter-spacing: 1px;
        }
        .header p {
            font-size: 1.15em;
            opacity: 0.96;
        }
        .tabs {
            display: flex;
            border-bottom: 2px solid #eee;
            background: #f8f9fa;
        }
        .tab {
            padding: 18px 32px;
            cursor: pointer;
            font-weight: 500;
            color: #555;
            border: none;
            background: none;
            outline: none;
            transition: background 0.2s, color 0.2s;
            font-size: 1.08em;
        }
        .tab.active {
            color: #667eea;
            border-bottom: 3px solid #667eea;
            background: #fff;
        }
        .filters-bar {
            display: flex;
            gap: 24px;
            padding: 22px 36px 12px 36px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            flex-wrap: wrap;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        .filter-group label {
            font-weight: 600;
            margin-bottom: 6px;
            color: #333;
            font-size: 1em;
        }
        .filter-group select, .filter-group input {
            padding: 9px 14px;
            border: 2px solid #ddd;
            border-radius: 9px;
            font-size: 1em;
            min-width: 160px;
            background: #fff;
            transition: border-color 0.2s;
        }
        .filter-group select:focus, .filter-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        .date-range {
            display: flex;
            gap: 8px;
        }
        .date-range input {
            padding: 9px 14px;
            border: 2px solid #ddd;
            border-radius: 9px;
            font-size: 1em;
            min-width: 140px;
            background: #fff;
            transition: border-color 0.2s;
        }
        .date-range input:focus {
            outline: none;
            border-color: #667eea;
        }
        .kpi-cards {
            display: flex;
            gap: 32px;
            margin: 36px 0 24px 0;
            flex-wrap: wrap;
            justify-content: space-between;
        }
        .kpi-card {
            background: linear-gradient(135deg, #f8f9fa 60%, #e9eafc 100%);
            border-radius: 16px;
            box-shadow: 0 2px 16px rgba(102,126,234,0.07);
            padding: 32px 34px 28px 34px;
            min-width: 220px;
            flex: 1;
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: box-shadow 0.2s, transform 0.2s;
            margin-bottom: 10px;
            animation: fadeInUp 0.7s;
        }
        .kpi-card:hover {
            box-shadow: 0 8px 32px rgba(102,126,234,0.13);
            transform: translateY(-2px) scale(1.03);
        }
        .kpi-icon {
            font-size: 2.1em;
            margin-bottom: 8px;
            color: #667eea;
            display: block;
            opacity: 0.85;
        }
        .kpi-label {
            color: #888;
            font-size: 1.08em;
            margin-bottom: 8px;
            font-weight: 500;
        }
        .kpi-value {
            font-size: 2.2em;
            font-weight: bold;
            color: #764ba2;
            letter-spacing: 1px;
        }
        .charts-row {
            display: flex;
            gap: 32px;
            flex-wrap: wrap;
            margin: 36px 0 0 0;
        }
        .chart-container {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 2px 16px rgba(102,126,234,0.07);
            padding: 24px 18px 18px 18px;
            flex: 1;
            min-width: 340px;
            transition: box-shadow 0.2s;
            animation: fadeInUp 0.8s;
        }
        .chart-container:hover {
            box-shadow: 0 8px 32px rgba(102,126,234,0.13);
        }
        .section-title {
            font-size: 1.18em;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 18px;
            letter-spacing: 0.5px;
        }
        .loading {
            text-align: center;
            color: #667eea;
            padding: 40px;
            font-size: 1.2em;
        }
        .no-data {
            text-align: center;
            color: #888;
            padding: 40px;
            font-size: 1.1em;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(102,126,234,0.07);
            margin-top: 10px;
        }
        th, td {
            padding: 12px 14px;
            border-bottom: 1px solid #f0f0f0;
            text-align: left;
        }
        th {
            background: linear-gradient(90deg, #e9eafc 60%, #f8f9fa 100%);
            color: #667eea;
            font-weight: 600;
            font-size: 1.05em;
            position: sticky;
            top: 0;
            z-index: 2;
        }
        tr:hover {
            background: #f4f6fa;
        }
        tr:nth-child(even) {
            background: #fafaff;
        }
        .tab-content {
            display: none;
            padding: 30px;
        }
        .tab-content.active {
            display: block;
        }
        .export-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            margin: 10px 0;
            transition: transform 0.2s;
        }
        .export-btn:hover {
            transform: translateY(-2px);
        }
        .error-message {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #c33;
        }
        .info-message {
            background: #e3f2fd;
            color: #1976d2;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #1976d2;
        }
        .success-message {
            background: #efe;
            color: #363;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #363;
        }
        .refresh-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 9px 20px;
            border-radius: 9px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            font-size: 1em;
        }
        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40,167,69,0.3);
        }
        .refresh-btn:active {
            transform: translateY(0);
        }
        .refresh-btn.loading {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            cursor: not-allowed;
        }

        .alert-low-chargeability {
            background-color: #fff3cd !important;
            border-left: 4px solid #ffc107;
        }

        .alert-low-chargeability:hover {
            background-color: #ffeaa7 !important;
        }

        .alert-low-rentability {
            background-color: #ffebee !important;
            border-left: 4px solid #f44336;
            color: #c62828 !important;
        }

        .alert-low-rentability:hover {
            background-color: #ffcdd2 !important;
        }

        .alert-excellent-performance {
            background-color: #e8f5e8 !important;
            color: #2e7d32 !important;
        }
        
        .alert-good-performance {
            background-color: #f1f8e9 !important;
            color: #558b2f !important;
        }
        
        .alert-medium-performance {
            background-color: #fff3e0 !important;
            color: #ef6c00 !important;
        }
        
        .alert-low-performance {
            background-color: #ffebee !important;
            color: #c62828 !important;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-text">
                    <h1>Tableau de bord TRS</h1>
                    <p>Visualisez et analysez la r√©partition du temps de vos √©quipes par P√¥le, Collaborateur et Mission.</p>
                </div>
                <div class="header-actions">
                    <button id="refreshBtn" class="refresh-btn">
                        üîÑ Mise √† jour
                    </button>
                </div>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab active" data-tab="dashboard">Dashboard</button>
            <button class="tab" data-tab="missions">Missions</button>
            <button class="tab" data-tab="facturation">Facturation</button>
            <button class="tab" data-tab="rentabilite">Rentabilit√©</button>
            <button class="tab" data-tab="performance">Performance</button>
            <button class="tab" data-tab="opportunites">Opportunit√©s</button>
        </div>

        <div class="filters-bar">
            <div class="filter-group">
                <label for="yearFilter">Ann√©e</label>
                <select id="yearFilter">
                    <option value="">Toutes les ann√©es</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="monthFilter">Mois</label>
                <select id="monthFilter">
                    <option value="">Tous les mois</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="startDate">P√©riode personnalis√©e</label>
                <div class="date-range">
                    <input type="date" id="startDate" placeholder="Date d√©but">
                    <input type="date" id="endDate" placeholder="Date fin">
                </div>
            </div>
            <div class="filter-group">
                <label for="buFilter">P√¥le</label>
                <select id="buFilter">
                    <option value="">Tous les p√¥les</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="collabFilter">Collaborateur</label>
                <select id="collabFilter">
                    <option value="">Tous les collaborateurs</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="missionFilter">Mission</label>
                <select id="missionFilter">
                    <option value="">Toutes les missions</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="typeHeureFilter">Type d'heure</label>
                <select id="typeHeureFilter">
                    <option value="">Tous les types</option>
                </select>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="tab-dashboard" class="tab-content active">
            <div class="loading">Chargement des donn√©es...</div>
        </div>

        <!-- Missions Tab -->
        <div id="tab-missions" class="tab-content">
            <div class="loading">Chargement des missions...</div>
        </div>

        <!-- Facturation Tab -->
        <div id="tab-facturation" class="tab-content">
            <div class="loading">Chargement de la facturation...</div>
        </div>

        <!-- Rentabilit√© Tab -->
        <div id="tab-rentabilite" class="tab-content">
            <div class="loading">Chargement de la rentabilit√©...</div>
        </div>

        <!-- Performance Tab -->
        <div id="tab-performance" class="tab-content">
            <div class="loading">Chargement de la performance...</div>
        </div>

        <!-- Opportunit√©s Tab -->
        <div id="tab-opportunites" class="tab-content">
            <div class="loading">Chargement des opportunit√©s...</div>
        </div>
    </div>

    <script>
        // Variables globales
        let trsData = [];
        let missionsData = [];
        let facturesData = [];
        let tauxHorairesData = [];
        let initialesData = [];
        let opportunitesData = [];
        let filteredData = [];
        let charts = {};
        let currentTab = 'dashboard';

        // Mappings
        let initialesToNom = {};
        let nomToInitiales = {};
        let gradeToTaux = {};

        // Parsing CSV robuste avec gestion des s√©parateurs et encodage
        function parseCSV(csvText) {
            let data = [];
            let lines = csvText.split('\n');
            if (lines.length < 2) return data;
            
            // D√©tecter le s√©parateur (; ou ,)
            let separator = ';';
            if (lines[0].includes(',')) separator = ',';
            
            let headers = lines[0].split(separator).map(h => h.replace(/"/g, '').trim());
            console.log('Headers d√©tect√©s:', headers);
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                
                let row = lines[i].split(separator);
                if (row.length === headers.length) {
                    let dataRow = {};
                    for (let j = 0; j < headers.length; j++) {
                        dataRow[headers[j]] = row[j] ? row[j].replace(/"/g, '').trim() : '';
                    }
                    data.push(dataRow);
                }
            }
            console.log('Donn√©es pars√©es:', data.length, 'lignes');
            return data;
        }

        // Chargement des donn√©es
        async function loadAllCSVs() {
            try {
                console.log('D√©but du chargement des CSV...');
                
                // Charger TRS
                console.log('Chargement TRS...');
                const trsResponse = await fetch('donn√©es_TRS.csv?v=' + Date.now());
                if (!trsResponse.ok) throw new Error('Fichier TRS non trouv√©');
                const trsText = await trsResponse.text();
                trsData = parseCSV(trsText);
                console.log('TRS charg√©:', trsData.length, 'lignes');

                // Charger Missions
                console.log('Chargement Missions...');
                const missionsResponse = await fetch('liste des missions.csv?v=' + Date.now());
                if (!missionsResponse.ok) throw new Error('Fichier missions non trouv√©');
                const missionsText = await missionsResponse.text();
                missionsData = parseCSV(missionsText);
                console.log('Missions charg√©es:', missionsData.length, 'lignes');

                // Charger Factures
                console.log('Chargement Factures...');
                const facturesResponse = await fetch('liste des factures.csv?v=' + Date.now());
                if (!facturesResponse.ok) throw new Error('Fichier factures non trouv√©');
                const facturesText = await facturesResponse.text();
                facturesData = parseCSV(facturesText);
                console.log('Factures charg√©es:', facturesData.length, 'lignes');

                // Charger Taux horaires
                console.log('Chargement Taux horaires...');
                const tauxResponse = await fetch('Taux horaire par grade.csv?v=' + Date.now());
                if (!tauxResponse.ok) throw new Error('Fichier taux horaires non trouv√©');
                const tauxText = await tauxResponse.text();
                tauxHorairesData = parseCSV(tauxText);
                console.log('Taux horaires charg√©s:', tauxHorairesData.length, 'lignes');

                // Charger Initiales
                console.log('Chargement Initiales...');
                const initialesResponse = await fetch('initiales.csv?v=' + Date.now());
                if (!initialesResponse.ok) throw new Error('Fichier initiales non trouv√©');
                const initialesText = await initialesResponse.text();
                initialesData = parseCSV(initialesText);
                console.log('Initiales charg√©es:', initialesData.length, 'lignes');

                // Charger Opportunit√©s
                console.log('Chargement Opportunit√©s...');
                const opportunitesResponse = await fetch('liste des opportunit√©s.csv?v=' + Date.now());
                if (!opportunitesResponse.ok) throw new Error('Fichier opportunit√©s non trouv√©');
                const opportunitesText = await opportunitesResponse.text();
                opportunitesData = parseCSV(opportunitesText);
                console.log('Opportunit√©s charg√©es:', opportunitesData.length, 'lignes');

                // Construire les mappings
                buildMappings();
                console.log('Mappings construits');
                
                // Initialiser l'onglet actif
                currentTab = 'dashboard';
                
                // Initialiser l'interface
                setupFilters();
                applyFilters();
                console.log('Interface initialis√©e');

            } catch (error) {
                console.error('Erreur lors du chargement des donn√©es:', error);
                document.querySelectorAll('.loading').forEach(el => {
                    el.innerHTML = 'Erreur lors du chargement des donn√©es. V√©rifiez que tous les fichiers CSV sont pr√©sents.';
                });
            }
        }

        // Construction des mappings
        function buildMappings() {
            // Mapping initiales ‚Üî noms
            initialesData.forEach(row => {
                if (row['Nom'] && row['Initiales 1']) {
                    initialesToNom[row['Initiales 1']] = row['Nom'];
                    nomToInitiales[row['Nom']] = row['Initiales 1'];
                }
            });

            // Mapping grade ‚Üî taux horaire
            tauxHorairesData.forEach(row => {
                if (row['Grade'] && row['Taux horaire']) {
                    let taux = parseFloat(row['Taux horaire'].replace(/\s/g, ''));
                    if (!isNaN(taux)) {
                        gradeToTaux[row['Grade']] = taux;
                    }
                }
            });
        }

        // Fonction pour normaliser les dates (g√®re les formats DD/MM/YYYY et anciens formats fran√ßais)
        function normalizeDate(dateStr) {
            if (!dateStr) return '';
            
            // Si c'est d√©j√† au format DD/MM/YYYY, le convertir en YYYY-MM-DD
            let match = dateStr.match(/(\d{2})\/(\d{2})\/(\d{4})/);
            if (match) {
                let jour = match[1];
                let mois = match[2];
                let annee = match[3];
                return `${annee}-${mois}-${jour}`;
            }
            
            return dateStr;
        }

        // Configuration des filtres
        function setupFilters() {
            console.log('Setup filters avec donn√©es:', trsData.length);
            
            // Protection contre les appels r√©cursifs
            if (window.isSettingUpFilters) {
                console.log('Setup filters d√©j√† en cours, ignor√©');
                return;
            }
            window.isSettingUpFilters = true;
            
            try {
                // V√©rifier que le DOM est pr√™t
                if (!document.getElementById('buFilter')) {
                    console.error('DOM pas encore pr√™t, retry dans 100ms');
                    setTimeout(() => {
                        window.isSettingUpFilters = false;
                        setupFilters();
                    }, 100);
                    return;
                }
                
                // Collecter toutes les dates de tous les fichiers
                let allDates = [];
                
                // Dates TRS
                let trsDates = trsData.map(row => row['Mois']).filter(d => d);
                allDates = allDates.concat(trsDates);
                
                // Dates Factures
                if (facturesData && facturesData.length > 0) {
                    let facturesDates = facturesData.map(row => row['Date']).filter(d => d);
                    allDates = allDates.concat(facturesDates);
                }
                
                // Dates Opportunit√©s
                if (opportunitesData && opportunitesData.length > 0) {
                    let opportunitesDates = opportunitesData.map(row => row['Date Insertion']).filter(d => d);
                    allDates = allDates.concat(opportunitesDates);
                }
                
                // Extraire directement les ann√©es et mois des dates DD/MM/YYYY
                let years = [];
                let months = [];
                
                allDates.forEach(dateStr => {
                    // V√©rifier si c'est au format DD/MM/YYYY
                    let match = dateStr.match(/(\d{2})\/(\d{2})\/(\d{4})/);
                    if (match) {
                        let jour = match[1];
                        let mois = match[2];
                        let annee = match[3];
                        years.push(annee);
                        months.push(mois);
                    }
                });
                
                // D√©dupliquer et trier
                years = [...new Set(years)].filter(y => y).sort();
                months = [...new Set(months)].filter(m => m).sort();
                
                // Remplir les filtres
                fillSelect(document.getElementById('yearFilter'), years, 'Toutes les ann√©es');
                fillSelect(document.getElementById('monthFilter'), months, 'Tous les mois', (month) => {
                    const moisNoms = {
                        '01': 'Janvier', '02': 'F√©vrier', '03': 'Mars', '04': 'Avril',
                        '05': 'Mai', '06': 'Juin', '07': 'Juillet', '08': 'Ao√ªt',
                        '09': 'Septembre', '10': 'Octobre', '11': 'Novembre', '12': 'D√©cembre'
                    };
                    return moisNoms[month] || month;
                });

                // Mettre √† jour les filtres selon l'onglet actif
                updateFiltersForCurrentTab();
            } finally {
                window.isSettingUpFilters = false;
            }
        }

        // Fonction pour mettre √† jour les filtres selon l'onglet actif
        function updateFiltersForCurrentTab() {
            console.log('updateFiltersForCurrentTab - currentTab:', currentTab);
            
            // Protection contre les appels r√©cursifs
            if (window.isUpdatingFilters) {
                console.log('Update filters d√©j√† en cours, ignor√©');
                return;
            }
            window.isUpdatingFilters = true;
            
            try {
                let bus = [];
                let collabs = [];
                let missions = [];
                
                // Pour tous les onglets, utiliser les donn√©es TRS comme base
                bus = [...new Set(trsData.map(row => row['Division']))].filter(b => b);
                collabs = [...new Set(trsData.map(row => row['Nom']))].filter(c => c);
                missions = [...new Set(trsData.map(row => row['Missions']))].filter(m => m);
                let typesHeure = [...new Set(trsData.map(row => row['Type Heure']))].filter(t => t);
                
                fillSelect(document.getElementById('buFilter'), bus, 'Tous les p√¥les');
                fillSelect(document.getElementById('collabFilter'), collabs, 'Tous les collaborateurs');
                fillSelect(document.getElementById('missionFilter'), missions, 'Toutes les missions');
                fillSelect(document.getElementById('typeHeureFilter'), typesHeure, 'Tous les types');
            } finally {
                window.isUpdatingFilters = false;
            }
        }

        function fillSelect(select, values, allLabel, formatter = null) {
            console.log('fillSelect - select:', select.id, 'values:', values, 'allLabel:', allLabel);
            
            // D√©sactiver temporairement les √©v√©nements pour √©viter les appels r√©cursifs
            const originalOnChange = select.onchange;
            select.onchange = null;
            
            try {
                select.innerHTML = `<option value="">${allLabel}</option>`;
                values.forEach(value => {
                    let option = document.createElement('option');
                    option.value = value;
                    option.textContent = formatter ? formatter(value) : value;
                    select.appendChild(option);
                });
                console.log('fillSelect - options ajout√©es:', select.options.length);
            } finally {
                // Restaurer l'√©v√©nement
                select.onchange = originalOnChange;
            }
        }

        // Application des filtres
        function applyFilters() {
            console.log('Application des filtres pour l\'onglet:', currentTab);
            
            // Protection contre les appels r√©cursifs
            if (window.isApplyingFilters) {
                console.log('Filtres d√©j√† en cours d\'application, ignor√©');
                return;
            }
            window.isApplyingFilters = true;
            
            try {
                // Toujours utiliser les donn√©es TRS comme base
                let sourceData = trsData;
                let dateField = 'Mois';
                
                if (!sourceData || sourceData.length === 0) {
                    console.error('Aucune donn√©e disponible pour l\'onglet:', currentTab);
                    filteredData = [];
                    renderCurrentTab();
                    return;
                }
                
                console.log('Filtrage de', sourceData.length, 'lignes pour', currentTab);
                
                filteredData = sourceData.filter(row => {
                    let yearFilter = document.getElementById('yearFilter').value;
                    let monthFilter = document.getElementById('monthFilter').value;
                    let startDate = document.getElementById('startDate').value;
                    let endDate = document.getElementById('endDate').value;
                    let buFilter = document.getElementById('buFilter').value;
                    let collabFilter = document.getElementById('collabFilter').value;
                    let missionFilter = document.getElementById('missionFilter').value;
                    let typeHeureFilter = document.getElementById('typeHeureFilter').value;

                    // Filtre par ann√©e
                    if (yearFilter && dateField && dateField !== '') {
                        let rowDate = row[dateField];
                        let rowYear = '';
                        
                        if (rowDate) {
                            // V√©rifier si c'est au format DD/MM/YYYY
                            let match = rowDate.match(/(\d{2})\/(\d{2})\/(\d{4})/);
                            if (match) {
                                rowYear = match[3];
                            } else {
                                // Fallback pour l'ancien format
                                let normalizedRowDate = normalizeDate(rowDate);
                                rowYear = extractYearFromDate(normalizedRowDate);
                            }
                            
                            if (rowYear !== yearFilter) {
                                return false;
                            }
                        } else {
                            return false; // Pas de date
                        }
                    }
                    
                    // Filtre par mois
                    if (monthFilter && dateField && dateField !== '') {
                        let rowDate = row[dateField];
                        let rowMonth = '';
                        
                        if (rowDate) {
                            // V√©rifier si c'est au format DD/MM/YYYY
                            let match = rowDate.match(/(\d{2})\/(\d{2})\/(\d{4})/);
                            if (match) {
                                rowMonth = match[2];
                            } else {
                                // Fallback pour l'ancien format
                                let normalizedRowDate = normalizeDate(rowDate);
                                rowMonth = extractMonthFromDate(normalizedRowDate);
                            }
                            
                            if (rowMonth !== monthFilter) {
                                return false;
                            }
                        } else {
                            return false; // Pas de date
                        }
                    }
                    
                    // Filtres sp√©cifiques - toujours utiliser les colonnes TRS
                    if (buFilter && row['Division'] !== buFilter) {
                        return false;
                    }
                    if (collabFilter && row['Nom'] !== collabFilter) {
                        return false;
                    }
                    if (missionFilter && row['Missions'] !== missionFilter) {
                        return false;
                    }
                    if (typeHeureFilter && row['Type Heure'] !== typeHeureFilter) {
                        return false;
                    }

                    return true;
                });

                console.log('Donn√©es filtr√©es:', filteredData.length, 'pour l\'onglet:', currentTab);
                renderCurrentTab();
            } finally {
                window.isApplyingFilters = false;
            }
        }

        // Fonction pour rendre l'onglet actif
        function renderCurrentTab() {
            console.log('renderCurrentTab - currentTab:', currentTab);
            console.log('renderCurrentTab - filteredData.length:', filteredData.length);
            
            // Protection contre les appels r√©cursifs
            if (window.isRenderingTab) {
                console.log('Rendu d\'onglet d√©j√† en cours, ignor√©');
                return;
            }
            window.isRenderingTab = true;
            
            try {
                switch (currentTab) {
                    case 'dashboard':
                        renderDashboard();
                        break;
                    case 'missions':
                        renderMissionsTab();
                        break;
                    case 'facturation':
                        renderFacturationTab();
                        break;
                    case 'rentabilite':
                        renderRentabiliteTab();
                        break;
                    case 'performance':
                        renderPerformanceTab();
                        break;
                    case 'opportunites':
                        renderOpportunitesTab();
                        break;
                    default:
                        renderDashboard();
                }
            } finally {
                window.isRenderingTab = false;
            }
        }

        // Gestion des onglets avec protection
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Protection contre les clics multiples
                if (window.isChangingTab) {
                    console.log('Changement d\'onglet d√©j√† en cours, ignor√©');
                    return;
                }
                window.isChangingTab = true;
                
                try {
                    // Retirer la classe active de tous les onglets
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Ajouter la classe active √† l'onglet cliqu√©
                    tab.classList.add('active');
                    const tabId = 'tab-' + tab.dataset.tab;
                    document.getElementById(tabId).classList.add('active');
                    
                    // Mettre √† jour l'onglet actif
                    currentTab = tab.dataset.tab;
                    
                    // Mettre √† jour les filtres pour le nouvel onglet
                    updateFiltersForCurrentTab();
                    
                    // Appliquer les filtres pour l'onglet actif
                    applyFilters();
                } finally {
                    window.isChangingTab = false;
                }
            });
        });

        // Gestion des filtres avec protection
        function handleFilterChange() {
            if (!window.isApplyingFilters) {
                applyFilters();
            }
        }

        document.querySelectorAll('select').forEach(select => {
            select.addEventListener('change', handleFilterChange);
        });
        
        // Gestion sp√©cifique du filtre type d'heure
        document.getElementById('typeHeureFilter').addEventListener('change', handleFilterChange);
        
        // Gestion des filtres de dates
        document.getElementById('startDate').addEventListener('change', handleFilterChange);
        document.getElementById('endDate').addEventListener('change', handleFilterChange);

        // Gestion du bouton de mise √† jour
        document.getElementById('refreshBtn').addEventListener('click', refreshData);

        // Fonctions utilitaires pour les dates
        function extractYearFromDate(dateStr) {
            if (!dateStr) return '';
            let match = dateStr.match(/(\d{4})/);
            return match ? match[1] : '';
        }

        function extractMonthFromDate(dateStr) {
            if (!dateStr) return '';
            let match = dateStr.match(/(\d{2})\/(\d{2})\/(\d{4})/);
            return match ? match[2] : '';
        }

        // Fonction de rafra√Æchissement des donn√©es
        function refreshData() {
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.classList.add('loading');
            refreshBtn.textContent = 'üîÑ Chargement...';
            
            setTimeout(() => {
                loadAllCSVs();
                refreshBtn.classList.remove('loading');
                refreshBtn.textContent = 'üîÑ Mise √† jour';
            }, 1000);
        }

        // Rendu du dashboard principal
        function renderDashboard() {
            console.log('renderDashboard - filteredData.length:', filteredData.length);
            
            // Protection contre les appels multiples
            if (window.isRenderingDashboard) {
                console.log('Dashboard d√©j√† en cours de rendu, ignor√©');
                return;
            }
            window.isRenderingDashboard = true;
            
            try {
                if (!filteredData.length) {
                    document.getElementById('tab-dashboard').innerHTML = '<div class="no-data">Aucune donn√©e √† afficher</div>';
                    return;
                }

            // Calcul des KPIs
            let totalHeures = filteredData.reduce((sum, row) => sum + (parseFloat(row['Heures']) || 0), 0);
            let totalCollaborateurs = new Set(filteredData.map(row => row['Nom'])).size;
            let totalMissions = new Set(filteredData.map(row => row['Missions'])).size;
            let totalPoles = new Set(filteredData.map(row => row['Division'])).size;

            // HTML des KPIs
            let kpisHTML = `
                <div class="kpi-cards">
                    <div class="kpi-card">
                        <span class="kpi-icon">‚è∞</span>
                        <div class="kpi-label">Total Heures</div>
                        <div class="kpi-value">${totalHeures.toFixed(1)}h</div>
                    </div>
                    <div class="kpi-card">
                        <span class="kpi-icon">üë•</span>
                        <div class="kpi-label">Collaborateurs</div>
                        <div class="kpi-value">${totalCollaborateurs}</div>
                    </div>
                    <div class="kpi-card">
                        <span class="kpi-icon">üìã</span>
                        <div class="kpi-label">Missions</div>
                        <div class="kpi-value">${totalMissions}</div>
                    </div>
                    <div class="kpi-card">
                        <span class="kpi-icon">üè¢</span>
                        <div class="kpi-label">P√¥les</div>
                        <div class="kpi-value">${totalPoles}</div>
                    </div>
                </div>
            `;

            // Graphiques
            let chartsHTML = `
                <div class="charts-row">
                    <div class="chart-container">
                        <div class="section-title">R√©partition par P√¥le</div>
                        <canvas id="chartByBU"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="section-title">Top Collaborateurs</div>
                        <canvas id="chartTopCollab"></canvas>
                    </div>
                </div>
            `;

            document.getElementById('tab-dashboard').innerHTML = kpisHTML + chartsHTML;

            // Rendu des graphiques temporairement d√©sactiv√© pour debug
            console.log('Graphiques temporairement d√©sactiv√©s pour debug');
            /*
            setTimeout(() => {
                try {
                    renderChart('chartByBU', getHoursByField(filteredData, 'Division'), 'bar', 'P√¥le', 'Heures');
                } catch (error) {
                    console.error('Erreur graphique chartByBU:', error);
                }
            }, 100);
            setTimeout(() => {
                try {
                    renderChart('chartTopCollab', getTopN('Nom', 5), 'bar', 'Collaborateur', 'Heures');
                } catch (error) {
                    console.error('Erreur graphique chartTopCollab:', error);
                }
            }, 200);
            */
            } catch (error) {
                console.error('Erreur lors du rendu du dashboard:', error);
            } finally {
                window.isRenderingDashboard = false;
            }
        }

        // Fonctions utilitaires pour les graphiques
        function getHoursByField(data, field) {
            let map = {};
            data.forEach(row => {
                let value = row[field];
                if (value) {
                    map[value] = (map[value] || 0) + (parseFloat(row['Heures']) || 0);
                }
            });
            return map;
        }

        // Fonction pour obtenir les top N √©l√©ments
        function getTopN(field, n) {
            let map = {};
            filteredData.forEach(row => {
                let value = row[field];
                if (value) {
                    map[value] = (map[value] || 0) + (parseFloat(row['Heures']) || 0);
                }
            });
            
            return Object.entries(map)
                .sort((a, b) => b[1] - a[1])
                .slice(0, n)
                .reduce((obj, [key, value]) => {
                    obj[key] = value;
                    return obj;
                }, {});
        }

        // Fonction pour rendre un graphique
        function renderChart(canvasId, data, type, xLabel, yLabel) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.error('Canvas non trouv√©:', canvasId);
                return;
            }

            // V√©rifier si les donn√©es sont valides
            if (!data || Object.keys(data).length === 0) {
                console.warn('Aucune donn√©e pour le graphique:', canvasId);
                return;
            }

            // Protection contre les rendus multiples
            if (window.isRenderingChart && window.isRenderingChart === canvasId) {
                console.warn('Graphique d√©j√† en cours de rendu:', canvasId);
                return;
            }
            window.isRenderingChart = canvasId;

            try {
                // D√©truire le graphique existant s'il y en a un
                if (charts[canvasId]) {
                    charts[canvasId].destroy();
                    delete charts[canvasId];
                }

                const ctx = canvas.getContext('2d');
                
                let chartData = {
                    labels: Object.keys(data),
                    datasets: [{
                        label: yLabel,
                        data: Object.values(data),
                        backgroundColor: type === 'doughnut' ? [
                            '#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe',
                            '#00f2fe', '#43e97b', '#38f9d7', '#fa7093', '#fee140'
                        ] : '#667eea',
                        borderColor: type === 'doughnut' ? '#fff' : '#764ba2',
                        borderWidth: 2
                    }]
                };

                charts[canvasId] = new Chart(ctx, {
                    type: type,
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        },
                        scales: type !== 'doughnut' ? {
                            y: {
                                beginAtZero: true
                            }
                        } : {}
                    }
                });
            } catch (error) {
                console.error('Erreur lors du rendu du graphique:', canvasId, error);
            } finally {
                window.isRenderingChart = null;
            }
        }

        // ===== ONGLET MISSIONS =====
        function renderMissionsTab() {
            // Protection contre les appels multiples
            if (window.isRenderingMissions) {
                console.log('Missions d√©j√† en cours de rendu, ignor√©');
                return;
            }
            window.isRenderingMissions = true;
            
            try {
                if (!filteredData.length) {
                    document.getElementById('tab-missions').innerHTML = '<div class="no-data">Aucune donn√©e de missions disponible</div>';
                    return;
                }

            let missionStats = calculateMissionStats();
            let totalHeures = filteredData.reduce((sum, row) => sum + (parseFloat(row['Heures']) || 0), 0);
            let totalCout = calculateTotalCost();

            let missionsHTML = `
                <div class="kpi-cards">
                    <div class="kpi-card">
                        <span class="kpi-icon">üìã</span>
                        <div class="kpi-label">Missions Actives</div>
                        <div class="kpi-value">${Object.keys(missionStats).length}</div>
                    </div>
                    <div class="kpi-card">
                        <span class="kpi-icon">‚è∞</span>
                        <div class="kpi-label">Total Heures</div>
                        <div class="kpi-value">${totalHeures.toFixed(1)}h</div>
                    </div>
                    <div class="kpi-card">
                        <span class="kpi-icon">üí∞</span>
                        <div class="kpi-label">Co√ªt Total</div>
                        <div class="kpi-value">${totalCout.toLocaleString()} XAF</div>
                    </div>
                    <div class="kpi-card">
                        <span class="kpi-icon">üë•</span>
                        <div class="kpi-label">Collaborateurs</div>
                        <div class="kpi-value">${new Set(filteredData.map(row => row['Nom'])).size}</div>
                    </div>
                    <div class="kpi-card">
                        <span class="kpi-icon">üìä</span>
                        <div class="kpi-label">Heures Moyennes/Mission</div>
                        <div class="kpi-value">${Object.keys(missionStats).length > 0 ? (totalHeures / Object.keys(missionStats).length).toFixed(1) : 0}h</div>
                    </div>
                    <div class="kpi-card">
                        <span class="kpi-icon">üèÜ</span>
                        <div class="kpi-label">Top Mission Co√ªteuse</div>
                        <div class="kpi-value">${getTopCostlyMission(missionStats)}</div>
                    </div>
                </div>
                <div class="charts-row">
                    <div class="chart-container">
                        <div class="section-title">Heures par Mission (Top 10)</div>
                        <canvas id="missionsChartHours"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="section-title">R√©partition par Type d'Heure</div>
                        <canvas id="missionsChartType"></canvas>
                    </div>
                </div>
                <div class="charts-row">
                    <div class="chart-container">
                        <div class="section-title">√âvolution des Heures par Mois</div>
                        <canvas id="missionsChartEvolution"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="section-title">R√©partition par Grade</div>
                        <canvas id="missionsChartGrade"></canvas>
                    </div>
                </div>
                <div class="charts-row">
                    <div class="chart-container">
                        <div class="section-title">Top Collaborateurs par Heures</div>
                        <canvas id="missionsChartCollaborateurs"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="section-title">Co√ªt par Division</div>
                        <canvas id="missionsChartDivision"></canvas>
                    </div>
                </div>
                <div class="chart-container" style="margin-top: 20px;">
                    <div class="section-title">D√©tail des Heures par Mission</div>
                    <table id="missionsTable">
                        <thead>
                            <tr>
                                <th>Mission</th>
                                <th>Division</th>
                                <th>Collaborateurs</th>
                                <th>Heures HC</th>
                                <th>Heures HNC</th>
                                <th>Total Heures</th>
                                <th>Co√ªt Total</th>
                                <th>Co√ªt Moyen/H</th>
                                <th>Taux Chargeabilit√©</th>
                                <th>Co√ªt/Collaborateur</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${generateMissionsTable()}
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('tab-missions').innerHTML = missionsHTML;

            // Rendu des graphiques temporairement d√©sactiv√© pour debug
            console.log('Graphiques missions temporairement d√©sactiv√©s pour debug');
            /*
            renderChart('missionsChartHours', getHoursByMission(), 'bar', 'Mission', 'Heures');
            renderChart('missionsChartType', getHoursByType(), 'doughnut', 'Type d\'heure', 'Heures');
            renderChart('missionsChartEvolution', getHoursByMonth(), 'line', 'Mois', 'Heures');
            renderChart('missionsChartGrade', getHoursByGrade(), 'bar', 'Grade', 'Heures');
            renderChart('missionsChartCollaborateurs', getTopCollaborateurs(), 'bar', 'Collaborateur', 'Heures');
            renderChart('missionsChartDivision', getCostByDivision(), 'bar', 'Division', 'Co√ªt (XAF)');
            */
            } catch (error) {
                console.error('Erreur lors du rendu des missions:', error);
            } finally {
                window.isRenderingMissions = false;
            }
        }

        function calculateMissionStats() {
            let stats = {};
            filteredData.forEach(row => {
                let mission = row['Missions'];
                if (!mission) return;
                
                if (!stats[mission]) {
                    stats[mission] = {
                        division: row['Division'],
                        collaborateurs: new Set(),
                        heures: 0,
                        heuresHC: 0,
                        heuresHNC: 0,
                        cout: 0
                    };
                }
                
                stats[mission].collaborateurs.add(row['Nom']);
                let heures = parseFloat(row['Heures']) || 0;
                stats[mission].heures += heures;
                
                // Calculer le co√ªt bas√© sur le grade (uniquement pour les heures HC)
                if (row['Type Heure'] === 'HC') {
                    let grade = row['Grade'];
                    let tauxHoraire = gradeToTaux[grade] || 0;
                    stats[mission].cout += tauxHoraire * heures;
                    stats[mission].heuresHC += heures;
                } else {
                    stats[mission].heuresHNC += heures;
                }
            });
            
            return stats;
        }

        function calculateTotalCost() {
            return filteredData.reduce((sum, row) => {
                // Ne calculer le co√ªt que pour les heures HC (chargeables)
                if (row['Type Heure'] === 'HC') {
                    let grade = row['Grade'];
                    let tauxHoraire = gradeToTaux[grade] || 0;
                    let heures = parseFloat(row['Heures']) || 0;
                    return sum + (tauxHoraire * heures);
                }
                return sum;
            }, 0);
        }

        function getTopCostlyMission(missionStats) {
            let topMission = Object.entries(missionStats)
                .sort((a, b) => b[1].cout - a[1].cout)[0];
            return topMission ? topMission[0].substring(0, 20) + '...' : 'N/A';
        }

        function getHoursByMission() {
            let missionStats = calculateMissionStats();
            return Object.entries(missionStats)
                .sort((a, b) => b[1].heures - a[1].heures)
                .slice(0, 10)
                .reduce((obj, [mission, stats]) => {
                    obj[mission.substring(0, 20) + '...'] = stats.heures;
                    return obj;
                }, {});
        }

        function getHoursByType() {
            let hcTotal = 0;
            let hncTotal = 0;
            
            filteredData.forEach(row => {
                let heures = parseFloat(row['Heures']) || 0;
                if (row['Type Heure'] === 'HC') {
                    hcTotal += heures;
                } else {
                    hncTotal += heures;
                }
            });
            
            return {
                'Heures Chargeables': hcTotal,
                'Heures Non-Chargeables': hncTotal
            };
        }

        function getHoursByMonth() {
            let monthStats = {};
            filteredData.forEach(row => {
                let mois = row['Mois'] || 'Non d√©fini';
                let heures = parseFloat(row['Heures']) || 0;
                monthStats[mois] = (monthStats[mois] || 0) + heures;
            });
            return monthStats;
        }

        function getHoursByGrade() {
            let gradeStats = {};
            filteredData.forEach(row => {
                let grade = row['Grade'] || 'Non d√©fini';
                let heures = parseFloat(row['Heures']) || 0;
                gradeStats[grade] = (gradeStats[grade] || 0) + heures;
            });
            return gradeStats;
        }

        function getTopCollaborateurs() {
            let collabStats = {};
            filteredData.forEach(row => {
                let nom = row['Nom'];
                let heures = parseFloat(row['Heures']) || 0;
                collabStats[nom] = (collabStats[nom] || 0) + heures;
            });
            
            return Object.entries(collabStats)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .reduce((obj, [nom, heures]) => {
                    obj[nom.length > 15 ? nom.substring(0, 15) + '...' : nom] = heures;
                    return obj;
                }, {});
        }

        function getCostByDivision() {
            let divisionStats = {};
            filteredData.forEach(row => {
                if (row['Type Heure'] === 'HC') {
                    let division = row['Division'] || 'Non d√©fini';
                    let grade = row['Grade'];
                    let tauxHoraire = gradeToTaux[grade] || 0;
                    let heures = parseFloat(row['Heures']) || 0;
                    let cout = tauxHoraire * heures;
                    
                    divisionStats[division] = (divisionStats[division] || 0) + cout;
                }
            });
            return divisionStats;
        }

        function generateMissionsTable() {
            let missionStats = calculateMissionStats();
            return Object.entries(missionStats).map(([mission, stats]) => {
                let coutMoyenH = stats.heures > 0 ? stats.cout / stats.heures : 0;
                let tauxChargeabilite = stats.heures > 0 ? (stats.heuresHC / stats.heures) * 100 : 0;
                let coutParCollab = stats.collaborateurs.size > 0 ? stats.cout / stats.collaborateurs.size : 0;
                
                let rowClass = tauxChargeabilite < 50 ? 'alert-low-chargeability' : '';
                
                return `
                    <tr class="${rowClass}">
                        <td>${mission}</td>
                        <td>${stats.division}</td>
                        <td>${stats.collaborateurs.size}</td>
                        <td>${stats.heuresHC.toFixed(1)}h</td>
                        <td>${stats.heuresHNC.toFixed(1)}h</td>
                        <td>${stats.heures.toFixed(1)}h</td>
                        <td>${stats.cout.toLocaleString()} XAF</td>
                        <td>${coutMoyenH.toLocaleString()} XAF/h</td>
                        <td>${tauxChargeabilite.toFixed(1)}%</td>
                        <td>${coutParCollab.toLocaleString()} XAF</td>
                    </tr>
                `;
            }).join('');
        }

        // ===== ONGLET FACTURATION =====
        function renderFacturationTab() {
            if (!facturesData.length) {
                document.getElementById('tab-facturation').innerHTML = '<div class="no-data">Aucune donn√©e de facturation disponible</div>';
                return;
            }

            let facturationStats = calculateFacturationStats();

            let facturationHTML = `
                <div class="kpi-cards">
                    <div class="kpi-card">
                        <span class="kpi-icon">üìÑ</span>
                        <div class="kpi-label">Total Factures</div>
                        <div class="kpi-value">${facturationStats.totalFactures}</div>
                    </div>
                    <div class="kpi-card">
                        <span class="kpi-icon">üí∞</span>
                        <div class="kpi-label">Montant Factur√©</div>
                        <div class="kpi-value">${facturationStats.montantFacture.toLocaleString()} XAF</div>
                    </div>
                    <div class="kpi-card">
                        <span class="kpi-icon">üí≥</span>
                        <div class="kpi-label">Montant Encaiss√©</div>
                        <div class="kpi-value">${facturationStats.montantEncaisse.toLocaleString()} XAF</div>
                    </div>
                    <div class="kpi-card">
                        <span class="kpi-icon">üìä</span>
                        <div class="kpi-label">Taux d'Encaissement</div>
                        <div class="kpi-value">${facturationStats.tauxEncaissement.toFixed(1)}%</div>
                    </div>
                </div>
                <div class="charts-row">
                    <div class="chart-container">
                        <div class="section-title">Facturation par Division</div>
                        <canvas id="facturationChartDivision"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="section-title">√âtat des Factures</div>
                        <canvas id="facturationChartEtat"></canvas>
                    </div>
                </div>
                <div class="chart-container" style="margin-top: 20px;">
                    <div class="section-title">D√©tail des Factures</div>
                    <table id="facturationTable">
                        <thead>
                            <tr>
                                <th>Client</th>
                                <th>Division</th>
                                <th>Montant Factur√©</th>
                                <th>Montant Encaiss√©</th>
                                <th>Solde</th>
                                <th>√âtat</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${generateFacturationTable()}
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('tab-facturation').innerHTML = facturationHTML;

            // Rendu des graphiques temporairement d√©sactiv√© pour debug
            console.log('Graphiques facturation temporairement d√©sactiv√©s pour debug');
            /*
            renderChart('facturationChartDivision', getFacturationByDivision(), 'bar', 'Division', 'Montant (XAF)');
            renderChart('facturationChartEtat', getFacturationByEtat(), 'doughnut', '√âtat', 'Nombre');
            */
        }

        function calculateFacturationStats() {
            let totalFactures = facturesData.length;
            let montantFacture = facturesData.reduce((sum, facture) => {
                let montant = parseFloat(facture['Montant Factur√©']?.replace(/\s/g, '') || '0');
                return sum + montant;
            }, 0);
            let montantEncaisse = facturesData.reduce((sum, facture) => {
                let montant = parseFloat(facture['Montant Encaiss√©']?.replace(/\s/g, '') || '0');
                return sum + montant;
            }, 0);
            let tauxEncaissement = montantFacture > 0 ? (montantEncaisse / montantFacture) * 100 : 0;

            return {
                totalFactures,
                montantFacture,
                montantEncaisse,
                tauxEncaissement
            };
        }

        function getFacturationByDivision() {
            let divisionStats = {};
            facturesData.forEach(facture => {
                let division = facture['Division'] || 'Non d√©fini';
                let montant = parseFloat(facture['Montant Factur√©']?.replace(/\s/g, '') || '0');
                
                if (!divisionStats[division]) {
                    divisionStats[division] = 0;
                }
                divisionStats[division] += montant;
            });

            return divisionStats;
        }

        function getFacturationByEtat() {
            let etatStats = {};
            facturesData.forEach(facture => {
                let montantFacture = parseFloat(facture['Montant Factur√©']?.replace(/\s/g, '') || '0');
                let montantEncaisse = parseFloat(facture['Montant Encaiss√©']?.replace(/\s/g, '') || '0');
                let solde = montantFacture - montantEncaisse;
                let etat = solde === 0 ? 'Pay√©' : solde > 0 ? 'En attente' : 'Surpay√©';
                
                if (!etatStats[etat]) {
                    etatStats[etat] = 0;
                }
                etatStats[etat]++;
            });

            return etatStats;
        }

        function generateFacturationTable() {
            return facturesData.map(facture => {
                let montantFacture = parseFloat(facture['Montant Factur√©']?.replace(/\s/g, '') || '0');
                let montantEncaisse = parseFloat(facture['Montant Encaiss√©']?.replace(/\s/g, '') || '0');
                let solde = montantFacture - montantEncaisse;
                let etat = solde === 0 ? 'Pay√©' : solde > 0 ? 'En attente' : 'Surpay√©';
                
                let rowClass = etat === 'En attente' ? 'alert-low-rentability' : '';
                
                return `
                    <tr class="${rowClass}">
                        <td>${facture['Client'] || ''}</td>
                        <td>${facture['Division'] || ''}</td>
                        <td>${montantFacture.toLocaleString()} XAF</td>
                        <td>${montantEncaisse.toLocaleString()} XAF</td>
                        <td>${solde.toLocaleString()} XAF</td>
                        <td>${etat}</td>
                        <td>${facture['Date'] || ''}</td>
                    </tr>
                `;
            }).join('');
        }

        // ===== ONGLET RENTABILIT√â =====
        function renderRentabiliteTab() {
            if (!filteredData.length) {
                document.getElementById('tab-rentabilite').innerHTML = '<div class="no-data">Aucune donn√©e de rentabilit√© disponible</div>';
                return;
            }

            let rentabiliteStats = calculateRentabiliteStats();

            let rentabiliteHTML = `
                <div class="kpi-cards">
                    <div class="kpi-card">
                        <span class="kpi-icon">üí∞</span>
                        <div class="kpi-label">Chiffre d'Affaires</div>
                        <div class="kpi-value">${rentabiliteStats.ca.toLocaleString()} XAF</div>
                    </div>
                    <div class="kpi-card">
                        <span class="kpi-icon">üí∏</span>
                        <div class="kpi-label">Co√ªts Totaux</div>
                        <div class="kpi-value">${rentabiliteStats.couts.toLocaleString()} XAF</div>
                    </div>
                    <div class="kpi-card">
                        <span class="kpi-icon">üìà</span>
                        <div class="kpi-label">Marge Brute</div>
                        <div class="kpi-value">${rentabiliteStats.marge.toLocaleString()} XAF</div>
                    </div>
                    <div class="kpi-card">
                        <span class="kpi-icon">üìä</span>
                        <div class="kpi-label">Taux de Marge</div>
                        <div class="kpi-value">${rentabiliteStats.tauxMarge.toFixed(1)}%</div>
                    </div>
                    <div class="kpi-card">
                        <span class="kpi-icon">üéØ</span>
                        <div class="kpi-label">ROI</div>
                        <div class="kpi-value">${rentabiliteStats.roi.toFixed(1)}%</div>
                    </div>
                    <div class="kpi-card">
                        <span class="kpi-icon">üìã</span>
                        <div class="kpi-label">Missions Rentables</div>
                        <div class="kpi-value">${rentabiliteStats.missionsRentables}</div>
                    </div>
                </div>
                <div class="charts-row">
                    <div class="chart-container">
                        <div class="section-title">Rentabilit√© par Mission</div>
                        <canvas id="rentabiliteChartMissions"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="section-title">Rentabilit√© par Division</div>
                        <canvas id="rentabiliteChartDivision"></canvas>
                    </div>
                </div>
                <div class="chart-container" style="margin-top: 20px;">
                    <div class="section-title">D√©tail de la Rentabilit√©</div>
                    <table id="rentabiliteTable">
                        <thead>
                            <tr>
                                <th>Mission</th>
                                <th>Division</th>
                                <th>CA</th>
                                <th>Co√ªts</th>
                                <th>Marge</th>
                                <th>Taux Marge</th>
                                <th>ROI</th>
                                <th>CA/H HC</th>
                                <th>Co√ªt/H HC</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${generateRentabiliteTable()}
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('tab-rentabilite').innerHTML = rentabiliteHTML;

            // Rendu des graphiques temporairement d√©sactiv√© pour debug
            console.log('Graphiques rentabilit√© temporairement d√©sactiv√©s pour debug');
            /*
            renderChart('rentabiliteChartMissions', getRentabiliteByMission(), 'bar', 'Mission', 'Marge (XAF)');
            renderChart('rentabiliteChartDivision', getRentabiliteByDivision(), 'bar', 'Division', 'Marge (XAF)');
            */
        }

        function calculateRentabiliteStats() {
            let missionStats = calculateMissionStats();
            let totalCA = 0;
            let totalCouts = 0;
            let missionsRentables = 0;

            Object.entries(missionStats).forEach(([mission, stats]) => {
                // Simuler le CA bas√© sur les heures HC (pour l'exemple)
                let ca = stats.heuresHC * 5000; // Taux moyen de 5000 XAF/h
                let couts = stats.cout;
                let marge = ca - couts;
                
                totalCA += ca;
                totalCouts += couts;
                if (marge > 0) missionsRentables++;
            });

            let marge = totalCA - totalCouts;
            let tauxMarge = totalCA > 0 ? (marge / totalCA) * 100 : 0;
            let roi = totalCouts > 0 ? (marge / totalCouts) * 100 : 0;

            return {
                ca: totalCA,
                couts: totalCouts,
                marge: marge,
                tauxMarge: tauxMarge,
                roi: roi,
                missionsRentables: missionsRentables
            };
        }

        function getRentabiliteByMission() {
            let missionStats = calculateMissionStats();
            return Object.entries(missionStats)
                .map(([mission, stats]) => {
                    let ca = stats.heuresHC * 5000; // Taux moyen
                    let marge = ca - stats.cout;
                    return {
                        mission: mission.substring(0, 20) + '...',
                        marge: marge
                    };
                })
                .sort((a, b) => b.marge - a.marge)
                .slice(0, 10)
                .reduce((obj, item) => {
                    obj[item.mission] = item.marge;
                    return obj;
                }, {});
        }

        function getRentabiliteByDivision() {
            let divisionStats = {};
            let missionStats = calculateMissionStats();
            
            Object.entries(missionStats).forEach(([mission, stats]) => {
                let division = stats.division || 'Non d√©fini';
                let ca = stats.heuresHC * 5000;
                let marge = ca - stats.cout;
                
                if (!divisionStats[division]) {
                    divisionStats[division] = 0;
                }
                divisionStats[division] += marge;
            });

            return divisionStats;
        }

        function generateRentabiliteTable() {
            let missionStats = calculateMissionStats();
            return Object.entries(missionStats).map(([mission, stats]) => {
                let ca = stats.heuresHC * 5000;
                let marge = ca - stats.cout;
                let tauxMarge = ca > 0 ? (marge / ca) * 100 : 0;
                let roi = stats.cout > 0 ? (marge / stats.cout) * 100 : 0;
                let caParHeure = stats.heuresHC > 0 ? ca / stats.heuresHC : 0;
                let coutParHeure = stats.heuresHC > 0 ? stats.cout / stats.heuresHC : 0;
                
                let rowClass = marge < 0 ? 'alert-low-rentability' : '';
                
                return `
                    <tr class="${rowClass}">
                        <td>${mission}</td>
                        <td>${stats.division}</td>
                        <td>${ca.toLocaleString()} XAF</td>
                        <td>${stats.cout.toLocaleString()} XAF</td>
                        <td>${marge.toLocaleString()} XAF</td>
                        <td>${tauxMarge.toFixed(1)}%</td>
                        <td>${roi.toFixed(1)}%</td>
                        <td>${caParHeure.toLocaleString()} XAF/h</td>
                        <td>${coutParHeure.toLocaleString()} XAF/h</td>
                    </tr>
                `;
            }).join('');
        }

        // ===== ONGLET PERFORMANCE =====
        function renderPerformanceTab() {
            if (!filteredData.length) {
                document.getElementById('tab-performance').innerHTML = '<div class="no-data">Aucune donn√©e de performance disponible</div>';
                return;
            }

            let performanceStats = calculatePerformanceStats();

            let performanceHTML = `
                <div class="kpi-cards">
                    <div class="kpi-card">
                        <span class="kpi-icon">‚è∞</span>
                        <div class="kpi-label">Total Heures</div>
                        <div class="kpi-value">${performanceStats.totalHeures.toFixed(1)}h</div>
                    </div>
                    <div class="kpi-card">
                        <span class="kpi-icon">üìä</span>
                        <div class="kpi-label">Taux de Chargeabilit√©</div>
                        <div class="kpi-value">${performanceStats.tauxChargeabilite.toFixed(1)}%</div>
                    </div>
                    <div class="kpi-card">
                        <span class="kpi-icon">üë•</span>
                        <div class="kpi-label">Collaborateurs Actifs</div>
                        <div class="kpi-value">${performanceStats.collaborateursActifs}</div>
                    </div>
                    <div class="kpi-card">
                        <span class="kpi-icon">üèÜ</span>
                        <div class="kpi-label">Plus Efficace</div>
                        <div class="kpi-value">${performanceStats.plusEfficace}</div>
                    </div>
                    <div class="kpi-card">
                        <span class="kpi-icon">üìà</span>
                        <div class="kpi-label">Productivit√© Moyenne</div>
                        <div class="kpi-value">${performanceStats.productiviteMoyenne.toFixed(1)}h/j</div>
                    </div>
                    <div class="kpi-card">
                        <span class="kpi-icon">üéØ</span>
                        <div class="kpi-label">Meilleure Division</div>
                        <div class="kpi-value">${performanceStats.meilleureDivision}</div>
                    </div>
                </div>
                <div class="charts-row">
                    <div class="chart-container">
                        <div class="section-title">Performance par Collaborateur</div>
                        <canvas id="performanceChartCollaborateurs"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="section-title">R√©partition HC/HNC</div>
                        <canvas id="performanceChartHCHNC"></canvas>
                    </div>
                </div>
                <div class="charts-row">
                    <div class="chart-container">
                        <div class="section-title">Performance par Division</div>
                        <canvas id="performanceChartDivision"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="section-title">√âvolution par Mois</div>
                        <canvas id="performanceChartEvolution"></canvas>
                    </div>
                </div>
                <div class="chart-container" style="margin-top: 20px;">
                    <div class="section-title">D√©tail de la Performance</div>
                    <table id="performanceTable">
                        <thead>
                            <tr>
                                <th>Collaborateur</th>
                                <th>Division</th>
                                <th>Heures HC</th>
                                <th>Heures HNC</th>
                                <th>Total Heures</th>
                                <th>Taux Chargeabilit√©</th>
                                <th>Ratio HC/HNC</th>
                                <th>Productivit√©</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${generatePerformanceTable()}
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('tab-performance').innerHTML = performanceHTML;

            // Rendu des graphiques temporairement d√©sactiv√© pour debug
            console.log('Graphiques performance temporairement d√©sactiv√©s pour debug');
            /*
            renderChart('performanceChartCollaborateurs', getPerformanceByCollaborateur(), 'bar', 'Collaborateur', 'Heures');
            renderChart('performanceChartHCHNC', getRepartitionHCHNC(), 'doughnut', 'Type', 'Heures');
            renderChart('performanceChartDivision', getPerformanceByDivision(), 'bar', 'Division', 'Taux (%)');
            renderChart('performanceChartEvolution', getPerformanceByMonth(), 'line', 'Mois', 'Taux (%)');
            */
        }

        function calculatePerformanceStats() {
            let totalHeures = filteredData.reduce((sum, row) => sum + (parseFloat(row['Heures']) || 0), 0);
            let totalHeuresHC = filteredData.filter(row => row['Type Heure'] === 'HC')
                .reduce((sum, row) => sum + (parseFloat(row['Heures']) || 0), 0);
            let tauxChargeabilite = totalHeures > 0 ? (totalHeuresHC / totalHeures) * 100 : 0;
            
            let collaborateursActifs = new Set(filteredData.map(row => row['Nom'])).size;
            
            // Trouver le collaborateur le plus efficace (plus d'heures HC)
            let collabStats = {};
            filteredData.forEach(row => {
                let nom = row['Nom'];
                let heures = parseFloat(row['Heures']) || 0;
                if (row['Type Heure'] === 'HC') {
                    collabStats[nom] = (collabStats[nom] || 0) + heures;
                }
            });
            
            let plusEfficace = Object.entries(collabStats)
                .sort((a, b) => b[1] - a[1])[0];
            plusEfficace = plusEfficace ? plusEfficace[0].substring(0, 15) + '...' : 'N/A';
            
            // Calculer la productivit√© moyenne (heures par jour travaill√©)
            let productiviteMoyenne = collaborateursActifs > 0 ? totalHeures / (collaborateursActifs * 20) : 0; // 20 jours/mois
            
            // Trouver la meilleure division (taux de chargeabilit√© le plus √©lev√©)
            let divisionStats = {};
            filteredData.forEach(row => {
                let division = row['Division'] || 'Non d√©fini';
                let heures = parseFloat(row['Heures']) || 0;
                let isHC = row['Type Heure'] === 'HC';
                
                if (!divisionStats[division]) {
                    divisionStats[division] = { total: 0, hc: 0 };
                }
                divisionStats[division].total += heures;
                if (isHC) divisionStats[division].hc += heures;
            });
            
            let meilleureDivision = Object.entries(divisionStats)
                .map(([division, stats]) => ({
                    division,
                    taux: stats.total > 0 ? (stats.hc / stats.total) * 100 : 0
                }))
                .sort((a, b) => b.taux - a.taux)[0];
            meilleureDivision = meilleureDivision ? meilleureDivision.division : 'N/A';

            return {
                totalHeures,
                tauxChargeabilite,
                collaborateursActifs,
                plusEfficace,
                productiviteMoyenne,
                meilleureDivision
            };
        }

        function getPerformanceByCollaborateur() {
            let collabStats = {};
            filteredData.forEach(row => {
                let nom = row['Nom'];
                let heures = parseFloat(row['Heures']) || 0;
                collabStats[nom] = (collabStats[nom] || 0) + heures;
            });
            
            return Object.entries(collabStats)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .reduce((obj, [nom, heures]) => {
                    obj[nom.length > 15 ? nom.substring(0, 15) + '...' : nom] = heures;
                    return obj;
                }, {});
        }

        function getRepartitionHCHNC() {
            let hcTotal = 0;
            let hncTotal = 0;
            
            filteredData.forEach(row => {
                let heures = parseFloat(row['Heures']) || 0;
                if (row['Type Heure'] === 'HC') {
                    hcTotal += heures;
                } else {
                    hncTotal += heures;
                }
            });
            
            return {
                'Heures Chargeables': hcTotal,
                'Heures Non-Chargeables': hncTotal
            };
        }

        function getPerformanceByDivision() {
            let divisionStats = {};
            filteredData.forEach(row => {
                let division = row['Division'] || 'Non d√©fini';
                let heures = parseFloat(row['Heures']) || 0;
                let isHC = row['Type Heure'] === 'HC';
                
                if (!divisionStats[division]) {
                    divisionStats[division] = { total: 0, hc: 0 };
                }
                divisionStats[division].total += heures;
                if (isHC) divisionStats[division].hc += heures;
            });
            
            return Object.entries(divisionStats)
                .reduce((obj, [division, stats]) => {
                    obj[division] = stats.total > 0 ? (stats.hc / stats.total) * 100 : 0;
                    return obj;
                }, {});
        }

        function getPerformanceByMonth() {
            let monthStats = {};
            filteredData.forEach(row => {
                let mois = row['Mois'] || 'Non d√©fini';
                let heures = parseFloat(row['Heures']) || 0;
                let isHC = row['Type Heure'] === 'HC';
                
                if (!monthStats[mois]) {
                    monthStats[mois] = { total: 0, hc: 0 };
                }
                monthStats[mois].total += heures;
                if (isHC) monthStats[mois].hc += heures;
            });
            
            return Object.entries(monthStats)
                .sort((a, b) => a[0].localeCompare(b[0]))
                .reduce((obj, [mois, stats]) => {
                    obj[mois] = stats.total > 0 ? (stats.hc / stats.total) * 100 : 0;
                    return obj;
                }, {});
        }

        function generatePerformanceTable() {
            let collabStats = {};
            filteredData.forEach(row => {
                let nom = row['Nom'];
                let heures = parseFloat(row['Heures']) || 0;
                let isHC = row['Type Heure'] === 'HC';
                
                if (!collabStats[nom]) {
                    collabStats[nom] = { hc: 0, hnc: 0, division: row['Division'] };
                }
                if (isHC) {
                    collabStats[nom].hc += heures;
                } else {
                    collabStats[nom].hnc += heures;
                }
            });
            
            return Object.entries(collabStats).map(([nom, stats]) => {
                let totalHeures = stats.hc + stats.hnc;
                let tauxChargeabilite = totalHeures > 0 ? (stats.hc / totalHeures) * 100 : 0;
                let ratioHCHNC = stats.hnc > 0 ? stats.hc / stats.hnc : stats.hc > 0 ? 999 : 0;
                let productivite = totalHeures / 20; // 20 jours/mois
                
                let rowClass = '';
                if (tauxChargeabilite >= 80) rowClass = 'alert-excellent-performance';
                else if (tauxChargeabilite >= 60) rowClass = 'alert-good-performance';
                else if (tauxChargeabilite >= 40) rowClass = 'alert-medium-performance';
                else rowClass = 'alert-low-performance';
                
                return `
                    <tr class="${rowClass}">
                        <td>${nom}</td>
                        <td>${stats.division}</td>
                        <td>${stats.hc.toFixed(1)}h</td>
                        <td>${stats.hnc.toFixed(1)}h</td>
                        <td>${totalHeures.toFixed(1)}h</td>
                        <td>${tauxChargeabilite.toFixed(1)}%</td>
                        <td>${ratioHCHNC.toFixed(2)}</td>
                        <td>${productivite.toFixed(1)}h/j</td>
                    </tr>
                `;
            }).join('');
        }

        // ===== ONGLET OPPORTUNIT√âS =====
        function renderOpportunitesTab() {
            if (!opportunitesData.length) {
                document.getElementById('tab-opportunites').innerHTML = '<div class="no-data">Aucune donn√©e d\'opportunit√©s disponible</div>';
                return;
            }

            let opportunitesStats = calculateOpportunitesStats();

            let opportunitesHTML = `
                <div class="kpi-cards">
                    <div class="kpi-card">
                        <span class="kpi-icon">üéØ</span>
                        <div class="kpi-label">Total Opportunit√©s</div>
                        <div class="kpi-value">${opportunitesStats.totalOpportunites}</div>
                    </div>
                    <div class="kpi-card">
                        <span class="kpi-icon">üí∞</span>
                        <div class="kpi-label">Valeur Totale</div>
                        <div class="kpi-value">${opportunitesStats.valeurTotale.toLocaleString()} XAF</div>
                    </div>
                    <div class="kpi-card">
                        <span class="kpi-icon">üìä</span>
                        <div class="kpi-label">Taux de Conversion</div>
                        <div class="kpi-value">${opportunitesStats.tauxConversion.toFixed(1)}%</div>
                    </div>
                    <div class="kpi-card">
                        <span class="kpi-icon">üìà</span>
                        <div class="kpi-label">Valeur Moyenne</div>
                        <div class="kpi-value">${opportunitesStats.valeurMoyenne.toLocaleString()} XAF</div>
                    </div>
                    <div class="kpi-card">
                        <span class="kpi-icon">üèÜ</span>
                        <div class="kpi-label">Opportunit√©s Gagn√©es</div>
                        <div class="kpi-value">${opportunitesStats.opportunitesGagnees}</div>
                    </div>
                    <div class="kpi-card">
                        <span class="kpi-icon">‚è≥</span>
                        <div class="kpi-label">En Cours</div>
                        <div class="kpi-value">${opportunitesStats.enCours}</div>
                    </div>
                </div>
                <div class="charts-row">
                    <div class="chart-container">
                        <div class="section-title">Opportunit√©s par Division</div>
                        <canvas id="opportunitesChartDivision"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="section-title">Opportunit√©s par Statut</div>
                        <canvas id="opportunitesChartStatut"></canvas>
                    </div>
                </div>
                <div class="chart-container" style="margin-top: 20px;">
                    <div class="section-title">Pipeline Commercial</div>
                    <table id="opportunitesTable">
                        <thead>
                            <tr>
                                <th>Opportunit√©</th>
                                <th>Division</th>
                                <th>Statut</th>
                                <th>Responsable</th>
                                <th>Secteur</th>
                                <th>Type</th>
                                <th>Valeur</th>
                                <th>Date Insertion</th>
                                <th>Derni√®re Action</th>
                                <th>Prochaine Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${generateOpportunitesTable()}
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('tab-opportunites').innerHTML = opportunitesHTML;

            // Rendu des graphiques temporairement d√©sactiv√© pour debug
            console.log('Graphiques opportunit√©s temporairement d√©sactiv√©s pour debug');
            /*
            renderChart('opportunitesChartDivision', getOpportunitesByDivision(), 'bar', 'Division', 'Nombre');
            renderChart('opportunitesChartStatut', getOpportunitesByStatut(), 'doughnut', 'Statut', 'Nombre');
            */
        }

        function calculateOpportunitesStats() {
            let totalOpportunites = opportunitesData.length;
            let valeurTotale = opportunitesData.reduce((sum, opp) => {
                let valeur = parseFloat(opp['Valeur']?.replace(/\s/g, '') || '0');
                return sum + valeur;
            }, 0);
            let valeurMoyenne = totalOpportunites > 0 ? valeurTotale / totalOpportunites : 0;
            
            let oppGagnees = opportunitesData.filter(opp => 
                opp['Statut']?.toLowerCase().includes('win') || 
                opp['Statut']?.toLowerCase().includes('gagn√©')
            ).length;
            let tauxConversion = totalOpportunites > 0 ? (oppGagnees / totalOpportunites) * 100 : 0;

            return {
                totalOpportunites,
                valeurTotale,
                valeurMoyenne,
                tauxConversion,
                opportunitesGagnees: oppGagnees,
                enCours: totalOpportunites - oppGagnees
            };
        }

        function getOpportunitesByDivision() {
            let divisionStats = {};
            opportunitesData.forEach(opp => {
                let division = opp['Division'] || 'Non d√©fini';
                divisionStats[division] = (divisionStats[division] || 0) + 1;
            });
            return divisionStats;
        }

        function getOpportunitesByStatut() {
            let statutStats = {};
            opportunitesData.forEach(opp => {
                let statut = opp['Statut'] || 'Non d√©fini';
                statutStats[statut] = (statutStats[statut] || 0) + 1;
            });
            return statutStats;
        }

        function generateOpportunitesTable() {
            return opportunitesData.map(opp => `
                <tr>
                    <td>${opp['Opportunit√©'] || ''}</td>
                    <td>${opp['Division'] || ''}</td>
                    <td>${opp['Statut'] || ''}</td>
                    <td>${opp['Responsable'] || ''}</td>
                    <td>${opp['Secteur'] || ''}</td>
                    <td>${opp['Type'] || ''}</td>
                    <td>${opp['Valeur'] ? parseFloat(opp['Valeur']).toLocaleString() + ' XAF' : ''}</td>
                    <td>${opp['Date Insertion'] || ''}</td>
                    <td>${opp['Date Derni√®re action'] || ''}</td>
                    <td>${opp['Date prochaine action'] || ''}</td>
                </tr>
            `).join('');
        }

        // Chargement initial
        loadAllCSVs();
    </script>
</body>
</html> 