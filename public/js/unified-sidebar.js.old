// Sidebar Unifiée - Script centralisé pour toutes les pages
// Version réorganisée selon la nouvelle structure

class UnifiedSidebar {
    constructor() {
        this.init();
    }

    init() {
        this.generateSidebar();
        this.setupEventListeners();
        this.setActivePage();
    }

    generateSidebar() {
        const sidebarContainer = document.querySelector('.sidebar-container');
        if (!sidebarContainer) {
            console.warn('Container sidebar non trouvé');
            return;
        }

        // Vider le conteneur existant
        sidebarContainer.innerHTML = '';

        // Générer la sidebar complète
        sidebarContainer.innerHTML = this.getSidebarHTML();
    }

    getSidebarHTML() {
        return `
            <!-- Header de la sidebar -->
            <div class="sidebar-header">
                <h3>
                    <i class="fas fa-eye"></i>
                    EBVISION 2.0
                </h3>
                <p>Gestion Intelligente des Ressources</p>
            </div>

            <!-- Navigation principale -->
            <nav class="sidebar-nav">
                <!-- Section Dashboard -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">
                        <i class="fas fa-tachometer-alt"></i>
                        DASHBOARD
                    </div>
                    <a href="dashboard.html" class="sidebar-nav-link">
                        <i class="fas fa-chart-line"></i>
                        Tableau de bord principal
                    </a>
                    <a href="analytics.html" class="sidebar-nav-link">
                        <i class="fas fa-chart-bar"></i>
                        Analytics & Indicateurs
                    </a>
                </div>

                <!-- Section Rapports -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">
                        <i class="fas fa-file-alt"></i>
                        RAPPORTS
                    </div>
                    <a href="reports.html" class="sidebar-nav-link">
                        <i class="fas fa-chart-pie"></i>
                        Rapports généraux
                    </a>
                    <a href="reports.html?type=missions" class="sidebar-nav-link">
                        <i class="fas fa-briefcase"></i>
                        Rapports missions
                    </a>
                    <a href="reports.html?type=opportunities" class="sidebar-nav-link">
                        <i class="fas fa-lightbulb"></i>
                        Rapports opportunités
                    </a>
                    <a href="reports.html?type=rh" class="sidebar-nav-link">
                        <i class="fas fa-users"></i>
                        Rapports RH
                    </a>
                </div>

                <!-- Section Gestion des Temps -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">
                        <i class="fas fa-clock"></i>
                        GESTION DES TEMPS
                    </div>
                    <a href="time-sheet-modern.html" class="sidebar-nav-link">
                        <i class="fas fa-calendar-alt"></i>
                        Saisie des temps
                    </a>
                    <a href="time-sheet-approvals.html" class="sidebar-nav-link">
                        <i class="fas fa-check-circle"></i>
                        Validation des temps
                    </a>
                </div>

                <!-- Section Gestion Mission -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">
                        <i class="fas fa-briefcase"></i>
                        GESTION MISSION
                    </div>
                    <a href="missions.html" class="sidebar-nav-link">
                        <i class="fas fa-tasks"></i>
                        Missions
                    </a>
                    <a href="mission-types.html" class="sidebar-nav-link">
                        <i class="fas fa-tag"></i>
                        Types de mission
                    </a>
                    <a href="task-templates.html" class="sidebar-nav-link">
                        <i class="fas fa-clipboard-list"></i>
                        Tâches
                    </a>
                    <a href="invoices.html" class="sidebar-nav-link">
                        <i class="fas fa-file-invoice"></i>
                        Factures et paiements
                    </a>
                    <a href="reports.html?type=missions" class="sidebar-nav-link">
                        <i class="fas fa-chart-line"></i>
                        Rapports mission
                    </a>
                </div>

                <!-- Section Market Pipeline -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">
                        <i class="fas fa-funnel-dollar"></i>
                        MARKET PIPELINE
                    </div>
                    <a href="clients.html" class="sidebar-nav-link">
                        <i class="fas fa-users"></i>
                        Clients et prospects
                    </a>
                    <a href="opportunities.html" class="sidebar-nav-link">
                        <i class="fas fa-lightbulb"></i>
                        Opportunités
                    </a>
                    <a href="opportunity-types.html" class="sidebar-nav-link">
                        <i class="fas fa-tags"></i>
                        Types d'opportunité
                    </a>
                    <a href="reports.html?type=opportunities" class="sidebar-nav-link">
                        <i class="fas fa-chart-line"></i>
                        Rapports opportunité
                    </a>
                </div>

                <!-- Section Gestion RH -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">
                        <i class="fas fa-users-cog"></i>
                        GESTION RH
                    </div>
                    <a href="collaborateurs.html" class="sidebar-nav-link">
                        <i class="fas fa-user-tie"></i>
                        Collaborateurs
                    </a>
                    <a href="collaborateurs.html?view=supervisors" class="sidebar-nav-link">
                        <i class="fas fa-user-shield"></i>
                        Superviseurs
                    </a>
                    <a href="grades.html" class="sidebar-nav-link">
                        <i class="fas fa-star"></i>
                        Grades
                    </a>
                    <a href="postes.html" class="sidebar-nav-link">
                        <i class="fas fa-id-badge"></i>
                        Postes
                    </a>
                </div>

                <!-- Section Configurations -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">
                        <i class="fas fa-cogs"></i>
                        CONFIGURATIONS
                    </div>
                    <a href="fiscal-years.html" class="sidebar-nav-link">
                        <i class="fas fa-calendar"></i>
                        Années fiscales
                    </a>
                    <a href="pays.html" class="sidebar-nav-link">
                        <i class="fas fa-globe"></i>
                        Pays
                    </a>
                </div>

                <!-- Section Business Unit -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">
                        <i class="fas fa-building"></i>
                        BUSINESS UNIT
                    </div>
                    <a href="divisions.html" class="sidebar-nav-link">
                        <i class="fas fa-sitemap"></i>
                        Divisions
                    </a>
                    <a href="business-units.html" class="sidebar-nav-link">
                        <i class="fas fa-building"></i>
                        Unités d'affaires
                    </a>
                    <a href="secteurs-activite.html" class="sidebar-nav-link">
                        <i class="fas fa-industry"></i>
                        Secteurs d'activité
                    </a>
                    <a href="opportunity-type-configuration.html" class="sidebar-nav-link">
                        <i class="fas fa-cog"></i>
                        Configuration types d'opportunité
                    </a>
                </div>

                <!-- Section Paramètres Administration -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">
                        <i class="fas fa-user-cog"></i>
                        PARAMÈTRES ADMINISTRATION
                    </div>
                    <a href="notification-settings.html" class="sidebar-nav-link">
                        <i class="fas fa-bell"></i>
                        Configuration notifications
                    </a>
                    <a href="users.html" class="sidebar-nav-link">
                        <i class="fas fa-users"></i>
                        Utilisateurs
                    </a>
                    <a href="profile.html" class="sidebar-nav-link">
                        <i class="fas fa-user"></i>
                        Profil utilisateur
                    </a>
                </div>
            </nav>

            <!-- Footer de la sidebar -->
            <div class="sidebar-footer">
                <div class="sidebar-user-info">
                    <i class="fas fa-user-circle"></i>
                    <span>Admin User</span>
                    <small style="display: block; opacity: 0.7; margin-top: 2px;">Administrateur</small>
                </div>
            </div>
        `;
    }

    setupEventListeners() {
        // Gestion du toggle mobile
        const toggleBtn = document.querySelector('.sidebar-toggle');
        const sidebar = document.querySelector('.sidebar-container');
        
        if (toggleBtn && sidebar) {
            toggleBtn.addEventListener('click', () => {
                sidebar.classList.toggle('open');
                toggleBtn.classList.toggle('active');
            });
        }

        // Fermer la sidebar en cliquant à l'extérieur (mobile)
        document.addEventListener('click', (e) => {
            if (window.innerWidth <= 768) {
                if (sidebar && !sidebar.contains(e.target) && toggleBtn && !toggleBtn.contains(e.target)) {
                    sidebar.classList.remove('open');
                    if (toggleBtn) toggleBtn.classList.remove('active');
                }
            }
        });

        // Gestion des liens de navigation
        document.addEventListener('click', (e) => {
            if (e.target.closest('.sidebar-nav-link')) {
                const link = e.target.closest('.sidebar-nav-link');
                this.setActiveLink(link);
            }
        });

        // Gestion de l'expansion/réduction des sections
        document.addEventListener('click', (e) => {
            if (e.target.closest('.sidebar-section-title')) {
                const section = e.target.closest('.sidebar-section');
                section.classList.toggle('collapsed');
            }
        });
    }

    setActivePage() {
        const currentPath = window.location.pathname;
        const currentSearch = window.location.search;
        const navLinks = document.querySelectorAll('.sidebar-nav-link');
        
        navLinks.forEach(link => {
            const href = link.getAttribute('href');
            if (href) {
                const [path, search] = href.split('?');
                const currentPage = currentPath.split('/').pop();
                const linkPage = path.split('/').pop();
                
                // Vérifier si c'est la page active
                if (currentPage === linkPage) {
                    // Si il y a des paramètres de recherche, les vérifier aussi
                    if (search && currentSearch) {
                        if (currentSearch.includes(search.split('=')[1])) {
                            this.setActiveLink(link);
                        }
                    } else if (!search && !currentSearch) {
                        this.setActiveLink(link);
                    }
                }
            }
        });
    }

    setActiveLink(activeLink) {
        // Retirer la classe active de tous les liens
        document.querySelectorAll('.sidebar-nav-link').forEach(link => {
            link.classList.remove('active');
        });
        
        // Ajouter la classe active au lien cliqué
        if (activeLink) {
            activeLink.classList.add('active');
            
            // S'assurer que la section parente est visible
            const section = activeLink.closest('.sidebar-section');
            if (section) {
                section.classList.remove('collapsed');
            }
        }
    }

    // Méthode pour mettre à jour les informations utilisateur
    updateUserInfo(username, role) {
        const userInfo = document.querySelector('.sidebar-user-info');
        if (userInfo) {
            userInfo.innerHTML = `
                <i class="fas fa-user-circle"></i>
                <span>${username}</span>
                <small style="display: block; opacity: 0.7; margin-top: 2px;">${role}</small>
            `;
        }
    }

    // Méthode pour ajouter des notifications
    addNotificationBadge(linkSelector, count) {
        const link = document.querySelector(linkSelector);
        if (link && count > 0) {
            let badge = link.querySelector('.badge');
            if (!badge) {
                badge = document.createElement('span');
                badge.className = 'badge';
                link.appendChild(badge);
            }
            badge.textContent = count;
        }
    }

    // Méthode pour ajouter des indicateurs de statut
    addStatusIndicator(linkSelector, status) {
        const link = document.querySelector(linkSelector);
        if (link) {
            let indicator = link.querySelector('.status-indicator');
            if (!indicator) {
                indicator = document.createElement('span');
                indicator.className = 'status-indicator';
                link.appendChild(indicator);
            }
            indicator.className = `status-indicator status-${status}`;
        }
    }
}

// Initialisation automatique
document.addEventListener('DOMContentLoaded', function() {
    window.unifiedSidebar = new UnifiedSidebar();
});

// Exposer la classe globalement
window.UnifiedSidebar = UnifiedSidebar; 