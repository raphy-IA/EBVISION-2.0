<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Opportunites</title>
    
    <!-- CSS Bootstrap et FontAwesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/vendor/fontawesome/css/all.min.css" rel="stylesheet">
    
    <!-- CSS de la sidebar moderne -->
    <link rel="stylesheet" href="css/modern-sidebar.css">
    
    
    <!-- Script d'authentification -->
    <script src="js/auth.js"></script>
    
    <!-- Script de gestion des permissions de menu -->
    <script src="js/menu-permissions.js"></script>
                
                <!-- Scripts de zone utilisateur -->
                <script src="js/user-header.js"></script>
    <script src="js/profile-menu.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/tasks.js"></script>
                <!-- <script src="js/user-modals.js"></script> -->
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #f8f9fa;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            overflow-x: hidden;
        }
        
        .page-wrapper {
            display: flex;
            min-height: 100vh;
        }

        .main-content-area {
            flex-grow: 1;
            padding: 2rem;
            background-color: var(--light-bg);
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .stat-card.success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .stat-card.warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .stat-card.info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
        }
        
        .table thead th {
            background-color: var(--primary-color);
            color: white;
        }

        @media (max-width: 768px) {
            .page-wrapper {
                flex-direction: column;
            }
            
            .main-content-area {
                padding: 1rem;
            }
        }
    </style>

        <script src="js/global-auth.js"></script>
    <!-- Scripts pour la top bar EBVISION 2.0 -->
    
    
    

    <!-- CSS des variables de branding dynamiques -->
    <link rel="stylesheet" href="/config/themes/brand-variables.css">
    
    <!-- Scripts de branding -->
    <script src="js/branding-loader.js"></script>
    <script src="js/sidebar-branding.js"></script>
</head>
<body>
    <!-- Bouton toggle sidebar mobile -->
    <button class="sidebar-toggle d-md-none">
        <i class="fas fa-bars"></i>
    </button>
    <div class="page-wrapper">
        <!-- Sidebar Container -->
        <div class="sidebar-container">
            <!-- La sidebar sera générée par JavaScript -->
        </div>

        <!-- Main Content Area -->
        <div class="main-content-area">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-lightbulb me-2"></i>Gestion des Opportunites</h2>
                <button class="btn btn-primary" onclick="newOpportunity()">
                    <i class="fas fa-plus me-2"></i>Nouvelle Opportunite
                </button>
            </div>
            
            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-3 mb-3">
                    <div class="card stat-card">
                        <div class="card-body text-center">
                            <i class="fas fa-lightbulb fa-2x mb-2"></i>
                            <div class="stat-number" id="total-opportunities">0</div>
                            <div>Total Opportunites</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card stat-card info">
                        <div class="card-body text-center">
                            <i class="fas fa-clock fa-2x mb-2"></i>
                            <div class="stat-number" id="en-cours-opportunities">0</div>
                            <div>En Cours</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card stat-card success">
                        <div class="card-body text-center">
                            <i class="fas fa-trophy fa-2x mb-2"></i>
                            <div class="stat-number" id="gagnees-opportunities">0</div>
                            <div>Gagnees</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card stat-card warning">
                        <div class="card-body text-center">
                            <i class="fas fa-times-circle fa-2x mb-2"></i>
                            <div class="stat-number" id="perdues-opportunities">0</div>
                            <div>Perdues</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Filtres avances -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-filter me-2"></i>
                        Filtres avances
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="filter-status" class="form-label">Statut</label>
                            <select class="form-select" id="filter-status" onchange="applyFilters()">
                                <option value="">Tous les statuts</option>
                                <option value="EN_COURS">En Cours</option>
                                <option value="GAGNEE">Gagnee</option>
                                <option value="PERDUE">Perdue</option>
                                <option value="OPEN">Ouverte</option>
                                <option value="WON">Gagnee</option>
                                <option value="LOST">Perdue</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="filter-business-unit" class="form-label">Business Unit</label>
                            <select class="form-select" id="filter-business-unit" onchange="applyFilters()">
                                <option value="">Toutes les BU</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="filter-collaborateur" class="form-label">Responsable</label>
                            <select class="form-select" id="filter-collaborateur" onchange="applyFilters()">
                                <option value="">Tous les responsables</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="filter-search" class="form-label">Recherche</label>
                            <input type="text" class="form-control" id="filter-search" 
                                   placeholder="Nom, client..." onkeyup="applyFilters()">
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-3 mb-3">
                            <label for="filter-montant-min" class="form-label">Montant min</label>
                            <input type="number" class="form-control" id="filter-montant-min" 
                                   placeholder="0" onchange="applyFilters()">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="filter-montant-max" class="form-label">Montant max</label>
                            <input type="number" class="form-control" id="filter-montant-max" 
                                   placeholder="1000000" onchange="applyFilters()">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="filter-probabilite" class="form-label">Probabilite min</label>
                            <input type="number" class="form-control" id="filter-probabilite" 
                                   placeholder="0" min="0" max="100" onchange="applyFilters()">
                        </div>
                        <div class="col-md-3 mb-3 d-flex align-items-end">
                            <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                                <i class="fas fa-times me-2"></i>Effacer les filtres
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Header avec bouton Actualiser -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list me-2"></i>
                        Liste des Opportunites
                    </h5>
                    <button class="btn btn-outline-primary" onclick="loadOpportunities()">
                        <i class="fas fa-sync-alt me-1"></i>
                        Actualiser
                    </button>
                </div>
                <div class="card-body">
                    <div id="opportunities-loading" class="text-center" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Chargement...</span>
                        </div>
                    </div>
                    <div id="opportunities-content">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Nom</th>
                                        <th>Client</th>
                                        <th>Business Unit</th>
                                        <th>Responsable</th>
                                        <th>Montant</th>
                                        <th>Probabilite</th>
                                        <th>Date Fermeture</th>
                                        <th>Statut</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="opportunities-table">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de visualisation des opportunites -->
    <div class="modal fade" id="viewOpportunityModal" tabindex="-1" aria-labelledby="viewOpportunityModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="viewOpportunityModalLabel">
                        <i class="fas fa-eye me-2"></i>Details de l'Opportunite
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="viewOpportunityModalBody">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Chargement...</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Fermer
                    </button>
                    <button type="button" class="btn btn-warning" id="editOpportunityBtn" onclick="editFromView()">
                        <i class="fas fa-edit me-2"></i>Modifier
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal d'edition des opportunites -->
    <div class="modal fade" id="editOpportunityModal" tabindex="-1" aria-labelledby="editOpportunityModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="editOpportunityModalLabel">
                        <i class="fas fa-edit me-2"></i>Modifier l'Opportunite
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editOpportunityForm">
                        <div class="row">
                            <!-- Informations principales -->
                            <div class="col-md-6">
                                <h6 class="text-primary mb-3">Informations principales</h6>
                                
                                <div class="mb-3">
                                    <label for="edit-nom" class="form-label">Nom de l'opportunite *</label>
                                    <input type="text" class="form-control" id="edit-nom" name="nom" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="edit-client" class="form-label">Client</label>
                                    <select class="form-select" id="edit-client" name="client_id">
                                        <option value="">Selectionner un client</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="edit-business-unit" class="form-label">Business Unit</label>
                                    <select class="form-select" id="edit-business-unit" name="business_unit_id">
                                        <option value="">Selectionner une BU</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="edit-responsable" class="form-label">Responsable</label>
                                    <select class="form-select" id="edit-responsable" name="collaborateur_id">
                                        <option value="">Selectionner un responsable</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Informations financieres -->
                            <div class="col-md-6">
                                <h6 class="text-success mb-3">Informations financieres</h6>
                                
                                <div class="mb-3">
                                    <label for="edit-montant" class="form-label">Montant estime</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="edit-montant" name="montant_estime" step="0.01" min="0">
                                        <select class="form-select" id="edit-devise" name="devise" style="max-width: 100px;">
                                            <option value="XAF">XAF (FCFA)</option>
                                            <option value="EUR">EUR (€)</option>
                                            <option value="USD">USD ($)</option>
                                            <option value="GBP">GBP (£)</option>
                                            <option value="CHF">CHF (CHF)</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="edit-probabilite" class="form-label">Probabilite (%)</label>
                                    <input type="number" class="form-control" id="edit-probabilite" name="probabilite" min="0" max="100">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="edit-date-fermeture" class="form-label">Date fermeture prevue</label>
                                    <input type="date" class="form-control" id="edit-date-fermeture" name="date_fermeture_prevue">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="edit-statut" class="form-label">Statut</label>
                                    <select class="form-select" id="edit-statut" name="statut">
                                        <option value="NOUVELLE">Nouvelle</option>
                                        <option value="EN_COURS">En Cours</option>
                                        <option value="GAGNEE">Gagnée</option>
                                        <option value="PERDUE">Perdue</option>
                                        <option value="ANNULEE">Annulée</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Informations supplementaires -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6 class="text-info mb-3">Informations supplementaires</h6>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="edit-type" class="form-label">Type d'opportunite</label>
                                            <select class="form-select" id="edit-type" name="type_opportunite">
                                                <option value="">Selectionner un type</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="edit-source" class="form-label">Source</label>
                                            <select class="form-select" id="edit-source" name="source">
                                                <option value="">Selectionner une source</option>
                                                <option value="Site Web">Site Web</option>
                                                <option value="Reseaux Sociaux">Reseaux Sociaux</option>
                                                <option value="Recommandation">Recommandation</option>
                                                <option value="Salon/Evenement">Salon/Evenement</option>
                                                <option value="Prospection">Prospection</option>
                                                <option value="Partenariat">Partenariat</option>
                                                <option value="Publicite">Publicite</option>
                                                <option value="Email Marketing">Email Marketing</option>
                                                <option value="Telephone">Telephone</option>
                                                <option value="Autre">Autre</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="edit-description" class="form-label">Description</label>
                                    <textarea class="form-control" id="edit-description" name="description" rows="4"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Messages d'erreur/succes -->
                        <div id="edit-form-messages"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Annuler
                    </button>
                    <button type="button" class="btn btn-warning" onclick="saveOpportunityChanges()">
                        <i class="fas fa-save me-2"></i>Enregistrer
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de suppression -->
    <div class="modal fade" id="deleteOpportunityModal" tabindex="-1" aria-labelledby="deleteOpportunityModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteOpportunityModalLabel">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Confirmer la suppression
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <i class="fas fa-trash-alt fa-3x text-danger mb-3"></i>
                        <h6>Êtes-vous sûr de vouloir supprimer cette opportunité ?</h6>
                        <p class="text-muted" id="delete-opportunity-name"></p>
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Attention :</strong> Cette action est irréversible.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Annuler
                    </button>
                    <button type="button" class="btn btn-danger" onclick="confirmDeleteOpportunity()">
                        <i class="fas fa-trash me-2"></i>Supprimer définitivement
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de création d'opportunité -->
    <div class="modal fade" id="newOpportunityModal" tabindex="-1" aria-labelledby="newOpportunityModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="newOpportunityModalLabel">
                        <i class="fas fa-plus me-2"></i>
                        Nouvelle Opportunité
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="newOpportunityForm">
                        <div class="row">
                            <div class="col-md-8">
                                <!-- Informations de base -->
                                <div class="mb-4">
                                    <h6 class="text-primary mb-3">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Informations de Base
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="new-opportunity-name" class="form-label">
                                                <i class="fas fa-tag me-1"></i>Nom de l'Opportunité *
                                            </label>
                                            <input type="text" class="form-control" id="new-opportunity-name" 
                                                   name="nom" required placeholder="Ex: Développement application mobile">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="new-opportunity-source" class="form-label">
                                                <i class="fas fa-search me-1"></i>Source
                                            </label>
                                            <select class="form-select" id="new-opportunity-source" name="source">
                                                <option value="">Sélectionner une source</option>
                                                <option value="Site Web">Site Web</option>
                                                <option value="Réseaux Sociaux">Réseaux Sociaux</option>
                                                <option value="Recommandation">Recommandation</option>
                                                <option value="Salon/Événement">Salon/Événement</option>
                                                <option value="Prospection">Prospection</option>
                                                <option value="Presse/Journal">Presse/Journal</option>
                                                <option value="Radio/Télé">Radio/Télé</option>
                                                <option value="Contact de proximité">Contact de proximité</option>
                                                <option value="Besoin direct">Besoin direct</option>
                                                <option value="Suivi événement/séminaire">Suivi événement/séminaire</option>
                                                <option value="Réunion business">Réunion business</option>
                                                <option value="Autre">Autre</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- Parties prenantes -->
                                <div class="mb-4">
                                    <h6 class="text-primary mb-3">
                                        <i class="fas fa-users me-2"></i>
                                        Parties Prenantes
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="new-opportunity-client" class="form-label">
                                                <i class="fas fa-building me-1"></i>Client *
                                            </label>
                                            <select class="form-select" id="new-opportunity-client" name="client_id" required>
                                                <option value="">Sélectionner un client</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="new-opportunity-collaborateur" class="form-label">
                                                <i class="fas fa-user-tie me-1"></i>Responsable *
                                            </label>
                                            <select class="form-select" id="new-opportunity-collaborateur" name="collaborateur_id" required>
                                                <option value="">Sélectionner un collaborateur</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- Organisation -->
                                <div class="mb-4">
                                    <h6 class="text-primary mb-3">
                                        <i class="fas fa-sitemap me-2"></i>
                                        Organisation
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="new-opportunity-business-unit" class="form-label">
                                                <i class="fas fa-briefcase me-1"></i>Business Unit *
                                            </label>
                                            <select class="form-select" id="new-opportunity-business-unit" name="business_unit_id" required>
                                                <option value="">Sélectionner une Business Unit</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="new-opportunity-type" class="form-label">
                                                <i class="fas fa-layer-group me-1"></i>Type d'Opportunité *
                                            </label>
                                            <select class="form-select" id="new-opportunity-type" name="type_opportunite" required>
                                                <option value="">Sélectionner un type</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- Informations commerciales -->
                                <div class="mb-4">
                                    <h6 class="text-primary mb-3">
                                        <i class="fas fa-chart-line me-2"></i>
                                        Informations Commerciales
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="new-opportunity-amount" class="form-label">
                                                <i class="fas fa-euro-sign me-1"></i>Montant Estimé
                                            </label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="new-opportunity-amount" 
                                                       name="montant_estime" min="0" step="0.01" placeholder="0.00">
                                                <select class="form-select" id="new-opportunity-currency" name="devise" style="max-width: 100px;">
                                                    <option value="XAF">XAF (FCFA)</option>
                                                    <option value="EUR">EUR (€)</option>
                                                    <option value="USD">USD ($)</option>
                                                    <option value="GBP">GBP (£)</option>
                                                    <option value="CHF">CHF (CHF)</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="new-opportunity-probability" class="form-label">
                                                <i class="fas fa-percentage me-1"></i>Probabilité de Succès
                                            </label>
                                            <div class="input-group">
                                                <input type="range" class="form-range" id="new-opportunity-probability" 
                                                       name="probabilite" min="0" max="100" value="50">
                                                <span class="input-group-text" id="probability-value">50%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Dates -->
                                <div class="mb-4">
                                    <h6 class="text-primary mb-3">
                                        <i class="fas fa-calendar me-2"></i>
                                        Planning
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="new-opportunity-closing-date" class="form-label">
                                                <i class="fas fa-calendar-check me-1"></i>Date de Fermeture Prévue
                                            </label>
                                            <input type="date" class="form-control" id="new-opportunity-closing-date" 
                                                   name="date_fermeture_prevue">
                                        </div>
                                    </div>
                                </div>

                                <!-- Description -->
                                <div class="mb-4">
                                    <h6 class="text-primary mb-3">
                                        <i class="fas fa-align-left me-2"></i>
                                        Description
                                    </h6>
                                    <textarea class="form-control" id="new-opportunity-description" 
                                              name="description" rows="4" 
                                              placeholder="Décrivez l'opportunité, les enjeux, les objectifs..."></textarea>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <!-- Panel d'informations -->
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title text-primary">
                                            <i class="fas fa-lightbulb me-2"></i>
                                            Conseils
                                        </h6>
                                        <div class="mb-3">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="fas fa-check-circle text-success me-2"></i>
                                                <small>Donnez un nom clair et descriptif</small>
                                            </div>
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="fas fa-check-circle text-success me-2"></i>
                                                <small>Sélectionnez le bon responsable</small>
                                            </div>
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="fas fa-check-circle text-success me-2"></i>
                                                <small>Identifiez la source de l'opportunité</small>
                                            </div>
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="fas fa-check-circle text-success me-2"></i>
                                                <small>Estimez le montant et la probabilité</small>
                                            </div>
                                        </div>
                                        
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            <strong>Note :</strong> Les champs marqués d'un * sont obligatoires.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Annuler
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveNewOpportunity()">
                        <i class="fas fa-save me-2"></i>Créer l'Opportunité
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Script d'authentification déjà inclus plus haut -->
    <script src="js/sidebar.js" defer></script>
    <!-- SessionManager pour la gestion centralisée des sessions -->
    <script src="js/session-manager.js"></script>
    <script>
        const API_BASE_URL = '/api';
        let opportunities = [];
        let allOpportunities = []; // Pour stocker toutes les opportunites non filtrees
        let businessUnits = [];
        let collaborateurs = [];
        let clients = [];
        let currentEditOpportunityId = null;

        // Fonction utilitaire pour les appels API authentifiés
        async function authenticatedFetch(url, options = {}) {
            const token = localStorage.getItem('authToken');
            const defaultHeaders = {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
            
            return fetch(url, {
                ...options,
                headers: {
                    ...defaultHeaders,
                    ...options.headers
                }
            });
        }
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Page opportunities.html chargee');
            await loadFilterData(); // Charger d'abord les données de référence
            loadOpportunities(); // Puis charger les opportunités
        });
        
        async function loadFilterData() {
            try {
                console.log('🔄 Chargement des données de référence...');
                
                // Charger les clients
                console.log('📋 Chargement des clients...');
                const clientsResponse = await authenticatedFetch(`${API_BASE_URL}/clients`);
                const clientsData = await clientsResponse.json();
                if (clientsData.success) {
                    clients = clientsData.data.clients;
                    console.log(`✅ ${clients.length} clients chargés`);
                    populateClientFilter();
                }
                
                // Charger les Business Units
                console.log('🏢 Chargement des Business Units...');
                const buResponse = await authenticatedFetch(`${API_BASE_URL}/business-units`);
                const buData = await buResponse.json();
                if (buData.success) {
                    // L'API retourne data directement comme un tableau
                    businessUnits = Array.isArray(buData.data) ? buData.data : buData.data.businessUnits || [];
                    console.log(`✅ ${businessUnits.length} Business Units chargées`);
                    populateBusinessUnitFilter();
                }
                
                // Charger les collaborateurs
                console.log('👥 Chargement des collaborateurs...');
                const collabResponse = await authenticatedFetch(`${API_BASE_URL}/collaborateurs`);
                const collabData = await collabResponse.json();
                if (collabData.success) {
                    // L'API retourne data directement comme un tableau
                    collaborateurs = Array.isArray(collabData.data) ? collabData.data : collabData.data.collaborateurs || [];
                    console.log(`✅ ${collaborateurs.length} collaborateurs chargés`);
                    populateCollaborateurFilter();
                }
                
                // Charger les types d'opportunités
                console.log('📊 Chargement des types d\'opportunités...');
                try {
                    const typesResponse = await authenticatedFetch(`${API_BASE_URL}/opportunity-types`);
                    const typesData = await typesResponse.json();
                    if (typesData.success) {
                        window.opportunityTypes = typesData.data.opportunityTypes;
                        console.log(`✅ ${window.opportunityTypes.length} types d'opportunités chargés`);
                        populateOpportunityTypeFilter();
                    }
                } catch (error) {
                    console.warn('⚠️ Impossible de charger les types d\'opportunités:', error);
                }
                
                console.log('✅ Toutes les données de référence chargées');
            } catch (error) {
                console.error('❌ Erreur lors du chargement des données de filtres:', error);
            }
        }
        
        function populateBusinessUnitFilter() {
            const select = document.getElementById('filter-business-unit');
            const editSelect = document.getElementById('edit-business-unit');
            
            // Vérifier que businessUnits est défini et non vide
            if (!businessUnits || !Array.isArray(businessUnits)) {
                console.warn('⚠️ businessUnits n\'est pas défini ou n\'est pas un tableau');
                return;
            }
            
            // Remplir le select des filtres
            if (select) {
                console.log('🏢 Remplissage du select BU filtres avec', businessUnits.length, 'BU');
                businessUnits.forEach(bu => {
                    const option = document.createElement('option');
                    option.value = bu.id;
                    option.textContent = bu.nom || bu.name || `BU ${bu.id}`;
                    select.appendChild(option);
                });
            }
            
            // Remplir le select du modal d'edition
            if (editSelect) {
                console.log('🏢 Remplissage du select BU edition avec', businessUnits.length, 'BU');
                editSelect.innerHTML = '<option value="">Selectionner une BU</option>';
                businessUnits.forEach(bu => {
                    const option = document.createElement('option');
                    option.value = bu.id;
                    option.textContent = bu.nom || bu.name || `BU ${bu.id}`;
                    editSelect.appendChild(option);
                });
                console.log('✅ Select BU edition rempli avec', editSelect.options.length, 'options');
            } else {
                console.warn('⚠️ Element edit-business-unit non trouve');
            }
        }
        
        function populateClientFilter() {
            const editSelect = document.getElementById('edit-client');
            
            // Vérifier que clients est défini et non vide
            if (!clients || !Array.isArray(clients)) {
                console.warn('⚠️ clients n\'est pas défini ou n\'est pas un tableau');
                return;
            }
            
            if (editSelect) {
                console.log('📋 Remplissage du select client avec', clients.length, 'clients');
                editSelect.innerHTML = '<option value="">Selectionner un client</option>';
                clients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = client.nom || client.raison_sociale || `Client ${client.id}`;
                    editSelect.appendChild(option);
                });
                console.log('✅ Select client rempli avec', editSelect.options.length, 'options');
            } else {
                console.warn('⚠️ Element edit-client non trouve');
            }
        }
        
        function populateCollaborateurFilter() {
            const select = document.getElementById('filter-collaborateur');
            const editSelect = document.getElementById('edit-responsable');
            
            // Vérifier que collaborateurs est défini et non vide
            if (!collaborateurs || !Array.isArray(collaborateurs)) {
                console.warn('⚠️ collaborateurs n\'est pas défini ou n\'est pas un tableau');
                return;
            }
            
            // Remplir le select des filtres
            if (select) {
                console.log('👥 Remplissage du select collaborateur filtres avec', collaborateurs.length, 'collaborateurs');
                collaborateurs.forEach(collab => {
                    const option = document.createElement('option');
                    option.value = collab.id;
                    option.textContent = `${collab.nom || ''} ${collab.prenom || ''}`.trim() || `Collaborateur ${collab.id}`;
                    select.appendChild(option);
                });
            }
            
            // Remplir le select du modal d'edition
            if (editSelect) {
                console.log('👥 Remplissage du select collaborateur edition avec', collaborateurs.length, 'collaborateurs');
                editSelect.innerHTML = '<option value="">Selectionner un responsable</option>';
                collaborateurs.forEach(collab => {
                    const option = document.createElement('option');
                    option.value = collab.id;
                    option.textContent = `${collab.nom || ''} ${collab.prenom || ''}`.trim() || `Collaborateur ${collab.id}`;
                    editSelect.appendChild(option);
                });
                console.log('✅ Select collaborateur edition rempli avec', editSelect.options.length, 'options');
            } else {
                console.warn('⚠️ Element edit-responsable non trouve');
            }
        }
        
        async function loadOpportunities() {
            showLoading(true);
            try {
                console.log('Chargement des opportunites...');
                const response = await authenticatedFetch(`${API_BASE_URL}/opportunities`);
                const data = await response.json();
                
                console.log('Reponse API:', data);
                
                if (data.success) {
                    allOpportunities = data.data.opportunities; // Stocker toutes les opportunites
                    opportunities = allOpportunities; // Initialiser avec toutes les opportunites
                    displayOpportunities();
                } else {
                    console.error('Erreur API:', data.error || data.message);
                    showError('Erreur lors du chargement des opportunites');
                }
            } catch (error) {
                console.error('Erreur de connexion:', error);
                showError('Erreur de connexion');
            } finally {
                showLoading(false);
            }
        }
        
        function displayOpportunities() {
            const tbody = document.getElementById('opportunities-table');
            tbody.innerHTML = '';
            
            if (opportunities.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center">Aucune opportunite trouvee</td></tr>';
                updateStatistics();
                return;
            }
            
            opportunities.forEach(opp => {
                const row = document.createElement('tr');
                
                const montant = opp.montant_estime ? formatCurrency(opp.montant_estime, opp.devise || "EUR") : '-';
                const probabilite = opp.probabilite ? `${opp.probabilite}%` : '-';
                const responsable = opp.collaborateur_nom ? `${opp.collaborateur_nom} ${opp.collaborateur_prenom}` : '-';
                const dateFermeture = opp.date_fermeture_prevue ? new Date(opp.date_fermeture_prevue).toLocaleDateString('fr-FR') : '-';
                const statusClass = getStatusClass(opp.statut);
                const statusLabel = getStatusLabel(opp.statut);
                
                row.innerHTML = `
                    <td><strong>${opp.nom}</strong></td>
                    <td>${opp.client_nom || '-'}</td>
                    <td>${opp.business_unit_nom || '-'}</td>
                    <td>${responsable}</td>
                    <td>${montant}</td>
                    <td>${probabilite}</td>
                    <td>${dateFermeture}</td>
                    <td><span class="badge ${statusClass}">${statusLabel}</span></td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-info" onclick="viewOpportunity('${opp.id}')" title="Voir">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-secondary" onclick="goToStages('${opp.id}')" title="Gérer les étapes">
                                <i class="fas fa-list-check"></i>
                            </button>
                            <button class="btn btn-outline-primary" onclick="showCompleteHistory('${opp.id}')" title="Suivi détaillé">
                                <i class="fas fa-history"></i>
                            </button>
                            <button class="btn btn-outline-warning" onclick="editOpportunity('${opp.id}')" title="Modifier">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteOpportunity('${opp.id}')" title="Supprimer">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            updateStatistics();
            console.log('Opportunites affichees');
        }
        
        function updateStatistics() {
            const total = opportunities.length;
            const enCours = opportunities.filter(opp => 
                opp.statut === 'EN_COURS' || opp.statut === 'OPEN'
            ).length;
            const gagnees = opportunities.filter(opp => 
                opp.statut === 'GAGNEE' || opp.statut === 'WON'
            ).length;
            const perdues = opportunities.filter(opp => 
                opp.statut === 'PERDUE' || opp.statut === 'LOST'
            ).length;
            
            document.getElementById('total-opportunities').textContent = total;
            document.getElementById('en-cours-opportunities').textContent = enCours;
            document.getElementById('gagnees-opportunities').textContent = gagnees;
            document.getElementById('perdues-opportunities').textContent = perdues;
            
            console.log('Statistiques mises a jour:', { total, enCours, gagnees, perdues });
        }
        
        function applyFilters() {
            const statusFilter = document.getElementById('filter-status').value;
            const buFilter = document.getElementById('filter-business-unit').value;
            const collabFilter = document.getElementById('filter-collaborateur').value;
            const searchFilter = document.getElementById('filter-search').value.toLowerCase();
            const montantMin = parseFloat(document.getElementById('filter-montant-min').value) || 0;
            const montantMax = parseFloat(document.getElementById('filter-montant-max').value) || Infinity;
            const probabiliteMin = parseFloat(document.getElementById('filter-probabilite').value) || 0;
            
            opportunities = allOpportunities.filter(opp => {
                // Filtre par statut
                if (statusFilter && opp.statut !== statusFilter) return false;
                
                // Filtre par Business Unit
                if (buFilter && opp.business_unit_id != buFilter) return false;
                
                // Filtre par collaborateur
                if (collabFilter && opp.collaborateur_id != collabFilter) return false;
                
                // Filtre par recherche (nom, client)
                if (searchFilter) {
                    const searchText = `${opp.nom} ${opp.client_nom || ''}`.toLowerCase();
                    if (!searchText.includes(searchFilter)) return false;
                }
                
                // Filtre par montant
                if (opp.montant_estime) {
                    const montant = parseFloat(opp.montant_estime);
                    if (montant < montantMin || montant > montantMax) return false;
                }
                
                // Filtre par probabilite
                if (opp.probabilite) {
                    const probabilite = parseFloat(opp.probabilite);
                    if (probabilite < probabiliteMin) return false;
                }
                
                return true;
            });
            
            displayOpportunities();
            console.log('Filtres appliques:', opportunities.length, 'opportunites affichees');
        }
        
        function clearFilters() {
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-business-unit').value = '';
            document.getElementById('filter-collaborateur').value = '';
            document.getElementById('filter-search').value = '';
            document.getElementById('filter-montant-min').value = '';
            document.getElementById('filter-montant-max').value = '';
            document.getElementById('filter-probabilite').value = '';
            
            opportunities = allOpportunities;
            displayOpportunities();
            console.log('Filtres effaces');
        }
        
        function formatCurrency(value, currency = 'EUR') {
            try {
                return new Intl.NumberFormat('fr-FR', { 
                    style: 'currency', 
                    currency: currency 
                }).format(value);
            } catch (error) {
                return `${value} ${currency}`;
            }
        }
        
        function getStatusClass(status) {
            const classes = {
                'EN_COURS': 'bg-primary',
                'GAGNEE': 'bg-success',
                'PERDUE': 'bg-danger',
                'OPEN': 'bg-primary',
                'WON': 'bg-success',
                'LOST': 'bg-danger'
            };
            return classes[status] || 'bg-secondary';
        }
        
        function getStatusLabel(status) {
            const labels = {
                'EN_COURS': 'En Cours',
                'GAGNEE': 'Gagnee',
                'PERDUE': 'Perdue',
                'OPEN': 'Ouverte',
                'WON': 'Gagnee',
                'LOST': 'Perdue'
            };
            return labels[status] || status;
        }
        
        function showLoading(show) {
            document.getElementById('opportunities-loading').style.display = show ? 'block' : 'none';
            document.getElementById('opportunities-content').style.display = show ? 'none' : 'block';
        }
        
        function showError(message) {
            const content = document.getElementById('opportunities-content');
            content.style.display = 'block';
            content.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${message}
                </div>
            `;
        }
        
        function goToStages(id) {
            window.location.href = `/opportunity-stages.html?opportunity_id=${id}`;
        }

        function showCompleteHistory(id) {
            window.location.href = `/opportunity-stages.html?opportunity_id=${id}&show_history=true`;
        }

        // Fonctions CRUD (a enrichir progressivement)
        async function newOpportunity() {
            console.log('➕ Ouverture du modal nouvelle opportunité');
            
            // Réinitialiser le formulaire
            document.getElementById('newOpportunityForm').reset();
            
            // Charger les données de référence si pas encore fait
            await ensureNewOpportunityDataLoaded();
            
            // Configurer les événements
            setupNewOpportunityEvents();
            
            // Afficher le modal
            const modal = new bootstrap.Modal(document.getElementById('newOpportunityModal'));
            modal.show();
        }
        
        async function ensureNewOpportunityDataLoaded() {
            console.log('🔍 Vérification des données de référence pour nouvelle opportunité...');
            
            // Charger les clients si pas encore fait
            if (!window.clients) {
                console.log('🏢 Chargement des clients pour nouvelle opportunité...');
                try {
                    const clientsResponse = await authenticatedFetch(`${API_BASE_URL}/clients`);
                    const clientsData = await clientsResponse.json();
                    if (clientsData.success) {
                        window.clients = clientsData.data.clients;
                        console.log(`✅ ${window.clients.length} clients chargés pour nouvelle opportunité`);
                        populateNewOpportunityClientSelect();
                    }
                } catch (error) {
                    console.warn('⚠️ Impossible de charger les clients:', error);
                }
            } else {
                console.log(`✅ ${window.clients.length} clients déjà chargés`);
                populateNewOpportunityClientSelect();
            }
            
            // Charger les business units si pas encore fait
            if (!window.businessUnits) {
                console.log('🏢 Chargement des business units pour nouvelle opportunité...');
                try {
                    const buResponse = await authenticatedFetch(`${API_BASE_URL}/business-units`);
                    const buData = await buResponse.json();
                    if (buData.success) {
                        window.businessUnits = buData.data;
                        console.log(`✅ ${window.businessUnits.length} business units chargées pour nouvelle opportunité`);
                        populateNewOpportunityBusinessUnitSelect();
                    }
                } catch (error) {
                    console.warn('⚠️ Impossible de charger les business units:', error);
                }
            } else {
                console.log(`✅ ${window.businessUnits.length} business units déjà chargées`);
                populateNewOpportunityBusinessUnitSelect();
            }
            
            // Charger les collaborateurs si pas encore fait
            if (!window.collaborateurs) {
                console.log('👥 Chargement des collaborateurs pour nouvelle opportunité...');
                try {
                    const collabResponse = await authenticatedFetch(`${API_BASE_URL}/collaborateurs`);
                    const collabData = await collabResponse.json();
                    if (collabData.success) {
                        window.collaborateurs = collabData.data;
                        console.log(`✅ ${window.collaborateurs.length} collaborateurs chargés pour nouvelle opportunité`);
                        populateNewOpportunityCollaborateurSelect();
                    }
                } catch (error) {
                    console.warn('⚠️ Impossible de charger les collaborateurs:', error);
                }
            } else {
                console.log(`✅ ${window.collaborateurs.length} collaborateurs déjà chargés`);
                populateNewOpportunityCollaborateurSelect();
            }
            
            // Charger les types d'opportunités si pas encore fait
            if (!window.opportunityTypes) {
                console.log('📊 Chargement des types d\'opportunités pour nouvelle opportunité...');
                try {
                    const typesResponse = await authenticatedFetch(`${API_BASE_URL}/opportunity-types`);
                    const typesData = await typesResponse.json();
                    if (typesData.success) {
                        window.opportunityTypes = typesData.data.opportunityTypes;
                        console.log(`✅ ${window.opportunityTypes.length} types d'opportunités chargés pour nouvelle opportunité`);
                        populateNewOpportunityTypeSelect();
                    }
                } catch (error) {
                    console.warn('⚠️ Impossible de charger les types d\'opportunités:', error);
                }
            } else {
                console.log(`✅ ${window.opportunityTypes.length} types d'opportunités déjà chargés`);
                populateNewOpportunityTypeSelect();
            }
            
            console.log('✅ Toutes les données de référence sont prêtes pour nouvelle opportunité');
        }
        
        function populateNewOpportunityClientSelect() {
            const select = document.getElementById('new-opportunity-client');
            if (select && window.clients) {
                console.log('🏢 Remplissage du select client avec', window.clients.length, 'clients');
                select.innerHTML = '<option value="">Sélectionner un client</option>';
                window.clients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = client.nom || client.raison_sociale || `Client ${client.id}`;
                    select.appendChild(option);
                });
                console.log('✅ Select client rempli avec', select.options.length, 'options');
            }
        }
        
        function populateNewOpportunityBusinessUnitSelect() {
            const select = document.getElementById('new-opportunity-business-unit');
            if (select && window.businessUnits) {
                console.log('🏢 Remplissage du select business unit avec', window.businessUnits.length, 'business units');
                select.innerHTML = '<option value="">Sélectionner une Business Unit</option>';
                window.businessUnits.forEach(bu => {
                    const option = document.createElement('option');
                    option.value = bu.id;
                    option.textContent = bu.nom || bu.name || `BU ${bu.id}`;
                    select.appendChild(option);
                });
                console.log('✅ Select business unit rempli avec', select.options.length, 'options');
            }
        }
        
        function populateNewOpportunityCollaborateurSelect() {
            const select = document.getElementById('new-opportunity-collaborateur');
            if (select && window.collaborateurs) {
                console.log('👥 Remplissage du select collaborateur avec', window.collaborateurs.length, 'collaborateurs');
                select.innerHTML = '<option value="">Sélectionner un collaborateur</option>';
                window.collaborateurs.forEach(collab => {
                    const option = document.createElement('option');
                    option.value = collab.id;
                    option.textContent = `${collab.nom || ''} ${collab.prenom || ''}`.trim() || `Collaborateur ${collab.id}`;
                    select.appendChild(option);
                });
                console.log('✅ Select collaborateur rempli avec', select.options.length, 'options');
            }
        }
        
        function populateNewOpportunityTypeSelect() {
            const select = document.getElementById('new-opportunity-type');
            if (select && window.opportunityTypes) {
                console.log('📊 Remplissage du select type avec', window.opportunityTypes.length, 'types');
                select.innerHTML = '<option value="">Sélectionner un type</option>';
                window.opportunityTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type.id;
                    option.textContent = type.nom || type.name || `Type ${type.id}`;
                    select.appendChild(option);
                });
                console.log('✅ Select type rempli avec', select.options.length, 'options');
            }
        }
        
        function setupNewOpportunityEvents() {
            // Événement pour le slider de probabilité
            const probabilitySlider = document.getElementById('new-opportunity-probability');
            const probabilityValue = document.getElementById('probability-value');
            
            if (probabilitySlider && probabilityValue) {
                probabilitySlider.addEventListener('input', function() {
                    probabilityValue.textContent = this.value + '%';
                    console.log('📊 Probabilité mise à jour:', this.value + '%');
                });
            }
        }
        
        async function saveNewOpportunity() {
            console.log('💾 Sauvegarde de la nouvelle opportunité...');
            
            // Récupérer les données du formulaire
            const form = document.getElementById('newOpportunityForm');
            const formData = new FormData(form);
            
            // Validation côté client
            if (!formData.get('nom') || !formData.get('client_id') || !formData.get('collaborateur_id') || 
                !formData.get('business_unit_id') || !formData.get('type_opportunite')) {
                showErrorMessage('Veuillez remplir tous les champs obligatoires');
                return;
            }
            
            // Préparer les données
            const opportunityData = {
                nom: formData.get('nom'),
                client_id: formData.get('client_id'),
                collaborateur_id: formData.get('collaborateur_id'),
                business_unit_id: formData.get('business_unit_id'),
                type_opportunite: formData.get('type_opportunite'),
                source: formData.get('source') || null,
                montant_estime: formData.get('montant_estime') ? parseFloat(formData.get('montant_estime')) : null,
                devise: formData.get('devise') || 'EUR',
                probabilite: formData.get('probabilite') ? parseInt(formData.get('probabilite')) : null,
                date_fermeture_prevue: formData.get('date_fermeture_prevue') || null,
                description: formData.get('description') || null
            };
            
            console.log('📋 Données de l\'opportunité:', opportunityData);
            
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/opportunities`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(opportunityData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('✅ Opportunité créée avec succès:', data.data.opportunity);
                    
                    // Fermer le modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('newOpportunityModal'));
                    modal.hide();
                    
                    // Afficher un message de succès
                    showSuccessMessage('Opportunité créée avec succès');
                    
                    // Recharger la liste des opportunités
                    loadOpportunities();
                    
                    // Réinitialiser le formulaire
                    form.reset();
                } else {
                    console.error('❌ Erreur lors de la création:', data.error);
                    showErrorMessage(data.error || 'Erreur lors de la création de l\'opportunité');
                }
            } catch (error) {
                console.error('❌ Erreur de connexion lors de la création:', error);
                showErrorMessage('Erreur de connexion lors de la création');
            }
        }
        
        async function viewOpportunity(id) {
            console.log('Visualisation de l\'opportunite:', id);
            
            // Afficher le modal avec loading
            const modal = new bootstrap.Modal(document.getElementById('viewOpportunityModal'));
            modal.show();
            
            try {
                // Charger les details de l'opportunite
                const response = await authenticatedFetch(`${API_BASE_URL}/opportunities/${id}`);
                const data = await response.json();
                
                if (data.success) {
                    const opportunity = data.data.opportunity;
                    displayOpportunityDetails(opportunity);
                    
                    // Stocker l'ID pour le bouton Modifier
                    document.getElementById('editOpportunityBtn').setAttribute('data-opportunity-id', id);
                } else {
                    showModalError('Erreur lors du chargement des details');
                }
            } catch (error) {
                console.error('Erreur lors du chargement des details:', error);
                showModalError('Erreur de connexion');
            }
        }
        
        function displayOpportunityDetails(opportunity) {
            const modalBody = document.getElementById('viewOpportunityModalBody');
            
            const montant = opportunity.montant_estime ? formatCurrency(opportunity.montant_estime, opportunity.devise || "EUR") : '-';
            const probabilite = opportunity.probabilite ? `${opportunity.probabilite}%` : '-';
            const responsable = opportunity.collaborateur_nom ? `${opportunity.collaborateur_nom} ${opportunity.collaborateur_prenom}` : '-';
            const dateFermeture = opportunity.date_fermeture_prevue ? new Date(opportunity.date_fermeture_prevue).toLocaleDateString('fr-FR') : '-';
            const dateCreation = opportunity.created_at ? new Date(opportunity.created_at).toLocaleDateString('fr-FR') : '-';
            const statusClass = getStatusClass(opportunity.statut);
            const statusLabel = getStatusLabel(opportunity.statut);
            
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-8">
                        <h4 class="text-primary mb-3">${opportunity.nom}</h4>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Client:</strong> ${opportunity.client_nom || 'Non specifie'}</p>
                                <p><strong>Responsable:</strong> ${responsable}</p>
                                <p><strong>Business Unit:</strong> ${opportunity.business_unit_nom || 'Non specifie'}</p>
                                <p><strong>Type:</strong> ${opportunity.opportunity_type_nom || opportunity.type_opportunite || 'Non specifie'}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Montant estime:</strong> ${montant}</p>
                                <p><strong>Probabilite:</strong> ${probabilite}</p>
                                <p><strong>Date fermeture prevue:</strong> ${dateFermeture}</p>
                                <p><strong>Statut:</strong> <span class="badge ${statusClass}">${statusLabel}</span></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">Informations generales</h6>
                                <p><strong>ID:</strong> ${opportunity.id}</p>
                                <p><strong>Date creation:</strong> ${dateCreation}</p>
                                <p><strong>Devise:</strong> ${opportunity.devise || 'EUR'}</p>
                                <p><strong>Source:</strong> ${opportunity.source || 'Non specifie'}</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                ${opportunity.description ? `
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Description:</h6>
                        <div class="card">
                            <div class="card-body">
                                <p class="mb-0">${opportunity.description}</p>
                            </div>
                        </div>
                    </div>
                </div>
                ` : ''}
                
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Actions rapides:</h6>
                        <div class="btn-group" role="group">
                            <button class="btn btn-outline-primary" onclick="editOpportunity('${opportunity.id}')">
                                <i class="fas fa-edit me-2"></i>Modifier
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteOpportunity('${opportunity.id}')">
                                <i class="fas fa-trash me-2"></i>Supprimer
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function showModalError(message) {
            const modalBody = document.getElementById('viewOpportunityModalBody');
            modalBody.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${message}
                </div>
            `;
        }
        
        function editFromView() {
            const opportunityId = document.getElementById('editOpportunityBtn').getAttribute('data-opportunity-id');
            if (opportunityId) {
                // Fermer le modal de visualisation
                const modal = bootstrap.Modal.getInstance(document.getElementById('viewOpportunityModal'));
                modal.hide();
                
                // Ouvrir le modal d'edition
                editOpportunity(opportunityId);
            }
        }
        
        async function editOpportunity(id) {
            console.log('🔄 Édition de l\'opportunité:', id);
            currentEditOpportunityId = id;
            
            try {
                // S'assurer que les donnees de reference sont chargees AVANT d'ouvrir le modal
                console.log('📋 Chargement des données de référence...');
                await ensureEditDataLoaded();
                
                // Charger les details de l'opportunite
                console.log('📊 Chargement des détails de l\'opportunité...');
                const response = await authenticatedFetch(`${API_BASE_URL}/opportunities/${id}`);
                const data = await response.json();
                
                if (data.success) {
                    const opportunity = data.data.opportunity;
                    console.log('✅ Détails de l\'opportunité chargés:', opportunity);
                    
                    // Afficher le modal d'edition APRÈS avoir chargé les données
                    const modal = new bootstrap.Modal(document.getElementById('editOpportunityModal'));
                    modal.show();
                    console.log('✅ Modal d\'édition affiché');
                    
                    // Remplir le formulaire après un court délai pour s'assurer que le modal est visible
                    setTimeout(() => {
                        console.log('⏰ Début du remplissage du formulaire...');
                        populateEditForm(opportunity);
                    }, 200);
                } else {
                    console.error('❌ Erreur lors du chargement des détails:', data.error);
                    showEditFormError('Erreur lors du chargement des details');
                }
            } catch (error) {
                console.error('❌ Erreur lors du chargement des details:', error);
                showEditFormError('Erreur de connexion');
            }
        }
        
        async function ensureEditDataLoaded() {
            console.log('🔍 Vérification des données de référence pour édition...');
            
            // Charger les clients si pas encore fait
            if (!clients || clients.length === 0) {
                console.log('📋 Chargement des clients pour édition...');
                const clientsResponse = await authenticatedFetch(`${API_BASE_URL}/clients`);
                const clientsData = await clientsResponse.json();
                if (clientsData.success) {
                    clients = clientsData.data.clients;
                    console.log(`✅ ${clients.length} clients chargés pour édition`);
                    populateClientFilter();
                }
            } else {
                console.log(`✅ ${clients.length} clients déjà chargés`);
            }
            
            // Charger les Business Units si pas encore fait
            if (!businessUnits || businessUnits.length === 0) {
                console.log('🏢 Chargement des Business Units pour édition...');
                const buResponse = await authenticatedFetch(`${API_BASE_URL}/business-units`);
                const buData = await buResponse.json();
                if (buData.success) {
                    // L'API retourne data directement comme un tableau
                    businessUnits = Array.isArray(buData.data) ? buData.data : buData.data.businessUnits || [];
                    console.log(`✅ ${businessUnits.length} Business Units chargées pour édition`);
                    populateBusinessUnitFilter();
                }
            } else {
                console.log(`✅ ${businessUnits.length} Business Units déjà chargées`);
            }
            
            // Charger les collaborateurs si pas encore fait
            if (!collaborateurs || collaborateurs.length === 0) {
                console.log('👥 Chargement des collaborateurs pour édition...');
                const collabResponse = await authenticatedFetch(`${API_BASE_URL}/collaborateurs`);
                const collabData = await collabResponse.json();
                if (collabData.success) {
                    // L'API retourne data directement comme un tableau
                    collaborateurs = Array.isArray(collabData.data) ? collabData.data : collabData.data.collaborateurs || [];
                    console.log(`✅ ${collaborateurs.length} collaborateurs chargés pour édition`);
                    populateCollaborateurFilter();
                }
            } else {
                console.log(`✅ ${collaborateurs.length} collaborateurs déjà chargés`);
            }
            
            // Charger les types d'opportunites si pas encore fait
            if (!window.opportunityTypes) {
                console.log('📊 Chargement des types d\'opportunites pour édition...');
                try {
                    const typesResponse = await authenticatedFetch(`${API_BASE_URL}/opportunity-types`);
                    const typesData = await typesResponse.json();
                    if (typesData.success) {
                        window.opportunityTypes = typesData.data.opportunityTypes;
                        console.log(`✅ ${window.opportunityTypes.length} types d'opportunités chargés pour édition`);
                        populateOpportunityTypeFilter();
                    }
                } catch (error) {
                    console.warn('⚠️ Impossible de charger les types d\'opportunites:', error);
                }
            } else {
                console.log(`✅ ${window.opportunityTypes.length} types d'opportunités déjà chargés`);
            }
            
            console.log('✅ Toutes les données de référence sont prêtes pour édition');
        }
        
        function populateOpportunityTypeFilter() {
            const editSelect = document.getElementById('edit-type');
            
            if (editSelect && window.opportunityTypes) {
                console.log('📊 Remplissage du select type avec', window.opportunityTypes.length, 'types');
                editSelect.innerHTML = '<option value="">Selectionner un type</option>';
                window.opportunityTypes.forEach(type => {
                    const option = document.createElement('option');
                    // Utiliser l'ID comme valeur pour correspondre à la base de données
                    option.value = type.id;
                    option.textContent = type.nom || type.name || `Type ${type.id}`;
                    editSelect.appendChild(option);
                });
                console.log('✅ Select type rempli avec', editSelect.options.length, 'options');
            } else {
                console.warn('⚠️ Element edit-type non trouve ou types non charges');
            }
        }
        
        function populateEditForm(opportunity) {
            console.log('🔄 Remplissage du formulaire avec:', opportunity);
            
            // Attendre que les selects soient remplis avant de definir les valeurs
            setTimeout(() => {
                console.log('⏰ Début du remplissage des champs...');
                
                // Remplir le formulaire avec les donnees de l'opportunite
                const nomField = document.getElementById('edit-nom');
                const clientField = document.getElementById('edit-client');
                const buField = document.getElementById('edit-business-unit');
                const responsableField = document.getElementById('edit-responsable');
                const montantField = document.getElementById('edit-montant');
                const deviseField = document.getElementById('edit-devise');
                const probabiliteField = document.getElementById('edit-probabilite');
                const dateField = document.getElementById('edit-date-fermeture');
                const statutField = document.getElementById('edit-statut');
                const typeField = document.getElementById('edit-type');
                const sourceField = document.getElementById('edit-source');
                const descriptionField = document.getElementById('edit-description');
                
                // Vérifier que tous les champs existent
                if (!nomField || !clientField || !buField || !responsableField || !montantField || 
                    !deviseField || !probabiliteField || !dateField || !statutField || 
                    !typeField || !sourceField || !descriptionField) {
                    console.error('❌ Un ou plusieurs champs du formulaire sont manquants');
                    return;
                }
                
                // Remplir les champs
                nomField.value = opportunity.nom || '';
                clientField.value = opportunity.client_id || '';
                buField.value = opportunity.business_unit_id || '';
                responsableField.value = opportunity.collaborateur_id || '';
                montantField.value = opportunity.montant_estime || '';
                deviseField.value = opportunity.devise || 'EUR';
                probabiliteField.value = opportunity.probabilite || '';
                dateField.value = opportunity.date_fermeture_prevue ? opportunity.date_fermeture_prevue.split('T')[0] : '';
                statutField.value = opportunity.statut || 'EN_COURS';
                
                // Gérer le type d'opportunité (utiliser le nouveau champ opportunity_type_id)
                if (opportunity.opportunity_type_id) {
                    typeField.value = opportunity.opportunity_type_id;
                } else if (opportunity.type_opportunite) {
                    // Fallback vers l'ancien champ si le nouveau n'existe pas
                    const isUuid = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(opportunity.type_opportunite);
                    if (isUuid) {
                        typeField.value = opportunity.type_opportunite;
                    } else {
                        // Si c'est un nom, chercher l'ID correspondant
                        const typeOption = Array.from(typeField.options).find(option => 
                            option.textContent === opportunity.type_opportunite
                        );
                        if (typeOption) {
                            typeField.value = typeOption.value;
                        } else {
                            typeField.value = opportunity.type_opportunite;
                        }
                    }
                } else {
                    typeField.value = '';
                }
                
                sourceField.value = opportunity.source || '';
                descriptionField.value = opportunity.description || '';
                
                // Debug: afficher les valeurs pour verification
                console.log('📋 Valeurs remplies:');
                console.log('- Nom:', opportunity.nom, '->', nomField.value);
                console.log('- Client ID:', opportunity.client_id, '->', clientField.value);
                console.log('- BU ID:', opportunity.business_unit_id, '->', buField.value);
                console.log('- Collaborateur ID:', opportunity.collaborateur_id, '->', responsableField.value);
                console.log('- Montant:', opportunity.montant_estime, '->', montantField.value);
                console.log('- Devise:', opportunity.devise, '->', deviseField.value);
                console.log('- Probabilite:', opportunity.probabilite, '->', probabiliteField.value);
                console.log('- Date fermeture:', opportunity.date_fermeture_prevue, '->', dateField.value);
                console.log('- Statut:', opportunity.statut, '->', statutField.value);
                console.log('- Type (ancien):', opportunity.type_opportunite, '->', typeField.value);
                console.log('- Type (nouveau):', opportunity.opportunity_type_id, '->', typeField.value);
                console.log('- Source:', opportunity.source, '->', sourceField.value);
                console.log('- Description:', opportunity.description, '->', descriptionField.value);
                
                // Verification des selects
                console.log('🔍 Verification des selects:');
                console.log('- Client select options:', clientField.options.length);
                console.log('- BU select options:', buField.options.length);
                console.log('- Collaborateur select options:', responsableField.options.length);
                console.log('- Type select options:', typeField.options.length);
                console.log('- Source select options:', sourceField.options.length);
                
                // Vérifier si les valeurs sont bien sélectionnées
                console.log('✅ Vérification des sélections:');
                console.log('- Client sélectionné:', clientField.value, '->', clientField.options[clientField.selectedIndex]?.text);
                console.log('- BU sélectionnée:', buField.value, '->', buField.options[buField.selectedIndex]?.text);
                console.log('- Collaborateur sélectionné:', responsableField.value, '->', responsableField.options[responsableField.selectedIndex]?.text);
                console.log('- Type sélectionné:', typeField.value, '->', typeField.options[typeField.selectedIndex]?.text);
                console.log('- Source sélectionnée:', sourceField.value, '->', sourceField.options[sourceField.selectedIndex]?.text);
                
                // Effacer les messages d'erreur
                clearEditFormMessages();
                
                console.log('✅ Formulaire rempli avec succès');
            }, 300); // Délai plus long pour s'assurer que les selects sont remplis
        }
        
        async function saveOpportunityChanges() {
            if (!currentEditOpportunityId) {
                showEditFormError('ID de l\'opportunite manquant');
                return;
            }
            
            // Recuperer les donnees du formulaire
            const formData = new FormData(document.getElementById('editOpportunityForm'));
            const opportunityData = {
                nom: formData.get('nom'),
                client_id: formData.get('client_id') || null,
                business_unit_id: formData.get('business_unit_id') || null,
                collaborateur_id: formData.get('collaborateur_id') || null,
                montant_estime: formData.get('montant_estime') ? parseFloat(formData.get('montant_estime')) : null,
                devise: formData.get('devise'),
                probabilite: formData.get('probabilite') ? parseInt(formData.get('probabilite')) : null,
                date_fermeture_prevue: formData.get('date_fermeture_prevue') || null,
                statut: formData.get('statut'),
                type_opportunite: formData.get('type_opportunite') || null,
                source: formData.get('source'),
                description: formData.get('description')
            };
            
            try {
                // Envoyer les modifications
                const response = await authenticatedFetch(`${API_BASE_URL}/opportunities/${currentEditOpportunityId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(opportunityData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showEditFormSuccess('Opportunite modifiee avec succes');
                    
                    // Fermer le modal apres un delai
                    setTimeout(() => {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('editOpportunityModal'));
                        modal.hide();
                        
                        // Recharger les opportunites
                        loadOpportunities();
                    }, 1500);
                } else {
                    showEditFormError(data.error || 'Erreur lors de la modification');
                }
            } catch (error) {
                console.error('Erreur lors de la sauvegarde:', error);
                showEditFormError('Erreur de connexion');
            }
        }
        
        function showEditFormError(message) {
            const messagesDiv = document.getElementById('edit-form-messages');
            messagesDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${message}
                </div>
            `;
        }
        
        function showEditFormSuccess(message) {
            const messagesDiv = document.getElementById('edit-form-messages');
            messagesDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    ${message}
                </div>
            `;
        }
        
        function clearEditFormMessages() {
            const messagesDiv = document.getElementById('edit-form-messages');
            messagesDiv.innerHTML = '';
        }
        
        let currentDeleteOpportunityId = null;
        let currentDeleteOpportunityName = null;
        
        function deleteOpportunity(id) {
            console.log('🗑️ Demande de suppression de l\'opportunité:', id);
            
            // Trouver l'opportunité dans la liste
            const opportunity = opportunities.find(opp => opp.id === id);
            if (!opportunity) {
                console.error('❌ Opportunité non trouvée:', id);
                alert('Erreur: Opportunité non trouvée');
                return;
            }
            
            // Stocker les informations pour la confirmation
            currentDeleteOpportunityId = id;
            currentDeleteOpportunityName = opportunity.nom || 'Opportunité sans nom';
            
            // Afficher le nom de l'opportunité dans le modal
            const nameElement = document.getElementById('delete-opportunity-name');
            if (nameElement) {
                nameElement.textContent = `"${currentDeleteOpportunityName}"`;
            }
            
            // Afficher le modal de confirmation
            const modal = new bootstrap.Modal(document.getElementById('deleteOpportunityModal'));
            modal.show();
        }
        
        async function confirmDeleteOpportunity() {
            if (!currentDeleteOpportunityId) {
                console.error('❌ ID d\'opportunité manquant pour la suppression');
                return;
            }
            
            console.log('🗑️ Confirmation de suppression pour l\'opportunité:', currentDeleteOpportunityId);
            
            try {
                // Appel API pour supprimer l'opportunité
                const response = await authenticatedFetch(`${API_BASE_URL}/opportunities/${currentDeleteOpportunityId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('✅ Opportunité supprimée avec succès');
                    
                    // Fermer le modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('deleteOpportunityModal'));
                    modal.hide();
                    
                    // Afficher un message de succès
                    showSuccessMessage('Opportunité supprimée avec succès');
                    
                    // Recharger la liste des opportunités
                    loadOpportunities();
                    
                    // Réinitialiser les variables
                    currentDeleteOpportunityId = null;
                    currentDeleteOpportunityName = null;
                } else {
                    console.error('❌ Erreur lors de la suppression:', data.error);
                    showErrorMessage(data.error || 'Erreur lors de la suppression');
                }
            } catch (error) {
                console.error('❌ Erreur de connexion lors de la suppression:', error);
                showErrorMessage('Erreur de connexion lors de la suppression');
            }
        }
        
        function showSuccessMessage(message) {
            // Créer un toast ou une alerte Bootstrap
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            // Supprimer automatiquement après 3 secondes
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 3000);
        }
        
        function showErrorMessage(message) {
            // Créer un toast ou une alerte Bootstrap
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed';
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            // Supprimer automatiquement après 5 secondes
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }

    </script>
    </body>
</html>
