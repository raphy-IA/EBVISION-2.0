<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Types de Mission - TRS Affichage</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="css/modern-sidebar.css" rel="stylesheet">
    <link href="css/user-header.css" rel="stylesheet">
    
    <!-- Script d'authentification -->
    <script src="js/auth.js"></script>
    <script src="js/global-auth.js"></script>
    <script src="js/user-header-utils.js"></script>
    <script src="js/user-header-main.js"></script>
    <script src="js/user-header-init.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #f8f9fa;
            --dark-bg: #343a40;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            margin: 0;
            padding: 0;
        }
        
        .main-content-area {
            flex-grow: 1;
            padding: 2rem;
            background-color: var(--light-bg);
        }
        
        .page-wrapper {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar-container {
            width: 300px;
            flex-shrink: 0;
        }
        
        .badge-status {
            font-size: 0.8em;
        }
        
        .badge-priority {
            font-size: 0.75em;
            font-weight: 600;
        }
        
        .badge-priority.critique {
            background-color: #dc3545;
            color: white;
        }
        
        .badge-priority.haute {
            background-color: #fd7e14;
            color: white;
        }
        
        .badge-priority.moyenne {
            background-color: #ffc107;
            color: #212529;
        }
        
        .badge-priority.basse {
            background-color: #28a745;
            color: white;
        }
        /* Amélioration de l'entête et positionnement du bouton Nouveau Type */
        .header { margin-bottom: 1.25rem; }
        .header .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }
        .header .header-actions { display: flex; align-items: center; }
        .header .header-actions .btn { white-space: nowrap; }

        .table-responsive {
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .card-stats {
            transition: transform 0.2s;
        }
        .card-stats:hover {
            transform: translateY(-2px);
        }
        .btn-action {
            margin: 0 2px;
        }
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .form-label {
            font-weight: 600;
            color: #495057;
        }
        .alert {
            border-radius: 8px;
            border: none;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
        }
        
        .page-header h1 {
            margin: 0;
            font-weight: 700;
        }
        
        .page-header p {
            margin: 0.5rem 0 0 0;
            opacity: 0.9;
        }
        
        .badge-priority {
            font-size: 0.75em;
            padding: 0.35em 0.65em;
        }

        .badge-priority.critique {
            background-color: #e74c3c;
        }

        .badge-priority.haute {
            background-color: #f39c12;
        }

        .badge-priority.moyenne {
            background-color: #17a2b8;
        }

        .badge-priority.basse {
            background-color: #27ae60;
        }
        
        @media (max-width: 768px) {
            .page-wrapper {
                flex-direction: column;
            }
            .sidebar-container {
                width: 100%;
                height: auto;
            }
            .main-content-area {
                padding: 1rem;
            }
            .header .header-content { flex-direction: column; align-items: stretch; }
            .header .header-actions { width: 100%; }
            .header .header-actions .btn { width: 100%; }
        }
    </style>
</head>
<body>
    <button class="sidebar-toggle d-md-none"><i class="fas fa-bars"></i></button>
    <div class="page-wrapper">
        <!-- Sidebar Container -->
        <div class="sidebar-container">
            <!-- La sidebar sera générée par JavaScript -->
        </div>

        <!-- Main Content Area -->
        <div class="main-content-area">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <h1><i class="fas fa-tag"></i> Types de Mission</h1>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="openCreateModal()">
                        <i class="fas fa-plus"></i> Nouveau Type
                    </button>
                </div>
            </div>
        </header>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card card-stats bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Total Types</h6>
                                <h3 id="totalTypes">-</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-tags fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-stats bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Types Actifs</h6>
                                <h3 id="activeTypes">-</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-check-circle fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-stats bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Avec Division</h6>
                                <h3 id="withDivision">-</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-sitemap fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-stats bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Sans Division</h6>
                                <h3 id="withoutDivision">-</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-exclamation-triangle fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label for="filterDivision" class="form-label">Division</label>
                        <select class="form-select" id="filterDivision">
                            <option value="">Toutes les divisions</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="filterStatus" class="form-label">Statut</label>
                        <select class="form-select" id="filterStatus">
                            <option value="">Tous les statuts</option>
                            <option value="true">Actif</option>
                            <option value="false">Inactif</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="searchInput" class="form-label">Recherche</label>
                        <input type="text" class="form-control" id="searchInput" placeholder="Rechercher par codification ou libellé...">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                            <i class="fas fa-times"></i> Effacer
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alert Messages -->
        <div id="alertContainer"></div>

        <!-- Data Table -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list"></i> Liste des Types de Mission
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="missionTypesTable">
                        <thead class="table-dark">
                            <tr>
                                <th>Codification</th>
                                <th>Libellé</th>
                                <th>Description</th>
                                <th>Division</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="missionTypesTableBody">
                            <tr>
                                <td colspan="6" class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Chargement...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
        </div>
    </div>

    <!-- Create Modal -->
    <div class="modal fade" id="createModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-plus"></i> Nouveau Type de Mission</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="createCodification" class="form-label">Codification *</label>
                                    <input type="text" class="form-control" id="createCodification" required maxlength="20">
                                    <div class="form-text">Code unique (ex: AUDIT, CONSEIL)</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="createLibelle" class="form-label">Libellé *</label>
                                    <input type="text" class="form-control" id="createLibelle" required maxlength="200">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="createDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="createDescription" rows="3" maxlength="500"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="createDivision" class="form-label">Division</label>
                            <select class="form-select" id="createDivision">
                                <option value="">Sélectionner une division</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="createMissionType()">
                        <i class="fas fa-save"></i> Créer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-edit"></i> Modifier le Type de Mission</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <input type="hidden" id="editId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editCodification" class="form-label">Codification *</label>
                                    <input type="text" class="form-control" id="editCodification" required maxlength="20">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editLibelle" class="form-label">Libellé *</label>
                                    <input type="text" class="form-control" id="editLibelle" required maxlength="200">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="editDescription" rows="3" maxlength="500"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editDivision" class="form-label">Division</label>
                            <select class="form-select" id="editDivision">
                                <option value="">Sélectionner une division</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editActif" checked>
                                <label class="form-check-label" for="editActif">
                                    Type actif
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="updateMissionType()">
                        <i class="fas fa-save"></i> Mettre à jour
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-trash"></i> Confirmer la suppression</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Êtes-vous sûr de vouloir supprimer le type de mission <strong id="deleteMissionTypeName"></strong> ?</p>
                    <p class="text-muted">Cette action ne peut pas être annulée.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-danger" onclick="deleteMissionType()">
                        <i class="fas fa-trash"></i> Supprimer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tasks Modal -->
    <div class="modal fade" id="tasksModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="tasksModalTitle">
                        <i class="fas fa-tasks"></i> Tâches associées
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Bouton pour ajouter une nouvelle tâche -->
                    <div class="mb-3">
                        <button type="button" class="btn btn-success" onclick="openAddTaskModal()">
                            <i class="fas fa-plus"></i> Ajouter une tâche
                        </button>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Code</th>
                                    <th>Libellé</th>
                                    <th>Description</th>
                                    <th>Durée (h)</th>
                                    <th>Priorité</th>
                                    <th>Caractère</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tasksModalTableBody">
                                <!-- Les tâches seront chargées ici -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div class="modal fade" id="addTaskModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-plus"></i> Ajouter une tâche existante
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addTaskForm">
                        <div class="mb-3">
                            <label for="addTaskSelect" class="form-label">Sélectionner une tâche *</label>
                            <select class="form-control" id="addTaskSelect" required>
                                <option value="">Chargement des tâches...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="addTaskObligatoire" class="form-label">Caractère</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="addTaskObligatoire" checked>
                                <label class="form-check-label" for="addTaskObligatoire">
                                    Obligatoire
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-success" onclick="addExistingTaskToMissionType()">
                        <i class="fas fa-plus"></i> Ajouter la tâche
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Task Modal -->
    <div class="modal fade" id="editTaskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                        <i class="fas fa-edit"></i> Modifier le statut de la tâche
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editTaskForm">
                        <input type="hidden" id="editTaskId">
                        <div class="mb-3">
                            <label class="form-label">Tâche</label>
                            <div class="form-control-plaintext" id="editTaskInfo"></div>
                        </div>
                        <div class="mb-3">
                            <label for="editTaskObligatoire" class="form-label">Caractère</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="editTaskObligatoire">
                                <label class="form-check-label" for="editTaskObligatoire">
                                    Obligatoire
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-warning" onclick="updateTaskObligatoireStatus()">
                        <i class="fas fa-save"></i> Mettre à jour
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Task Confirmation Modal -->
    <div class="modal fade" id="deleteTaskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-trash"></i> Confirmer la suppression
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Êtes-vous sûr de vouloir supprimer cette tâche ?</p>
                    <p><strong id="deleteTaskName"></strong></p>
                    <p class="text-muted">Cette action est irréversible.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDeleteTask()">
                        <i class="fas fa-trash"></i> Supprimer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/sidebar.js"></script>
    <script>
        // Variables globales
        let missionTypes = [];
        let divisions = [];
        let currentEditId = null;
        let currentDeleteId = null;
        let currentMissionTypeId = null;
        let currentMissionTypeCode = null;

        // Fonction utilitaire pour les appels API avec authentification
        async function apiCall(url, options = {}) {
            const authHeaders = window.authManager ? window.authManager.getAuthHeaders() : {
                'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                'Content-Type': 'application/json'
            };
            
            const defaultOptions = {
                headers: {
                    ...authHeaders,
                    ...options.headers
                },
                ...options
            };
            return fetch(url, defaultOptions);
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // Vérifier l'authentification
            if (!localStorage.getItem('authToken')) {
                console.log('❌ Aucun token d\'authentification trouvé, redirection vers la page de connexion');
                window.location.href = '/login.html';
                return;
            }
            
            loadMissionTypes();
            loadDivisions();
            setupEventListeners();
        });

        // Configuration des événements
        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', filterMissionTypes);
            document.getElementById('filterDivision').addEventListener('change', filterMissionTypes);
            document.getElementById('filterStatus').addEventListener('change', filterMissionTypes);
        }

        // Charger les types de mission
        async function loadMissionTypes() {
            try {
                const response = await apiCall('/api/mission-types');
                
                if (response.status === 401) {
                    console.log('❌ Token d\'authentification invalide ou expiré');
                    showAlert('Session expirée. Veuillez vous reconnecter.', 'warning');
                    setTimeout(() => {
                        window.location.href = '/login.html';
                    }, 2000);
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`Erreur de connexion: ${response.status}`);
                }
                
                const result = await response.json();
                
                // Gérer la nouvelle structure de réponse
                if (result.success && result.data && result.data.missionTypes) {
                    missionTypes = result.data.missionTypes;
                } else if (Array.isArray(result)) {
                    // Fallback pour l'ancienne structure
                    missionTypes = result;
                } else {
                    console.error('Structure de réponse inattendue:', result);
                    throw new Error('Format de réponse invalide');
                }
                
                displayMissionTypes(missionTypes);
                loadStats();
            } catch (error) {
                console.error('Erreur:', error);
                showAlert('Erreur lors du chargement des types de mission', 'danger');
            }
        }

        // Charger les divisions
        async function loadDivisions() {
            try {
                const response = await apiCall('/api/divisions');
                if (!response.ok) throw new Error('Erreur de connexion');
                
                const result = await response.json();
                
                // Gérer la structure de réponse des divisions
                if (result.success && result.data) {
                    divisions = result.data;
                } else if (result.data) {
                    divisions = result.data;
                } else if (Array.isArray(result)) {
                    divisions = result;
                } else {
                    console.error('Structure de réponse divisions inattendue:', result);
                    divisions = [];
                }
                
                populateDivisionSelects();
            } catch (error) {
                console.error('Erreur:', error);
                divisions = [];
            }
        }

        // Remplir les selects de division
        function populateDivisionSelects() {
            const selects = ['createDivision', 'editDivision', 'filterDivision'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">Sélectionner une division</option>';
                    if (Array.isArray(divisions)) {
                        divisions.forEach(division => {
                            const option = document.createElement('option');
                            option.value = division.id;
                            option.textContent = division.nom;
                            select.appendChild(option);
                        });
                    } else {
                        console.warn('Divisions non disponibles:', divisions);
                    }
                }
            });
        }

        // Afficher les types de mission
        function displayMissionTypes(types) {
            const tbody = document.getElementById('missionTypesTableBody');
            tbody.innerHTML = '';

            if (types.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Aucun type de mission trouvé</td></tr>';
                return;
            }

            types.forEach(type => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${type.codification}</strong></td>
                    <td>${type.libelle}</td>
                    <td>${type.description || '-'}</td>
                    <td>${type.division_nom || '-'}</td>
                    <td>
                        <span class="badge ${type.actif ? 'bg-success' : 'bg-secondary'} badge-status">
                            ${type.actif ? 'Actif' : 'Inactif'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-info btn-action" onclick="viewMissionType('${type.id}')" title="Voir">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-warning btn-action" onclick="editMissionType('${type.id}')" title="Modifier">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-primary btn-action" onclick="viewTasksForMissionType('${type.id}', '${type.codification}')" title="Tâches">
                            <i class="fas fa-tasks"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger btn-action" onclick="confirmDelete('${type.id}', '${type.libelle}')" title="Supprimer">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Filtrer les types de mission
        function filterMissionTypes() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const divisionFilter = document.getElementById('filterDivision').value;
            const statusFilter = document.getElementById('filterStatus').value;

            const filtered = missionTypes.filter(type => {
                const matchesSearch = !searchTerm || 
                    type.codification.toLowerCase().includes(searchTerm) ||
                    type.libelle.toLowerCase().includes(searchTerm);
                
                const matchesDivision = !divisionFilter || type.division_id === divisionFilter;
                const matchesStatus = !statusFilter || type.actif.toString() === statusFilter;

                return matchesSearch && matchesDivision && matchesStatus;
            });

            displayMissionTypes(filtered);
        }

        // Effacer les filtres
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterDivision').value = '';
            document.getElementById('filterStatus').value = '';
            displayMissionTypes(missionTypes);
        }

        // Charger les statistiques
        async function loadStats() {
            try {
                const response = await apiCall('/api/mission-types/stats/stats');
                if (!response.ok) throw new Error('Erreur de connexion');
                
                const stats = await response.json();
                document.getElementById('totalTypes').textContent = stats.total_types || 0;
                document.getElementById('activeTypes').textContent = stats.types_actifs || 0;
                document.getElementById('withDivision').textContent = stats.types_avec_division || 0;
                document.getElementById('withoutDivision').textContent = (stats.total_types - stats.types_avec_division) || 0;
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        // Ouvrir le modal de création
        function openCreateModal() {
            document.getElementById('createForm').reset();
            const modal = new bootstrap.Modal(document.getElementById('createModal'));
            modal.show();
        }

        // Créer un type de mission
        async function createMissionType() {
            const form = document.getElementById('createForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const data = {
                codification: document.getElementById('createCodification').value,
                libelle: document.getElementById('createLibelle').value,
                description: document.getElementById('createDescription').value,
                division_id: document.getElementById('createDivision').value || null
            };

            try {
                const response = await apiCall('/api/mission-types', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Erreur de connexion');
                }

                const newType = await response.json();
                missionTypes.push(newType);
                displayMissionTypes(missionTypes);
                loadStats();
                
                bootstrap.Modal.getInstance(document.getElementById('createModal')).hide();
                showAlert('Type de mission créé avec succès', 'success');
            } catch (error) {
                console.error('Erreur:', error);
                showAlert(error.message, 'danger');
            }
        }

        // Modifier un type de mission
        async function editMissionType(id) {
            try {
                const response = await apiCall(`/api/mission-types/${id}`);
                if (!response.ok) throw new Error('Erreur de connexion');
                
                const type = await response.json();
                currentEditId = id;

                document.getElementById('editId').value = type.id;
                document.getElementById('editCodification').value = type.codification;
                document.getElementById('editLibelle').value = type.libelle;
                document.getElementById('editDescription').value = type.description || '';
                document.getElementById('editDivision').value = type.division_id || '';
                document.getElementById('editActif').checked = type.actif;

                // Rendre tous les champs éditables
                document.getElementById('editCodification').readOnly = false;
                document.getElementById('editLibelle').readOnly = false;
                document.getElementById('editDescription').readOnly = false;
                document.getElementById('editDivision').disabled = false;
                document.getElementById('editActif').disabled = false;

                // Restaurer le titre et les boutons du modal
                const modalTitle = document.querySelector('#editModal .modal-title');
                modalTitle.innerHTML = '<i class="fas fa-edit"></i> Modifier le Type de Mission';
                
                const updateBtn = document.querySelector('#editModal .btn-primary');
                updateBtn.style.display = 'inline-block';
                
                const cancelBtn = document.querySelector('#editModal .btn-secondary');
                cancelBtn.textContent = 'Annuler';

                const modal = new bootstrap.Modal(document.getElementById('editModal'));
                modal.show();
            } catch (error) {
                console.error('Erreur:', error);
                showAlert('Erreur lors du chargement des données', 'danger');
            }
        }

        // Mettre à jour un type de mission
        async function updateMissionType() {
            const form = document.getElementById('editForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const data = {
                codification: document.getElementById('editCodification').value,
                libelle: document.getElementById('editLibelle').value,
                description: document.getElementById('editDescription').value,
                division_id: document.getElementById('editDivision').value || null,
                actif: document.getElementById('editActif').checked
            };

            try {
                const response = await apiCall(`/api/mission-types/${currentEditId}`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Erreur de connexion');
                }

                const updatedType = await response.json();
                const index = missionTypes.findIndex(t => t.id === currentEditId);
                if (index !== -1) {
                    missionTypes[index] = updatedType;
                }
                
                displayMissionTypes(missionTypes);
                loadStats();
                
                bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
                showAlert('Type de mission mis à jour avec succès', 'success');
            } catch (error) {
                console.error('Erreur:', error);
                showAlert(error.message, 'danger');
            }
        }

        // Confirmer la suppression
        function confirmDelete(id, name) {
            currentDeleteId = id;
            document.getElementById('deleteMissionTypeName').textContent = name;
            const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
            modal.show();
        }

        // Supprimer un type de mission
        async function deleteMissionType() {
            try {
                const response = await apiCall(`/api/mission-types/${currentDeleteId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Erreur de connexion');
                }

                missionTypes = missionTypes.filter(t => t.id !== currentDeleteId);
                displayMissionTypes(missionTypes);
                loadStats();
                
                bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
                showAlert('Type de mission supprimé avec succès', 'success');
            } catch (error) {
                console.error('Erreur:', error);
                showAlert(error.message, 'danger');
            }
        }

        // Voir un type de mission (lecture seule)
        async function viewMissionType(id) {
            try {
                const response = await apiCall(`/api/mission-types/${id}`);
                if (!response.ok) throw new Error('Erreur de connexion');
                
                const type = await response.json();
                
                // Remplir le modal avec les données en lecture seule
                document.getElementById('editId').value = type.id;
                document.getElementById('editCodification').value = type.codification;
                document.getElementById('editLibelle').value = type.libelle;
                document.getElementById('editDescription').value = type.description || '';
                document.getElementById('editDivision').value = type.division_id || '';
                document.getElementById('editActif').checked = type.actif;

                // Rendre tous les champs en lecture seule
                document.getElementById('editCodification').readOnly = true;
                document.getElementById('editLibelle').readOnly = true;
                document.getElementById('editDescription').readOnly = true;
                document.getElementById('editDivision').disabled = true;
                document.getElementById('editActif').disabled = true;

                // Changer le titre et les boutons du modal
                const modalTitle = document.querySelector('#editModal .modal-title');
                modalTitle.innerHTML = '<i class="fas fa-eye"></i> Détails du Type de Mission';
                
                const updateBtn = document.querySelector('#editModal .btn-primary');
                updateBtn.style.display = 'none';
                
                const cancelBtn = document.querySelector('#editModal .btn-secondary');
                cancelBtn.textContent = 'Fermer';

                const modal = new bootstrap.Modal(document.getElementById('editModal'));
                modal.show();
            } catch (error) {
                console.error('Erreur:', error);
                showAlert('Erreur lors du chargement des données', 'danger');
            }
        }

        // Afficher une alerte
        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            container.appendChild(alert);

            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }

        // Voir les tâches associées à un type de mission
        async function viewTasksForMissionType(missionTypeId, missionTypeCode) {
            try {
                // Stocker l'ID et le code du type de mission actuel pour les opérations CRUD
                currentMissionTypeId = missionTypeId;
                currentMissionTypeCode = missionTypeCode;
                
                // Charger les tâches associées à ce type de mission
                const response = await apiCall(`/api/tasks?mission_type_id=${missionTypeId}`);
                if (!response.ok) throw new Error('Erreur de connexion');
                
                const tasks = await response.json();
                
                // Remplir le modal avec les données
                document.getElementById('tasksModalTitle').textContent = `Tâches pour ${missionTypeCode}`;
                
                const tbody = document.getElementById('tasksModalTableBody');
                tbody.innerHTML = '';
                
                if (tasks.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Aucune tâche associée à ce type de mission</td></tr>';
                } else {
                    tasks.forEach(task => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><strong>${task.code}</strong></td>
                            <td>${task.libelle}</td>
                            <td>${task.description || '-'}</td>
                            <td>${task.duree_estimee}h</td>
                            <td>
                                <span class="badge badge-priority ${task.priorite.toLowerCase()}">
                                    ${task.priorite}
                                </span>
                            </td>
                            <td>
                                <span class="badge ${task.obligatoire ? 'bg-danger' : 'bg-warning'}">
                                    ${task.obligatoire ? 'Obligatoire' : 'Optionnel'}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-warning" onclick="editTaskFromModal('${task.id}')" title="Modifier le statut">
                                    <i class="fas fa-toggle-on"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="confirmDeleteTaskModal('${task.id}', '${task.libelle}')" title="Supprimer">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }
                
                const modal = new bootstrap.Modal(document.getElementById('tasksModal'));
                modal.show();
            } catch (error) {
                console.error('Erreur:', error);
                showAlert('Erreur lors du chargement des tâches', 'danger');
            }
        }

        // Ouvrir le modal d'ajout de tâche
        async function openAddTaskModal() {
            document.getElementById('addTaskForm').reset();
            
            // Charger les tâches disponibles (non associées à ce type de mission)
            try {
                const response = await apiCall('/api/tasks');
                if (!response.ok) throw new Error('Erreur de connexion');
                
                const allTasks = await response.json();
                
                // Récupérer les tâches déjà associées à ce type de mission
                const associatedResponse = await apiCall(`/api/tasks?mission_type_id=${currentMissionTypeId}`);
                if (!associatedResponse.ok) throw new Error('Erreur de connexion');
                
                const associatedTasks = await associatedResponse.json();
                const associatedTaskIds = associatedTasks.map(task => task.id);
                
                // Filtrer pour ne garder que les tâches non associées
                const availableTasks = allTasks.filter(task => !associatedTaskIds.includes(task.id));
                
                const select = document.getElementById('addTaskSelect');
                select.innerHTML = '<option value="">Sélectionner une tâche...</option>';
                
                availableTasks.forEach(task => {
                    const option = document.createElement('option');
                    option.value = task.id;
                    option.textContent = `${task.code} - ${task.libelle}`;
                    select.appendChild(option);
                });
                
                if (availableTasks.length === 0) {
                    select.innerHTML = '<option value="">Aucune tâche disponible</option>';
                    select.disabled = true;
                }
            } catch (error) {
                console.error('Erreur:', error);
                showAlert('Erreur lors du chargement des tâches', 'danger');
            }
            
            const modal = new bootstrap.Modal(document.getElementById('addTaskModal'));
            modal.show();
        }

        // Ajouter une tâche existante à un type de mission
        async function addExistingTaskToMissionType() {
            const form = document.getElementById('addTaskForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const taskId = document.getElementById('addTaskSelect').value;
            const obligatoire = document.getElementById('addTaskObligatoire').checked;

            if (!taskId) {
                showAlert('Veuillez sélectionner une tâche', 'danger');
                return;
            }

            try {
                const response = await apiCall(`/api/tasks/${taskId}/mission-types`, {
                    method: 'POST',
                    body: JSON.stringify({
                        mission_type_id: currentMissionTypeId,
                        obligatoire: obligatoire
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Erreur de connexion');
                }

                // Recharger les tâches pour le type de mission actuel
                await viewTasksForMissionType(currentMissionTypeId, currentMissionTypeCode);
                
                bootstrap.Modal.getInstance(document.getElementById('addTaskModal')).hide();
                showAlert('Tâche ajoutée avec succès', 'success');
            } catch (error) {
                console.error('Erreur:', error);
                showAlert(error.message, 'danger');
            }
        }

        // Modifier le statut obligatoire d'une tâche depuis le modal des tâches
        async function editTaskFromModal(taskId) {
            try {
                // Fermer le modal des tâches
                bootstrap.Modal.getInstance(document.getElementById('tasksModal')).hide();
                
                // Charger les données de la tâche à éditer
                const response = await apiCall(`/api/tasks/${taskId}`);
                if (!response.ok) throw new Error('Erreur de connexion');
                
                const task = await response.json();
                
                // Remplir le modal d'édition avec les informations de la tâche
                document.getElementById('editTaskId').value = task.id;
                document.getElementById('editTaskInfo').textContent = `${task.code} - ${task.libelle}`;
                
                // Récupérer le statut obligatoire actuel pour ce type de mission
                const associatedResponse = await apiCall(`/api/tasks?mission_type_id=${currentMissionTypeId}`);
                if (!associatedResponse.ok) throw new Error('Erreur de connexion');
                
                const associatedTasks = await associatedResponse.json();
                const currentTask = associatedTasks.find(t => t.id === taskId);
                document.getElementById('editTaskObligatoire').checked = currentTask ? currentTask.obligatoire : false;

                const modal = new bootstrap.Modal(document.getElementById('editTaskModal'));
                modal.show();
            } catch (error) {
                console.error('Erreur:', error);
                showAlert('Erreur lors du chargement des données de la tâche', 'danger');
            }
        }

        // Mettre à jour le statut obligatoire d'une tâche
        async function updateTaskObligatoireStatus() {
            const taskId = document.getElementById('editTaskId').value;
            const obligatoire = document.getElementById('editTaskObligatoire').checked;

            try {
                // Supprimer l'association existante
                await apiCall(`/api/tasks/${taskId}/mission-types/${currentMissionTypeId}`, {
                    method: 'DELETE'
                });

                // Recréer l'association avec le nouveau statut obligatoire
                const response = await apiCall(`/api/tasks/${taskId}/mission-types`, {
                    method: 'POST',
                    body: JSON.stringify({
                        mission_type_id: currentMissionTypeId,
                        obligatoire: obligatoire
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Erreur de connexion');
                }

                // Recharger les tâches pour le type de mission actuel
                await viewTasksForMissionType(currentMissionTypeId, currentMissionTypeCode);
                
                bootstrap.Modal.getInstance(document.getElementById('editTaskModal')).hide();
                showAlert('Statut de la tâche mis à jour avec succès', 'success');
            } catch (error) {
                console.error('Erreur:', error);
                showAlert(error.message, 'danger');
            }
        }

        // Confirmer la suppression d'une tâche
        function confirmDeleteTaskModal(taskId, name) {
            currentDeleteId = taskId; // Utiliser currentDeleteId pour la suppression
            document.getElementById('deleteTaskName').textContent = name;
            const modal = new bootstrap.Modal(document.getElementById('deleteTaskModal'));
            modal.show();
        }

        // Supprimer une tâche
        async function confirmDeleteTask() {
            try {
                // Supprimer seulement l'association entre la tâche et le type de mission actuel
                const response = await apiCall(`/api/tasks/${currentDeleteId}/mission-types/${currentMissionTypeId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    // Fermer le modal de confirmation
                    const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteTaskModal'));
                    deleteModal.hide();
                    
                    // Recharger la liste des tâches pour ce type de mission
                    await viewTasksForMissionType(currentMissionTypeId, currentMissionTypeCode);
                    
                    // Afficher un message de succès
                    showAlert('Association supprimée avec succès', 'success');
                } else {
                    const error = await response.json();
                    showAlert('Erreur lors de la suppression de l\'association: ' + error.error, 'danger');
                }
            } catch (error) {
                console.error('Erreur lors de la suppression de l\'association:', error);
                showAlert('Erreur de connexion lors de la suppression de l\'association', 'danger');
            }
        }
    </script>
</body>
</html>
