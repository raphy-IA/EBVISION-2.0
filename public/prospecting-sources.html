<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prospection - Sources & Entreprises</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/modern-sidebar.css">
    
	<style>
		/* Mise en page coh√©rente avec les autres pages (sidebar √† gauche, contenu √† droite) */
		.page-wrapper {
			display: flex;
			min-height: 100vh;
		}
		.main-content-area {
			flex-grow: 1;
			padding: 2rem;
		}
		@media (max-width: 768px) {
			.page-wrapper { flex-direction: column; }
			.main-content-area { padding: 1rem; }
			.sidebar-container.open { transform: translateX(0); }
		}
	</style>
    
    
    
    <!-- Script pour la gestion utilisateur -->
    <script src="js/user-header.js"></script>
    <script src="js/menu-permissions.js"></script>
    <script src="/js/page-permissions.js"></script>
    <script src="js/profile-menu.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/tasks.js"></script>

    <!-- CSS des variables de branding dynamiques -->
    <link rel="stylesheet" href="/config/themes/brand-variables.css">
    
    <!-- Scripts de branding -->
    <script src="js/branding-loader.js"></script>
    <script src="js/sidebar-branding.js"></script>
</head>
<body>
    <button class="sidebar-toggle d-md-none">
        <i class="fas fa-bars"></i>
    </button>
    <div class="page-wrapper">
        <div class="sidebar-container"></div>
        <div class="main-content-area">
            <div class="container-fluid py-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2><i class="fas fa-database me-2"></i>Sources d'entreprises</h2>
                </div>

                <div class="card mb-4">
                    <div class="card-header">Cr√©er une source</div>
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-md-4">
                                <input id="sourceName" class="form-control" placeholder="Nom de la source (ex: DGE, CSI_EPA Global)">
                            </div>
                            <div class="col-md-6">
                                <input id="sourceDescription" class="form-control" placeholder="Description (optionnel)">
                            </div>
                            <div class="col-md-2 d-grid">
                                <button type="button" id="btnCreateSource" class="btn btn-primary" onclick="createSource()">
                                    <i class="fas fa-plus me-1"></i>Cr√©er
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        Liste des sources
                        <div class="float-end">
                            <small class="text-muted">
                                <i class="fas fa-building"></i> Nombre d'entreprises | 
                                <i class="fas fa-upload"></i> Importer | 
                                <i class="fas fa-eye"></i> Voir | 
                                <i class="fas fa-edit"></i> Modifier | 
                                <i class="fas fa-trash"></i> Supprimer source | 
                                <i class="fas fa-trash-alt"></i> Supprimer entreprises
                            </small>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Nom</th>
                                        <th>Description</th>
                                        <th>Entreprises</th>
                                        <th>Importer</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="sourcesTable"></tbody>
                            </table>
                        </div>

                        <div class="mt-4" id="companiesSection" style="display:none;">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5><i class="fas fa-building me-2"></i>Entreprises de la source: <span id="currentSourceName"></span></h5>
                                <div>
                                    <button class="btn btn-sm btn-success me-2" onclick="showCreateCompanyModal()">
                                        <i class="fas fa-plus me-1"></i>Cr√©er une entreprise
                                    </button>
                                    <button class="btn btn-sm btn-danger" id="btnDeleteSelected" onclick="deleteSelectedCompanies()" style="display:none;">
                                        <i class="fas fa-trash me-1"></i>Supprimer s√©lection (<span id="selectedCount">0</span>)
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Filtres et recherche -->
                            <div class="card mb-3">
                                <div class="card-body">
                                    <div class="row g-2">
                                        <div class="col-md-3">
                                            <input id="searchCompanies" class="form-control form-control-sm" placeholder="Rechercher entreprises...">
                                        </div>
                                        <div class="col-md-2">
                                            <select id="filterIndustry" class="form-select form-select-sm">
                                                <option value="">Tous secteurs</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <select id="filterCity" class="form-select form-select-sm">
                                                <option value="">Toutes villes</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <select id="sortBy" class="form-select form-select-sm">
                                                <option value="name">Trier par nom</option>
                                                <option value="industry">Trier par secteur</option>
                                                <option value="city">Trier par ville</option>
                                                <option value="created_at">Trier par date</option>
                                            </select>
                                        </div>
                                        <div class="col-md-1">
                                            <select id="sortOrder" class="form-select form-select-sm">
                                                <option value="ASC">‚Üë</option>
                                                <option value="DESC">‚Üì</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <button class="btn btn-sm btn-primary w-100" onclick="searchAndFilterCompanies()">
                                                <i class="fas fa-search me-1"></i>Filtrer
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-sm table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th style="width: 30px;">
                                                <input type="checkbox" id="selectAllCompanies" onchange="toggleSelectAll()">
                                            </th>
                                            <th style="min-width: 200px;">Nom</th>
                                            <th style="min-width: 80px;">Sigle</th>
                                            <th style="min-width: 150px;">Secteur</th>
                                            <th style="min-width: 120px;">Email</th>
                                            <th style="min-width: 100px;">T√©l√©phone</th>
                                            <th style="min-width: 100px;">Ville</th>
                                            <th style="min-width: 80px;">Pays</th>
                                            <th style="min-width: 120px;">Site Web</th>
                                            <th style="min-width: 100px;">SIRET</th>
                                            <th style="min-width: 80px;">Taille</th>
                                            <th style="min-width: 120px;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="companiesTable"></tbody>
                                </table>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <div class="text-muted small">
                                    <span id="companiesCount">0</span> entreprise(s) trouv√©e(s)
                                </div>
                                <div id="companiesPagination"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour voir les d√©tails d'une entreprise -->
    <div class="modal fade" id="companyDetailsModal" tabindex="-1" aria-labelledby="companyDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="companyDetailsModalLabel">
                        <i class="fas fa-building me-2"></i>D√©tails de l'entreprise
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Informations g√©n√©rales</h6>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm table-borderless">
                                        <tr><td><strong>Nom :</strong></td><td id="detail-name"></td></tr>
                                        <tr><td><strong>Sigle :</strong></td><td id="detail-sigle"></td></tr>
                                        <tr><td><strong>Secteur :</strong></td><td id="detail-industry"></td></tr>
                                        <tr><td><strong>Taille :</strong></td><td id="detail-size"></td></tr>
                                        <tr><td><strong>SIRET :</strong></td><td id="detail-siret"></td></tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-map-marker-alt me-2"></i>Localisation</h6>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm table-borderless">
                                        <tr><td><strong>Adresse :</strong></td><td id="detail-address"></td></tr>
                                        <tr><td><strong>Ville :</strong></td><td id="detail-city"></td></tr>
                                        <tr><td><strong>Pays :</strong></td><td id="detail-country"></td></tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-phone me-2"></i>Contact</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <strong>Email :</strong><br>
                                            <span id="detail-email"></span>
                                        </div>
                                        <div class="col-md-4">
                                            <strong>T√©l√©phone :</strong><br>
                                            <span id="detail-phone"></span>
                                        </div>
                                        <div class="col-md-4">
                                            <strong>Site Web :</strong><br>
                                            <span id="detail-website"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-clock me-2"></i>M√©tadonn√©es</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <strong>Ajout√©e le :</strong><br>
                                            <span id="detail-created"></span>
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Modifi√©e le :</strong><br>
                                            <span id="detail-updated"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="editCompanyFromModal()">
                        <i class="fas fa-edit me-1"></i>Modifier
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/auth.js" defer></script>
    <script src="/js/sidebar.js" defer></script>
    <!-- SessionManager pour la gestion centralis√©e des sessions -->
    <script src="js/session-manager.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <script>
        const API = new URL('/api/prospecting', window.location.origin).toString();

        function getAuthHeader() {
            const token = localStorage.getItem('authToken');
            return { 'Authorization': `Bearer ${token}` };
        }

        async function loadSources() {
            const res = await fetch(`${API}/sources`, { headers: getAuthHeader() });
            const data = await res.json();
            const tbody = document.getElementById('sourcesTable');
            tbody.innerHTML = '';
            
            (data.data || []).forEach(src => {
                const companiesCount = src.companies_count || 0;
                const tr = document.createElement('tr');
                tr.setAttribute('data-source-id', src.id);
                tr.innerHTML = `
                    <td>${src.name}</td>
                    <td>${src.description || ''}</td>
                    <td>
                        <span class="badge bg-info">${companiesCount}</span>
                        ${companiesCount > 0 ? `<small class="text-muted ms-1">entreprise(s)</small>` : ''}
                    </td>
                    <td>
                        <input type="file" class="form-control form-control-sm" id="file_${src.id}" accept=".csv">
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="importCompanies('${src.id}', '${encodeURIComponent(src.name)}')"><i class="fas fa-upload"></i> Importer</button>
                            <button class="btn btn-outline-secondary" onclick="viewCompanies('${src.id}', '${encodeURIComponent(src.name)}')"><i class="fas fa-eye"></i> Voir</button>
                            <button class="btn btn-outline-warning" onclick="editSource('${src.id}', '${encodeURIComponent(src.name)}', '${encodeURIComponent(src.description || '')}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-outline-danger" onclick="deleteSource('${src.id}', '${encodeURIComponent(src.name)}')"><i class="fas fa-trash"></i></button>
                            <button class="btn btn-outline-danger" onclick="deleteAllCompaniesFromSource('${src.id}', '${encodeURIComponent(src.name)}')" title="Supprimer toutes les entreprises non associ√©es aux campagnes"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function createSource() {
            console.log('[Prospecting] createSource clicked');
            const name = document.getElementById('sourceName').value.trim();
            const description = document.getElementById('sourceDescription').value.trim();
            if (!name) { alert('Nom requis'); return; }
			
			console.log('[Prospecting] API URL:', API);
			console.log('[Prospecting] Auth header:', getAuthHeader());
			console.log('[Prospecting] Request body:', { name, description });
			
			let timeoutId;
			const controller = new AbortController();
			try {
				const btn = document.getElementById('btnCreateSource');
				if (btn) { btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Cr√©er'; }
				console.log('[Prospecting] POST /sources start');
				timeoutId = setTimeout(() => {
					console.warn('[Prospecting] Aborting request after 8s timeout');
					controller.abort();
				}, 8000);
				
				const url = `${API}/sources`;
				const options = {
                method: 'POST',
                headers: { ...getAuthHeader(), 'Content-Type': 'application/json' },
					body: JSON.stringify({ name, description }),
					signal: controller.signal
				};
				
				console.log('[Prospecting] Fetch URL:', url);
				console.log('[Prospecting] Fetch options:', options);
				
				const res = await fetch(url, options);
				clearTimeout(timeoutId);
				console.log('[Prospecting] POST /sources response received, status:', res.status);
				
            if (res.ok) {
					const data = await res.json();
					console.log('[Prospecting] Success response:', data);
                document.getElementById('sourceName').value = '';
                document.getElementById('sourceDescription').value = '';
                await loadSources();
					alert('Source cr√©√©e avec succ√®s !');
            } else {
					console.error('[Prospecting] Error response status:', res.status);
                const d = await res.json().catch(() => ({}));
					console.error('[Prospecting] Error response body:', d);
                alert('Erreur: ' + (d.message || d.error || res.status));
				}
			} catch (e) {
				console.error('[Prospecting] Exception caught:', e);
				if (e.name === 'AbortError') {
					alert('D√©lai d√©pass√© lors de la cr√©ation de la source (timeout)');
					console.warn('[Prospecting] POST /sources aborted (timeout)');
				} else if (e.name === 'TypeError' && e.message.includes('fetch')) {
					alert('Erreur de connexion au serveur. V√©rifiez que le serveur est d√©marr√©.');
					console.error('[Prospecting] Network error:', e.message);
				} else {
					alert('Erreur inattendue lors de la cr√©ation de la source');
					console.error('[Prospecting] Unexpected error:', e);
				}
			} finally {
				if (timeoutId) clearTimeout(timeoutId);
				const btn = document.getElementById('btnCreateSource');
				if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-plus me-1"></i>Cr√©er'; }
				console.log('[Prospecting] createSource finally block executed');
			}
		}

        // Exposer imm√©diatement pour l'attribut onclick, sans attendre DOMContentLoaded
        window.createSource = createSource;

        async function importCompanies(sourceId, sourceNameEnc) {
            const fileInput = document.getElementById(`file_${sourceId}`);
            if (!fileInput.files || !fileInput.files[0]) { alert('S√©lectionnez un fichier CSV'); return; }
            const fd = new FormData();
            fd.append('file', fileInput.files[0]);
            const res = await fetch(`${API}/sources/${sourceId}/import`, {
                method: 'POST',
                headers: getAuthHeader(),
                body: fd
            });
            const d = await res.json().catch(() => ({}));
            if (res.ok) {
                const message = `Import termin√©:\n` +
                    `‚úÖ ${d.data?.inserted || 0} entreprises ajout√©es\n` +
                    `üîÑ ${d.data?.updated || 0} entreprises mises √† jour\n` +
                    `‚ùå ${d.data?.errors || 0} erreurs\n` +
                    `üìä Total trait√©: ${d.data?.total || 0}`;
                alert(message);
                
                // Rafra√Æchir le compteur d'entreprises de la source
                await refreshSourceCompaniesCount(sourceId);
                
                await viewCompanies(sourceId, sourceNameEnc);
            } else {
                alert('Import √©chou√©: ' + (d.message || d.error || res.status));
            }
        }

        let currentSourceId = null;
        let selectedCompanyIds = new Set();

        async function viewCompanies(sourceId, sourceNameEnc) {
            currentSourceId = sourceId;
            document.getElementById('currentSourceName').textContent = decodeURIComponent(sourceNameEnc);
            
            console.log('[DEBUG] Chargement entreprises pour source:', sourceId);
            
            // D'abord, essayer la m√©thode simple pour v√©rifier la persistance
            try {
                const directRes = await fetch(`${API}/sources/${sourceId}/companies`, { headers: getAuthHeader() });
                const directData = await directRes.json();
                console.log('[DEBUG] Entreprises trouv√©es via route directe:', directData.data?.length || 0);
                
                if (directData.data && directData.data.length > 0) {
                    // Les donn√©es existent, utiliser la nouvelle interface avec filtres
                    await loadCompanyFilters();
                    await searchAndFilterCompanies();
                } else {
                    // Aucune entreprise trouv√©e, afficher un message
                    const tbody = document.getElementById('companiesTable');
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Aucune entreprise import√©e pour cette source</td></tr>';
                    document.getElementById('companiesCount').textContent = '0';
                }
            } catch (e) {
                console.error('[DEBUG] Erreur chargement entreprises:', e);
                alert('Erreur lors du chargement des entreprises');
            }
            
            document.getElementById('companiesSection').style.display = 'block';
        }

        async function loadCompanyFilters() {
            try {
                const res = await fetch(`${API}/companies/filters`, { headers: getAuthHeader() });
                const data = await res.json();
                
                // Remplir les filtres secteur
                const industrySelect = document.getElementById('filterIndustry');
                industrySelect.innerHTML = '<option value="">Tous secteurs</option>';
                (data.data?.industries || []).forEach(industry => {
                    const option = document.createElement('option');
                    option.value = industry;
                    option.textContent = industry;
                    industrySelect.appendChild(option);
                });
                
                // Remplir les filtres ville
                const citySelect = document.getElementById('filterCity');
                citySelect.innerHTML = '<option value="">Toutes villes</option>';
                (data.data?.cities || []).forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    citySelect.appendChild(option);
                });
            } catch (e) {
                console.error('Erreur chargement filtres:', e);
            }
        }



        async function searchAndFilterCompanies(page = 1) {
            if (!currentSourceId) {
                console.error('[DEBUG] currentSourceId manquant');
                return;
            }
            
            const q = document.getElementById('searchCompanies').value.trim();
            const industry = document.getElementById('filterIndustry').value;
            const city = document.getElementById('filterCity').value;
            const sort_by = document.getElementById('sortBy').value;
            const sort_order = document.getElementById('sortOrder').value;
            const limit = 20;
            const offset = (page - 1) * limit;
            
            try {
                const params = new URLSearchParams({
                    source_id: currentSourceId,
                    limit: limit.toString(),
                    offset: offset.toString(),
                    sort_by,
                    sort_order
                });
                
                if (q) params.append('q', q);
                if (industry) params.append('industry', industry);
                if (city) params.append('city', city);
                
                console.log('[DEBUG] Recherche avec params:', params.toString());
                const res = await fetch(`${API}/companies/search?${params}`, { headers: getAuthHeader() });
                const data = await res.json();
                
                console.log('[DEBUG] R√©sultat recherche:', data);
                
                renderCompaniesTable(data.data || []);
                renderPagination(data.pagination || {}, page);
                
                document.getElementById('companiesCount').textContent = data.pagination?.total || 0;
            } catch (e) {
                console.error('[DEBUG] Erreur recherche entreprises:', e);
            }
        }

        function renderCompaniesTable(companies) {
            const tbody = document.getElementById('companiesTable');
            tbody.innerHTML = '';
            
            companies.forEach(c => {
                const tr = document.createElement('tr');
                const isSelected = selectedCompanyIds.has(c.id);
                tr.innerHTML = `
                    <td>
                        <input type="checkbox" value="${c.id}" ${isSelected ? 'checked' : ''} 
                               onchange="toggleCompanySelection('${c.id}')">
                    </td>
                    <td>
                        <strong>${c.name}</strong>
                        ${c.campaigns_count > 0 ? `<br><small class="text-warning"><i class="fas fa-exclamation-triangle"></i> ${c.campaigns_count} campagne(s)</small>` : ''}
                    </td>
                    <td>${c.sigle ? `<span class="badge bg-primary">${c.sigle}</span>` : '<span class="text-muted">N/A</span>'}</td>
                    <td><span class="badge bg-secondary">${c.industry || 'N/A'}</span></td>
                    <td>${c.email ? `<a href="mailto:${c.email}">${c.email}</a>` : '<span class="text-muted">N/A</span>'}</td>
                    <td>${c.phone ? `<a href="tel:${c.phone}">${c.phone}</a>` : '<span class="text-muted">N/A</span>'}</td>
                    <td>${c.city || '<span class="text-muted">N/A</span>'}</td>
                    <td>${c.country || '<span class="text-muted">N/A</span>'}</td>
                    <td>${c.website ? `<a href="${c.website}" target="_blank" title="Ouvrir le site">${c.website.length > 20 ? c.website.substring(0, 20) + '...' : c.website}</a>` : '<span class="text-muted">N/A</span>'}</td>
                    <td><small class="text-muted">${c.siret || 'N/A'}</small></td>
                    <td><span class="badge bg-info">${c.size_label || 'N/A'}</span></td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-info" onclick="viewCompanyDetails('${c.id}')" title="Voir d√©tails">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-primary" onclick="editCompany('${c.id}')" title="Modifier">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteCompany('${c.id}')" title="Supprimer" ${c.campaigns_count > 0 ? 'disabled' : ''}>
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderPagination(pagination, currentPage) {
            const container = document.getElementById('companiesPagination');
            const { total = 0, limit = 20 } = pagination;
            const totalPages = Math.ceil(total / limit);
            
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let html = '<nav><ul class="pagination pagination-sm mb-0">';
            
            // Page pr√©c√©dente
            html += `<li class="page-item ${currentPage <= 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="searchAndFilterCompanies(${currentPage - 1})">Pr√©c√©dent</a>
            </li>`;
            
            // Pages num√©rot√©es (afficher max 5 pages)
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, startPage + 4);
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="searchAndFilterCompanies(${i})">${i}</a>
                </li>`;
            }
            
            // Page suivante
            html += `<li class="page-item ${currentPage >= totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="searchAndFilterCompanies(${currentPage + 1})">Suivant</a>
            </li>`;
            
            html += '</ul></nav>';
            container.innerHTML = html;
        }

        function toggleCompanySelection(companyId) {
            if (selectedCompanyIds.has(companyId)) {
                selectedCompanyIds.delete(companyId);
            } else {
                selectedCompanyIds.add(companyId);
            }
            updateSelectionUI();
        }

        function toggleSelectAll() {
            const checkbox = document.getElementById('selectAllCompanies');
            const checkboxes = document.querySelectorAll('#companiesTable input[type="checkbox"]');
            
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
                const companyId = cb.value;
                if (checkbox.checked) {
                    selectedCompanyIds.add(companyId);
                } else {
                    selectedCompanyIds.delete(companyId);
                }
            });
            updateSelectionUI();
        }

        function updateSelectionUI() {
            const count = selectedCompanyIds.size;
            document.getElementById('selectedCount').textContent = count;
            const deleteBtn = document.getElementById('btnDeleteSelected');
            deleteBtn.style.display = count > 0 ? 'block' : 'none';
            
            // Mettre √† jour le checkbox "tout s√©lectionner"
            const allCheckboxes = document.querySelectorAll('#companiesTable input[type="checkbox"]');
            const checkedCheckboxes = document.querySelectorAll('#companiesTable input[type="checkbox"]:checked');
            const selectAllCheckbox = document.getElementById('selectAllCompanies');
            
            if (allCheckboxes.length === 0) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            } else if (checkedCheckboxes.length === allCheckboxes.length) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = true;
            } else if (checkedCheckboxes.length > 0) {
                selectAllCheckbox.indeterminate = true;
                selectAllCheckbox.checked = false;
            } else {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            }
        }

        async function deleteSelectedCompanies() {
            if (selectedCompanyIds.size === 0) return;
            
            if (!confirm(`√ätes-vous s√ªr de vouloir supprimer ${selectedCompanyIds.size} entreprise(s) ?`)) return;
            
            try {
                const res = await fetch(`${API}/companies`, {
                    method: 'DELETE',
                    headers: getAuthHeader(),
                    body: JSON.stringify({ ids: Array.from(selectedCompanyIds) })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    alert(data.message);
                    selectedCompanyIds.clear();
                    updateSelectionUI();
                    await searchAndFilterCompanies();
                    
                    // Rafra√Æchir le compteur d'entreprises de la source
                    if (currentSourceId) {
                        await refreshSourceCompaniesCount(currentSourceId);
                    }
                } else {
                    // G√©rer les erreurs de d√©pendances
                    if (data.dependencies) {
                        let message = data.message + '\n\nD√©tails:\n';
                        data.dependencies.forEach(dep => {
                            message += `- Entreprise ID ${dep.company_id}: ${dep.campaigns_count} campagne(s), ${dep.validations_count} validation(s)\n`;
                        });
                        message += '\nCes entreprises ne peuvent pas √™tre supprim√©es car elles sont impliqu√©es dans des campagnes de prospection.';
                        alert(message);
                    } else {
                        alert('Erreur: ' + (data.message || data.error || res.status));
                    }
                }
            } catch (e) {
                console.error('Erreur suppression:', e);
                alert('Erreur lors de la suppression');
            }
        }

        async function deleteCompany(companyId) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette entreprise ?')) return;
            
            try {
                const res = await fetch(`${API}/companies/${companyId}`, {
                    method: 'DELETE',
                    headers: getAuthHeader()
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    selectedCompanyIds.delete(companyId);
                    updateSelectionUI();
                    await searchAndFilterCompanies();
                    
                    // Rafra√Æchir le compteur d'entreprises de la source
                    if (currentSourceId) {
                        await refreshSourceCompaniesCount(currentSourceId);
                    }
                    
                    alert('Entreprise supprim√©e');
                } else {
                    // G√©rer les erreurs de d√©pendances
                    if (data.dependencies) {
                        let message = data.message + '\n\nD√©tails:\n';
                        message += `- Campagnes: ${data.dependencies.campaigns_count}\n`;
                        message += `- Validations: ${data.dependencies.validations_count}\n`;
                        message += '\nCette entreprise ne peut pas √™tre supprim√©e car elle est impliqu√©e dans des campagnes de prospection.';
                        alert(message);
                    } else {
                        alert('Erreur: ' + (data.message || data.error || res.status));
                    }
                }
            } catch (e) {
                console.error('Erreur suppression:', e);
                alert('Erreur lors de la suppression');
            }
        }

        let currentCompanyId = null;

        async function viewCompanyDetails(companyId) {
            try {
                const res = await fetch(`${API}/companies/${companyId}`, { headers: getAuthHeader() });
                const data = await res.json();
                
                if (data.success) {
                    const company = data.data;
                    currentCompanyId = companyId;
                    
                    // Remplir les d√©tails dans le modal
                    document.getElementById('detail-name').textContent = company.name || 'N/A';
                    document.getElementById('detail-sigle').innerHTML = company.sigle ? `<span class="badge bg-primary">${company.sigle}</span>` : 'N/A';
                    document.getElementById('detail-industry').innerHTML = company.industry ? `<span class="badge bg-secondary">${company.industry}</span>` : 'N/A';
                    document.getElementById('detail-size').innerHTML = company.size_label ? `<span class="badge bg-info">${company.size_label}</span>` : 'N/A';
                    document.getElementById('detail-siret').textContent = company.siret || 'N/A';
                    
                    document.getElementById('detail-address').textContent = company.address || 'N/A';
                    document.getElementById('detail-city').textContent = company.city || 'N/A';
                    document.getElementById('detail-country').textContent = company.country || 'N/A';
                    
                    document.getElementById('detail-email').innerHTML = company.email ? 
                        `<a href="mailto:${company.email}">${company.email}</a>` : 'N/A';
                    document.getElementById('detail-phone').innerHTML = company.phone ? 
                        `<a href="tel:${company.phone}">${company.phone}</a>` : 'N/A';
                    document.getElementById('detail-website').innerHTML = company.website ? 
                        `<a href="${company.website}" target="_blank">${company.website}</a>` : 'N/A';
                    
                    document.getElementById('detail-created').textContent = company.created_at ? 
                        new Date(company.created_at).toLocaleString('fr-FR') : 'N/A';
                    document.getElementById('detail-updated').textContent = company.updated_at ? 
                        new Date(company.updated_at).toLocaleString('fr-FR') : 'N/A';
                    
                    // Ouvrir le modal
                    const modal = new bootstrap.Modal(document.getElementById('companyDetailsModal'));
                    modal.show();
                } else {
                    alert('Erreur lors du chargement des d√©tails: ' + data.error);
                }
            } catch (e) {
                console.error('Erreur chargement d√©tails:', e);
                alert('Erreur lors du chargement des d√©tails');
            }
        }

        function editCompanyFromModal() {
            if (currentCompanyId) {
                // Fermer le modal des d√©tails
                const modal = bootstrap.Modal.getInstance(document.getElementById('companyDetailsModal'));
                modal.hide();
                
                // Ouvrir la fonction d'√©dition
                editCompany(currentCompanyId);
            }
        }

        function editCompany(companyId) {
            // Pour l'instant, simple prompt - √† am√©liorer avec un modal d'√©dition
            alert('Fonction de modification √† impl√©menter. ID: ' + companyId);
            // TODO: Cr√©er un modal d'√©dition avec formulaire
        }

        // Fonction pour modifier une source
        async function editSource(sourceId, sourceNameEnc, sourceDescriptionEnc) {
            const sourceName = decodeURIComponent(sourceNameEnc);
            const sourceDescription = decodeURIComponent(sourceDescriptionEnc);
            
            const newName = prompt('Nouveau nom de la source:', sourceName);
            if (!newName || newName.trim() === '') return;
            
            const newDescription = prompt('Nouvelle description (optionnel):', sourceDescription);
            
            try {
                const res = await fetch(`${API}/sources/${sourceId}`, {
                    method: 'PUT',
                    headers: { ...getAuthHeader(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        name: newName.trim(), 
                        description: newDescription || null 
                    })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    alert('Source modifi√©e avec succ√®s !');
                    await loadSources();
                } else {
                    alert('Erreur: ' + (data.message || data.error || res.status));
                }
            } catch (e) {
                console.error('Erreur modification source:', e);
                alert('Erreur lors de la modification');
            }
        }

        // Fonction pour supprimer une source
        async function deleteSource(sourceId, sourceNameEnc) {
            const sourceName = decodeURIComponent(sourceNameEnc);
            
            if (!confirm(`√ätes-vous s√ªr de vouloir supprimer la source "${sourceName}" ?\n\nCette action ne peut √™tre annul√©e.`)) {
                return;
            }
            
            try {
                const res = await fetch(`${API}/sources/${sourceId}`, {
                    method: 'DELETE',
                    headers: getAuthHeader()
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    alert('Source supprim√©e avec succ√®s !');
                    await loadSources();
                } else {
                    if (data.companiesCount) {
                        alert(`Impossible de supprimer cette source car elle contient ${data.companiesCount} entreprise(s).\n\nSupprimez d'abord toutes les entreprises de cette source.`);
                    } else {
                        alert('Erreur: ' + (data.message || data.error || res.status));
                    }
                }
            } catch (e) {
                console.error('Erreur suppression source:', e);
                alert('Erreur lors de la suppression');
            }
        }

        // Fonction pour supprimer toutes les entreprises d'une source
        async function deleteAllCompaniesFromSource(sourceId, sourceNameEnc) {
            const sourceName = decodeURIComponent(sourceNameEnc);
            
            if (!confirm(`√ätes-vous s√ªr de vouloir supprimer TOUTES les entreprises de la source "${sourceName}" ?\n\n‚ö†Ô∏è ATTENTION: Seules les entreprises non associ√©es aux campagnes seront supprim√©es.\n\nCette action ne peut √™tre annul√©e.`)) {
                return;
            }
            
            try {
                const res = await fetch(`${API}/sources/${sourceId}/companies`, {
                    method: 'DELETE',
                    headers: getAuthHeader()
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    const message = `Suppression termin√©e:\n` +
                        `‚úÖ ${data.data.deleted} entreprises supprim√©es\n` +
                        `‚ö†Ô∏è ${data.data.remaining} entreprises conserv√©es (associ√©es aux campagnes)\n` +
                        `üìä Total initial: ${data.data.total}`;
                    alert(message);
                    
                    // Recharger les sources et les entreprises si on est sur cette source
                    await loadSources();
                    if (currentSourceId === sourceId) {
                        await searchAndFilterCompanies();
                    }
                } else {
                    alert('Erreur: ' + (data.message || data.error || res.status));
                }
            } catch (e) {
                console.error('Erreur suppression entreprises source:', e);
                alert('Erreur lors de la suppression');
            }
        }

        // Fonction pour rafra√Æchir le compteur d'entreprises d'une source
        async function refreshSourceCompaniesCount(sourceId) {
            try {
                const res = await fetch(`${API}/sources`, { headers: getAuthHeader() });
                const data = await res.json();
                const source = (data.data || []).find(s => s.id === sourceId);
                
                if (source) {
                    const companiesCount = source.companies_count || 0;
                    const badgeElement = document.querySelector(`tr[data-source-id="${sourceId}"] .badge.bg-info`);
                    if (badgeElement) {
                        badgeElement.textContent = companiesCount;
                        const textElement = badgeElement.nextElementSibling;
                        if (textElement && textElement.classList.contains('text-muted')) {
                            textElement.textContent = companiesCount > 0 ? ' entreprise(s)' : '';
                        }
                    }
                }
            } catch (error) {
                console.error('Erreur rafra√Æchissement compteur:', error);
            }
        }

        // Fonction pour afficher le modal de cr√©ation d'entreprise
        function showCreateCompanyModal() {
            if (!currentSourceId) {
                alert('Veuillez d\'abord s√©lectionner une source d\'entreprises.');
                return;
            }
            
            // R√©initialiser le formulaire
            document.getElementById('createCompanyForm').reset();
            document.getElementById('companyCountry').value = 'Cameroun';
            
            // Afficher le modal
            const modal = new bootstrap.Modal(document.getElementById('createCompanyModal'));
            modal.show();
        }

        // Fonction pour cr√©er une entreprise
        async function createCompany() {
            // R√©cup√©rer les donn√©es du formulaire
            const formData = {
                name: document.getElementById('companyName').value.trim(),
                sigle: document.getElementById('companySigle').value.trim() || null,
                industry: document.getElementById('companyIndustry').value.trim() || null,
                size_label: document.getElementById('companySize').value || null,
                email: document.getElementById('companyEmail').value.trim() || null,
                phone: document.getElementById('companyPhone').value.trim() || null,
                website: document.getElementById('companyWebsite').value.trim() || null,
                siret: document.getElementById('companySiret').value.trim() || null,
                country: document.getElementById('companyCountry').value.trim() || null,
                city: document.getElementById('companyCity').value.trim() || null,
                address: document.getElementById('companyAddress').value.trim() || null
            };

            // Validation
            if (!formData.name) {
                alert('Le nom de l\'entreprise est obligatoire.');
                return;
            }

            try {
                // Afficher un indicateur de chargement
                const createBtn = document.querySelector('#createCompanyModal .btn-primary');
                const originalText = createBtn.innerHTML;
                createBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Cr√©ation...';
                createBtn.disabled = true;

                // Appel API pour cr√©er l'entreprise
                const res = await fetch(`${API}/companies`, {
                    method: 'POST',
                    headers: { ...getAuthHeader(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ...formData,
                        source_id: currentSourceId
                    })
                });

                const data = await res.json();

                if (res.ok) {
                    // Fermer le modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('createCompanyModal'));
                    modal.hide();

                    // Afficher le message de succ√®s
                    alert(`Entreprise "${formData.name}" cr√©√©e avec succ√®s !`);

                    // Recharger les donn√©es
                    await loadSources();
                    if (currentSourceId) {
                        await searchAndFilterCompanies();
                    }
                } else {
                    alert('Erreur: ' + (data.message || data.error || res.status));
                }
            } catch (error) {
                console.error('Erreur cr√©ation entreprise:', error);
                alert('Erreur lors de la cr√©ation de l\'entreprise');
            } finally {
                // Restaurer le bouton
                const createBtn = document.querySelector('#createCompanyModal .btn-primary');
                createBtn.innerHTML = '<i class="fas fa-save me-1"></i>Cr√©er l\'entreprise';
                createBtn.disabled = false;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadSources();
        });
    </script>
    <script src="js/session-manager.js"></script>

    <!-- Modal de cr√©ation d'entreprise -->
    <div class="modal fade" id="createCompanyModal" tabindex="-1" aria-labelledby="createCompanyModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createCompanyModalLabel">
                        <i class="fas fa-plus me-2"></i>Cr√©er une nouvelle entreprise
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="createCompanyForm">
                        <div class="row g-3">
                            <!-- Informations principales -->
                            <div class="col-md-12">
                                <h6 class="text-primary mb-3"><i class="fas fa-building me-2"></i>Informations principales</h6>
                            </div>
                            
                            <div class="col-md-8">
                                <label for="companyName" class="form-label">Nom de l'entreprise *</label>
                                <input type="text" class="form-control" id="companyName" required>
                            </div>
                            
                            <div class="col-md-4">
                                <label for="companySigle" class="form-label">Sigle</label>
                                <input type="text" class="form-control" id="companySigle" placeholder="Ex: UBA, CDC">
                            </div>
                            
                            <div class="col-md-6">
                                <label for="companyIndustry" class="form-label">Secteur d'activit√©</label>
                                <input type="text" class="form-control" id="companyIndustry" placeholder="Ex: Banque, Commerce">
                            </div>
                            
                            <div class="col-md-6">
                                <label for="companySize" class="form-label">Taille</label>
                                <select class="form-select" id="companySize">
                                    <option value="">S√©lectionner...</option>
                                    <option value="TPE">TPE (Tr√®s Petite Entreprise)</option>
                                    <option value="PME">PME (Petite et Moyenne Entreprise)</option>
                                    <option value="GE">GE (Grande Entreprise)</option>
                                    <option value="ETI">ETI (Entreprise de Taille Interm√©diaire)</option>
                                </select>
                            </div>
                            
                            <!-- Contact -->
                            <div class="col-md-12">
                                <h6 class="text-primary mb-3"><i class="fas fa-address-book me-2"></i>Contact</h6>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="companyEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="companyEmail" placeholder="contact@entreprise.com">
                            </div>
                            
                            <div class="col-md-6">
                                <label for="companyPhone" class="form-label">T√©l√©phone</label>
                                <input type="tel" class="form-control" id="companyPhone" placeholder="+237 XXX XXX XXX">
                            </div>
                            
                            <div class="col-md-6">
                                <label for="companyWebsite" class="form-label">Site web</label>
                                <input type="url" class="form-control" id="companyWebsite" placeholder="https://www.entreprise.com">
                            </div>
                            
                            <div class="col-md-6">
                                <label for="companySiret" class="form-label">SIRET/NIU</label>
                                <input type="text" class="form-control" id="companySiret" placeholder="Num√©ro d'identification">
                            </div>
                            
                            <!-- Localisation -->
                            <div class="col-md-12">
                                <h6 class="text-primary mb-3"><i class="fas fa-map-marker-alt me-2"></i>Localisation</h6>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="companyCountry" class="form-label">Pays</label>
                                <input type="text" class="form-control" id="companyCountry" value="Cameroun">
                            </div>
                            
                            <div class="col-md-6">
                                <label for="companyCity" class="form-label">Ville</label>
                                <input type="text" class="form-control" id="companyCity" placeholder="Ex: Douala, Yaound√©">
                            </div>
                            
                            <div class="col-md-12">
                                <label for="companyAddress" class="form-label">Adresse</label>
                                <textarea class="form-control" id="companyAddress" rows="2" placeholder="Adresse compl√®te de l'entreprise"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Annuler
                    </button>
                    <button type="button" class="btn btn-primary" onclick="createCompany()">
                        <i class="fas fa-save me-1"></i>Cr√©er l'entreprise
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>


