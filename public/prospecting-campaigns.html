<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prospection - Campagnes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/modern-sidebar.css">
    <link rel="stylesheet" href="css/user-header.css">
    <script src="js/user-header-utils.js"></script>
    <script src="js/user-header-main.js"></script>
    <script src="js/user-header-init.js"></script>
</head>
<body>
    <button class="sidebar-toggle d-md-none">
        <i class="fas fa-bars"></i>
    </button>
    <div class="page-wrapper">
        <div class="sidebar-container"></div>
        <div class="main-content-area">
            <div class="container-fluid py-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2><i class="fas fa-bullhorn me-2"></i>Campagnes de prospection</h2>
                    <button class="btn btn-primary" onclick="openCreateModal()"><i class="fas fa-plus me-1"></i> Nouvelle campagne</button>
                </div>

                <div class="card mb-4">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Nom</th>
                                        <th>Canal</th>
                                        <th>Statut</th>
                                        <th>Mod√®le</th>
                                        <th>Planifi√©e</th>
                                        <th>Entreprises</th>
                                        <th>Cr√©√©e le</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="campaignsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="campaignModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nouvelle campagne</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-2">
                        <label class="form-label">Nom</label>
                        <input id="campName" class="form-control" placeholder="Nom de la campagne">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Canal</label>
                        <select id="campChannel" class="form-select">
                            <option value="EMAIL">Emails</option>
                            <option value="PHYSIQUE">Courrier physique</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Mod√®le (optionnel)</label>
                        <select id="campTemplate" class="form-select"></select>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Date planifi√©e (optionnel)</label>
                        <input id="campDate" type="date" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button class="btn btn-primary" onclick="createCampaign()">Enregistrer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal d'affectation d'entreprises -->
    <div class="modal fade" id="assignModal" tabindex="-1" aria-labelledby="assignModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen-lg-down modal-xl" style="max-width: 95vw;">
            <div class="modal-content" style="height: 90vh;">
                <div class="modal-header">
                    <h5 class="modal-title" id="assignModalLabel">
                        <i class="fas fa-users me-2"></i>Affecter des entreprises √† la campagne
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="height: calc(90vh - 140px); overflow-y: auto;">
                    <div class="row h-100">
                        <!-- Section gauche : S√©lection et ajout d'entreprises -->
                        <div class="col-md-7">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-plus me-2"></i>Ajouter des entreprises</h6>
                                </div>
                                <div class="card-body d-flex flex-column">
                                    <!-- S√©lection de source -->
                                    <div class="mb-3">
                                        <label class="form-label">Source d'entreprises :</label>
                                        <select id="sourceSelect" class="form-select" onchange="loadSourceCompanies()">
                                            <option value="">S√©lectionnez une source...</option>
                                        </select>
                                    </div>

                                    <!-- Filtres avanc√©s -->
                                    <div class="mb-3" id="filtersSection" style="display: none;">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <label class="form-label">Secteur d'activit√©</label>
                                                <select id="filterIndustry" class="form-select form-select-sm" onchange="applyFilters()">
                                                    <option value="">Tous les secteurs</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">Ville</label>
                                                <select id="filterCity" class="form-select form-select-sm" onchange="applyFilters()">
                                                    <option value="">Toutes les villes</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">Taille</label>
                                                <select id="filterSize" class="form-select form-select-sm" onchange="applyFilters()">
                                                    <option value="">Toutes les tailles</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Recherche dans la source -->
                                    <div class="mb-3">
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                                            <input type="text" id="companySearch" class="form-control" placeholder="Rechercher une entreprise..." oninput="filterCompanies()">
                                            <button class="btn btn-outline-secondary" type="button" onclick="clearFilters()">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Liste des entreprises de la source -->
                                    <div class="mb-3 flex-grow-1">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <small class="text-muted">
                                                Entreprises de la source 
                                                <span id="companiesCount" class="badge bg-secondary ms-2">0</span>
                                            </small>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="selectAllSource" onchange="toggleSelectAllSource()">
                                                <label class="form-check-label" for="selectAllSource">Tout s√©lectionner</label>
                                            </div>
                                        </div>
                                        <div id="sourceCompaniesList" style="height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem;">
                                            <div class="text-center py-4">
                                                <i class="fas fa-database fa-2x text-muted"></i>
                                                <p class="text-muted mt-2">S√©lectionnez une source pour voir les entreprises</p>
                                            </div>
                                        </div>
                                        
                                        <!-- Pagination -->
                                        <div class="d-flex justify-content-between align-items-center mt-2" id="paginationSection" style="display: none;">
                                            <div class="d-flex align-items-center">
                                                <span class="text-muted me-2">Page</span>
                                                <select id="pageSelect" class="form-select form-select-sm" style="width: auto;" onchange="goToPage()">
                                                </select>
                                                <span class="text-muted ms-2">sur <span id="totalPages">0</span></span>
                                            </div>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-secondary" onclick="previousPage()" id="prevBtn">
                                                    <i class="fas fa-chevron-left"></i>
                                                </button>
                                                <button class="btn btn-outline-secondary" onclick="nextPage()" id="nextBtn">
                                                    <i class="fas fa-chevron-right"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Bouton d'ajout -->
                                    <button class="btn btn-primary w-100" onclick="addSelectedCompanies()" id="addCompaniesBtn" disabled>
                                        <i class="fas fa-plus me-2"></i>Ajouter les entreprises s√©lectionn√©es
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Section droite : Entreprises de la campagne -->
                        <div class="col-md-5">
                            <div class="row h-100">
                                <!-- Entreprises s√©lectionn√©es pour ajout -->
                                <div class="col-12 mb-3">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0"><i class="fas fa-clock me-2"></i>√Ä ajouter (<span id="selectedCount">0</span>)</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="selectedCompaniesList" style="max-height: 200px; overflow-y: auto;">
                                                <div class="text-center py-3">
                                                    <i class="fas fa-list fa-2x text-muted"></i>
                                                    <p class="text-muted mt-2">Aucune entreprise s√©lectionn√©e</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Entreprises d√©j√† affect√©es -->
                                <div class="col-12 flex-grow-1">
                                    <div class="card h-100">
                                        <div class="card-header">
                                            <h6 class="mb-0"><i class="fas fa-check me-2"></i>D√©j√† affect√©es (<span id="assignedCount">0</span>)</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="assignedCompaniesList" style="height: 300px; overflow-y: auto;">
                                                <div class="text-center py-3">
                                                    <div class="spinner-border spinner-border-sm" role="status">
                                                        <span class="visually-hidden">Chargement...</span>
                                                    </div>
                                                    <p class="text-muted mt-2">Chargement...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                    <button type="button" class="btn btn-success" onclick="saveAssignments()" id="saveAssignmentsBtn">
                        <i class="fas fa-save me-2"></i>Sauvegarder les affectations
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/auth.js" defer></script>
    <script src="/js/sidebar.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script>
        const API = '/api/prospecting';
        let campaignModal;

        function getAuthHeader() {
            const token = localStorage.getItem('authToken');
            console.log('üîç [DEBUG] Token d\'authentification:', token ? 'Pr√©sent' : 'Absent');
            return { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' };
        }

        async function loadCampaigns() {
            try {
            const res = await fetch(`${API}/campaigns`, { headers: getAuthHeader() });
            const data = await res.json();
            const tbody = document.getElementById('campaignsTable');
            tbody.innerHTML = '';
                
                if (!data.data || data.data.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center py-4">
                                <i class="fas fa-bullhorn fa-2x text-muted mb-3"></i>
                                <p class="text-muted">Aucune campagne cr√©√©e pour le moment</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
            (data.data || []).forEach(c => {
                const tr = document.createElement('tr');
                    const statusClass = getStatusClass(c.status);
                    const channelClass = c.channel === 'EMAIL' ? 'info' : 'secondary';
                    const createdDate = c.created_at ? new Date(c.created_at).toLocaleDateString('fr-FR') : '-';
                    const scheduledDate = c.scheduled_date ? new Date(c.scheduled_date).toLocaleDateString('fr-FR') : '-';
                    
                tr.innerHTML = `
                        <td><strong>${c.name}</strong></td>
                        <td><span class="badge bg-${channelClass}">${c.channel}</span></td>
                        <td><span class="badge bg-${statusClass}">${getStatusText(c.status)}</span></td>
                        <td>${c.template_name || '-'}</td>
                        <td>${scheduledDate}</td>
                    <td><span class="badge bg-light text-dark">${c.companies_count || 0}</span></td>
                        <td><small class="text-muted">${createdDate}</small></td>
                    <td>
                        <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="assignCompanies('${c.id}')" title="Affecter des entreprises">
                                    <i class="fas fa-users"></i> Affecter
                                </button>
                                <a class="btn btn-outline-info" href="prospecting-campaign-summary.html?id=${c.id}" title="Voir r√©capitulatif">
                                    <i class="fas fa-eye"></i> R√©cap
                                </a>
                                <button class="btn btn-outline-warning" onclick="editCampaign('${c.id}')" title="Modifier">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteCampaign('${c.id}')" title="Supprimer">
                                    <i class="fas fa-trash"></i>
                                </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            } catch (error) {
                console.error('Erreur chargement campagnes:', error);
                document.getElementById('campaignsTable').innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-4">
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Erreur lors du chargement des campagnes
                            </div>
                        </td>
                    </tr>
                `;
            }
        }

        function getStatusClass(status) {
            switch (status) {
                case 'DRAFT': return 'warning';
                case 'READY': return 'primary';
                case 'SENT': return 'success';
                case 'ARCHIVED': return 'secondary';
                default: return 'secondary';
            }
        }

        function getStatusText(status) {
            switch (status) {
                case 'DRAFT': return 'Brouillon';
                case 'READY': return 'Pr√™te';
                case 'SENT': return 'Envoy√©e';
                case 'ARCHIVED': return 'Archiv√©e';
                default: return status;
            }
        }

        async function loadTemplates() {
            const res = await fetch(`${API}/templates`, { headers: getAuthHeader() });
            const data = await res.json();
            const sel = document.getElementById('campTemplate');
            sel.innerHTML = '<option value="">(Aucun)</option>';
            (data.data || []).forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.id;
                opt.textContent = `${t.name} (${t.channel} / ${t.type_courrier})`;
                sel.appendChild(opt);
            });
        }

        function openCreateModal() {
            resetCreateModal();
            if (!campaignModal) campaignModal = new bootstrap.Modal(document.getElementById('campaignModal'));
            campaignModal.show();
        }

        async function createCampaign() {
            const name = document.getElementById('campName').value.trim();
            const channel = document.getElementById('campChannel').value;
            const template_id = document.getElementById('campTemplate').value || null;
            const scheduled_date = document.getElementById('campDate').value || null;
            if (!name) { alert('Nom requis'); return; }
            const res = await fetch(`${API}/campaigns`, {
                method: 'POST',
                headers: getAuthHeader(),
                body: JSON.stringify({ name, channel, template_id, scheduled_date })
            });
            if (res.ok) {
                campaignModal.hide();
                await loadCampaigns();
            } else {
                const d = await res.json().catch(() => ({}));
                alert('Erreur: ' + (d.message || d.error || res.status));
            }
        }

        // Fonction pour affecter des entreprises √† une campagne
        function assignCompanies(campaignId) {
            // Ouvrir le modal d'affectation d'entreprises
            openAssignModal(campaignId);
        }

        // Fonction pour √©diter une campagne
        async function editCampaign(campaignId) {
            try {
                const res = await fetch(`${API}/campaigns/${campaignId}`, { headers: getAuthHeader() });
                const data = await res.json();
                
                if (res.ok && data.data) {
                    const campaign = data.data;
                    
                    // Remplir le formulaire avec les donn√©es existantes
                    document.getElementById('campName').value = campaign.name;
                    document.getElementById('campChannel').value = campaign.channel;
                    document.getElementById('campTemplate').value = campaign.template_id || '';
                    document.getElementById('campDate').value = campaign.scheduled_date || '';
                    
                    // Changer le titre du modal
                    document.querySelector('#campaignModal .modal-title').textContent = 'Modifier la campagne';
                    
                    // Changer le bouton
                    const saveBtn = document.querySelector('#campaignModal .btn-primary');
                    saveBtn.textContent = 'Mettre √† jour';
                    saveBtn.onclick = () => updateCampaign(campaignId);
                    
                    // Afficher le modal
                    if (!campaignModal) campaignModal = new bootstrap.Modal(document.getElementById('campaignModal'));
                    campaignModal.show();
                } else {
                    alert('Erreur lors du chargement de la campagne');
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors du chargement de la campagne');
            }
        }

        // Fonction pour mettre √† jour une campagne
        async function updateCampaign(campaignId) {
            const name = document.getElementById('campName').value.trim();
            const channel = document.getElementById('campChannel').value;
            const template_id = document.getElementById('campTemplate').value || null;
            const scheduled_date = document.getElementById('campDate').value || null;
            
            if (!name) { alert('Nom requis'); return; }
            
            try {
                const res = await fetch(`${API}/campaigns/${campaignId}`, {
                    method: 'PUT',
                    headers: getAuthHeader(),
                    body: JSON.stringify({ name, channel, template_id, scheduled_date })
                });
                
                if (res.ok) {
                    campaignModal.hide();
            await loadCampaigns();
                    alert('Campagne mise √† jour avec succ√®s !');
                } else {
                    const d = await res.json().catch(() => ({}));
                    alert('Erreur: ' + (d.message || d.error || res.status));
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de la mise √† jour');
            }
        }

        // Fonction pour supprimer une campagne
        async function deleteCampaign(campaignId) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette campagne ? Cette action est irr√©versible.')) {
                return;
            }
            
            try {
                const res = await fetch(`${API}/campaigns/${campaignId}`, {
                    method: 'DELETE',
                    headers: getAuthHeader()
                });
                
                if (res.ok) {
                    await loadCampaigns();
                    alert('Campagne supprim√©e avec succ√®s !');
                } else {
                    const d = await res.json().catch(() => ({}));
                    alert('Erreur: ' + (d.message || d.error || res.status));
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de la suppression');
            }
        }

        // Fonction pour r√©initialiser le modal de cr√©ation
        function resetCreateModal() {
            document.getElementById('campName').value = '';
            document.getElementById('campChannel').value = 'EMAIL';
            document.getElementById('campTemplate').value = '';
            document.getElementById('campDate').value = '';
            
            // Remettre le titre et le bouton par d√©faut
            document.querySelector('#campaignModal .modal-title').textContent = 'Nouvelle campagne';
            const saveBtn = document.querySelector('#campaignModal .btn-primary');
            saveBtn.textContent = 'Enregistrer';
            saveBtn.onclick = createCampaign;
        }

        // ===== FONCTIONS DU MODAL D'AFFECTATION =====
        
        let assignModal;
        let currentCampaignId;
        let currentSourceCompanies = [];
        let selectedCompanies = new Set();
        let assignedCompanies = new Set();

        // Ouvrir le modal d'affectation
        async function openAssignModal(campaignId) {
            currentCampaignId = campaignId;
            selectedCompanies.clear();
            assignedCompanies.clear();
            
            // R√©initialiser l'interface
            resetAssignModal();
            
            // Charger les sources et les entreprises d√©j√† affect√©es
            await Promise.all([
                loadSources(),
                loadAssignedCompanies()
            ]);
            
            // Afficher le modal
            if (!assignModal) {
                assignModal = new bootstrap.Modal(document.getElementById('assignModal'));
            }
            assignModal.show();
        }

        // R√©initialiser le modal
        function resetAssignModal() {
            document.getElementById('sourceSelect').value = '';
            document.getElementById('companySearch').value = '';
            document.getElementById('selectAllSource').checked = false;
            document.getElementById('addCompaniesBtn').disabled = true;
            
            // R√©initialiser les filtres
            document.getElementById('filterIndustry').value = '';
            document.getElementById('filterCity').value = '';
            document.getElementById('filterSize').value = '';
            document.getElementById('filtersSection').style.display = 'none';
            
            // R√©initialiser la pagination
            currentPage = 1;
            allSourceCompanies = [];
            filteredCompanies = [];
            
            // Vider les listes
            document.getElementById('sourceCompaniesList').innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-database fa-2x text-muted"></i>
                    <p class="text-muted mt-2">S√©lectionnez une source pour voir les entreprises</p>
                </div>
            `;
            
            // Masquer la pagination
            document.getElementById('paginationSection').style.display = 'none';
            
            updateSelectedCompaniesList();
            updateCounts();
        }

        // Charger les sources
        async function loadSources() {
            try {
                console.log('üîç [DEBUG] Chargement des sources...');
                const res = await fetch(`${API}/sources`, { headers: getAuthHeader() });
                console.log('üîç [DEBUG] R√©ponse sources:', res.status, res.statusText);
                
                const data = await res.json();
                console.log('üîç [DEBUG] Donn√©es sources:', data);
                
                const select = document.getElementById('sourceSelect');
                
                // Garder l'option par d√©faut
                select.innerHTML = '<option value="">S√©lectionnez une source...</option>';
                
                if (data.data && data.data.length > 0) {
                    console.log('üîç [DEBUG] Sources trouv√©es:', data.data.length);
                    data.data.forEach(source => {
                        const option = document.createElement('option');
                        option.value = source.id;
                        option.textContent = source.name;
                        select.appendChild(option);
                    });
                } else {
                    console.log('üîç [DEBUG] Aucune source trouv√©e');
                }
            } catch (error) {
                console.error('‚ùå [DEBUG] Erreur chargement sources:', error);
            }
        }

        // Charger les entreprises d'une source
        async function loadSourceCompanies() {
            const sourceId = document.getElementById('sourceSelect').value;
            console.log('üîç [DEBUG] Chargement entreprises pour source:', sourceId);
            
            if (!sourceId) {
                console.log('üîç [DEBUG] Aucune source s√©lectionn√©e');
                resetSourceCompaniesList();
                return;
            }

            try {
                console.log('üîç [DEBUG] Appel API:', `${API}/sources/${sourceId}/companies`);
                const res = await fetch(`${API}/sources/${sourceId}/companies`, { headers: getAuthHeader() });
                console.log('üîç [DEBUG] R√©ponse entreprises:', res.status, res.statusText);
                
                const data = await res.json();
                console.log('üîç [DEBUG] Donn√©es entreprises:', data);
                
                allSourceCompanies = data.data || [];
                currentSourceCompanies = allSourceCompanies;
                console.log('üîç [DEBUG] Nombre d\'entreprises trouv√©es:', allSourceCompanies.length);
                
                // R√©initialiser la pagination
                currentPage = 1;
                
                // Charger les filtres
                loadFilters();
                
                // Afficher les entreprises
                renderSourceCompanies(currentSourceCompanies);
                
                // Afficher la section des filtres si il y a des entreprises
                if (allSourceCompanies.length > 0) {
                    document.getElementById('filtersSection').style.display = 'block';
                }
            } catch (error) {
                console.error('‚ùå [DEBUG] Erreur chargement entreprises source:', error);
                resetSourceCompaniesList();
            }
        }

        // Variables pour la pagination
        let currentPage = 1;
        let companiesPerPage = 20;
        let allSourceCompanies = [];
        let filteredCompanies = [];

        // Afficher les entreprises de la source
        function renderSourceCompanies(companies) {
            const container = document.getElementById('sourceCompaniesList');
            
            if (companies.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-building fa-2x text-muted"></i>
                        <p class="text-muted mt-2">Aucune entreprise dans cette source</p>
                        <small class="text-muted">Essayez de s√©lectionner une autre source ou importez des entreprises via la page "Sources d'entreprises"</small>
                    </div>
                `;
                return;
            }

            // Calculer la pagination
            const startIndex = (currentPage - 1) * companiesPerPage;
            const endIndex = startIndex + companiesPerPage;
            const companiesToShow = companies.slice(startIndex, endIndex);

            container.innerHTML = companiesToShow.map(company => `
                <div class="form-check mb-3 company-item p-3 border rounded" data-company-id="${company.id}">
                    <div class="d-flex align-items-start">
                        <input class="form-check-input mt-1 me-3" type="checkbox" value="${company.id}" id="company_${company.id}" onchange="toggleCompanySelection('${company.id}')">
                        <div class="flex-grow-1">
                            <label class="form-check-label w-100" for="company_${company.id}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1 fw-bold">${company.name}</h6>
                                        <div class="row text-muted small">
                                            <div class="col-md-6">
                                                <i class="fas fa-industry me-1"></i>
                                                <strong>Secteur:</strong> ${company.industry || 'Non renseign√©'}
                                            </div>
                                            <div class="col-md-6">
                                                <i class="fas fa-map-marker-alt me-1"></i>
                                                <strong>Ville:</strong> ${company.city || 'Non renseign√©'}
                                            </div>
                                        </div>
                                        <div class="row text-muted small mt-1">
                                            <div class="col-md-6">
                                                <i class="fas fa-envelope me-1"></i>
                                                <strong>Email:</strong> ${company.email || 'Non renseign√©'}
                                            </div>
                                            <div class="col-md-6">
                                                <i class="fas fa-phone me-1"></i>
                                                <strong>T√©l√©phone:</strong> ${company.phone || 'Non renseign√©'}
                                            </div>
                                        </div>
                                        ${company.website ? `
                                        <div class="row text-muted small mt-1">
                                            <div class="col-12">
                                                <i class="fas fa-globe me-1"></i>
                                                <strong>Site web:</strong> <a href="${company.website}" target="_blank" class="text-decoration-none">${company.website}</a>
                                            </div>
                                        </div>
                                        ` : ''}
                                        ${company.size_label ? `
                                        <div class="row text-muted small mt-1">
                                            <div class="col-12">
                                                <i class="fas fa-users me-1"></i>
                                                <strong>Taille:</strong> ${company.size_label}
                                            </div>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
            `).join('');

            // Mettre √† jour la pagination
            updatePagination(companies.length);
        }

        // R√©initialiser la liste des entreprises de la source
        function resetSourceCompaniesList() {
            document.getElementById('sourceCompaniesList').innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-database fa-2x text-muted"></i>
                    <p class="text-muted mt-2">S√©lectionnez une source pour voir les entreprises</p>
                </div>
            `;
        }

        // Charger les filtres
        function loadFilters() {
            const industries = [...new Set(allSourceCompanies.map(c => c.industry).filter(Boolean))].sort();
            const cities = [...new Set(allSourceCompanies.map(c => c.city).filter(Boolean))].sort();
            const sizes = [...new Set(allSourceCompanies.map(c => c.size_label).filter(Boolean))].sort();

            // Remplir les filtres
            const industrySelect = document.getElementById('filterIndustry');
            const citySelect = document.getElementById('filterCity');
            const sizeSelect = document.getElementById('filterSize');

            industrySelect.innerHTML = '<option value="">Tous les secteurs</option>';
            citySelect.innerHTML = '<option value="">Toutes les villes</option>';
            sizeSelect.innerHTML = '<option value="">Toutes les tailles</option>';

            industries.forEach(industry => {
                const option = document.createElement('option');
                option.value = industry;
                option.textContent = industry;
                industrySelect.appendChild(option);
            });

            cities.forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                citySelect.appendChild(option);
            });

            sizes.forEach(size => {
                const option = document.createElement('option');
                option.value = size;
                option.textContent = size;
                sizeSelect.appendChild(option);
            });
        }

        // Appliquer les filtres
        function applyFilters() {
            const searchTerm = document.getElementById('companySearch').value.toLowerCase();
            const industryFilter = document.getElementById('filterIndustry').value;
            const cityFilter = document.getElementById('filterCity').value;
            const sizeFilter = document.getElementById('filterSize').value;

            filteredCompanies = allSourceCompanies.filter(company => {
                const matchesSearch = !searchTerm || 
                    company.name.toLowerCase().includes(searchTerm) ||
                    (company.industry && company.industry.toLowerCase().includes(searchTerm)) ||
                    (company.city && company.city.toLowerCase().includes(searchTerm));

                const matchesIndustry = !industryFilter || company.industry === industryFilter;
                const matchesCity = !cityFilter || company.city === cityFilter;
                const matchesSize = !sizeFilter || company.size_label === sizeFilter;

                return matchesSearch && matchesIndustry && matchesCity && matchesSize;
            });

            currentSourceCompanies = filteredCompanies;
            currentPage = 1;
            renderSourceCompanies(currentSourceCompanies);
        }

        // Filtrer les entreprises (recherche en temps r√©el)
        function filterCompanies() {
            applyFilters();
        }

        // Effacer tous les filtres
        function clearFilters() {
            document.getElementById('companySearch').value = '';
            document.getElementById('filterIndustry').value = '';
            document.getElementById('filterCity').value = '';
            document.getElementById('filterSize').value = '';
            
            currentSourceCompanies = allSourceCompanies;
            currentPage = 1;
            renderSourceCompanies(currentSourceCompanies);
        }

        // Mettre √† jour la pagination
        function updatePagination(totalCompanies) {
            const totalPages = Math.ceil(totalCompanies / companiesPerPage);
            const paginationSection = document.getElementById('paginationSection');
            const pageSelect = document.getElementById('pageSelect');
            const totalPagesSpan = document.getElementById('totalPages');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            if (totalPages <= 1) {
                paginationSection.style.display = 'none';
                return;
            }

            paginationSection.style.display = 'flex';
            totalPagesSpan.textContent = totalPages;

            // Mettre √† jour le s√©lecteur de page
            pageSelect.innerHTML = '';
            for (let i = 1; i <= totalPages; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                if (i === currentPage) option.selected = true;
                pageSelect.appendChild(option);
            }

            // Mettre √† jour les boutons
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;

            // Mettre √† jour le compteur
            document.getElementById('companiesCount').textContent = totalCompanies;
        }

        // Aller √† une page sp√©cifique
        function goToPage() {
            const pageSelect = document.getElementById('pageSelect');
            currentPage = parseInt(pageSelect.value);
            renderSourceCompanies(currentSourceCompanies);
        }

        // Page pr√©c√©dente
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                renderSourceCompanies(currentSourceCompanies);
            }
        }

        // Page suivante
        function nextPage() {
            const totalPages = Math.ceil(currentSourceCompanies.length / companiesPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderSourceCompanies(currentSourceCompanies);
            }
        }

        // S√©lectionner/d√©s√©lectionner tout
        function toggleSelectAllSource() {
            const selectAll = document.getElementById('selectAllSource');
            const checkboxes = document.querySelectorAll('#sourceCompaniesList input[type="checkbox"]:not([style*="display: none"])');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
                if (selectAll.checked) {
                    selectedCompanies.add(checkbox.value);
                } else {
                    selectedCompanies.delete(checkbox.value);
                }
            });
            
            updateSelectedCompaniesList();
            updateCounts();
            updateAddButton();
        }

        // Basculer la s√©lection d'une entreprise
        function toggleCompanySelection(companyId) {
            if (selectedCompanies.has(companyId)) {
                selectedCompanies.delete(companyId);
            } else {
                selectedCompanies.add(companyId);
            }
            
            updateSelectedCompaniesList();
            updateCounts();
            updateAddButton();
        }

        // Mettre √† jour la liste des entreprises s√©lectionn√©es
        function updateSelectedCompaniesList() {
            const container = document.getElementById('selectedCompaniesList');
            
            if (selectedCompanies.size === 0) {
                container.innerHTML = `
                    <div class="text-center py-3">
                        <i class="fas fa-list fa-2x text-muted"></i>
                        <p class="text-muted mt-2">Aucune entreprise s√©lectionn√©e</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = Array.from(selectedCompanies).map(companyId => {
                const company = currentSourceCompanies.find(c => c.id === companyId);
                if (!company) return '';
                
                return `
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                        <div>
                            <strong>${company.name}</strong><br>
                            <small class="text-muted">${company.industry || 'N/A'} ‚Ä¢ ${company.city || 'N/A'}</small>
                        </div>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeSelectedCompany('${companyId}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }

        // Supprimer une entreprise de la s√©lection
        function removeSelectedCompany(companyId) {
            selectedCompanies.delete(companyId);
            
            // D√©cocher la checkbox correspondante
            const checkbox = document.getElementById(`company_${companyId}`);
            if (checkbox) checkbox.checked = false;
            
            updateSelectedCompaniesList();
            updateCounts();
            updateAddButton();
        }

        // Ajouter les entreprises s√©lectionn√©es
        function addSelectedCompanies() {
            if (selectedCompanies.size === 0) return;
            
            // Ajouter aux entreprises assign√©es et stocker leurs d√©tails
            selectedCompanies.forEach(companyId => {
                assignedCompanies.add(companyId);
                
                // Suivre les ajouts
                if (!originalAssignedCompanies.has(companyId)) {
                    addedCompanies.add(companyId);
                }
                // Si l'entreprise √©tait marqu√©e comme supprim√©e, la retirer de cette liste
                removedCompanies.delete(companyId);
                
                // Trouver les d√©tails de l'entreprise dans currentSourceCompanies
                const companyDetails = currentSourceCompanies.find(c => c.id === companyId);
                if (companyDetails) {
                    // Ajouter aux d√©tails des entreprises assign√©es
                    if (!window.assignedCompaniesDetails) {
                        window.assignedCompaniesDetails = [];
                    }
                    window.assignedCompaniesDetails.push(companyDetails);
                }
            });
            
            // Vider la s√©lection
            selectedCompanies.clear();
            
            // Mettre √† jour l'interface
            updateSelectedCompaniesList();
            updateAssignedCompaniesList();
            updateCounts();
            updateAddButton();
            
            // D√©cocher toutes les checkboxes
            document.querySelectorAll('#sourceCompaniesList input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            document.getElementById('selectAllSource').checked = false;
        }

        // Charger les entreprises d√©j√† affect√©es
        async function loadAssignedCompanies() {
            try {
                const res = await fetch(`${API}/campaigns/${currentCampaignId}/companies`, { headers: getAuthHeader() });
                const data = await res.json();
                
                assignedCompanies.clear();
                originalAssignedCompanies.clear();
                addedCompanies.clear();
                removedCompanies.clear();
                
                // Stocker les d√©tails complets des entreprises assign√©es
                window.assignedCompaniesDetails = data.data || [];
                
                (data.data || []).forEach(company => {
                    assignedCompanies.add(company.id);
                    originalAssignedCompanies.add(company.id); // Garder une copie des entreprises originales
                });
                
                updateAssignedCompaniesList();
                updateCounts();
            } catch (error) {
                console.error('Erreur chargement entreprises assign√©es:', error);
            }
        }

        // Mettre √† jour la liste des entreprises assign√©es
        function updateAssignedCompaniesList() {
            const container = document.getElementById('assignedCompaniesList');
            
            if (assignedCompanies.size === 0) {
                container.innerHTML = `
                    <div class="text-center py-3">
                        <i class="fas fa-check fa-2x text-muted"></i>
                        <p class="text-muted mt-2">Aucune entreprise affect√©e</p>
                    </div>
                `;
                return;
            }

            // Afficher les vraies informations des entreprises assign√©es
            container.innerHTML = (window.assignedCompaniesDetails || []).map(company => `
                <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                    <div>
                        <strong>${company.name}</strong><br>
                        <small class="text-muted">
                            ${company.industry || 'N/A'} ‚Ä¢ ${company.city || 'N/A'}
                            ${company.email ? ` ‚Ä¢ ${company.email}` : ''}
                        </small>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeAssignedCompany('${company.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }

        // Supprimer une entreprise assign√©e
        function removeAssignedCompany(companyId) {
            assignedCompanies.delete(companyId);
            
            // Suivre les suppressions
            if (originalAssignedCompanies.has(companyId)) {
                removedCompanies.add(companyId);
            }
            // Si l'entreprise √©tait marqu√©e comme ajout√©e, la retirer de cette liste
            addedCompanies.delete(companyId);
            
            // Supprimer aussi des d√©tails
            if (window.assignedCompaniesDetails) {
                window.assignedCompaniesDetails = window.assignedCompaniesDetails.filter(c => c.id !== companyId);
            }
            
            updateAssignedCompaniesList();
            updateCounts();
        }

        // Mettre √† jour les compteurs
        function updateCounts() {
            document.getElementById('selectedCount').textContent = selectedCompanies.size;
            document.getElementById('assignedCount').textContent = assignedCompanies.size;
        }

        // Mettre √† jour l'√©tat du bouton d'ajout
        function updateAddButton() {
            const btn = document.getElementById('addCompaniesBtn');
            btn.disabled = selectedCompanies.size === 0;
        }

                // Variables pour suivre les modifications
        let originalAssignedCompanies = new Set();
        let addedCompanies = new Set();
        let removedCompanies = new Set();

        // Sauvegarder les affectations
        async function saveAssignments() {
            try {
                console.log('üîç [DEBUG] Sauvegarde des affectations...');
                console.log('üîç [DEBUG] Entreprises originales:', originalAssignedCompanies.size);
                console.log('üîç [DEBUG] Entreprises ajout√©es:', addedCompanies.size);
                console.log('üîç [DEBUG] Entreprises supprim√©es:', removedCompanies.size);
                console.log('üîç [DEBUG] Entreprises finales:', assignedCompanies.size);

                // Si aucune modification, ne rien faire
                if (addedCompanies.size === 0 && removedCompanies.size === 0) {
                    alert('Aucune modification √† sauvegarder');
                    return;
                }

                // Pr√©parer les donn√©es pour l'API
                const data = {
                    added_company_ids: Array.from(addedCompanies),
                    removed_company_ids: Array.from(removedCompanies)
                };

                console.log('üîç [DEBUG] Donn√©es √† envoyer:', data);

                const res = await fetch(`${API}/campaigns/${currentCampaignId}/companies/batch`, {
                    method: 'PUT',
                    headers: { ...getAuthHeader(), 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    const result = await res.json();
                    const message = [];
                    if (addedCompanies.size > 0) message.push(`${addedCompanies.size} entreprise(s) ajout√©e(s)`);
                    if (removedCompanies.size > 0) message.push(`${removedCompanies.size} entreprise(s) supprim√©e(s)`);
                    
                    alert(`Modifications sauvegard√©es avec succ√®s !\n${message.join('\n')}`);
                    assignModal.hide();
                    await loadCampaigns(); // Recharger la liste des campagnes
                } else {
                    const error = await res.json();
                    alert('Erreur lors de la sauvegarde : ' + (error.error || 'Erreur inconnue'));
                }
            } catch (error) {
                console.error('‚ùå [DEBUG] Erreur sauvegarde affectations:', error);
                alert('Erreur lors de la sauvegarde des affectations');
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await loadCampaigns();
            await loadTemplates();
        });
    </script>
    <script src="js/session-manager.js"></script>
</body>
</html>


