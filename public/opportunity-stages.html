<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Étapes d'une Opportunité - TRS</title>
    
    <!-- CSS Bootstrap et FontAwesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- CSS de la sidebar moderne -->
    <link rel="stylesheet" href="css/modern-sidebar.css">
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c4c;
            --light-bg: #f8f9fa;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            overflow-x: hidden; /* Empêche le défilement horizontal */
        }
        
        /* Le conteneur principal de la page qui contient la sidebar et le contenu */
        .page-wrapper {
            display: flex;
            min-height: 100vh;
        }

        /* Styles pour le contenu principal */
        .main-content-area {
            flex-grow: 1; /* Prend l'espace restant */
            padding: 2rem;
            background-color: var(--light-bg);
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .stat-card.success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .stat-card.warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .stat-card.info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
        }
        
        .table thead th {
            background-color: var(--primary-color);
            color: white;
        }
        
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-saisie { background-color: #e3f2fd; color: #1976d2; }
        .status-soumise { background-color: #fff3e0; color: #f57c00; }
        .status-validee { background-color: #e8f5e8; color: #388e3c; }
        .status-rejetee { background-color: #ffebee; color: #d32f2f; }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Styles spécifiques pour la sidebar (si non gérés par modern-sidebar.css) */
        .sidebar-container {
            width: 300px; /* Largeur fixe pour la sidebar */
            flex-shrink: 0; /* Empêche la sidebar de rétrécir */
        }

        /* Ajustements pour les petits écrans */
        @media (max-width: 768px) {
            .page-wrapper {
                flex-direction: column; /* Empile la sidebar et le contenu */
            }
            .sidebar-container {
                width: 100%; /* La sidebar prend toute la largeur */
                height: auto; /* Hauteur automatique */
            }
            .main-content-area {
                padding: 1rem;
            }
        }

        /* Kanban */
        .kanban-board { display: flex; gap: 1rem; }
        .kanban-column { flex: 1; background: #ffffff; border-radius: 12px; padding: 0.75rem; min-height: 240px; border: 1px solid #eee; }
        .kanban-column h6 { font-weight: 600; margin-bottom: 0.75rem; }
        .kanban-card { background: #f8f9fa; border: 1px solid #eaeaea; border-radius: 10px; padding: 0.5rem 0.75rem; margin-bottom: 0.5rem; cursor: grab; }
        .kanban-card .small-muted { font-size: 12px; color: #6c757d; }
        .droppable-hover { outline: 2px dashed var(--secondary-color); }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <!-- Sidebar Container -->
        <div class="sidebar-container">
            <!-- La sidebar sera générée par JavaScript -->
        </div>

        <!-- Main Content Area -->
        <div class="main-content-area">
            <!-- Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center gap-3">
                            <a class="btn btn-outline-secondary" href="/opportunities.html">
                                <i class="fas fa-arrow-left me-1"></i> Retour
                            </a>
                            <h2 class="mb-0">
                                <i class="fas fa-project-diagram me-2"></i>
                                Étapes de l'opportunité
                                <span id="opp-name" class="text-primary"></span>
                                <span id="opp-status" class="badge ms-2"></span>
                            </h2>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats -->
            <div class="row g-3 mb-3" id="stats-cards" style="display:none;">
                <div class="col-md-3">
                    <div class="card stat-card info">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="small">Total Étapes</div>
                                    <div class="stat-number" id="stat-total">0</div>
                                </div>
                                <i class="fas fa-layer-group fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card success">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="small">Terminées</div>
                                    <div class="stat-number" id="stat-completed">0</div>
                                </div>
                                <i class="fas fa-check-circle fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card warning">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="small">En cours</div>
                                    <div class="stat-number" id="stat-inprogress">0</div>
                                </div>
                                <i class="fas fa-play-circle fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="small">En attente</div>
                                    <div class="stat-number" id="stat-pending">0</div>
                                </div>
                                <i class="fas fa-pause-circle fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alertes -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0"><i class="fas fa-bell me-2"></i>Alertes</h5>
                    <button class="btn btn-sm btn-outline-secondary" id="btn-refresh-alerts">
                        <i class="fas fa-rotate"></i> Actualiser
                    </button>
                </div>
                <div class="card-body" id="alerts-container">
                    <div class="text-muted">Chargement des alertes…</div>
                </div>
            </div>

            <!-- Kanban des étapes -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="fas fa-columns me-2"></i>Kanban des étapes</h5>
                </div>
                <div class="card-body">
                    <div class="kanban-board">
                        <div class="kanban-column" data-status="PENDING" id="kanban-col-pending">
                            <h6><span class="badge bg-secondary me-2">En attente</span>À faire</h6>
                            <div id="kanban-pending"></div>
                        </div>
                        <div class="kanban-column" data-status="IN_PROGRESS" id="kanban-col-inprogress">
                            <h6><span class="badge bg-warning text-dark me-2">En cours</span>En traitement</h6>
                            <div id="kanban-inprogress"></div>
                        </div>
                        <div class="kanban-column" data-status="COMPLETED" id="kanban-col-completed">
                            <h6><span class="badge bg-success me-2">Terminé</span>Complétées</h6>
                            <div id="kanban-completed"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tableau des étapes -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="fas fa-list me-2"></i>Étapes de l'opportunité</h5>
                </div>
                <div class="card-body">
                    <div id="stages-loading" class="loading">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Chargement...</span>
                        </div>
                    </div>
                    <div id="stages-content">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Ordre</th>
                                        <th>Étape</th>
                                        <th>Statut</th>
                                        <th>Échéance</th>
                                        <th>Risque</th>
                                        <th>Priorité</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="stages-table"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add Stage Modal -->
    <div class="modal fade" id="addStageModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plus me-2"></i>
                        Ajouter une Étape d'Opportunité
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addStageForm">
                        <div class="mb-3">
                            <label for="stageName" class="form-label">Nom de l'Étape *</label>
                            <input type="text" class="form-control" id="stageName" required>
                        </div>
                        <div class="mb-3">
                            <label for="stageDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="stageDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="stageOrder" class="form-label">Ordre *</label>
                            <input type="number" class="form-control" id="stageOrder" required min="0">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="addStage()">
                        <i class="fas fa-save me-1"></i>
                        Enregistrer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Stage Modal -->
    <div class="modal fade" id="editStageModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-edit me-2"></i>
                        Modifier l'Étape d'Opportunité
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editStageForm">
                        <input type="hidden" id="editStageId">
                        <div class="mb-3">
                            <label for="editStageName" class="form-label">Nom de l'Étape *</label>
                            <input type="text" class="form-control" id="editStageName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editStageDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="editStageDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editStageOrder" class="form-label">Ordre *</label>
                            <input type="number" class="form-control" id="editStageOrder" required min="0">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="updateStage()">
                        <i class="fas fa-save me-1"></i>
                        Mettre à jour
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle me-2 text-warning"></i>
                        Confirmer la suppression
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Êtes-vous sûr de vouloir supprimer cette étape d'opportunité ?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                        <i class="fas fa-trash me-1"></i>
                        Supprimer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/auth.js" defer></script>
    <script src="/js/sidebar.js" defer></script>
    <script>
        const API_BASE_URL = '/api';
        const statusBadges = {
            'NOUVELLE': 'bg-secondary',
            'EN_COURS': 'bg-warning text-dark',
            'GAGNEE': 'bg-success',
            'PERDUE': 'bg-danger'
        };

        // Appel API authentifié (utilise auth.js)
        async function authenticatedFetch(url, options = {}) {
            const token = localStorage.getItem('authToken');
            const headers = {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
                ...(options.headers || {})
            };
            return fetch(url, { ...options, headers });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const oppId = getOpportunityIdFromUrl();
            if (!oppId) {
                showAlert("Paramètre 'opportunity_id' manquant dans l'URL", 'danger');
                return;
            }
            loadOpportunityStages(oppId);
        });

        function getOpportunityIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('opportunity_id');
        }

        async function loadOpportunityStages(opportunityId) {
            showLoading(true);
            try {
                const resp = await authenticatedFetch(`${API_BASE_URL}/opportunity-stages/opportunity/${opportunityId}`);
                const json = await resp.json();
                if (!json.success) throw new Error(json.error || 'Erreur API');

                renderOpportunityHeader(json.data.opportunity);
                renderStats(json.data.stats);
                renderStagesTable(json.data.stages);
                renderKanban(json.data.stages);
                loadAlerts(opportunityId);
            } catch (e) {
                console.error(e);
                showAlert("Erreur lors du chargement des étapes de l'opportunité", 'danger');
            } finally {
                showLoading(false);
            }
        }

        function renderOpportunityHeader(opportunity) {
            if (!opportunity) return;
            const nameEl = document.getElementById('opp-name');
            const statusEl = document.getElementById('opp-status');
            nameEl.textContent = `— ${opportunity.nom || ''}`;
            statusEl.textContent = opportunity.statut || '';
            const badgeClass = statusBadges[opportunity.statut] || 'bg-secondary';
            statusEl.className = `badge ${badgeClass}`;
        }

        function renderStats(stats) {
            if (!stats) return;
            document.getElementById('stats-cards').style.display = '';
            document.getElementById('stat-total').textContent = stats.total_stages || 0;
            document.getElementById('stat-completed').textContent = stats.completed_stages || 0;
            document.getElementById('stat-inprogress').textContent = stats.in_progress_stages || 0;
            document.getElementById('stat-pending').textContent = stats.pending_stages || 0;
        }

        function renderStagesTable(stages) {
            const tbody = document.getElementById('stages-table');
            tbody.innerHTML = '';
            if (!stages || stages.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            <i class="fas fa-project-diagram fa-2x mb-3"></i>
                            <p>Aucune étape trouvée pour cette opportunité</p>
                        </td>
                    </tr>`;
                return;
            }

            stages.forEach((st) => {
                const canStart = st.status === 'PENDING';
                const canComplete = st.status === 'IN_PROGRESS';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${st.stage_order}</td>
                    <td>
                        <div class="fw-semibold">${st.stage_name || st.nom}</div>
                        <div class="text-muted small">${st.template_description || st.description || ''}</div>
                    </td>
                    <td>
                        <span class="badge ${st.status === 'COMPLETED' ? 'bg-success' : st.status === 'IN_PROGRESS' ? 'bg-warning text-dark' : 'bg-secondary'}">${st.status}</span>
                    </td>
                    <td>${st.due_date ? new Date(st.due_date).toLocaleDateString('fr-FR') : '-'}</td>
                    <td>${st.risk_level || '-'}</td>
                    <td>${st.priority_level || '-'}</td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-primary" ${canStart ? '' : 'disabled'} onclick="startStage('${st.id}')" title="Démarrer">
                                <i class="fas fa-play"></i>
                            </button>
                            <button class="btn btn-outline-success" ${canComplete ? '' : 'disabled'} onclick="completeStage('${st.id}')" title="Terminer">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn btn-outline-secondary" ${canComplete ? '' : 'disabled'} onclick="nextStage('${st.id}')" title="Terminer et passer à la suivante">
                                <i class="fas fa-forward"></i>
                            </button>
                            <button class="btn btn-outline-info" onclick="openSchedule('${st.id}', '${st.due_date || ''}', '${(st.notes || '').toString().replace(/"/g, '&quot;')}')" title="Planifier / Notes">
                                <i class="fas fa-calendar-alt"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderKanban(stages) {
            const pending = document.getElementById('kanban-pending');
            const inprogress = document.getElementById('kanban-inprogress');
            const completed = document.getElementById('kanban-completed');
            pending.innerHTML = inprogress.innerHTML = completed.innerHTML = '';
            (stages || []).forEach(st => {
                const card = document.createElement('div');
                card.className = 'kanban-card';
                card.draggable = st.status !== 'COMPLETED';
                card.dataset.stageId = st.id;
                card.innerHTML = `
                    <div class="fw-semibold">${st.stage_name || st.nom}</div>
                    <div class="small-muted">#${st.stage_order} • ${st.due_date ? new Date(st.due_date).toLocaleDateString('fr-FR') : '—'} • ${st.risk_level || '—'}</div>
                `;
                card.addEventListener('dragstart', onDragStart);
                card.addEventListener('dragend', onDragEnd);
                if (st.status === 'PENDING') pending.appendChild(card);
                else if (st.status === 'IN_PROGRESS') inprogress.appendChild(card);
                else completed.appendChild(card);
            });
            initDroppables();
        }

        function onDragStart(e) {
            e.dataTransfer.setData('text/plain', e.target.dataset.stageId);
        }
        function onDragEnd() {}
        function initDroppables() {
            document.querySelectorAll('.kanban-column').forEach(col => {
                col.addEventListener('dragover', e => { e.preventDefault(); col.classList.add('droppable-hover'); });
                col.addEventListener('dragleave', () => col.classList.remove('droppable-hover'));
                col.addEventListener('drop', async e => {
                    e.preventDefault();
                    col.classList.remove('droppable-hover');
                    const stageId = e.dataTransfer.getData('text/plain');
                    const targetStatus = col.dataset.status;
                    await moveViaKanban(stageId, targetStatus);
                });
            });
        }

        async function moveViaKanban(stageId, targetStatus) {
            try {
                if (targetStatus === 'IN_PROGRESS') {
                    await startStage(stageId);
                } else if (targetStatus === 'COMPLETED') {
                    // si PENDING -> IN_PROGRESS puis COMPLETE
                    await startStage(stageId).catch(() => {});
                    await completeStage(stageId);
                }
            } catch (e) {
                console.error(e);
                showAlert(e.message || 'Déplacement impossible', 'warning');
            }
        }

        async function startStage(stageId) {
            try {
                const resp = await authenticatedFetch(`${API_BASE_URL}/opportunity-stages/${stageId}/start`, { method: 'POST' });
                const json = await resp.json();
                if (!json.success) throw new Error(json.error || 'Erreur');
                reload();
            } catch (e) {
                console.error(e);
                showAlert(e.message || "Erreur lors du démarrage de l'étape", 'danger');
            }
        }

        async function completeStage(stageId) {
            try {
                const resp = await authenticatedFetch(`${API_BASE_URL}/opportunity-stages/${stageId}/complete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const json = await resp.json();
                if (!json.success) throw new Error(json.error || 'Erreur');
                reload();
            } catch (e) {
                console.error(e);
                showAlert(e.message || "Erreur lors de la finalisation de l'étape", 'danger');
            }
        }

        async function nextStage(stageId) {
            try {
                const resp = await authenticatedFetch(`${API_BASE_URL}/opportunity-stages/${stageId}/next`, { method: 'POST' });
                const json = await resp.json();
                if (!json.success) throw new Error(json.error || 'Erreur');
                reload();
            } catch (e) {
                console.error(e);
                showAlert(e.message || "Erreur lors du passage à l'étape suivante", 'danger');
            }
        }

        function reload() {
            const oppId = getOpportunityIdFromUrl();
            if (oppId) loadOpportunityStages(oppId);
        }

        // Alertes
        async function loadAlerts(opportunityId) {
            try {
                const cont = document.getElementById('alerts-container');
                const resp = await authenticatedFetch(`${API_BASE_URL}/opportunity-stages/opportunity/${opportunityId}/alerts`);
                const json = await resp.json();
                const alerts = json?.data?.alerts || [];
                if (alerts.length === 0) { cont.innerHTML = '<div class="text-muted">Aucune alerte.</div>'; return; }
                cont.innerHTML = alerts.map(a => `
                    <div class="d-flex align-items-center justify-content-between border rounded p-2 mb-2">
                        <div>
                            <div class="fw-semibold">${a.stage_name}</div>
                            <div class="small text-muted">Échéance: ${a.due_date ? new Date(a.due_date).toLocaleDateString('fr-FR') : '—'} • Risque: ${a.risk_level || '—'} • Priorité: ${a.priority_level || '—'}</div>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary" onclick="recomputeRisk('${a.id}')"><i class="fas fa-gauge-high"></i></button>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error(e);
            }
        }
        document.getElementById('btn-refresh-alerts').addEventListener('click', () => {
            const oppId = getOpportunityIdFromUrl();
            if (oppId) loadAlerts(oppId);
        });

        async function recomputeRisk(stageId) {
            try {
                const resp = await authenticatedFetch(`${API_BASE_URL}/opportunity-stages/${stageId}/recompute-risk`, { method: 'POST' });
                const json = await resp.json();
                if (!json.success) throw new Error(json.error || 'Erreur');
                reload();
            } catch (e) {
                console.error(e);
                showAlert("Erreur lors du recalcul du risque", 'danger');
            }
        }

        // Planification (due_date, notes)
        function openSchedule(stageId, dueDate, notes) {
            const newDue = prompt("Nouvelle échéance (YYYY-MM-DD)", (dueDate || '').substring(0,10));
            if (newDue === null) return;
            const newNotes = prompt("Notes (optionnel)", notes || '');
            updateSchedule(stageId, newDue, newNotes);
        }
        async function updateSchedule(stageId, dueDate, notes) {
            try {
                const resp = await authenticatedFetch(`${API_BASE_URL}/opportunity-stages/${stageId}/schedule`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ due_date: dueDate, notes })
                });
                const json = await resp.json();
                if (!json.success) throw new Error(json.error || 'Erreur');
                reload();
            } catch (e) {
                console.error(e);
                showAlert("Erreur lors de la mise à jour de l'échéance", 'danger');
            }
        }

        function showLoading(show) {
            document.getElementById('stages-loading').style.display = show ? 'flex' : 'none';
            document.getElementById('stages-content').style.display = show ? 'none' : 'block';
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            const container = document.querySelector('.main-content-area');
            if (container) {
                container.insertBefore(alertDiv, container.firstChild);
            } else {
                document.body.appendChild(alertDiv);
            }
            setTimeout(() => {
                if (alertDiv.parentNode) alertDiv.remove();
            }, 5000);
        }
    </script>

    <!-- SessionManager pour la gestion centralisée des sessions -->
    <script src="/js/session-manager.js"></script>
</body>
</html>