<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Objectifs</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/modern-sidebar.css">

    <!-- Script d'authentification -->
    <script src="js/auth.js"></script>
    <script src="js/menu-permissions.js"></script>
    <script src="/js/page-permissions.js"></script>

    <!-- Scripts de zone utilisateur -->
    <script src="js/user-header.js"></script>
    <script src="js/profile-menu.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/tasks.js"></script>

    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #f8f9fa;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            overflow-x: hidden;
        }

        .page-wrapper {
            display: flex;
            min-height: 100vh;
        }

        .main-content-area {
            flex-grow: 1;
            padding: 2rem;
            background-color: var(--light-bg);
        }

        .badge-statut {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }

        .stats-card {
            transition: transform 0.2s;
        }

        .stats-card:hover {
            transform: translateY(-2px);
        }

        .objective-card {
            border-left: 4px solid var(--primary-color);
            margin-bottom: 1rem;
        }

        .objective-card.global {
            border-left-color: var(--primary-color);
        }

        .objective-card.bu {
            border-left-color: var(--secondary-color);
        }

        .objective-card.division {
            border-left-color: var(--success-color);
        }

        @media (max-width: 768px) {
            .page-wrapper {
                flex-direction: column;
            }

            .main-content-area {
                padding: 1rem;
            }
        }
    </style>

    <!-- CSS des variables de branding dynamiques -->
    <link rel="stylesheet" href="/config/themes/brand-variables.css">

    <!-- Scripts de branding -->
    <script src="js/branding-loader.js"></script>
    <script src="js/sidebar-branding.js"></script>
</head>

<body>
    <button class="sidebar-toggle d-md-none">
        <i class="fas fa-bars"></i>
    </button>
    <div class="page-wrapper">
        <div class="sidebar-container"></div>

        <div class="main-content-area">
            <div class="container-fluid">
                <!-- En-t√™te -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h1 class="h3 mb-0">
                                    <i class="fas fa-bullseye text-primary me-2"></i>
                                    Gestion des Objectifs
                                </h1>
                                <p class="text-muted mb-0">D√©finissez et suivez les objectifs strat√©giques</p>
                            </div>
                            <div class="d-flex gap-2">
                                <select class="form-select" id="fiscalYearSelect" style="width: 200px;">
                                    <option value="">Chargement...</option>
                                </select>
                                <a href="objectives-config.html" class="btn btn-outline-secondary"
                                    title="Configurer m√©triques et types">
                                    <i class="fas fa-cog"></i>
                                </a>
                                <button class="btn btn-outline-primary" id="btnLibrary"
                                    onclick="openTemplateLibraryModal()">
                                    <i class="fas fa-book-open me-2"></i>Depuis Biblioth√®que
                                </button>
                                <button class="btn btn-info text-white" id="btnCreateIndividual"
                                    onclick="openIndividualWizard()">
                                    <i class="fas fa-user-check me-2"></i>Affecter Objectifs
                                </button>
                                <button class="btn btn-primary" onclick="openCreateObjectiveModal()">
                                    <i class="fas fa-plus me-2"></i>Nouvel Objectif
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Statistiques Globales -->
                <div class="row mb-4" id="statsContainer">
                    <div class="col-md-3">
                        <div class="card stats-card border-primary">
                            <div class="card-body text-primary">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h6 class="card-title">Budget Global</h6>
                                        <h3 class="mb-0 fw-bold" id="globalBudget">-</h3>
                                    </div>
                                    <div class="align-self-center">
                                        <i class="fas fa-euro-sign currency-icon fa-2x opacity-75"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card border-success">
                            <div class="card-body text-success">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h6 class="card-title">Objectifs Atteints</h6>
                                        <h3 class="mb-0 fw-bold" id="achievedObjectives">-</h3>
                                    </div>
                                    <div class="align-self-center">
                                        <i class="fas fa-check-circle fa-2x opacity-75"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card border-info">
                            <div class="card-body text-info">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h6 class="card-title">Progression Globale</h6>
                                        <h3 class="mb-0 fw-bold" id="globalProgress">-</h3>
                                    </div>
                                    <div class="align-self-center">
                                        <i class="fas fa-chart-line fa-2x opacity-75"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card border-warning">
                            <div class="card-body text-warning">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h6 class="card-title">Objectifs en Retard</h6>
                                        <h3 class="mb-0 fw-bold" id="delayedObjectives">-</h3>
                                    </div>
                                    <div class="align-self-center">
                                        <i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contenu Principal -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <ul class="nav nav-tabs card-header-tabs" id="objectivesTabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="global-tab" data-bs-toggle="tab"
                                            data-bs-target="#global" type="button" role="tab">
                                            <i class="fas fa-globe me-2"></i>Objectifs Globaux
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="bu-tab" data-bs-toggle="tab" data-bs-target="#bu"
                                            type="button" role="tab">
                                            <i class="fas fa-building me-2"></i>Par Business Unit
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="division-tab" data-bs-toggle="tab"
                                            data-bs-target="#division" type="button" role="tab">
                                            <i class="fas fa-sitemap me-2"></i>Par Division
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="individual-tab" data-bs-toggle="tab"
                                            data-bs-target="#individual" type="button" role="tab">
                                            <i class="fas fa-user-check me-2"></i>Individuels
                                        </button>
                                    </li>
                                </ul>
                            </div>
                            <div class="card-body">
                                <div class="tab-content" id="objectivesTabContent">
                                    <!-- Onglet Objectifs Globaux -->
                                    <div class="tab-pane fade show active" id="global" role="tabpanel">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h5 class="card-title">Objectifs Strat√©giques de
                                                l'Entreprise</h5>
                                            <div class="btn-group">
                                                <button class="btn btn-outline-secondary btn-sm"
                                                    onclick="refreshObjectives()">
                                                    <i class="fas fa-sync-alt"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div id="globalObjectivesList">
                                            <div class="text-center text-muted py-5">
                                                <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                                                <p>Chargement des objectifs...</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Onglet Business Units -->
                                    <div class="tab-pane fade" id="bu" role="tabpanel">
                                        <div class="row mb-3">
                                            <div class="col-md-4">
                                                <select class="form-select" id="buSelect" onchange="loadBuObjectives()">
                                                    <option value="">Toutes les Business Units</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div id="buObjectivesList">
                                            <div class="text-center text-muted py-5">
                                                <p>S√©lectionnez une Business Unit pour voir ses
                                                    objectifs</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Onglet Divisions -->
                                    <div class="tab-pane fade" id="division" role="tabpanel">
                                        <div class="row mb-3">
                                            <div class="col-md-4">
                                                <select class="form-select" id="divisionSelect"
                                                    onchange="loadDivisionObjectives()">
                                                    <option value="">Toutes les Divisions</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div id="divisionObjectivesList">
                                            <div class="text-center text-muted py-5">
                                                <p>S√©lectionnez une Division pour voir ses objectifs</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Onglet Objectifs Individuels -->
                                    <div class="tab-pane fade" id="individual" role="tabpanel">
                                        <div class="row g-3 mb-4 align-items-end">
                                            <div class="col-md-3">
                                                <label class="form-label small fw-bold">Business Unit</label>
                                                <select class="form-select" id="individualBuSelect">
                                                    <option value="">Toutes les BUs</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small fw-bold">Division</label>
                                                <select class="form-select" id="individualDivisionSelect">
                                                    <option value="">Toutes les Divisions</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small fw-bold">Collaborateur</label>
                                                <select class="form-select" id="individualCollaboratorSelect">
                                                    <option value="">Tous les collaborateurs</option>
                                                </select>
                                            </div>
                                            <div class="col-md-2 text-end">
                                                <button class="btn btn-outline-secondary"
                                                    onclick="refreshIndividualObjectives()">
                                                    <i class="fas fa-sync-alt"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div id="individualObjectivesList">
                                            <div class="text-center text-muted py-5">
                                                <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                                                <p>Chargement des objectifs individuels...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de cr√©ation/√©dition d'objectif -->
    <div class="modal fade" id="objectiveModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="objectiveModalTitle">Nouvel Objectif</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="objectiveForm">
                        <input type="hidden" id="objectiveId">
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="objectiveTitle" class="form-label">Titre de l'objectif
                                    *</label>
                                <input type="text" class="form-control" id="objectiveTitle" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="objectiveDeadline" class="form-label">Date limite</label>
                                <input type="date" class="form-control" id="objectiveDeadline">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="objectiveScope" class="form-label">Port√©e *</label>
                                <select class="form-select" id="objectiveScope" required
                                    onchange="toggleScopeSelects()">
                                    <option value="GLOBAL">Global (Entreprise)</option>
                                    <option value="BU">Business Unit</option>
                                    <option value="DIVISION">Division</option>
                                    <option value="GRADE">Grade (Groupe de collaborateurs)</option>
                                </select>
                            </div>
                        </div>
                        <div class="row" id="scopeSelects" style="display: none;">
                            <div class="col-md-12 mb-3" id="buSelectContainer" style="display: none;">
                                <label for="objectiveBu" class="form-label">Business Unit</label>
                                <select class="form-select" id="objectiveBu">
                                    <option value="">S√©lectionner une BU...</option>
                                </select>
                            </div>
                            <div class="col-md-12 mb-3" id="divisionSelectContainer" style="display: none;">
                                <label for="objectiveDivision" class="form-label">Division</label>
                                <select class="form-select" id="objectiveDivision">
                                    <option value="">S√©lectionner une Division...</option>
                                </select>
                            </div>
                            <div class="col-md-12 mb-3" id="gradeSelectContainer" style="display: none;">
                                <label for="objectiveGrade" class="form-label">Grade Cible</label>
                                <select class="form-select" id="objectiveGrade">
                                    <option value="">S√©lectionner un Grade...</option>
                                </select>
                            </div>
                        </div>

                        <hr>
                        <h6 class="mb-3">Type d'objectif</h6>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="objectiveNature"
                                        id="objectiveAutonomous" value="AUTONOMOUS" checked
                                        onchange="toggleParentObjective()">
                                    <label class="form-check-label" for="objectiveAutonomous">
                                        ‚≠ê Objectif Autonome (nouveau)
                                    </label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="objectiveNature"
                                        id="objectiveCascaded" value="CASCADED" onchange="toggleParentObjective()">
                                    <label class="form-check-label" for="objectiveCascaded">
                                        üîó Distribution d'un objectif parent
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="row" id="parentObjectiveContainer" style="display: none;">
                            <div class="col-md-8 mb-3">
                                <label for="parentObjective" class="form-label">Objectif Parent</label>
                                <select class="form-select" id="parentObjective" onchange="updateRemainingAmount()">
                                    <option value="">S√©lectionner un objectif parent...</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Montant Restant</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="remainingAmount" readonly>
                                    <span class="input-group-text currency-symbol">‚Ç¨</span>
                                </div>
                            </div>
                        </div>

                        <hr>
                        <h6 class="mb-3">Suivi de l'objectif</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="trackingType" class="form-label">Type de suivi</label>
                                <select class="form-select" id="trackingType" onchange="toggleTrackingFields()">
                                    <option value="MANUAL">Manuel</option>
                                    <option value="AUTOMATIC">Automatique (Syst√®me)</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3" id="metricCodeContainer" style="display: none;">
                                <label for="metricCode" class="form-label">M√©trique Syst√®me</label>
                                <select class="form-select" id="metricCode">
                                    <option value="">S√©lectionner une m√©trique...</option>
                                    <option value="CAMPAIGNS_COUNT">Nombre de Campagnes</option>
                                    <option value="CONVERSION_RATE">Taux de Conversion (%)</option>
                                    <option value="OPPORTUNITIES_WON">Opportunit√©s Gagn√©es</option>
                                    <option value="MISSIONS_COUNT">Missions Actives</option>
                                    <option value="REVENUE_GENERATED">Chiffre d'Affaires (‚Ç¨)</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="saveObjective()">Enregistrer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Biblioth√®que de Templates -->
    <div class="modal fade" id="templateLibraryModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-book-open me-2"></i>Biblioth√®que d'Objectifs Standards
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <p class="text-muted mb-4">
                        <i class="fas fa-info-circle me-1"></i>
                        S√©lectionnez les objectifs √† cr√©er pour l'exercice <strong id="tplFiscalYearLabel"></strong> et
                        d√©finissez la valeur cible pour chacun.
                    </p>

                    <div id="templateLibraryContent">
                        <div class="text-center py-5">
                            <i class="fas fa-spinner fa-spin fa-2x text-primary mb-3"></i>
                            <p class="text-muted">Chargement des templates...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <span class="text-muted me-auto small" id="tplSelectionCount">0 objectif(s) s√©lectionn√©(s)</span>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="createFromSelectedTemplates()"
                        id="tplCreateBtn" disabled>
                        <i class="fas fa-plus me-2"></i>Cr√©er les objectifs s√©lectionn√©s
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/sidebar.js"></script>
    <script src="js/fiscal-year-selector.js"></script>
    <script src="js/session-manager.js"></script>

    <!-- Gestion des devises -->
    <script src="js/currency-config.js"></script>
    <script src="js/currency-context.js"></script>

    <script src="js/objectives-management.js"></script>
    <!-- Wizards pour cr√©ation d'objectifs -->
    <script src="js/objectives-wizards.js"></script>
    <script src="js/objectives-wizards-inject.js"></script>
    <!-- Enhancement: Support mode dual (M√âTRIQUE vs TYPE) -->
    <script src="js/objectives-wizard-dual-mode.js"></script>
    <!-- Biblioth√®que de templates d'objectifs -->
    <script src="js/objectives-templates.js"></script>
</body>

</html>