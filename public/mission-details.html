<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRS Dashboard - Détails Mission</title>
    
    <!-- CSS Bootstrap et FontAwesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/modern-sidebar.css">
    <script src="/js/currency-config.js" defer></script>
    
    <!-- Script d'authentification -->
    <script src="js/auth.js"></script>
    <!-- SessionManager pour la gestion centralisée des sessions -->
    <script src="js/session-manager.js"></script>
    
    <!-- Scripts de zone utilisateur -->
    <script src="js/user-header.js"></script>
    <script src="js/user-modals.js"></script>
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #f8f9fa;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            overflow-x: hidden;
        }
        
        .page-wrapper {
            display: flex;
            min-height: 100vh;
        }

        .main-content-area {
            flex-grow: 1;
            padding: 2rem;
            background-color: var(--light-bg);
        }
        
        /* Styles spécifiques pour la sidebar (si non gérés par modern-sidebar.css) */
        .sidebar-container {
            width: 300px; /* Largeur fixe pour la sidebar */
            flex-shrink: 0; /* Empêche la sidebar de rétrécir */
        }

        /* Ajustements pour les petits écrans */
        @media (max-width: 768px) {
            .page-wrapper {
                flex-direction: column; /* Empile la sidebar et le contenu */
            }
            .sidebar-container {
                width: 100%; /* La sidebar prend toute la largeur */
                height: auto; /* Hauteur automatique */
            }
            .main-content-area {
                padding: 1rem;
            }
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .nav-tabs .nav-link {
            border: none;
            border-radius: 0;
            color: #6c757d;
            font-weight: 500;
            padding: 1rem 1.5rem;
        }
        
        .nav-tabs .nav-link.active {
            background-color: var(--primary-color);
            color: white;
            border: none;
        }
        
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-en_cours { background-color: #e3f2fd; color: #1976d2; }
        .status-terminee { background-color: #e8f5e8; color: #388e3c; }
        .status-suspendue { background-color: #fff3e0; color: #f57c00; }
        .status-annulee { background-color: #ffebee; color: #d32f2f; }
        
        .back-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .back-button:hover {
            background: #34495e;
            color: white;
            text-decoration: none;
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <!-- Sidebar Container -->
        <div class="sidebar-container">
            <!-- La sidebar sera générée par JavaScript -->
        </div>

        <!-- Main Content Area -->
        <div class="main-content-area">
                <!-- Bouton retour -->
                <a href="missions.html" class="back-button">
                    <i class="fas fa-arrow-left"></i>
                    Retour aux missions
                </a>

                <!-- En-tête de la mission -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h2 id="missionTitle">Chargement...</h2>
                                <p class="text-muted mb-0" id="missionCode">Code: ...</p>
                            </div>
                            <div class="col-md-4 text-end">
                                <span id="missionStatus" class="status-badge">...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Onglets -->
                <div class="card">
                    <div class="card-header">
                        <ul class="nav nav-tabs" id="missionTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab">
                                    <i class="fas fa-info-circle me-2"></i>Informations
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="financial-tab" data-bs-toggle="tab" data-bs-target="#financial" type="button" role="tab">
                                    <i class="fas fa-euro-sign me-2"></i>Paramètres financiers
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="planning-tab" data-bs-toggle="tab" data-bs-target="#planning" type="button" role="tab">
                                    <i class="fas fa-calendar-alt me-2"></i>Planning
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="invoicing-tab" data-bs-toggle="tab" data-bs-target="#invoicing" type="button" role="tab">
                                    <i class="fas fa-file-invoice me-2"></i>Facturation
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="evolution-tab" data-bs-toggle="tab" data-bs-target="#evolution" type="button" role="tab">
                                    <i class="fas fa-chart-line me-2"></i>Évolution
                                </button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content" id="missionTabContent">
                            <!-- Onglet Informations -->
                            <div class="tab-pane fade show active" id="info" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h5>Informations générales</h5>
                                        <div class="card">
                                                                                         <div class="card-body">
                                                 <p><strong>Client:</strong> <span id="missionClient">...</span></p>
                                                 <p><strong>Type de mission:</strong> <span id="missionType">...</span></p>
                                                 <p><strong>Responsable:</strong> <span id="missionResponsable">...</span></p>
                                                 <p><strong>Associé en charge:</strong> <span id="missionAssocie">...</span></p>
                                                 <p><strong>Business Unit:</strong> <span id="missionBusinessUnit">...</span></p>
                                                 <p><strong>Division:</strong> <span id="missionDivision">...</span></p>
                                                 <p><strong>Année fiscale:</strong> <span id="missionFiscalYear">...</span></p>
                                                 <p><strong>Créé par:</strong> <span id="missionCreatedBy">...</span></p>
                                                 <p><strong>Date de création:</strong> <span id="missionCreatedAt">...</span></p>
                                             </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h5>Dates et durée</h5>
                                        <div class="card">
                                            <div class="card-body">
                                                <p><strong>Début:</strong> <span id="missionStartDate">...</span></p>
                                                <p><strong>Fin prévue:</strong> <span id="missionEndDate">...</span></p>
                                                <p><strong>Fin réelle:</strong> <span id="missionRealEndDate">...</span></p>
                                                <p><strong>Durée:</strong> <span id="missionDuration">...</span></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-4">
                                    <div class="col-12">
                                        <h5>Description</h5>
                                        <div class="card">
                                            <div class="card-body">
                                                <p id="missionDescription">...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Onglet Paramètres financiers -->
                            <div class="tab-pane fade" id="financial" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6>Configuration des honoraires</h6>
                                            </div>
                                            <div class="card-body">
                                                <p><strong>Montant:</strong> <span id="honorairesMontant">...</span></p>
                                                <p><strong>Devise:</strong> <span id="honorairesDevise">...</span></p>
                                                <p><strong>Description:</strong> <span id="honorairesDescription">...</span></p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6>Configuration des débours</h6>
                                            </div>
                                            <div class="card-body">
                                                <p><strong>Montant:</strong> <span id="deboursMontant">...</span></p>
                                                <p><strong>Devise:</strong> <span id="deboursDevise">...</span></p>
                                                <p><strong>Description:</strong> <span id="deboursDescription">...</span></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mt-4">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6>Conditions de paiement</h6>
                                            </div>
                                            <div class="card-body">
                                                <div id="paymentConditions">...</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Onglet Planning -->
                            <div class="tab-pane fade" id="planning" role="tabpanel">
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h5><i class="fas fa-calendar-alt me-2"></i>Planning de la Mission</h5>
                                            <button class="btn btn-primary" onclick="openPlanningEditor()">
                                                <i class="fas fa-edit me-2"></i>Modifier le Planning
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6><i class="fas fa-users me-2"></i>Équipe de mission</h6>
                                            </div>
                                            <div class="card-body">
                                                <div id="missionTeam">...</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6><i class="fas fa-tasks me-2"></i>Tâches planifiées</h6>
                                            </div>
                                            <div class="card-body">
                                                <div id="missionTasks">...</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Onglet Facturation -->
                            <div class="tab-pane fade" id="invoicing" role="tabpanel">
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h5>Factures générées</h5>
                                            <button class="btn btn-primary" onclick="createInvoiceFromMission()">
                                                <i class="fas fa-plus me-2"></i>Créer une facture
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-8">
                                        <div id="invoicesList">...</div>
                                    </div>
                                    <div class="col-md-4">
                                        <h5>Statistiques de facturation</h5>
                                        <div class="card">
                                            <div class="card-body">
                                                <p><strong>Total facturé:</strong> <span id="totalInvoiced">...</span></p>
                                                <p><strong>Total payé:</strong> <span id="totalPaid">...</span></p>
                                                <p><strong>En attente:</strong> <span id="totalPending">...</span></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Onglet Évolution -->
                            <div class="tab-pane fade" id="evolution" role="tabpanel">
                                <div class="row">
                                    <div class="col-12">
                                        <h5>Progression des tâches</h5>
                                        <div id="tasksProgress">...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/auth.js" defer></script>
    <script src="/js/sidebar.js" defer></script>
    <script>
        // Variables globales
        let currentMission = null;
        let missionId = null;

        // Fonction utilitaire pour les appels API authentifiés
        async function authenticatedFetch(url, options = {}) {
            const token = localStorage.getItem('authToken');
            const defaultHeaders = {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
            
            return fetch(url, {
                ...options,
                headers: {
                    ...defaultHeaders,
                    ...options.headers
                }
            });
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // Récupérer l'ID de la mission depuis l'URL
            const urlParams = new URLSearchParams(window.location.search);
            missionId = urlParams.get('id');
            
            if (missionId) {
                loadMissionDetails(missionId);
            } else {
                showError('ID de mission manquant');
            }
        });

        // Chargement des détails de la mission
        async function loadMissionDetails(id) {
            try {
                const response = await authenticatedFetch(`/api/missions/${id}`);
                if (response.ok) {
                    const data = await response.json();
                    currentMission = data.data;
                    displayMissionDetails();
                } else {
                    showError('Erreur lors du chargement de la mission');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showError('Erreur de connexion');
            }
        }

        // Affichage des détails de la mission
        function displayMissionDetails() {
            if (!currentMission) return;

            // Informations générales
            document.getElementById('missionTitle').textContent = currentMission.nom || currentMission.titre || 'Sans titre';
            document.getElementById('missionCode').textContent = `Code: ${currentMission.code || 'N/A'}`;
            document.getElementById('missionStatus').textContent = currentMission.statut || 'N/A';
            document.getElementById('missionStatus').className = `status-badge status-${(currentMission.statut || '').toLowerCase()}`;

            // Onglet Informations
            document.getElementById('missionClient').textContent = currentMission.client_nom || 'N/A';
            document.getElementById('missionType').textContent = currentMission.mission_type_nom || currentMission.type_mission || 'N/A';
            document.getElementById('missionResponsable').textContent = formatResponsable(currentMission.responsable_nom, currentMission.responsable_prenom);
            document.getElementById('missionAssocie').textContent = formatResponsable(currentMission.associe_nom, currentMission.associe_prenom);
            document.getElementById('missionBusinessUnit').textContent = currentMission.business_unit_nom || 'N/A';
            document.getElementById('missionDivision').textContent = currentMission.division_nom || 'N/A';
            document.getElementById('missionFiscalYear').textContent = currentMission.fiscal_year_annee || 'N/A';
            document.getElementById('missionCreatedBy').textContent = formatResponsable(currentMission.created_by_nom, currentMission.created_by_prenom);
            document.getElementById('missionCreatedAt').textContent = formatDate(currentMission.created_at || currentMission.date_creation);
            document.getElementById('missionStartDate').textContent = formatDate(currentMission.date_debut);
            document.getElementById('missionEndDate').textContent = formatDate(currentMission.date_fin_prevue || currentMission.date_fin);
            document.getElementById('missionRealEndDate').textContent = formatDate(currentMission.date_fin_reelle);
            document.getElementById('missionDuration').textContent = calculateDuration(currentMission.date_debut, currentMission.date_fin_reelle || currentMission.date_fin_prevue || currentMission.date_fin);
            document.getElementById('missionDescription').textContent = currentMission.description || 'Aucune description disponible';

            // Onglet Paramètres financiers
            displayFinancialData();

            // Onglet Planning
            displayPlanningData();

            // Onglet Facturation
            displayInvoicingData();

            // Onglet Évolution
            displayEvolutionData();
        }

        // Affichage des données financières
        function displayFinancialData() {
            const honoraires = currentMission.montant_honoraires || 0;
            const debours = currentMission.montant_debours || 0;
            const devise = currentMission.devise || 'XAF';

            document.getElementById('honorairesMontant').textContent = formatCurrency(honoraires, devise);
            document.getElementById('honorairesDevise').textContent = devise;
            document.getElementById('honorairesDescription').textContent = currentMission.description_honoraires || 'N/A';

            document.getElementById('deboursMontant').textContent = formatCurrency(debours, devise);
            document.getElementById('deboursDevise').textContent = devise;
            document.getElementById('deboursDescription').textContent = currentMission.description_debours || 'N/A';

            // Conditions de paiement
            const conditions = currentMission.conditions_paiement;
            if (conditions) {
                try {
                    const conditionsData = JSON.parse(conditions);
                    let conditionsHtml = '';
                                         conditionsData.forEach((condition, index) => {
                         conditionsHtml += `
                             <div class="border-bottom pb-2 mb-2">
                                 <div class="row">
                                     <div class="col-md-2">${condition.pourcentage_honoraires || 0}% Honoraires</div>
                                     <div class="col-md-2">${formatCurrency(condition.montant_honoraires || 0, devise)}</div>
                                     <div class="col-md-2">${condition.pourcentage_debours || 0}% Débours</div>
                                     <div class="col-md-2">${formatCurrency(condition.montant_debours || 0, devise)}</div>
                                     <div class="col-md-2">${formatDate(condition.date)}</div>
                                     <div class="col-md-2">${condition.details || ''}</div>
                                 </div>
                             </div>
                         `;
                     });
                    document.getElementById('paymentConditions').innerHTML = conditionsHtml;
                } catch (e) {
                    document.getElementById('paymentConditions').textContent = conditions;
                }
            } else {
                document.getElementById('paymentConditions').textContent = 'Aucune condition de paiement définie';
            }
        }

        // Affichage des données de planning
        async function displayPlanningData() {
            try {
                // Charger l'équipe
                const teamResponse = await authenticatedFetch(`/api/missions/${missionId}/team`);
                if (teamResponse.ok) {
                    const teamData = await teamResponse.json();
                    displayTeamData(teamData.data);
                } else {
                    document.getElementById('missionTeam').innerHTML = `
                        <div class="text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            Aucune équipe assignée à cette mission
                        </div>
                    `;
                }

                // Charger les tâches
                const tasksResponse = await authenticatedFetch(`/api/missions/${missionId}/tasks`);
                if (tasksResponse.ok) {
                    const tasksData = await tasksResponse.json();
                    displayTasksData(tasksData.data);
                } else {
                    document.getElementById('missionTasks').innerHTML = `
                        <div class="text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            Aucune tâche planifiée pour cette mission
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erreur lors du chargement des données de planning:', error);
                document.getElementById('missionTeam').innerHTML = `
                    <div class="text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Erreur lors du chargement de l'équipe
                    </div>
                `;
                document.getElementById('missionTasks').innerHTML = `
                    <div class="text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Erreur lors du chargement des tâches
                    </div>
                `;
            }
        }

        // Affichage des données d'équipe
        function displayTeamData(team) {
            if (!team || team.length === 0) {
                document.getElementById('missionTeam').innerHTML = `
                    <div class="text-muted">
                        <i class="fas fa-info-circle me-2"></i>
                        Aucune équipe assignée à cette mission
                    </div>
                `;
                return;
            }

            let teamHtml = '';
            team.forEach(member => {
                teamHtml += `
                    <div class="border-bottom pb-2 mb-2">
                        <div class="row">
                            <div class="col-md-4">
                                <strong>${member.prenom} ${member.nom}</strong>
                                <br><small class="text-muted">${member.grade_nom || 'N/A'}</small>
                            </div>
                            <div class="col-md-4">
                                <small>${member.email}</small>
                                <br><small class="text-muted">${member.telephone || 'N/A'}</small>
                            </div>
                            <div class="col-md-4">
                                <small>${member.nb_assignments} affectation(s)</small>
                                <br><small class="text-muted">${member.total_heures_planifiees || 0}h planifiées</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('missionTeam').innerHTML = teamHtml;
        }

        // Affichage des données de tâches
        function displayTasksData(tasks) {
            if (!tasks || tasks.length === 0) {
                document.getElementById('missionTasks').innerHTML = `
                    <div class="text-muted">
                        <i class="fas fa-info-circle me-2"></i>
                        Aucune tâche planifiée pour cette mission
                    </div>
                `;
                return;
            }

            let tasksHtml = '';
            tasks.forEach(task => {
                const statusClass = getStatusClass(task.statut);
                tasksHtml += `
                    <div class="border-bottom pb-2 mb-2">
                        <div class="row">
                            <div class="col-md-4">
                                <strong>${task.task_libelle || 'N/A'}</strong>
                                <br><small class="text-muted">${task.task_description || ''}</small>
                            </div>
                            <div class="col-md-2">
                                <span class="badge ${statusClass}">${task.statut || 'N/A'}</span>
                            </div>
                            <div class="col-md-2">
                                <small>Planifié: ${task.duree_planifiee || 0}h</small>
                                <br><small class="text-muted">Effectué: ${task.duree_reelle || 0}h</small>
                            </div>
                            <div class="col-md-2">
                                <small>Début: ${formatDate(task.date_debut)}</small>
                                <br><small class="text-muted">Fin: ${formatDate(task.date_fin)}</small>
                            </div>
                            <div class="col-md-2">
                                <small>${task.notes || ''}</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('missionTasks').innerHTML = tasksHtml;
        }

        // Affichage des données de facturation
        async function displayInvoicingData() {
            try {
                const devise = currentMission?.devise || 'XAF';
                
                // Charger les factures de la mission
                const response = await authenticatedFetch(`/api/invoices/mission/${missionId}`);
                if (response.ok) {
                    const invoicesData = await response.json();
                    displayInvoicesList(invoicesData.data, devise);
                } else {
                    document.getElementById('invoicesList').innerHTML = `
                        <div class="text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            Aucune facture trouvée pour cette mission
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erreur lors du chargement des factures:', error);
                document.getElementById('invoicesList').innerHTML = `
                    <div class="text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Erreur lors du chargement des factures
                    </div>
                `;
            }
        }

        // Affichage de la liste des factures
        function displayInvoicesList(invoices, devise) {
            if (!invoices || invoices.length === 0) {
                document.getElementById('invoicesList').innerHTML = `
                    <div class="text-muted">
                        <i class="fas fa-info-circle me-2"></i>
                        Aucune facture trouvée pour cette mission
                    </div>
                `;
                return;
            }

            let totalInvoiced = 0;
            let totalPaid = 0;
            let totalPending = 0;

            const invoicesHtml = invoices.map(invoice => {
                totalInvoiced += parseFloat(invoice.montant_ttc || 0);
                totalPaid += parseFloat(invoice.montant_paye || 0);
                totalPending += parseFloat(invoice.montant_restant || 0);

                return `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-3">
                                    <h6 class="mb-1">${invoice.numero_facture}</h6>
                                    <small class="text-muted">Émise le ${formatDate(invoice.date_emission)}</small>
                                </div>
                                <div class="col-md-2">
                                    <span class="badge status-${invoice.statut.toLowerCase()}">${invoice.statut}</span>
                                </div>
                                <div class="col-md-2">
                                    <strong>${formatCurrency(invoice.montant_ttc, devise)}</strong>
                                </div>
                                <div class="col-md-2">
                                    <span class="text-success">${formatCurrency(invoice.montant_paye, devise)}</span>
                                </div>
                                <div class="col-md-2">
                                    <span class="text-warning">${formatCurrency(invoice.montant_restant, devise)}</span>
                                </div>
                                <div class="col-md-1">
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewInvoice('${invoice.id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('invoicesList').innerHTML = invoicesHtml;
            document.getElementById('totalInvoiced').textContent = formatCurrency(totalInvoiced, devise);
            document.getElementById('totalPaid').textContent = formatCurrency(totalPaid, devise);
            document.getElementById('totalPending').textContent = formatCurrency(totalPending, devise);
        }

        // Fonction pour voir une facture
        function viewInvoice(invoiceId) {
            window.open(`/invoice-details.html?id=${invoiceId}`, '_blank');
        }

        // Fonction pour créer une facture depuis la mission
        async function createInvoiceFromMission() {
            try {
                // Préparer les données de la facture basées sur la mission
                const invoiceData = {
                    mission_id: missionId,
                    client_id: currentMission.client_id,
                    date_emission: new Date().toISOString().split('T')[0],
                    date_echeance: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // +30 jours
                    statut: 'BROUILLON',
                    conditions_paiement: currentMission.conditions_paiement,
                    taux_tva: 19.25,
                    adresse_facturation: currentMission.adresse_facturation || '',
                    notes_facture: `Facture générée automatiquement pour la mission: ${currentMission.nom}`
                };

                const response = await authenticatedFetch('/api/invoices', {
                    method: 'POST',
                    body: JSON.stringify(invoiceData)
                });

                if (response.ok) {
                    const result = await response.json();
                    const invoiceId = result.data.id;
                    
                    // Générer automatiquement les lignes de facture basées sur les conditions de paiement
                    const generateResponse = await authenticatedFetch(`/api/invoices/${invoiceId}/generate-items`, {
                        method: 'POST'
                    });
                    
                    if (generateResponse.ok) {
                        alert('Facture créée avec lignes générées automatiquement !');
                    } else {
                        const errorData = await generateResponse.json();
                        alert(`Facture créée mais erreur lors de la génération des lignes: ${errorData.error}`);
                    }
                    
                    // Recharger les factures
                    displayInvoicingData();
                } else {
                    const errorData = await response.json();
                    alert(`Erreur lors de la création de la facture: ${errorData.error}`);
                }
            } catch (error) {
                console.error('Erreur lors de la création de la facture:', error);
                alert('Erreur lors de la création de la facture');
            }
        }

        // Affichage des données d'évolution
        async function displayEvolutionData() {
            try {
                const response = await authenticatedFetch(`/api/missions/${missionId}/progress`);
                if (response.ok) {
                    const progressData = await response.json();
                    displayProgressData(progressData.data);
                } else {
                    document.getElementById('tasksProgress').innerHTML = `
                        <div class="text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            Aucune donnée de progression disponible
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erreur lors du chargement de la progression:', error);
                document.getElementById('tasksProgress').innerHTML = `
                    <div class="text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Erreur lors du chargement de la progression
                    </div>
                `;
            }
        }

        // Affichage des données de progression
        function displayProgressData(progressData) {
            const { stats, tasks } = progressData;
            
            let progressHtml = `
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">${stats.total_tasks || 0}</h5>
                                <p class="card-text">Total Tâches</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title text-success">${stats.completed_tasks || 0}</h5>
                                <p class="card-text">Terminées</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title text-warning">${stats.in_progress_tasks || 0}</h5>
                                <p class="card-text">En cours</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title text-info">${stats.planned_tasks || 0}</h5>
                                <p class="card-text">Planifiées</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6>Heures planifiées vs effectuées</h6>
                            </div>
                            <div class="card-body">
                                <p><strong>Planifiées:</strong> ${stats.total_planned_hours || 0} heures</p>
                                <p><strong>Effectuées:</strong> ${stats.total_actual_hours || 0} heures</p>
                                <div class="progress">
                                    <div class="progress-bar" role="progressbar" 
                                         style="width: ${stats.total_planned_hours > 0 ? (stats.total_actual_hours / stats.total_planned_hours) * 100 : 0}%">
                                        ${stats.total_planned_hours > 0 ? Math.round((stats.total_actual_hours / stats.total_planned_hours) * 100) : 0}%
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            if (tasks && tasks.length > 0) {
                progressHtml += `
                    <div class="card">
                        <div class="card-header">
                            <h6>Progression par tâche</h6>
                        </div>
                        <div class="card-body">
                `;
                
                tasks.forEach(task => {
                    const statusClass = getStatusClass(task.statut);
                    progressHtml += `
                        <div class="border-bottom pb-2 mb-2">
                            <div class="row">
                                <div class="col-md-4">
                                    <strong>${task.task_libelle || 'N/A'}</strong>
                                </div>
                                <div class="col-md-2">
                                    <span class="badge ${statusClass}">${task.statut || 'N/A'}</span>
                                </div>
                                <div class="col-md-2">
                                    <small>Planifié: ${task.duree_planifiee || 0}h</small>
                                    <br><small class="text-muted">Effectué: ${task.duree_reelle || 0}h</small>
                                </div>
                                <div class="col-md-4">
                                    <div class="progress">
                                        <div class="progress-bar" role="progressbar" 
                                             style="width: ${task.progress_percentage || 0}%">
                                            ${task.progress_percentage || 0}%
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                progressHtml += `
                        </div>
                    </div>
                `;
            } else {
                progressHtml += `
                    <div class="text-muted">
                        <i class="fas fa-info-circle me-2"></i>
                        Aucune tâche disponible pour cette mission
                    </div>
                `;
            }
            
            document.getElementById('tasksProgress').innerHTML = progressHtml;
        }

        // Utilitaires
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString('fr-FR');
        }

        function formatCurrency(amount, currencyCode = null) {
            if (!amount) {
                if (currencyCode) {
                    return CURRENCY_CONFIG.formatCurrency(0, currencyCode);
                }
                return CURRENCY_CONFIG.formatCurrency(0, 'XAF');
            }

            if (currencyCode) {
                return CURRENCY_CONFIG.formatCurrency(amount, currencyCode);
            }

            return CURRENCY_CONFIG.formatCurrency(amount, 'XAF');
        }

        function calculateDuration(startDate, endDate) {
            if (!startDate || !endDate) return 'N/A';
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            return `${diffDays} jours`;
        }

        function formatResponsable(nom, prenom) {
            if (!nom && !prenom) return 'N/A';
            if (!nom) return prenom;
            if (!prenom) return nom;
            return `${prenom} ${nom}`;
        }

        function getStatusClass(status) {
            switch (status?.toLowerCase()) {
                case 'terminee':
                case 'completed':
                    return 'bg-success';
                case 'en_cours':
                case 'in_progress':
                    return 'bg-warning';
                case 'planifiee':
                case 'planned':
                    return 'bg-info';
                case 'suspendue':
                case 'suspended':
                    return 'bg-secondary';
                case 'annulee':
                case 'cancelled':
                    return 'bg-danger';
                default:
                    return 'bg-secondary';
            }
        }

        function showError(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const container = document.querySelector('.main-content-area');
            if (container) {
                container.insertBefore(alertDiv, container.firstChild);
            }
        }

        // Fonction pour ouvrir l'éditeur de planning
        function openPlanningEditor() {
            if (!missionId) {
                showError('ID de mission non disponible');
                return;
            }
            
            // Ouvrir l'éditeur de planning dans une nouvelle fenêtre
            const planningUrl = `edit-mission-planning.html?mission_id=${missionId}`;
            window.open(planningUrl, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
        }
    </script>
</body>
</html> 