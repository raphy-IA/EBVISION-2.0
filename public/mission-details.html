<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Détails Mission</title>

    <!-- CSS Bootstrap et FontAwesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/vendor/fontawesome/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/modern-sidebar.css">

    <script src="/js/currency-config.js" defer></script>

    <!-- Script d'authentification -->
    <script src="js/auth.js"></script>
    <script src="js/menu-permissions.js"></script>
    <script src="/js/page-permissions.js"></script>
    <!-- SessionManager pour la gestion centralisée des sessions -->
    <script src="js/session-manager.js"></script>

    <!-- Scripts de zone utilisateur -->
    <!-- <script src="js/user-modals.js"></script> -->

    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #f8f9fa;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            overflow-x: hidden;
        }

        .page-wrapper {
            display: flex;
            min-height: 100vh;
        }

        .main-content-area {
            flex-grow: 1;
            padding: 2rem;
            background-color: var(--light-bg);
        }

        /* Ajustements pour les petits écrans */
        @media (max-width: 768px) {
            .page-wrapper {
                flex-direction: column;
                /* Empile la sidebar et le contenu */
            }

            .main-content-area {
                padding: 1rem;
            }
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .nav-tabs .nav-link {
            border: none;
            border-radius: 0;
            color: #6c757d;
            font-weight: 500;
            padding: 1rem 1.5rem;
        }

        .nav-tabs .nav-link.active {
            background-color: var(--primary-color);
            color: white;
            border: none;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-en_cours {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        .status-terminee {
            background-color: #e8f5e8;
            color: #388e3c;
        }

        .status-suspendue {
            background-color: #fff3e0;
            color: #f57c00;
        }

        .status-annulee {
            background-color: #ffebee;
            color: #d32f2f;
        }

        .back-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .back-button:hover {
            background: #34495e;
            color: white;
            text-decoration: none;
        }

        /* Tree View Styles */
        .tree-view {
            margin-left: 0;
            padding-left: 0;
        }

        .tree-node {
            list-style: none;
        }

        .tree-node .node-content:hover {
            background-color: #f0f2f5;
        }

        .tree-node .node-actions {
            opacity: 1;
        }
    </style>
    <!-- Scripts pour la top bar EBVISION 2.0 -->



    <!-- Script pour la gestion utilisateur -->
    <script src="js/user-header.js"></script>
    <script src="js/profile-menu.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/tasks.js"></script>

    <!-- CSS des variables de branding dynamiques -->
    <link rel="stylesheet" href="/config/themes/brand-variables.css">

    <!-- Scripts de branding -->
    <script src="js/branding-loader.js"></script>
    <script src="js/sidebar-branding.js"></script>
    <script src="js/mission-execution.js"></script>
</head>

<body>
    <!-- Bouton toggle sidebar mobile -->
    <button class="sidebar-toggle d-md-none">
        <i class="fas fa-bars"></i>
    </button>
    <div class="page-wrapper">
        <!-- Sidebar Container -->
        <div class="sidebar-container">
            <!-- La sidebar sera générée par JavaScript -->
        </div>

        <!-- Main Content Area -->
        <div class="main-content-area">
            <!-- Bouton retour -->
            <a href="missions.html" class="back-button">
                <i class="fas fa-arrow-left"></i>
                Retour aux missions
            </a>

            <!-- En-tête de la mission -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h2 id="missionTitle">Chargement...</h2>
                            <p class="text-muted mb-0" id="missionCode">Code: ...</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <span id="missionStatus" class="status-badge">...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Onglets -->
            <div class="card">
                <div class="card-header">
                    <ul class="nav nav-tabs" id="missionTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info"
                                type="button" role="tab">
                                <i class="fas fa-info-circle me-2"></i>Informations
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="financial-tab" data-bs-toggle="tab" data-bs-target="#financial"
                                type="button" role="tab">
                                <i class="fas fa-euro-sign me-2"></i>Paramètres financiers
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="planning-tab" data-bs-toggle="tab" data-bs-target="#planning"
                                type="button" role="tab">
                                <i class="fas fa-calendar-alt me-2"></i>Planning
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="invoicing-tab" data-bs-toggle="tab" data-bs-target="#invoicing"
                                type="button" role="tab">
                                <i class="fas fa-file-invoice me-2"></i>Facturation
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="execution-tab" data-bs-toggle="tab" data-bs-target="#execution"
                                type="button" role="tab" onclick="initExecutionTab(missionId)">
                                <i class="fas fa-folder-tree me-2"></i>Travaux
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="evolution-tab" data-bs-toggle="tab" data-bs-target="#evolution"
                                type="button" role="tab">
                                <i class="fas fa-chart-line me-2"></i>Évolution
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="missionTabContent">
                        <!-- Onglet Informations -->
                        <div class="tab-pane fade show active" id="info" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <h5>Informations générales</h5>
                                    <div class="card">
                                        <div class="card-body">
                                            <p><strong>Client:</strong> <span id="missionClient">...</span></p>
                                            <p><strong>Type de mission:</strong> <span id="missionType">...</span></p>
                                            <p><strong>Responsable:</strong> <span id="missionResponsable">...</span>
                                            </p>
                                            <p><strong>Manager:</strong> <span id="missionManager">...</span>
                                            </p>
                                            <p><strong>Associé en charge:</strong> <span id="missionAssocie">...</span>
                                            </p>
                                            <p><strong>Business Unit:</strong> <span id="missionBusinessUnit">...</span>
                                            </p>
                                            <p><strong>Division:</strong> <span id="missionDivision">...</span></p>
                                            <p><strong>Année fiscale:</strong> <span id="missionFiscalYear">...</span>
                                            </p>
                                            <p><strong>Créé par:</strong> <span id="missionCreatedBy">...</span></p>
                                            <p><strong>Date de création:</strong> <span id="missionCreatedAt">...</span>
                                            </p>
                                        </div>
                                    </div>

                                    <!-- Documents -->
                                    <h5 class="mt-4">Documents</h5>
                                    <div class="card">
                                        <div class="card-body" id="missionDocuments">
                                            <span class="text-muted">Aucun document disponible</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h5>Dates et durée</h5>
                                    <div class="card">
                                        <div class="card-body">
                                            <p><strong>Début:</strong> <span id="missionStartDate">...</span></p>
                                            <p><strong>Fin prévue:</strong> <span id="missionEndDate">...</span></p>
                                            <p><strong>Fin réelle:</strong> <span id="missionRealEndDate">...</span></p>
                                            <p><strong>Durée:</strong> <span id="missionDuration">...</span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-4">
                                <div class="col-12">
                                    <h5>Description</h5>
                                    <div class="card">
                                        <div class="card-body">
                                            <p id="missionDescription">...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Onglet Paramètres financiers -->
                        <div class="tab-pane fade" id="financial" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h6>Configuration des honoraires</h6>
                                            <button class="btn btn-sm btn-outline-primary"
                                                onclick="openFinancialEditor()">
                                                <i class="fas fa-edit me-1"></i>Modifier
                                            </button>
                                        </div>
                                        <div class="card-body">
                                            <p><strong>Budget Estimé:</strong> <span id="missionBudget">...</span></p>
                                            <p><strong>Montant Honoraires:</strong> <span
                                                    id="honorairesMontant">...</span></p>
                                            <p><strong>Devise:</strong> <span id="honorairesDevise">...</span></p>
                                            <p><strong>Description:</strong> <span id="honorairesDescription">...</span>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6>Configuration des débours</h6>
                                        </div>
                                        <div class="card-body">
                                            <p><strong>Montant:</strong> <span id="deboursMontant">...</span></p>
                                            <p><strong>Devise:</strong> <span id="deboursDevise">...</span></p>
                                            <p><strong>Description:</strong> <span id="deboursDescription">...</span>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6>Conditions de paiement</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="paymentConditions">...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Onglet Planning -->
                        <div class="tab-pane fade" id="planning" role="tabpanel">
                            <div class="row mb-3">
                                <div class="col-12">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5><i class="fas fa-calendar-alt me-2"></i>Planning de la Mission</h5>
                                        <button class="btn btn-primary" onclick="openPlanningEditor()">
                                            <i class="fas fa-edit me-2"></i>Modifier le Planning
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6><i class="fas fa-users me-2"></i>Équipe de mission</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="missionTeam">...</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6><i class="fas fa-tasks me-2"></i>Tâches planifiées</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row mb-2">
                                                <div class="col-12 d-flex align-items-center gap-2">
                                                    <label for="missionTasksFilter"
                                                        class="form-label mb-0 small text-muted">Filtrer par tâche
                                                        :</label>
                                                    <select id="missionTasksFilter" class="form-select form-select-sm"
                                                        style="max-width: 260px;">
                                                        <option value="__all__">Toutes les tâches</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div id="missionTasks">...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Onglet Facturation -->
                        <div class="tab-pane fade" id="invoicing" role="tabpanel">
                            <div class="row mb-3">
                                <div class="col-12">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5>Factures générées</h5>
                                        <button class="btn btn-primary" onclick="createInvoiceFromMission()">
                                            <i class="fas fa-plus me-2"></i>Créer une facture
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-8">
                                    <div id="invoicesList">...</div>
                                </div>
                                <div class="col-md-4">
                                    <h5>Statistiques de facturation</h5>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <div class="card bg-light">
                                                <div class="card-body p-2 text-center">
                                                    <small class="text-muted">Total facturé</small>
                                                    <h6 class="mb-0" id="totalInvoiced">...</h6>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="card bg-light">
                                                <div class="card-body p-2 text-center">
                                                    <small class="text-muted">Total payé</small>
                                                    <h6 class="mb-0 text-success" id="totalPaid">...</h6>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="card bg-light">
                                                <div class="card-body p-2 text-center">
                                                    <small class="text-muted">En attente</small>
                                                    <h6 class="mb-0 text-warning" id="totalPending">...</h6>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="card text-white"
                                                style="background: linear-gradient(135deg, #ff9966 0%, #ff5e62 100%);">
                                                <div class="card-body p-2 text-center">
                                                    <small>Prochaine facture</small>
                                                    <h6 class="mb-0" id="nextBillingDateDetails">-</h6>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="alert alert-info mb-0 p-2 small" id="nextBillingInfo"
                                                style="display: none;">
                                                <i class="fas fa-info-circle me-1"></i>
                                                <span id="nextBillingText"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Onglet Exécution -->
                        <div class="tab-pane fade" id="execution" role="tabpanel">
                            <div class="row">
                                <div class="col-12">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5><i class="fas fa-folder-tree me-2"></i>Documents & Travaux</h5>
                                        <div>
                                            <button class="btn btn-outline-primary btn-sm me-2"
                                                onclick="loadMissionDocuments()">
                                                <i class="fas fa-sync"></i> Actualiser
                                            </button>
                                            <button class="btn btn-primary btn-sm"
                                                onclick="createNewNode(null, 'folder')">
                                                <i class="fas fa-plus"></i> Nouveau dossier racine
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card bg-white border">
                                        <div class="card-body p-0">
                                            <div id="documentTreeContainer" style="min-height: 300px; padding: 1rem;">
                                                <!-- L'arborescence sera chargée ici -->
                                            </div>
                                        </div>
                                        <div class="card-footer bg-light text-muted small">
                                            <i class="fas fa-info-circle"></i> Glissez-déposez des fichiers dans les
                                            dossiers pour les télécharger.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Onglet Évolution -->
                        <div class="tab-pane fade" id="evolution" role="tabpanel">
                            <div class="row">
                                <div class="col-12">
                                    <h5>Progression des tâches</h5>
                                    <div id="tasksProgress">...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Financial Editor Modal -->
    <div class="modal fade" id="financialEditorModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Modifier les paramètres financiers</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="financialEditorForm">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="editBudget" class="form-label">Budget Estimé</label>
                                <input type="number" class="form-control" id="editBudget" step="0.01"
                                    oninput="validateGlobalAmounts()">
                            </div>
                            <div class="col-md-4">
                                <label for="editGlobalHon" class="form-label">Total Honoraires</label>
                                <input type="number" class="form-control" id="editGlobalHon" step="0.01"
                                    oninput="calculateRowAmounts(); validateGlobalAmounts()">
                            </div>
                            <div class="col-md-4">
                                <label for="editGlobalDeb" class="form-label">Total Débours</label>
                                <input type="number" class="form-control" id="editGlobalDeb" step="0.01"
                                    oninput="calculateRowAmounts(); validateGlobalAmounts()">
                            </div>
                        </div>
                        <div id="globalAmountWarning" class="alert alert-danger d-none py-1 mb-2 small">
                            La somme (Honoraires + Débours) dépasse le Budget !
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Echéancier de paiement (Calculé sur %)</label>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered" id="conditionsTable">
                                    <thead>
                                        <tr>
                                            <th>% Hon.</th>
                                            <th>Mnt Hon.</th>
                                            <th>% Déb.</th>
                                            <th>Mnt Déb.</th>
                                            <th>Date</th>
                                            <th>Détails</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="conditionsTableBody">
                                        <!-- Rows will be added here -->
                                    </tbody>
                                    <tfoot>
                                        <tr class="table-light fw-bold" style="font-size: 0.9em;">
                                            <td id="totalPctHon">0%</td>
                                            <td id="totalRowHon">0.00</td>
                                            <td id="totalPctDeb">0%</td>
                                            <td id="totalRowDeb">0.00</td>
                                            <td colspan="3"></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-success" onclick="addConditionRow()">
                                <i class="fas fa-plus"></i> Ajouter une ligne
                            </button>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary"
                        onclick="handleSaveFinancial(event)">Enregistrer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/sidebar.js" defer></script>
    <script>
        // Variables globales
        let currentMission = null;
        let missionId = null;

        // Fonction utilitaire pour les appels API authentifiés
        async function authenticatedFetch(url, options = {}) {
            const token = localStorage.getItem('authToken');
            const defaultHeaders = {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };

            return fetch(url, {
                ...options,
                headers: {
                    ...defaultHeaders,
                    ...options.headers
                }
            });
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function () {
            // Récupérer l'ID de la mission depuis l'URL
            const urlParams = new URLSearchParams(window.location.search);
            missionId = urlParams.get('id');

            if (missionId) {
                loadMissionDetails(missionId);
            } else {
                showError('ID de mission manquant');
            }
        });

        // Chargement des détails de la mission
        async function loadMissionDetails(id) {
            try {
                const response = await authenticatedFetch(`/api/missions/${id}`);
                if (response.ok) {
                    const data = await response.json();
                    currentMission = data.data;
                    displayMissionDetails();
                } else {
                    showError('Erreur lors du chargement de la mission');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showError('Erreur de connexion');
            }
        }

        // Affichage des détails de la mission
        function displayMissionDetails() {
            if (!currentMission) return;

            // Informations générales
            document.getElementById('missionTitle').textContent = currentMission.nom || currentMission.titre || 'Sans titre';
            document.getElementById('missionCode').textContent = `Code: ${currentMission.code || 'N/A'}`;
            document.getElementById('missionStatus').textContent = currentMission.statut || 'N/A';
            document.getElementById('missionStatus').className = `status-badge status-${(currentMission.statut || '').toLowerCase()}`;

            // Mettre à jour la devise de la mission
            updateCurrencySymbols(currentMission.devise || 'XAF');

            // Onglet Informations
            document.getElementById('missionClient').textContent = currentMission.client_nom || 'N/A';
            document.getElementById('missionType').textContent = currentMission.mission_type_nom || currentMission.type_mission || 'N/A';
            document.getElementById('missionResponsable').textContent = formatResponsable(currentMission.responsable_nom, currentMission.responsable_prenom);
            document.getElementById('missionManager').textContent = formatResponsable(currentMission.manager_nom, currentMission.manager_prenom);
            document.getElementById('missionAssocie').textContent = formatResponsable(currentMission.associe_nom, currentMission.associe_prenom);
            document.getElementById('missionBusinessUnit').textContent = currentMission.business_unit_nom || 'N/A';
            document.getElementById('missionDivision').textContent = currentMission.division_nom || 'N/A';
            document.getElementById('missionFiscalYear').textContent = currentMission.fiscal_year_annee || 'N/A';
            document.getElementById('missionCreatedBy').textContent = formatResponsable(currentMission.created_by_nom, currentMission.created_by_prenom);
            document.getElementById('missionCreatedAt').textContent = formatDate(currentMission.created_at || currentMission.date_creation);
            document.getElementById('missionStartDate').textContent = formatDate(currentMission.date_debut);
            document.getElementById('missionEndDate').textContent = formatDate(currentMission.date_fin_prevue || currentMission.date_fin);
            document.getElementById('missionRealEndDate').textContent = formatDate(currentMission.date_fin_reelle);
            document.getElementById('missionDuration').textContent = calculateDuration(currentMission.date_debut, currentMission.date_fin_reelle || currentMission.date_fin_prevue || currentMission.date_fin);
            document.getElementById('missionDescription').textContent = currentMission.description || 'Aucune description disponible';

            // Documents
            const docsHtml = [];
            if (currentMission.kyc_path) {
                docsHtml.push(`
                    <a href="${currentMission.kyc_path}" target="_blank" class="btn btn-outline-primary btn-sm mb-2 w-100 text-start">
                        <i class="fas fa-file-pdf me-2"></i>Télécharger KYC
                    </a>
                `);
            }
            if (currentMission.contract_path) {
                docsHtml.push(`
                    <a href="${currentMission.contract_path}" target="_blank" class="btn btn-outline-primary btn-sm mb-2 w-100 text-start">
                        <i class="fas fa-file-signature me-2"></i>Télécharger Contrat
                    </a>
                `);
            }

            const docsContainer = document.getElementById('missionDocuments');
            if (docsContainer) {
                if (docsHtml.length > 0) {
                    docsContainer.innerHTML = docsHtml.join('');
                } else {
                    docsContainer.innerHTML = '<span class="text-muted">Aucun document disponible</span>';
                }
            }

            // Onglet Paramètres financiers
            displayFinancialData();

            // Onglet Planning
            displayPlanningData();

            // Onglet Facturation
            displayInvoicingData();

            // Onglet Évolution
            displayEvolutionData();
        }

        // Affichage des données financières
        function displayFinancialData() {
            const budget = currentMission.budget_estime || currentMission.budget_prevue || 0;
            const honoraires = currentMission.montant_honoraires || 0;
            const debours = currentMission.montant_debours || 0;
            const devise = currentMission.devise || 'XAF';

            document.getElementById('missionBudget').textContent = formatCurrency(budget, devise);
            document.getElementById('honorairesMontant').textContent = formatCurrency(honoraires, devise);
            document.getElementById('honorairesDevise').textContent = devise;
            document.getElementById('honorairesDescription').textContent = currentMission.description_honoraires || 'N/A';

            document.getElementById('deboursMontant').textContent = formatCurrency(debours, devise);
            document.getElementById('deboursDevise').textContent = devise;
            document.getElementById('deboursDescription').textContent = currentMission.description_debours || 'N/A';

            // Conditions de paiement
            const conditions = currentMission.conditions_paiement;
            if (conditions) {
                try {
                    let parsed;

                    // 1) Tentative de parsing JSON direct
                    try {
                        parsed = JSON.parse(conditions);
                    } catch (_) {
                        parsed = null;
                    }

                    // Si c'est un objet (ex: {"0": "{...}", ...}) on le convertit en tableau
                    if (parsed && typeof parsed === 'object' && !Array.isArray(parsed)) {
                        parsed = Object.values(parsed).map(item => {
                            if (typeof item === 'string') {
                                try { return JSON.parse(item); } catch (_) { return null; }
                            }
                            return item;
                        }).filter(Boolean);
                    }

                    // 2) Si toujours pas un tableau, tenter un parseur "legacy" basé sur regex
                    if (!Array.isArray(parsed)) {
                        let legacyMatches = [];

                        // 2.a) Cas le plus courant: conditions = {"{\"id\":...}","{\"id\":...}"}
                        const quotedRegex = /"\{.*?\}"/g; // extrait chaque "{...}"
                        let match;
                        while ((match = quotedRegex.exec(conditions)) !== null) {
                            legacyMatches.push(match[0]);
                        }

                        // 2.b) Fallback: si rien trouvé, on tente sur les blocs {..} simples
                        if (legacyMatches.length === 0) {
                            const simpleRegex = /\{[^}]*\}/g;
                            while ((match = simpleRegex.exec(conditions)) !== null) {
                                legacyMatches.push(match[0]);
                            }
                        }

                        if (legacyMatches.length > 0) {
                            parsed = legacyMatches.map(chunk => {
                                try {
                                    // Nettoyer les séquences échappées et guillemets superflus
                                    let clean = chunk.trim();
                                    // Retirer les guillemets externes si présents
                                    if (clean.startsWith('"') && clean.endsWith('"')) {
                                        clean = clean.substring(1, clean.length - 1);
                                    }
                                    // Remplacer \" par "
                                    clean = clean.replace(/\\"/g, '"');
                                    return JSON.parse(clean);
                                } catch (_) { return null; }
                            }).filter(Boolean);
                        }
                    }

                    if (!Array.isArray(parsed) || parsed.length === 0) {
                        throw new Error('Format de conditions_paiement non supporté');
                    }

                    let conditionsHtml = '';

                    parsed.forEach(condition => {
                        // Normalisation des champs (camelCase ou snake_case)
                        const pctHon = condition.pourcentage_honoraires ?? condition.pourcentageHonoraires ?? 0;
                        const mntHon = condition.montant_honoraires ?? condition.montantHonoraires ?? 0;
                        const pctDeb = condition.pourcentage_debours ?? condition.pourcentageDebours ?? 0;
                        const mntDeb = condition.montant_debours ?? condition.montantDebours ?? 0;
                        const dateCond = condition.date ?? condition.datePrevisionnelle ?? null;
                        const details = condition.details || '';

                        conditionsHtml += `
                            <div class="border-bottom pb-2 mb-2">
                                <div class="row">
                                    <div class="col-md-2"><strong>${pctHon || 0}%</strong> Honoraires</div>
                                    <div class="col-md-2">${formatCurrency(mntHon || 0, devise)}</div>
                                    <div class="col-md-2"><strong>${pctDeb || 0}%</strong> Débours</div>
                                    <div class="col-md-2">${formatCurrency(mntDeb || 0, devise)}</div>
                                    <div class="col-md-2">${formatDate(dateCond)}</div>
                                    <div class="col-md-2">${details}</div>
                                </div>
                            </div>
                        `;
                    });

                    document.getElementById('paymentConditions').innerHTML = conditionsHtml;
                } catch (e) {
                    console.error('Erreur de parsing des conditions de paiement:', e, conditions);
                    document.getElementById('paymentConditions').innerHTML = `
                        <div class="text-warning mb-2">
                            Données de conditions de paiement non lisibles (ancien format).
                        </div>
                        <pre class="small text-muted" style="white-space: pre-wrap;">${conditions}</pre>
                    `;
                }
            } else {
                document.getElementById('paymentConditions').textContent = 'Aucune condition de paiement définie';
            }
        }

        // Affichage des données de planning
        async function displayPlanningData() {
            try {
                // Charger l'équipe
                const teamResponse = await authenticatedFetch(`/api/missions/${missionId}/team`);
                if (teamResponse.ok) {
                    const teamData = await teamResponse.json();
                    displayTeamData(teamData.data);
                } else {
                    document.getElementById('missionTeam').innerHTML = `
                        <div class="text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            Aucune équipe assignée à cette mission
                        </div>
                    `;
                }

                // Charger les tâches - utiliser l'endpoint /planning pour avoir TOUTES les tâches
                const planningResponse = await authenticatedFetch(`/api/missions/${missionId}/planning`);
                if (planningResponse.ok) {
                    const planningData = await planningResponse.json();
                    // Transformer les données du planning pour le format attendu
                    const tasksData = planningData.tasks.map(task => ({
                        ...task,
                        task_libelle: task.libelle,
                        task_description: task.description,
                        // Calculer les heures saisies et validées depuis les affectations
                        heures_saisies: task.assignments.reduce((sum, a) => sum + (parseFloat(a.heures_saisies) || 0), 0),
                        heures_validees: 0, // À calculer si nécessaire
                        // Transformer les affectations
                        collaborateurs_affectes: task.assignments.map(a => ({
                            id: a.collaborateur_id,
                            nom: a.nom,
                            prenom: a.prenom,
                            grade_nom: a.grade_nom,
                            heures_planifiees: a.heures_planifiees,
                            heures_saisies: a.heures_saisies,
                            heures_validees: 0,
                            taux_horaire: a.taux_horaire,
                            statut: a.statut
                        }))
                    }));
                    displayTasksData(tasksData);
                } else {
                    document.getElementById('missionTasks').innerHTML = `
                        <div class="text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            Aucune tâche planifiée pour cette mission
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erreur lors du chargement des données de planning:', error);
                document.getElementById('missionTeam').innerHTML = `
                    <div class="text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Erreur lors du chargement de l'équipe
                    </div>
                `;
                document.getElementById('missionTasks').innerHTML = `
                    <div class="text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Erreur lors du chargement des tâches
                    </div>
                `;
            }
        }

        // Affichage des données d'équipe
        function displayTeamData(team) {
            if (!team || team.length === 0) {
                document.getElementById('missionTeam').innerHTML = `
                    <div class="text-muted">
                        <i class="fas fa-info-circle me-2"></i>
                        Aucune équipe assignée à cette mission
                    </div>
                `;
                return;
            }

            let teamHtml = '';
            team.forEach(member => {
                teamHtml += `
                    <div class="border-bottom pb-2 mb-2">
                        <div class="row">
                            <div class="col-md-4">
                                <strong>${member.prenom} ${member.nom}</strong>
                                <br><small class="text-muted">${member.grade_nom || 'N/A'}</small>
                            </div>
                            <div class="col-md-4">
                                <small>${member.email}</small>
                                <br><small class="text-muted">${member.telephone || 'N/A'}</small>
                            </div>
                            <div class="col-md-4">
                                <small>${member.nb_assignments} affectation(s)</small>
                                <br><small class="text-muted">${member.total_heures_planifiees || 0}h planifiées</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('missionTeam').innerHTML = teamHtml;
        }

        // Données et affichage des tâches planifiées
        let missionTasksData = [];

        function displayTasksData(tasks) {
            missionTasksData = Array.isArray(tasks) ? tasks : [];

            if (!missionTasksData.length) {
                document.getElementById('missionTasks').innerHTML = `
                    <div class="text-muted">
                        <i class="fas fa-info-circle me-2"></i>
                        Aucune tâche planifiée pour cette mission
                    </div>
                `;
                const filterSelect = document.getElementById('missionTasksFilter');
                if (filterSelect) {
                    filterSelect.innerHTML = '<option value="__all__">Toutes les tâches</option>';
                }
                return;
            }

            initMissionTasksFilter();
            renderMissionTasks();

            // Mettre à jour les symboles de devise après le rendu
            if (currentMission && currentMission.devise) {
                updateCurrencySymbols(currentMission.devise);
            }
        }

        function initMissionTasksFilter() {
            const filterSelect = document.getElementById('missionTasksFilter');
            if (!filterSelect) return;

            // Ne remplir le select qu'une seule fois ou lorsque les tâches changent
            const currentValue = filterSelect.value || '__all__';
            const uniqueLabels = Array.from(new Set(missionTasksData.map(t => t.task_libelle || 'Sans libellé')));

            filterSelect.innerHTML = '<option value="__all__">Toutes les tâches</option>' +
                uniqueLabels.map(label => `<option value="${label}">${label}</option>`).join('');

            filterSelect.value = uniqueLabels.includes(currentValue) ? currentValue : '__all__';

            if (!filterSelect.dataset.initialized) {
                filterSelect.addEventListener('change', () => {
                    renderMissionTasks();
                });
                filterSelect.dataset.initialized = 'true';
            }
        }

        function renderMissionTasks() {
            const container = document.getElementById('missionTasks');
            if (!container) return;

            if (!missionTasksData.length) {
                container.innerHTML = `
                    <div class="text-muted">
                        <i class="fas fa-info-circle me-2"></i>
                        Aucune tâche planifiée pour cette mission
                    </div>
                `;
                return;
            }

            const filterSelect = document.getElementById('missionTasksFilter');
            const selectedLabel = filterSelect ? filterSelect.value : '__all__';

            let tasksToDisplay = missionTasksData;
            if (selectedLabel && selectedLabel !== '__all__') {
                tasksToDisplay = missionTasksData.filter(t => (t.task_libelle || 'Sans libellé') === selectedLabel);
            }

            let tasksHtml = '';

            tasksToDisplay.forEach(task => {
                const statusClass = getStatusClass(task.statut);

                // Tableau des informations de la tâche
                const taskTable = `
                    <div class="table-responsive mb-2">
                        <table class="table table-sm align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Nom de la tâche / Description</th>
                                    <th class="text-center">Heures planifiées</th>
                                    <th class="text-center">Heures effectuées</th>
                                    <th class="text-center">Date début</th>
                                    <th class="text-center">Date fin</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                        <div class="d-flex flex-column">
                                            <div>
                                                <strong>${task.task_libelle || 'N/A'}</strong>
                                                <span class="badge ms-2 ${statusClass}">${task.statut || 'N/A'}</span>
                                            </div>
                                            <small class="text-muted">${task.task_description || ''}</small>
                                            ${task.notes ? `<small class="text-muted">${task.notes}</small>` : ''}
                                        </div>
                                    </td>
                                    <td class="text-center">${task.duree_planifiee || 0}h</td>
                                    <td class="text-center">${formatHoursWithStatus(task.heures_saisies, task.heures_validees)}</td>
                                    <td class="text-center">${formatDate(task.date_debut)}</td>
                                    <td class="text-center">${formatDate(task.date_fin)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;

                // Tableau des collaborateurs affectés
                let collaborateursHtml = '';
                if (task.collaborateurs_affectes && task.collaborateurs_affectes.length > 0) {
                    const rowsHtml = task.collaborateurs_affectes.map(collab => `
                        <tr>
                            <td>
                                <div class="d-flex flex-column">
                                    <span><strong>${collab.prenom} ${collab.nom}</strong>${collab.grade_nom ? ` (${collab.grade_nom})` : ''}</span>
                                    ${collab.taux_horaire ? `<small class="text-muted">${collab.taux_horaire}<span class="currency-symbol">€</span>/h</small>` : ''}
                                </div>
                            </td>
                            <td class="text-center">${collab.heures_planifiees || 0}h</td>
                            <td class="text-center">${formatHoursWithStatus(collab.heures_saisies, collab.heures_validees)}</td>
                            <td class="text-center">${formatDate(collab.date_debut)}</td>
                            <td class="text-center">${formatDate(collab.date_fin)}</td>
                        </tr>
                    `).join('');

                    collaborateursHtml = `
                        <div class="mt-2">
                            <small class="text-primary d-block mb-1">
                                <i class="fas fa-users me-1"></i>Collaborateurs affectés
                            </small>
                            <div class="table-responsive">
                                <table class="table table-sm align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Nom (grade)</th>
                                            <th class="text-center">Heures planifiées</th>
                                            <th class="text-center">Heures effectuées</th>
                                            <th class="text-center">Date début</th>
                                            <th class="text-center">Date fin</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${rowsHtml}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                } else {
                    collaborateursHtml = `
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>Aucun collaborateur affecté
                            </small>
                        </div>
                    `;
                }

                tasksHtml += `
                    <div class="border-bottom pb-3 mb-3">
                        ${taskTable}
                        ${collaborateursHtml}
                    </div>
                `;
            });

            container.innerHTML = tasksHtml;
        }

        // Affichage des données de facturation
        async function displayInvoicingData() {
            try {
                const devise = currentMission?.devise || 'XAF';

                // 1. Charger les factures existantes
                const response = await authenticatedFetch(`/api/invoices/mission/${missionId}`);
                if (response.ok) {
                    const invoicesData = await response.json();
                    displayInvoicesList(invoicesData.data, devise);
                } else {
                    document.getElementById('invoicesList').innerHTML = `
                        <div class="text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            Aucune facture trouvée pour cette mission
                        </div>
                    `;
                }

                // 2. Charger la prochaine facturation suggérée
                const nextResponse = await authenticatedFetch(`/api/billing/mission/${missionId}/next`);
                if (nextResponse.ok) {
                    const result = await nextResponse.json();
                    const next = result.data;

                    const nextDateEl = document.getElementById('nextBillingDateDetails');
                    const infoEl = document.getElementById('nextBillingInfo');
                    const textEl = document.getElementById('nextBillingText');

                    if (next) {
                        if (next.date_prevue) {
                            const d = new Date(next.date_prevue);
                            nextDateEl.textContent = d.toLocaleDateString('fr-FR');
                            if (d < new Date()) {
                                nextDateEl.parentElement.parentElement.classList.remove('bg-success');
                                nextDateEl.parentElement.parentElement.style.background = 'linear-gradient(135deg, #ff9966 0%, #ff5e62 100%)'; // Orange/Red
                            } else {
                                nextDateEl.parentElement.parentElement.style.background = 'linear-gradient(135deg, #56ab2f 0%, #a8e063 100%)'; // Green
                            }
                        } else {
                            nextDateEl.textContent = 'À la demande';
                            nextDateEl.parentElement.parentElement.style.background = 'linear-gradient(135deg, #3498db 0%, #2980b9 100%)'; // Blue
                        }

                        infoEl.style.display = 'block';
                        textEl.innerHTML = `<strong>${next.description}</strong><br>Montant suggéré : ${formatCurrency(next.montant_total, devise)}`;

                        // Stocker pour usage dans createInvoiceFromMission
                        window.nextBillingSuggestion = next;
                    } else {
                        nextDateEl.textContent = '-';
                        infoEl.style.display = 'none';
                        window.nextBillingSuggestion = null;
                    }
                }

            } catch (error) {
                console.error('Erreur lors du chargement des factures:', error);
                document.getElementById('invoicesList').innerHTML = `
                    <div class="text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Erreur lors du chargement des factures
                    </div>
                `;
            }
        }

        // Affichage de la liste des factures
        function displayInvoicesList(invoices, devise) {
            if (!invoices || invoices.length === 0) {
                document.getElementById('invoicesList').innerHTML = `
                    <div class="text-muted">
                        <i class="fas fa-info-circle me-2"></i>
                        Aucune facture trouvée pour cette mission
                    </div>
                `;
                // Reset stats
                document.getElementById('totalInvoiced').textContent = formatCurrency(0, devise);
                document.getElementById('totalPaid').textContent = formatCurrency(0, devise);
                document.getElementById('totalPending').textContent = formatCurrency(0, devise);
                return;
            }

            let totalInvoiced = 0;
            let totalPaid = 0;
            let totalPending = 0;

            const invoicesHtml = invoices.map(invoice => {
                totalInvoiced += parseFloat(invoice.montant_ttc || 0);
                totalPaid += parseFloat(invoice.montant_paye || 0);
                totalPending += parseFloat(invoice.montant_restant || 0);

                return `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-3">
                                    <h6 class="mb-1">${invoice.numero_facture}</h6>
                                    <small class="text-muted">Émise le ${formatDate(invoice.date_emission)}</small>
                                </div>
                                <div class="col-md-2">
                                    <span class="badge status-${invoice.statut.toLowerCase()}">${invoice.statut}</span>
                                </div>
                                <div class="col-md-2">
                                    <strong>${formatCurrency(invoice.montant_ttc, devise)}</strong>
                                </div>
                                <div class="col-md-2">
                                    <span class="text-success">${formatCurrency(invoice.montant_paye, devise)}</span>
                                </div>
                                <div class="col-md-2">
                                    <span class="text-warning">${formatCurrency(invoice.montant_restant, devise)}</span>
                                </div>
                                <div class="col-md-1">
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewInvoice('${invoice.id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('invoicesList').innerHTML = invoicesHtml;
            document.getElementById('totalInvoiced').textContent = formatCurrency(totalInvoiced, devise);
            document.getElementById('totalPaid').textContent = formatCurrency(totalPaid, devise);
            document.getElementById('totalPending').textContent = formatCurrency(totalPending, devise);
        }

        // Fonction pour voir une facture
        function viewInvoice(invoiceId) {
            window.open(`/invoice-details.html?id=${invoiceId}`, '_blank');
        }

        // Fonction pour créer une facture depuis la mission
        async function createInvoiceFromMission() {
            const next = window.nextBillingSuggestion;
            const devise = currentMission?.devise || 'XAF';

            let confirmMsg = "Voulez-vous créer une nouvelle facture pour cette mission ?";
            if (next) {
                confirmMsg = `Générer la facture pour : ${next.description} ?\nMontant suggéré : ${formatCurrency(next.montant_total, devise)}`;
            }

            if (!confirm(confirmMsg)) return;

            try {
                // Cas 1 : Génération depuis une condition spécifique
                if (next && next.type === 'CONDITION') {
                    const response = await authenticatedFetch('/api/billing/generate', {
                        method: 'POST',
                        body: JSON.stringify({
                            mission_id: missionId,
                            type: 'CONDITION',
                            condition_index: next.condition_index
                        })
                    });

                    if (response.ok) {
                        alert('Facture brouillon générée avec succès !');
                        displayInvoicingData();
                    } else {
                        const err = await response.json();
                        alert('Erreur: ' + err.error);
                    }
                    return;
                }

                // Cas 2 : Solde ou Facture standard (si pas de suggestion ou type BALANCE)
                // On crée une facture brouillon manuellement
                const invoiceData = {
                    mission_id: missionId,
                    client_id: currentMission.client_id,
                    date_emission: new Date().toISOString().split('T')[0],
                    date_echeance: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    statut: 'BROUILLON',
                    conditions_paiement: next ? next.description : 'Facture standard',
                    taux_tva: 19.25,
                    adresse_facturation: currentMission.adresse_facturation || '',
                    notes_facture: next ? `Généré automatiquement (Solde).` : `Facture générée pour la mission: ${currentMission.nom}`
                };

                const response = await authenticatedFetch('/api/invoices', {
                    method: 'POST',
                    body: JSON.stringify(invoiceData)
                });

                if (response.ok) {
                    const result = await response.json();
                    const invoiceId = result.data.id;

                    // Si c'est un solde, on ajoute les lignes correspondantes
                    if (next && next.type === 'BALANCE') {
                        if (next.montant_honoraires > 0) {
                            await authenticatedFetch(`/api/invoices/${invoiceId}/items`, {
                                method: 'POST',
                                body: JSON.stringify({
                                    description: 'Solde Honoraires',
                                    quantite: 1,
                                    unite: 'forfait',
                                    prix_unitaire: next.montant_honoraires,
                                    taux_tva: 19.25
                                })
                            });
                        }
                        if (next.montant_debours > 0) {
                            await authenticatedFetch(`/api/invoices/${invoiceId}/items`, {
                                method: 'POST',
                                body: JSON.stringify({
                                    description: 'Solde Débours',
                                    quantite: 1,
                                    unite: 'forfait',
                                    prix_unitaire: next.montant_debours,
                                    taux_tva: 19.25
                                })
                            });
                        }
                        alert('Facture de solde générée avec succès !');
                    } else {
                        // Comportement par défaut (générer items depuis mission ou laisser vide)
                        // Ici on laisse vide pour que l'utilisateur remplisse, ou on peut appeler generate-items
                        // Pour l'instant, on notifie juste
                        alert('Facture brouillon créée. Veuillez ajouter les lignes.');
                    }

                    displayInvoicingData();
                } else {
                    const errorData = await response.json();
                    alert(`Erreur lors de la création de la facture: ${errorData.error}`);
                }
            } catch (error) {
                console.error('Erreur lors de la création de la facture:', error);
                alert('Erreur lors de la création de la facture');
            }
        }

        // Affichage des données d'évolution
        async function displayEvolutionData() {
            try {
                const response = await authenticatedFetch(`/api/missions/${missionId}/progress`);
                if (response.ok) {
                    const progressData = await response.json();
                    displayProgressData(progressData.data);
                } else {
                    document.getElementById('tasksProgress').innerHTML = `
                        <div class="text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            Aucune donnée de progression disponible
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erreur lors du chargement de la progression:', error);
                document.getElementById('tasksProgress').innerHTML = `
                    <div class="text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Erreur lors du chargement de la progression
                    </div>
                `;
            }
        }

        // Affichage des données de progression
        function displayProgressData(progressData) {
            const { stats, tasks, has_validated_hours } = progressData;

            let progressHtml = `
                <div class="row mb-4">
                    <div class="col-md-2">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">${stats.total_tasks || 0}</h5>
                                <p class="card-text">Total Tâches</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title text-success">${stats.completed_tasks || 0}</h5>
                                <p class="card-text">Terminées</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title text-warning">${stats.in_progress_tasks || 0}</h5>
                                <p class="card-text">En cours</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title text-info">${stats.planned_tasks || 0}</h5>
                                <p class="card-text">Planifiées</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title text-primary">${stats.total_validated_hours || 0}h</h5>
                                <p class="card-text">Heures Validées</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title ${has_validated_hours ? 'text-success' : 'text-muted'}">
                                    <i class="fas fa-${has_validated_hours ? 'check-circle' : 'clock'}"></i>
                                </h5>
                                <p class="card-text">${has_validated_hours ? 'Active' : 'En attente'}</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6><i class="fas fa-chart-bar me-2"></i>Heures planifiées vs validées</h6>
                            </div>
                            <div class="card-body">
                                <p><strong>Planifiées:</strong> ${stats.total_planned_hours || 0} heures</p>
                                <p><strong>Validées:</strong> ${stats.total_validated_hours || 0} heures</p>
                                <div class="progress">
                                    <div class="progress-bar bg-success" role="progressbar" 
                                         style="width: ${stats.total_planned_hours > 0 ? (stats.total_validated_hours / stats.total_planned_hours) * 100 : 0}%">
                                        ${stats.total_planned_hours > 0 ? Math.round((stats.total_validated_hours / stats.total_planned_hours) * 100) : 0}%
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6><i class="fas fa-info-circle me-2"></i>Statut de la mission</h6>
                            </div>
                            <div class="card-body">
                                <p><strong>Statut actuel:</strong> 
                                    <span class="badge bg-${has_validated_hours ? 'success' : 'secondary'}">
                                        ${has_validated_hours ? 'EN_COURS' : 'PLANIFIEE'}
                                    </span>
                                </p>
                                <p><strong>Heures validées:</strong> 
                                    <span class="text-${has_validated_hours ? 'success' : 'muted'}">
                                        ${has_validated_hours ? 'Oui' : 'Non'}
                                    </span>
                                </p>
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    La mission passe automatiquement en "EN_COURS" dès qu'elle a des heures validées
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            if (tasks && tasks.length > 0) {
                progressHtml += `
                    <div class="card">
                        <div class="card-header">
                            <h6>Progression par tâche</h6>
                        </div>
                        <div class="card-body">
                `;

                tasks.forEach(task => {
                    const statusClass = getStatusClass(task.effective_status || task.statut);
                    const hasValidatedHours = task.validated_hours > 0;
                    progressHtml += `
                        <div class="border-bottom pb-2 mb-2">
                            <div class="row">
                                <div class="col-md-3">
                                    <strong>${task.task_libelle || 'N/A'}</strong>
                                    ${hasValidatedHours ? '<br><small class="text-success"><i class="fas fa-check-circle me-1"></i>Heures validées</small>' : ''}
                                </div>
                                <div class="col-md-2">
                                    <span class="badge ${statusClass}">${task.effective_status || task.statut || 'N/A'}</span>
                                    ${hasValidatedHours && task.statut === 'PLANIFIEE' ? '<br><small class="text-success">→ EN_COURS</small>' : ''}
                                </div>
                                <div class="col-md-3">
                                    <small>Planifié: ${task.duree_planifiee || 0}h</small>
                                    <br><small class="text-success"><i class="fas fa-check-circle me-1"></i>Validées: ${task.heures_validees || 0}h</small>
                                    <br><small class="text-warning"><i class="fas fa-clock me-1"></i>En attente: ${task.heures_saisies || 0}h</small>
                                </div>
                                <div class="col-md-4">
                                    <div class="progress">
                                        <div class="progress-bar bg-success" role="progressbar" 
                                             style="width: ${task.progress_percentage || 0}%">
                                            ${task.progress_percentage || 0}%
                                        </div>
                                    </div>
                                    <small class="text-muted">
                                        Progression basée sur les heures validées
                                    </small>
                                </div>
                            </div>
                        </div>
                    `;
                });

                progressHtml += `
                        </div>
                    </div>
                `;
            } else {
                progressHtml += `
                    <div class="text-muted">
                        <i class="fas fa-info-circle me-2"></i>
                        Aucune tâche disponible pour cette mission
                    </div>
                `;
            }

            document.getElementById('tasksProgress').innerHTML = progressHtml;
        }

        // Utilitaires
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString('fr-FR');
        }

        function formatCurrency(amount, currencyCode = null) {
            if (!amount && amount !== 0) {
                if (currencyCode) {
                    return CURRENCY_CONFIG.format(0, currencyCode);
                }
                return CURRENCY_CONFIG.format(0, 'XAF');
            }
            return CURRENCY_CONFIG.format(amount, currencyCode || 'XAF');
        }

        function calculateDuration(startDate, endDate) {
            if (!startDate || !endDate) return 'N/A';

            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            return `${diffDays} jours`;
        }

        function formatResponsable(nom, prenom) {
            if (!nom && !prenom) return 'N/A';
            if (!nom) return prenom;
            if (!prenom) return nom;
            return `${prenom} ${nom}`;
        }

        function getStatusClass(status) {
            switch (status?.toLowerCase()) {
                case 'terminee':
                case 'completed':
                    return 'bg-success';
                case 'en_cours':
                case 'in_progress':
                    return 'bg-warning';
                case 'planifiee':
                case 'planned':
                    return 'bg-info';
                case 'suspendue':
                case 'suspended':
                    return 'bg-secondary';
                case 'annulee':
                case 'cancelled':
                    return 'bg-danger';
                default:
                    return 'bg-secondary';
            }
        }

        /**
         * Formate les heures avec code couleur selon le statut
         * @param {number} heures_saisies - Heures soumises (en attente)
         * @param {number} heures_validees - Heures approuvées
         * @returns {string} HTML formaté avec code couleur
         */
        function formatHoursWithStatus(heures_saisies, heures_validees) {
            heures_saisies = parseFloat(heures_saisies) || 0;
            heures_validees = parseFloat(heures_validees) || 0;

            // Si des heures sont validées, on affiche celles-là en vert (priorité)
            if (heures_validees > 0) {
                return `<span class="badge bg-success" title="Heures validées">
                    <i class="fas fa-check-circle me-1"></i>${heures_validees}h validées
                </span>`;
            }

            // Sinon, si des heures sont saisies, on les affiche en orange/warning
            if (heures_saisies > 0) {
                return `<span class="badge bg-warning text-dark" title="Heures en attente de validation">
                    <i class="fas fa-clock me-1"></i>${heures_saisies}h en attente
                </span>`;
            }

            // Aucune heure
            return `<span class="text-muted">0h</span>`;
        }

        function showError(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            const container = document.querySelector('.main-content-area');
            if (container) {
                container.insertBefore(alertDiv, container.firstChild);
            }
        }

        // Fonction pour ouvrir l'éditeur de planning
        function openPlanningEditor() {
            if (!missionId) {
                showError('ID de mission non disponible');
                return;
            }

            // Ouvrir l'éditeur de planning dans une nouvelle fenêtre
            const planningUrl = `edit-mission-planning.html?mission_id=${missionId}`;
            window.open(planningUrl, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
        }

        // Fonction pour mettre à jour les symboles de devise
        function updateCurrencySymbols(currencyCode) {
            if (typeof CURRENCY_CONFIG === 'undefined') {
                console.warn('CURRENCY_CONFIG non chargé');
                return;
            }

            const currency = CURRENCY_CONFIG.currencies[currencyCode];
            if (!currency) {
                console.warn(`Devise ${currencyCode} non trouvée dans CURRENCY_CONFIG`);
                return;
            }

            console.log(`💰 Mise à jour de la devise: ${currencyCode} (${currency.symbol})`);

            // Mettre à jour tous les symboles de devise
            document.querySelectorAll('.currency-symbol').forEach(el => {
                el.textContent = currency.symbol;
            });
        }


        // Functions for Financial Editor
        let conditionsRows = [];

        async function openFinancialEditor() {
            if (!currentMission) return;
            document.getElementById('editBudget').value = currentMission.budget_estime || currentMission.budget_prevue || 0;
            document.getElementById('editGlobalHon').value = currentMission.montant_honoraires || 0;
            document.getElementById('editGlobalDeb').value = currentMission.montant_debours || 0;

            // Populate Conditions Table
            const tbody = document.getElementById('conditionsTableBody');
            tbody.innerHTML = '';
            conditionsRows = [];

            let parsedConditions = [];
            const rawConditions = currentMission.conditions_paiement;

            if (rawConditions) {
                try {
                    if (typeof rawConditions === 'object') {
                        parsedConditions = rawConditions;
                    } else if (typeof rawConditions === 'string') {
                        try {
                            parsedConditions = JSON.parse(rawConditions);
                        } catch (e) {
                            parsedConditions = [];
                        }
                        if (typeof parsedConditions === 'string') {
                            try { parsedConditions = JSON.parse(parsedConditions); } catch (e) { }
                        }
                    }

                    if (!Array.isArray(parsedConditions)) {
                        if (parsedConditions && typeof parsedConditions === 'object') {
                            parsedConditions = Object.values(parsedConditions);
                        } else {
                            parsedConditions = [];
                        }
                    }
                } catch (e) {
                    console.warn('Failed to parse existing conditions for editor', e);
                }
            }

            if (parsedConditions.length === 0) {
                addConditionRow();
            } else {
                parsedConditions.forEach(cond => addConditionRow(cond));
            }

            new bootstrap.Modal(document.getElementById('financialEditorModal')).show();
            calculateRowAmounts(); // Initial calculation
            validateGlobalAmounts();
        }

        function addConditionRow(data = {}) {
            const tbody = document.getElementById('conditionsTableBody');
            const rowId = 'cond-row-' + Date.now() + Math.random().toString(36).substr(2, 5);

            // Handle both snake_case and camelCase
            const pctHon = data.pourcentage_honoraires ?? data.pourcentageHonoraires ?? 0;
            // Amounts are re-calculated, but let's grab what we have or 0
            const mntHon = data.montant_honoraires ?? data.montantHonoraires ?? 0;
            const pctDeb = data.pourcentage_debours ?? data.pourcentageDebours ?? 0;
            const mntDeb = data.montant_debours ?? data.montantDebours ?? 0;
            const dateVal = data.date ?? data.datePrevisionnelle ?? '';
            const detailsVal = data.details || '';

            const tr = document.createElement('tr');
            tr.id = rowId;
            tr.innerHTML = `
                <td><input type="number" class="form-control form-control-sm" name="pct_hon" value="${pctHon}" step="0.1" style="width: 60px;" oninput="calculateRowAmounts()"></td>
                <td><input type="number" class="form-control form-control-sm bg-light" name="mnt_hon" value="${mntHon}" style="width: 80px;" readonly></td>
                <td><input type="number" class="form-control form-control-sm" name="pct_deb" value="${pctDeb}" step="0.1" style="width: 60px;" oninput="calculateRowAmounts()"></td>
                <td><input type="number" class="form-control form-control-sm bg-light" name="mnt_deb" value="${mntDeb}" style="width: 80px;" readonly></td>
                <td><input type="date" class="form-control form-control-sm" name="date" value="${dateVal ? dateVal.split('T')[0] : ''}" style="width: 110px;"></td>
                <td><input type="text" class="form-control form-control-sm" name="details" value="${detailsVal}" placeholder="Description"></td>
                <td class="text-center">
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeConditionRow('${rowId}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
            calculateRowAmounts(); // Update amounts immediately
        }

        function removeConditionRow(rowId) {
            const row = document.getElementById(rowId);
            if (row) {
                row.remove();
                calculateRowAmounts();
            }
        }

        function calculateRowAmounts() {
            const globalHon = parseFloat(document.getElementById('editGlobalHon').value) || 0;
            const globalDeb = parseFloat(document.getElementById('editGlobalDeb').value) || 0;

            const rows = document.querySelectorAll('#conditionsTableBody tr');
            let sumPctHon = 0;
            let sumRowHon = 0;
            let sumPctDeb = 0;
            let sumRowDeb = 0;

            rows.forEach(row => {
                // Read percentages
                const pctHon = parseFloat(row.querySelector('[name="pct_hon"]').value) || 0;
                const pctDeb = parseFloat(row.querySelector('[name="pct_deb"]').value) || 0;

                // Calculate amounts
                const mntHon = (globalHon * pctHon) / 100;
                const mntDeb = (globalDeb * pctDeb) / 100;

                // Update inputs
                row.querySelector('[name="mnt_hon"]').value = mntHon.toFixed(2);
                row.querySelector('[name="mnt_deb"]').value = mntDeb.toFixed(2);

                // Sums
                sumPctHon += pctHon;
                sumRowHon += mntHon;
                sumPctDeb += pctDeb;
                sumRowDeb += mntDeb;
            });

            // Update Footer with Totals
            const devise = currentMission.devise || 'XAF';
            document.getElementById('totalPctHon').textContent = sumPctHon.toFixed(1) + '%';
            document.getElementById('totalRowHon').textContent = formatCurrency(sumRowHon, devise);
            document.getElementById('totalPctDeb').textContent = sumPctDeb.toFixed(1) + '%';
            document.getElementById('totalRowDeb').textContent = formatCurrency(sumRowDeb, devise);

            // Color indicators for 100% check
            document.getElementById('totalPctHon').className = (Math.abs(sumPctHon - 100) < 0.1) ? 'text-success fw-bold' : 'text-danger fw-bold';
            document.getElementById('totalPctDeb').className = (Math.abs(sumPctDeb - 100) < 0.1) ? 'text-success fw-bold' : 'text-danger fw-bold';
        }

        function validateGlobalAmounts() {
            const budget = parseFloat(document.getElementById('editBudget').value) || 0;
            const globalHon = parseFloat(document.getElementById('editGlobalHon').value) || 0;
            const globalDeb = parseFloat(document.getElementById('editGlobalDeb').value) || 0;

            const warningEl = document.getElementById('globalAmountWarning');
            if ((globalHon + globalDeb) > budget) {
                warningEl.textContent = `Attention: Total (${formatCurrency(globalHon + globalDeb, 'XAF')}) > Budget (${formatCurrency(budget, 'XAF')})`;
                warningEl.className = 'alert alert-danger py-1 mb-2 small'; // show
                return false;
            } else {
                warningEl.className = 'd-none'; // hide
                return true;
            }
        }

        async function handleSaveFinancial(event) {
            if (event) event.preventDefault();

            console.log("handleSaveFinancial triggered");

            if (!validateGlobalAmounts()) {
                console.warn("Global Amount Validation failed. Blocking save.");
                alert("Le budget est dépassé par le total des honoraires et débours. Veuillez corriger avant de sauvegarder.");
                return false;
            }

            // Double check strict
            const budget = parseFloat(document.getElementById('editBudget').value) || 0;
            const globalHon = parseFloat(document.getElementById('editGlobalHon').value) || 0;
            const globalDeb = parseFloat(document.getElementById('editGlobalDeb').value) || 0;

            if ((globalHon + globalDeb) > budget + 0.01) { // Epsilon for float
                alert("Le budget est dépassé (Double Check). Sauvegarde annulée.");
                return false;
            }

            // Build JSON from table and check percentages / mandatory fields
            const rows = document.querySelectorAll('#conditionsTableBody tr');
            let sumPctHon = 0;
            let sumPctDeb = 0;
            let missingFields = false;

            const conditionsArray = Array.from(rows).map((row, index) => {
                const pctHon = parseFloat(row.querySelector('[name="pct_hon"]').value) || 0;
                const pctDeb = parseFloat(row.querySelector('[name="pct_deb"]').value) || 0;

                const dateVal = row.querySelector('[name="date"]').value;
                const detailsVal = row.querySelector('[name="details"]').value;

                // Mandatory Fields Check
                if (!dateVal || !detailsVal.trim()) {
                    missingFields = true;
                    // Visual feedback could be added here (e.g., border red)
                    row.querySelector('[name="date"]').classList.toggle('is-invalid', !dateVal);
                    row.querySelector('[name="details"]').classList.toggle('is-invalid', !detailsVal.trim());
                } else {
                    row.querySelector('[name="date"]').classList.remove('is-invalid');
                    row.querySelector('[name="details"]').classList.remove('is-invalid');
                }

                sumPctHon += pctHon;
                sumPctDeb += pctDeb;

                // Amount calculation logic is duplicated here for payload, 
                // but relying on calculateRowAmounts() visually is safer.
                // We'll recompute to be 100% sure the payload is consistent with the percentage.
                const mntHon = (globalHon * pctHon) / 100;
                const mntDeb = (globalDeb * pctDeb) / 100;

                return {
                    pourcentage_honoraires: pctHon,
                    montant_honoraires: mntHon,
                    pourcentage_debours: pctDeb,
                    montant_debours: mntDeb,
                    date: dateVal,
                    details: detailsVal
                };
            });

            if (missingFields) {
                alert("Veuillez remplir la DATE et les DÉTAILS pour toutes les lignes.");
                return false;
            }

            // Validate Percentages
            // 1. Honoraires: Must be 100% IF there is a global amount > 0.
            // If globalHon is 0, sumPctHon can be anything (or 0), but let's enforce 100% or 0%? 
            // Usually if money involved -> 100%. If money=0, who cares.

            if (globalHon > 0) {
                if (Math.abs(sumPctHon - 100) > 0.1) {
                    alert(`Le total des pourcentages d'honoraires est de ${sumPctHon.toFixed(1)}%. Il doit être de 100%.`);
                    return false;
                }
            }

            if (globalDeb > 0) {
                if (Math.abs(sumPctDeb - 100) > 0.1) {
                    alert(`Le total des pourcentages de débours est de ${sumPctDeb.toFixed(1)}%. Il doit être de 100%.`);
                    return false;
                }
            }

            try {
                const response = await authenticatedFetch(`/api/missions/${missionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        budget_estime: budget,
                        montant_honoraires: globalHon,
                        montant_debours: globalDeb,
                        conditions_paiement: JSON.stringify(conditionsArray)
                    })
                });

                if (response.ok) {
                    location.reload();
                } else {
                    const err = await response.json();
                    alert('Erreur lors de la sauvegarde: ' + (err.error || 'Erreur inconnue'));
                }
            } catch (error) {
                console.error(error);
                alert('Erreur de connexion');
            }
        }
    </script>
</body>

</html>