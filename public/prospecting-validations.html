<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validations de Campagnes - Prospection - V7</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/modern-sidebar.css">
    
    <style>
        .page-wrapper {
            display: flex;
            min-height: 100vh;
        }
        .main-content-area {
            flex-grow: 1;
            padding: 2rem;
        }
        
        .validation-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: box-shadow 0.3s ease, transform 0.3s ease;
        }
        
        .validation-card:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .validation-card.urgent {
            border-left: 5px solid #dc3545;
        }
        
        .validation-card.warning {
            border-left: 5px solid #ffc107;
        }
        
        .campaign-stats {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .stats-item {
            text-align: center;
        }
        
        .stats-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #495057;
        }
        
        .days-remaining {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: bold;
        }
        
        .days-remaining.urgent {
            background: #dc3545;
            color: white;
        }
        
        .days-remaining.warning {
            background: #ffc107;
            color: #212529;
        }
        
        .days-remaining.normal {
            background: #28a745;
            color: white;
        }
        
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .demandeur-info {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }
        
                 .demandeur-avatar {
             width: 40px;
             height: 40px;
             border-radius: 50%;
             background: linear-gradient(45deg, #667eea, #764ba2);
             display: flex;
             align-items: center;
             justify-content: center;
             color: white;
             font-weight: bold;
             margin-right: 0.75rem;
         }
         
         /* Styles pour le modal de validation */
         .modal-xl {
             max-width: 95%;
         }
         
         .company-note {
             font-size: 0.9rem;
             border: 1px solid #dee2e6;
             border-radius: 4px;
             transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
         }
         
         .company-note:focus {
             border-color: #80bdff;
             outline: 0;
             box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
         }
         
         .table th {
             font-size: 0.9rem;
             font-weight: 600;
             vertical-align: middle;
         }
         
         .table td {
             vertical-align: middle;
             padding: 0.75rem 0.5rem;
         }
         
         .table td small {
             color: #6c757d;
             line-height: 1.2;
         }
         
         .company-avatar {
             width: 32px;
             height: 32px;
             border-radius: 50%;
             background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
             color: white;
             display: flex;
             align-items: center;
             justify-content: center;
             font-weight: bold;
             font-size: 12px;
         }
    </style>
    <!-- Script pour la gestion utilisateur -->
    <script src="js/user-header.js"></script>
    <script src="js/menu-permissions.js"></script>
    <script src="/js/page-permissions.js"></script>
    <script src="js/profile-menu.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/tasks.js"></script>

    <!-- CSS des variables de branding dynamiques -->
    <link rel="stylesheet" href="/config/themes/brand-variables.css">
    
    <!-- Scripts de branding -->
    <script src="js/branding-loader.js"></script>
    <script src="js/sidebar-branding.js"></script>
</head>
<body>
    <button class="sidebar-toggle d-md-none">
        <i class="fas fa-bars"></i>
    </button>
    <div class="page-wrapper">
        <div class="sidebar-container"></div>
        <div class="main-content-area">
            <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1><i class="fas fa-clipboard-check me-3"></i>Validations de Campagnes</h1>
                    <button class="btn btn-outline-primary" onclick="loadValidations()">
                        <i class="fas fa-sync me-1"></i>Actualiser
                    </button>
                </div>

                <!-- Statistiques des validations -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-warning mb-1" id="pendingCount">0</h3>
                                <p class="mb-0">En attente</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-danger mb-1" id="urgentCount">0</h3>
                                <p class="mb-0">Urgentes (< 2 jours)</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-success mb-1" id="approvedCount">0</h3>
                                <p class="mb-0">Approuv√©es ce mois</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-secondary mb-1" id="rejectedCount">0</h3>
                                <p class="mb-0">Rejet√©es ce mois</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filtres -->
                <div class="card mb-4">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-filter me-2"></i>
                                Filtres
                            </h5>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary" id="pendingBtn" onclick="toggleView('pending')">
                                    <i class="fas fa-clock me-1"></i>En attente
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="allBtn" onclick="toggleView('all')">
                                    <i class="fas fa-list me-1"></i>Toutes les validations
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-end">
                            <div class="col-md-3">
                                <label class="form-label">Statut</label>
                                <select class="form-select" id="statusFilter" onchange="filterValidations()">
                                    <option value="">Tous les statuts</option>
                                    <option value="EN_ATTENTE">En attente</option>
                                    <option value="APPROUVE">Approuv√©</option>
                                    <option value="REFUSE">Refus√©</option>
                                    <option value="EXPIRE">Expir√©</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Niveau</label>
                                <select class="form-select" id="levelFilter" onchange="filterValidations()">
                                    <option value="">Tous les niveaux</option>
                                    <option value="DIVISION">Division</option>
                                    <option value="BUSINESS_UNIT">Business Unit</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Priorit√©</label>
                                <select class="form-select" id="priorityFilter" onchange="filterValidations()">
                                    <option value="">Toutes</option>
                                    <option value="urgent">Urgentes</option>
                                    <option value="warning">Bient√¥t expir√©es</option>
                                    <option value="normal">Normales</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                                    <i class="fas fa-times me-1"></i>Effacer filtres
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Liste des validations -->
                <div class="row">
                    <div class="col-12">
                        <div id="validationsContainer">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Chargement...</span>
                                </div>
                                <p class="mt-2">Chargement des validations...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

         <!-- Modal de traitement de validation -->
     <div class="modal fade" id="processValidationModal" tabindex="-1">
         <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-gavel me-2"></i>
                        Traiter la validation
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="validationId">
                    <input type="hidden" id="campaignId">
                    
                    <!-- Informations de la campagne -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">Informations de la campagne</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Nom :</strong> <span id="modalCampaignName"></span></p>
                                    <p><strong>Canal :</strong> <span id="modalCampaignChannel"></span></p>
                                    <p><strong>Niveau requis :</strong> <span id="modalValidationLevel"></span></p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Demandeur :</strong> <span id="modalDemandeur"></span></p>
                                    <p><strong>Date demande :</strong> <span id="modalRequestDate"></span></p>
                                    <p><strong>Expire le :</strong> <span id="modalExpiryDate"></span></p>
                                </div>
                            </div>
                            <div id="modalDemandeurComment" class="mt-2"></div>
                        </div>
                    </div>
                    
                                         <!-- Liste des entreprises √† valider -->
                     <div class="card mb-3">
                         <div class="card-header">
                             <h6 class="mb-0">Entreprises √† valider</h6>
                         </div>
                         <div class="card-body">
                             <div id="companiesValidationList" class="table-responsive">
                                 <!-- Les entreprises seront charg√©es ici -->
                             </div>
                         </div>
                     </div>
                    
                                         <!-- D√©cision globale -->
                     <div class="mb-3">
                         <label class="form-label">D√©cision globale *</label>
                         <div class="btn-group w-100" role="group">
                             <input type="radio" class="btn-check" name="decision" id="approve" value="APPROUVE">
                             <label class="btn btn-outline-success" for="approve">
                                 <i class="fas fa-check me-1"></i>Approuver la campagne
                             </label>
                             
                             <input type="radio" class="btn-check" name="decision" id="reject" value="REFUSE">
                             <label class="btn btn-outline-danger" for="reject">
                                 <i class="fas fa-times me-1"></i>Rejeter la campagne
                             </label>
                         </div>
                     </div>
                     
                     <!-- Commentaire global -->
                     <div class="mb-3">
                         <label for="validatorComment" class="form-label">Commentaire global (optionnel)</label>
                         <textarea class="form-control" id="validatorComment" rows="3" 
                                   placeholder="Ajoutez un commentaire global sur votre d√©cision..."></textarea>
                     </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="submitValidation()">
                        <i class="fas fa-gavel me-1"></i>Valider la d√©cision
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/sidebar.js"></script>
    
    
    
    <script src="js/session-manager.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    
    <script>
        const API = '/api/prospecting';
        let allValidations = [];
        let filteredValidations = [];
        let currentView = 'pending'; // 'pending' ou 'all'
        
        // Fonction getAuthHeader si elle n'est pas d√©finie dans auth.js
        function getAuthHeader() {
            const token = localStorage.getItem('authToken');
            return {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
        }

        async function loadValidations() {
            try {
                // Utiliser la nouvelle API simplifi√©e
                const url = currentView === 'all' ? `${API}/validations?all=true` : `${API}/validations`;
                const response = await fetch(url, { headers: getAuthHeader() });
                
                if (response.status === 401) {
                    // L'utilisateur n'est pas un manager
                    document.getElementById('validationsContainer').innerHTML = `
                        <div class="text-center py-5">
                            <i class="fas fa-user-shield fa-3x text-muted mb-3"></i>
                            <h5>Acc√®s restreint</h5>
                            <p class="text-muted">Cette page est r√©serv√©e aux responsables de Business Units et Divisions.</p>
                            <p class="text-muted">Contactez votre administrateur si vous pensez avoir besoin d'acc√®s.</p>
                        </div>
                    `;
                    return;
                }
                
                const result = await response.json();
                console.log('üì° loadValidations - R√©ponse API:', result);
                
                if (result.success) {
                    allValidations = result.data || [];
                    console.log('üìä loadValidations - allValidations charg√©es:', allValidations);
                    console.log('üìä loadValidations - nombre de validations:', allValidations.length);
                    
                    filteredValidations = [...allValidations];
                    renderValidations();
                    updateStats();
                } else {
                    console.error('Erreur chargement validations:', result.error);
                    document.getElementById('validationsContainer').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Erreur lors du chargement des validations: ${result.error}
                        </div>
                    `;
                }
            } catch (e) {
                console.error('Erreur chargement validations:', e);
                document.getElementById('validationsContainer').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Erreur lors du chargement des validations: ${e.message}
                    </div>
                `;
            }
        }

        function canValidate(validation, businessUnits, divisions, campaign) {
            console.log('üîç canValidate - validation:', validation);
            console.log('üîç canValidate - businessUnits:', businessUnits);
            console.log('üîç canValidate - divisions:', divisions);
            console.log('üîç canValidate - campaign:', campaign);
            
            if (validation.niveau_validation === 'BUSINESS_UNIT') {
                console.log('üîç V√©rification BU - campaign.business_unit_id:', campaign?.business_unit_id);
                return businessUnits.some(bu => {
                    console.log('üîç Comparaison BU:', bu.id, '===', campaign?.business_unit_id);
                    return bu.id === campaign?.business_unit_id;
                });
            } else if (validation.niveau_validation === 'DIVISION') {
                console.log('üîç V√©rification Division - campaign.division_id:', campaign?.division_id);
                return divisions.some(div => {
                    console.log('üîç Comparaison Division:', div.id, '===', campaign?.division_id);
                    return div.id === campaign?.division_id;
                });
            }
            return false;
        }

        function renderValidations() {
            const container = document.getElementById('validationsContainer');
            
            if (filteredValidations.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5>Aucune validation en attente</h5>
                        <p class="text-muted">Toutes les validations sont √† jour.</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            filteredValidations.forEach(validation => {
                const daysRemaining = getDaysRemaining(validation.expires_at);
                const urgencyClass = daysRemaining <= 1 ? 'urgent' : daysRemaining <= 2 ? 'warning' : '';
                const urgencyBadgeClass = daysRemaining <= 1 ? 'urgent' : daysRemaining <= 2 ? 'warning' : 'normal';
                
                // D√©terminer le statut de validation
                let statusBadge = '';
                if (validation.statut_validation === 'EN_ATTENTE') {
                    statusBadge = '<span class="badge bg-warning">En attente</span>';
                } else if (validation.statut_validation === 'APPROUVE') {
                    statusBadge = '<span class="badge bg-success">Approuv√©e</span>';
                } else if (validation.statut_validation === 'REFUSE') {
                    statusBadge = '<span class="badge bg-danger">Rejet√©e</span>';
                }
                
                // Calculer les statistiques de la campagne
                const companiesCount = validation.companies_count || 0;
                const emailCount = validation.emails_count || 0;
                const sectorsCount = validation.sectors_count || 0;
                const citiesCount = validation.cities_count || 0;
                
                html += `
                    <div class="validation-card ${urgencyClass}" data-validation-id="${validation.id}">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div class="flex-grow-1">
                                <h5 class="mb-2">
                                    <i class="fas fa-bullhorn text-primary me-2"></i>
                                    ${validation.campaign_name}
                                </h5>
                                <div class="demandeur-info">
                                    <div class="demandeur-avatar">
                                        ${getInitials(`${validation.demandeur_prenom} ${validation.demandeur_nom}`)}
                                    </div>
                                    <div>
                                        <strong>Demandeur :</strong> ${validation.demandeur_prenom} ${validation.demandeur_nom}<br>
                                        <small class="text-muted">
                                            Demand√© le ${new Date(validation.created_at).toLocaleDateString('fr-FR')}
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-info">${validation.niveau_validation}</span><br>
                                ${statusBadge}<br>
                                ${validation.statut_validation === 'EN_ATTENTE' ? `
                                    <span class="days-remaining ${urgencyBadgeClass} mt-2">
                                        ${daysRemaining} jour${daysRemaining > 1 ? 's' : ''} restant${daysRemaining > 1 ? 's' : ''}
                                    </span>
                                ` : ''}
                                ${validation.statut_validation !== 'EN_ATTENTE' ? `
                                    <small class="text-muted mt-2">
                                        ${validation.validateur_nom ? `Valid√© par ${validation.validateur_prenom} ${validation.validateur_nom}` : ''}
                                        ${validation.date_validation ? `<br>le ${new Date(validation.date_validation).toLocaleDateString('fr-FR')}` : ''}
                                    </small>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="campaign-stats">
                            <div class="row text-center">
                                <div class="col-3">
                                    <div class="stats-item">
                                        <div class="stats-number">${companiesCount}</div>
                                        <small class="text-muted">Entreprises</small>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="stats-item">
                                        <div class="stats-number">${emailCount}</div>
                                        <small class="text-muted">Emails</small>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="stats-item">
                                        <div class="stats-number">${sectorsCount}</div>
                                        <small class="text-muted">Secteurs</small>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="stats-item">
                                        <div class="stats-number">${citiesCount}</div>
                                        <small class="text-muted">Villes</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        ${validation.commentaire_demandeur ? `
                            <div class="alert alert-light mt-2">
                                <strong>Commentaire du demandeur :</strong><br>
                                ${validation.commentaire_demandeur}
                            </div>
                        ` : ''}
                        ${validation.statut_validation !== 'EN_ATTENTE' && validation.commentaire_validateur ? `
                            <div class="alert alert-${validation.statut_validation === 'APPROUVE' ? 'success' : 'danger'} mt-2">
                                <strong>Commentaire du validateur :</strong><br>
                                ${validation.commentaire_validateur}
                            </div>
                        ` : ''}
                        
                        <div class="action-buttons">
                            ${validation.statut_validation === 'EN_ATTENTE' ? `
                                <button class="btn btn-primary" onclick="openValidationModal('${validation.id}', '${validation.campaign_id}')">
                                    <i class="fas fa-gavel me-1"></i>Traiter la validation
                                </button>
                            ` : ''}
                            <button class="btn btn-outline-info" onclick="viewCampaignSummary('${validation.campaign_id}')">
                                <i class="fas fa-eye me-1"></i>Voir d√©tails
                            </button>
                            ${validation.statut_validation === 'APPROUVE' ? `
                                <button class="btn btn-success" onclick="viewCampaignExecution('${validation.campaign_id}')">
                                    <i class="fas fa-play me-1"></i>Ex√©cuter
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function updateStats() {
            console.log('üìä updateStats - allValidations:', allValidations);
            console.log('üìä updateStats - nombre total de validations:', allValidations.length);
            
            const pending = allValidations.filter(v => v.statut_validation === 'EN_ATTENTE').length;
            const urgent = allValidations.filter(v => v.statut_validation === 'EN_ATTENTE' && getDaysRemaining(v.expires_at) <= 1).length;
            const approved = allValidations.filter(v => v.statut_validation === 'APPROUVE').length;
            const rejected = allValidations.filter(v => v.statut_validation === 'REFUSE').length;
            
            console.log('üìä Statistiques calcul√©es:', { pending, urgent, approved, rejected });
            
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('urgentCount').textContent = urgent;
            document.getElementById('approvedCount').textContent = approved;
            document.getElementById('rejectedCount').textContent = rejected;
        }

        function getDaysRemaining(expiryDate) {
            const now = new Date();
            const expiry = new Date(expiryDate);
            const diffTime = expiry - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return Math.max(0, diffDays);
        }

        function getInitials(fullName) {
            return fullName.split(' ').map(n => n[0]).join('').toUpperCase();
        }

                 async function loadCompaniesForValidation(campaignId) {
             try {
                 console.log('üîç Chargement des entreprises pour la campagne:', campaignId);
                 
                 const companiesRes = await fetch(`${API}/campaigns/${campaignId}/companies`, { headers: getAuthHeader() });
                 console.log('üì° R√©ponse API brute:', companiesRes);
                 
                 const companiesData = await companiesRes.json();
                 console.log('üìä Donn√©es JSON re√ßues:', companiesData);
                 
                 if (!companiesData.success) {
                     console.error('‚ùå Erreur API:', companiesData);
                     throw new Error('Erreur lors du chargement des entreprises');
                 }
                 
                 const companies = companiesData.data || [];
                 console.log('üìä Entreprises extraites:', companies);
                 console.log('üìä Nombre d\'entreprises:', companies.length);
                 
                 const container = document.getElementById('companiesValidationList');
                 
                 if (companies.length === 0) {
                     console.log('‚ö†Ô∏è Aucune entreprise trouv√©e');
                     container.innerHTML = `
                         <div class="alert alert-info">
                             <i class="fas fa-info-circle me-2"></i>
                             Aucune entreprise trouv√©e pour cette campagne.
                         </div>
                     `;
                     return;
                 }
                 
                                   let html = `
                      <table class="table table-striped table-hover">
                          <thead class="table-dark">
                              <tr>
                                  <th style="width: 20%;">Entreprise</th>
                                  <th style="width: 12%;">Secteur</th>
                                  <th style="width: 10%;">Ville</th>
                                  <th style="width: 15%;">Email</th>
                                  <th style="width: 12%;">T√©l√©phone</th>
                                  <th style="width: 15%;">Validation</th>
                                  <th style="width: 16%;">Note</th>
                              </tr>
                          </thead>
                          <tbody>
                  `;
                  
                  companies.forEach((company, index) => {
                      html += `
                          <tr>
                              <td>
                                  <strong>${company.name || 'N/A'}</strong>
                                  ${company.website ? `<br><small class="text-muted"><a href="${company.website}" target="_blank">${company.website}</a></small>` : ''}
                              </td>
                              <td><small>${company.industry || 'N/A'}</small></td>
                              <td><small>${company.city || 'N/A'}</small></td>
                              <td><small>${company.email || 'N/A'}</small></td>
                              <td><small>${company.phone || 'N/A'}</small></td>
                              <td>
                                  <div class="btn-group btn-group-sm" role="group">
                                      <input type="radio" class="btn-check" name="company_validation_${index}" id="ok_${index}" value="OK" checked>
                                      <label class="btn btn-outline-success" for="ok_${index}">
                                          <i class="fas fa-check"></i> OK
                                      </label>
                                      
                                      <input type="radio" class="btn-check" name="company_validation_${index}" id="not_ok_${index}" value="NOT_OK">
                                      <label class="btn btn-outline-danger" for="not_ok_${index}">
                                          <i class="fas fa-times"></i> Non OK
                                      </label>
                                  </div>
                              </td>
                              <td>
                                  <textarea class="form-control company-note" 
                                            rows="3" 
                                            placeholder="Note optionnelle..."
                                            data-company-id="${company.id}"
                                            data-company-index="${index}"
                                            style="min-width: 200px; resize: vertical;"></textarea>
                              </td>
                          </tr>
                      `;
                  });
                 
                 html += `
                         </tbody>
                     </table>
                 `;
                 
                 container.innerHTML = html;
                 
             } catch (e) {
                 console.error('Erreur chargement entreprises:', e);
                 document.getElementById('companiesValidationList').innerHTML = `
                     <div class="alert alert-danger">
                         <i class="fas fa-exclamation-triangle me-2"></i>
                         Erreur lors du chargement des entreprises: ${e.message}
                     </div>
                 `;
             }
         }

         async function openValidationModal(validationId, campaignId) {
             try {
                 const validation = allValidations.find(v => v.id === validationId);
                 if (!validation) return;
                 
                 // Remplir les informations
                 document.getElementById('validationId').value = validationId;
                 document.getElementById('campaignId').value = campaignId;
                 document.getElementById('modalCampaignName').textContent = validation.campaign_name;
                 document.getElementById('modalCampaignChannel').textContent = validation.campaign_channel;
                 document.getElementById('modalValidationLevel').textContent = validation.niveau_validation;
                 document.getElementById('modalDemandeur').textContent = `${validation.demandeur_prenom} ${validation.demandeur_nom}`;
                 document.getElementById('modalRequestDate').textContent = new Date(validation.created_at).toLocaleDateString('fr-FR');
                 document.getElementById('modalExpiryDate').textContent = new Date(validation.expires_at).toLocaleDateString('fr-FR');
                 
                 // Commentaire du demandeur
                 const commentDiv = document.getElementById('modalDemandeurComment');
                 if (validation.commentaire_demandeur) {
                     commentDiv.innerHTML = `
                         <div class="alert alert-info">
                             <strong>Commentaire du demandeur :</strong><br>
                             ${validation.commentaire_demandeur}
                         </div>
                     `;
                 } else {
                     commentDiv.innerHTML = '';
                 }
                 
                 // Charger et afficher les entreprises
                 await loadCompaniesForValidation(campaignId);
                 
                 // Cocher automatiquement tous les boutons "OK" par d√©faut
                 setTimeout(() => {
                     const companyValidationInputs = document.querySelectorAll('input[type="radio"][value="OK"]');
                     companyValidationInputs.forEach(input => {
                         if (!input.checked) {
                             input.checked = true;
                         }
                     });
                 }, 100);
                 
                 // R√©initialiser le formulaire
                 document.querySelectorAll('input[name="decision"]').forEach(input => input.checked = false);
                 document.getElementById('validatorComment').value = '';
                 
                 const modal = new bootstrap.Modal(document.getElementById('processValidationModal'));
                 modal.show();
             } catch (e) {
                 console.error('Erreur ouverture modal:', e);
                 alert('Erreur lors de l\'ouverture du modal');
             }
         }

                 async function submitValidation() {
             try {
                 const validationId = document.getElementById('validationId').value;
                 const campaignId = document.getElementById('campaignId').value;
                 const decision = document.querySelector('input[name="decision"]:checked')?.value;
                 const comment = document.getElementById('validatorComment').value.trim();
                 
                 if (!decision) {
                     alert('Veuillez s√©lectionner une d√©cision globale (Approuver ou Rejeter)');
                     return;
                 }
                 
                 // Collecter les validations individuelles des entreprises
                 const companyValidations = [];
                 const companyNotes = document.querySelectorAll('.company-note');
                 
                 companyNotes.forEach((noteElement, index) => {
                     const companyId = noteElement.getAttribute('data-company-id');
                     const companyIndex = noteElement.getAttribute('data-company-index');
                     const note = noteElement.value.trim();
                     
                     // R√©cup√©rer la validation s√©lectionn√©e pour cette entreprise
                     const selectedValidation = document.querySelector(`input[name="company_validation_${companyIndex}"]:checked`)?.value;
                     
                     if (companyId && selectedValidation) {
                         companyValidations.push({
                             company_id: companyId,
                             validation: selectedValidation,
                             note: note
                         });
                     }
                 });
                 
                 console.log('Validations des entreprises:', companyValidations);
                 
                 const response = await fetch(`${API}/campaigns/${campaignId}/validations/${validationId}/process`, {
                     method: 'POST',
                     headers: getAuthHeader(),
                     body: JSON.stringify({
                         decision: decision,
                         comment: comment,
                         company_validations: companyValidations
                     })
                 });
                 
                 const result = await response.json();
                 
                 if (result.success) {
                     alert(result.message || 'Validation trait√©e avec succ√®s');
                     
                     // Fermer le modal
                     const modal = bootstrap.Modal.getInstance(document.getElementById('processValidationModal'));
                     modal.hide();
                     
                     // Recharger les validations
                     await loadValidations();
                 } else {
                     alert('Erreur: ' + (result.error || 'Traitement √©chou√©'));
                 }
             } catch (e) {
                 console.error('Erreur traitement validation:', e);
                 alert('Erreur lors du traitement de la validation');
             }
         }

        function viewCampaignSummary(campaignId) {
            window.open(`/prospecting-campaign-summary.html?id=${campaignId}`, '_blank');
        }

        async function loadCompaniesForValidation(campaignId) {
            try {
                console.log('üîç Chargement des entreprises pour la campagne:', campaignId);
                
                const response = await fetch(`${API}/campaigns/${campaignId}/companies`, {
                    headers: getAuthHeader()
                });
                
                const result = await response.json();
                console.log('üì° R√©ponse API brute:', result);
                
                if (result.success) {
                    const companies = result.data || [];
                    console.log('üìä Entreprises extraites:', companies);
                    console.log('üìä Nombre d\'entreprises:', companies.length);
                    
                    renderCompaniesForValidation(companies);
                } else {
                    console.error('Erreur chargement entreprises:', result.error);
                    document.getElementById('companiesValidationList').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Erreur lors du chargement des entreprises: ${result.error}
                        </div>
                    `;
                }
            } catch (e) {
                console.error('Erreur chargement entreprises:', e);
                document.getElementById('companiesValidationList').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Erreur lors du chargement des entreprises: ${e.message}
                    </div>
                `;
            }
        }

        function renderCompaniesForValidation(companies) {
            const container = document.getElementById('companiesValidationList');
            
            if (companies.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-building fa-2x text-muted"></i>
                        <p class="text-muted mt-2">Aucune entreprise trouv√©e dans cette campagne</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Entreprise</th>
                                <th>Secteur</th>
                                <th>Ville</th>
                                <th>Validation</th>
                                <th>Note</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            companies.forEach((company, index) => {
                // Par d√©faut, toutes les entreprises sont positionn√©es √† "OK"
                // Sauf si elles ont d√©j√† √©t√© explicitement rejet√©es
                const validationStatus = company.validation_status || 'PENDING';
                const isRejected = validationStatus === 'REJECTED';
                const isApproved = !isRejected; // Par d√©faut, tout le reste est approuv√©
                
                html += `
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="company-avatar me-2">
                                    ${getInitials(company.name)}
                                </div>
                                <div>
                                    <strong>${company.name}</strong><br>
                                    <small class="text-muted">${company.email || 'Pas d\'email'}</small>
                                </div>
                            </div>
                        </td>
                        <td>${company.industry || 'Non d√©fini'}</td>
                        <td>${company.city || 'Non d√©finie'}</td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <input type="radio" class="btn-check" name="company_validation_${index}" 
                                       id="ok_${index}" value="OK" ${isApproved ? 'checked' : ''}>
                                <label class="btn btn-outline-success" for="ok_${index}">
                                    <i class="fas fa-check"></i> OK
                                </label>
                                
                                <input type="radio" class="btn-check" name="company_validation_${index}" 
                                       id="nok_${index}" value="NOT_OK" ${isRejected ? 'checked' : ''}>
                                <label class="btn btn-outline-danger" for="nok_${index}">
                                    <i class="fas fa-times"></i> Non OK
                                </label>
                            </div>
                        </td>
                        <td>
                            <textarea class="form-control form-control-sm company-note" 
                                      rows="2" placeholder="Note optionnelle..."
                                      data-company-id="${company.id}" 
                                      data-company-index="${index}">${company.notes || ''}</textarea>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        S√©lectionnez OK pour approuver l'entreprise, Non OK pour la rejeter. 
                        Vous pouvez ajouter des notes explicatives pour chaque entreprise.
                    </small>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function viewCampaignExecution(campaignId) {
            window.open(`/campaign-execution.html?id=${campaignId}`, '_blank');
        }

        function filterValidations() {
            const statusFilter = document.getElementById('statusFilter').value;
            const levelFilter = document.getElementById('levelFilter').value;
            const priorityFilter = document.getElementById('priorityFilter').value;
            
            filteredValidations = allValidations.filter(validation => {
                let passes = true;
                
                if (statusFilter && validation.statut_validation !== statusFilter) {
                    passes = false;
                }
                
                if (levelFilter && validation.niveau_validation !== levelFilter) {
                    passes = false;
                }
                
                if (priorityFilter) {
                    const daysRemaining = getDaysRemaining(validation.expires_at);
                    switch (priorityFilter) {
                        case 'urgent':
                            if (daysRemaining > 1) passes = false;
                            break;
                        case 'warning':
                            if (daysRemaining <= 1 || daysRemaining > 2) passes = false;
                            break;
                        case 'normal':
                            if (daysRemaining <= 2) passes = false;
                            break;
                    }
                }
                
                return passes;
            });
            
            renderValidations();
        }

        function clearFilters() {
            document.getElementById('statusFilter').value = '';
            document.getElementById('levelFilter').value = '';
            document.getElementById('priorityFilter').value = '';
            filteredValidations = [...allValidations];
            renderValidations();
        }

        function toggleView(view) {
            currentView = view;
            
            // Mettre √† jour l'apparence des boutons
            if (view === 'pending') {
                document.getElementById('pendingBtn').classList.remove('btn-outline-secondary');
                document.getElementById('pendingBtn').classList.add('btn-outline-primary');
                document.getElementById('allBtn').classList.remove('btn-outline-primary');
                document.getElementById('allBtn').classList.add('btn-outline-secondary');
            } else {
                document.getElementById('allBtn').classList.remove('btn-outline-secondary');
                document.getElementById('allBtn').classList.add('btn-outline-primary');
                document.getElementById('pendingBtn').classList.remove('btn-outline-primary');
                document.getElementById('pendingBtn').classList.add('btn-outline-secondary');
            }
            
            // Recharger les validations avec la nouvelle vue
            loadValidations();
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadValidations();
        });
    </script>
</body>
</html>



