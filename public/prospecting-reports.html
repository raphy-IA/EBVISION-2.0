<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapports de Prospection - EBVISION 2.0</title>
    
    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/modern-sidebar.css">
    
    <link rel="stylesheet" href="css/app-title.css">
    <link rel="stylesheet" href="css/prospecting-reports.css">
    
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            margin: 0;
            padding: 0;
        }

        .page-wrapper {
            display: flex;
            min-height: 100vh;
        }

        .main-content-area {
            flex-grow: 1; /* Prend l'espace restant */
            padding: 2rem;
            background-color: #f5f7fa;
        }

        /* Ajustements pour les petits écrans */
        @media (max-width: 768px) {
            .page-wrapper {
                flex-direction: column; /* Empile la sidebar et le contenu */
            }
            
            .main-content-area {
                padding: 1rem;
            }
        }

        .reports-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .filters-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            margin-bottom: 1rem;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .reports-table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .table-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1rem 1.5rem;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-brouillon { background-color: #e9ecef; color: #495057; }
        .status-en-validation { background-color: #fff3cd; color: #856404; }
        .status-valide { background-color: #d4edda; color: #155724; }
        .status-rejete { background-color: #f8d7da; color: #721c24; }
        .status-en-cours { background-color: #cce5ff; color: #004085; }
        .status-terminee { background-color: #d1ecf1; color: #0c5460; }

        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 3rem;
        }

        .export-buttons {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .campaign-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .progress-stats {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .progress-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .progress-item .badge {
            font-size: 0.7rem;
            min-width: 20px;
        }

        .progress-item small {
            font-size: 0.7rem;
            color: #6c757d;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .export-buttons {
                flex-direction: column;
            }

            .progress-stats {
                flex-direction: row;
                flex-wrap: wrap;
                gap: 0.5rem;
            }
        }
        
        /* Lignes déroulantes */
        .expandable-row {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .expandable-row:hover {
            background-color: #f8f9fa;
        }
        
        .expand-button {
            background: none;
            border: none;
            color: var(--primary-color);
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }
        
        .expand-button.expanded {
            transform: rotate(90deg);
        }
        
        .details-row {
            background-color: #f8f9fa;
            border-left: 4px solid var(--primary-color);
        }
        
        .details-row .table {
            margin-bottom: 0;
        }
        
        .details-row .table th {
            border-top: none;
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .details-row .table td {
            font-size: 0.9rem;
            vertical-align: middle;
        }
        
        .company-status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .status-approved { background: #d4edda; color: #155724; }
        .status-rejected { background: #f8d7da; color: #721c24; }
        .status-pending { background: #fff3cd; color: #856404; }
        
        .execution-status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .execution-deposed { background: #d1ecf1; color: #0c5460; }
        .execution-sent { background: #d4edda; color: #155724; }
        .execution-failed { background: #f8d7da; color: #721c24; }
        .execution-pending { background: #fff3cd; color: #856404; }
        
        .proof-file-link {
            color: var(--primary-color);
            text-decoration: none;
            font-size: 0.9rem;
        }
        
        .proof-file-link:hover {
            text-decoration: underline;
        }
        
        .notes-cell {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .notes-cell.expanded {
            white-space: normal;
            overflow: visible;
        }
        
        .company-row {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .company-row:hover {
            background-color: #e9ecef;
        }
        
        .company-icon {
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, #6c757d, #495057);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
        }
    </style>
    
    <!-- Scripts pour la top bar EBVISION 2.0 -->
    
    
    
</head>
<body>
    <!-- Bouton toggle sidebar mobile -->
    <button class="sidebar-toggle d-md-none">
        <i class="fas fa-bars"></i>
    </button>

    <div class="page-wrapper">
        <!-- Sidebar Container -->
        <div class="sidebar-container">
            <!-- Le contenu de la sidebar sera chargé dynamiquement -->
        </div>

        <!-- Main Content Area -->
        <div class="main-content-area">
        <!-- En-tête de la page -->
        <div class="reports-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="mb-2">
                        <i class="fas fa-chart-line me-3"></i>
                        Rapports de Prospection
                    </h1>
                    <p class="mb-0 opacity-75">Analysez et suivez vos campagnes de prospection</p>
                </div>
                <div class="text-end">
                    <div class="current-date" id="currentDate"></div>
                    <small class="opacity-75">Dernière mise à jour</small>
                </div>
            </div>
        </div>

        <!-- Filtres -->
        <div class="filters-card">
            <h5 class="mb-3">
                <i class="fas fa-filter me-2"></i>
                Filtres de rapport
            </h5>
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label class="form-label">Business Unit</label>
                    <select class="form-select" id="businessUnitFilter">
                        <option value="">Toutes les BU</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Division</label>
                    <select class="form-select" id="divisionFilter">
                        <option value="">Toutes les divisions</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Période</label>
                    <select class="form-select" id="periodFilter">
                        <option value="all">Toutes les périodes</option>
                        <option value="today">Aujourd'hui</option>
                        <option value="yesterday">Hier</option>
                        <option value="week">Cette semaine</option>
                        <option value="last_week">Semaine précédente</option>
                        <option value="month">Ce mois</option>
                        <option value="last_month">Mois précédent</option>
                        <option value="quarter">Ce trimestre</option>
                        <option value="year">Cette année</option>
                        <option value="custom">Période personnalisée</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Statut</label>
                    <select class="form-select" id="statusFilter">
                        <option value="">Tous les statuts</option>
                        <option value="BROUILLON">Brouillon</option>
                        <option value="EN_VALIDATION">En validation</option>
                        <option value="VALIDE">Validée</option>
                        <option value="REJETE">Rejetée</option>
                        <option value="EN_COURS">En cours</option>
                        <option value="TERMINEE">Terminée</option>
                    </select>
                </div>
            </div>
            
            <!-- Période personnalisée (cachée par défaut) -->
            <div class="row" id="customPeriodRow" style="display: none;">
                <div class="col-md-3 mb-3">
                    <label class="form-label">Date de début</label>
                    <input type="date" class="form-control" id="startDate">
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Date de fin</label>
                    <input type="date" class="form-control" id="endDate">
                </div>
            </div>
            
            <div class="d-flex justify-content-between align-items-center">
                <button class="btn btn-primary" onclick="generateReport()">
                    <i class="fas fa-search me-2"></i>
                    Générer le rapport
                </button>
                <button class="btn btn-outline-secondary" onclick="clearFilters()">
                    <i class="fas fa-times me-2"></i>
                    Effacer les filtres
                </button>
            </div>
        </div>

        <!-- Section des filtres actifs -->
        <div class="row mb-3">
            <div class="col-12">
                <div id="activeFiltersContainer">
                    <!-- Les filtres actifs seront affichés ici -->
                </div>
            </div>
        </div>

        <!-- Statistiques -->
        <div class="stats-grid" id="statsGrid">
            <div class="loading-spinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Chargement...</span>
                </div>
            </div>
        </div>

        <!-- Boutons d'export -->
        <div class="export-buttons" id="exportButtons" style="display: none;">
            <button class="btn btn-success" onclick="exportToExcel()">
                <i class="fas fa-file-excel me-2"></i>
                Exporter en Excel
            </button>
            <button class="btn btn-danger" onclick="exportToPDF()">
                <i class="fas fa-file-pdf me-2"></i>
                Exporter en PDF
            </button>
            <button class="btn btn-info" onclick="exportToCSV()">
                <i class="fas fa-file-csv me-2"></i>
                Exporter en CSV
            </button>
        </div>

        <!-- Tableau des résultats -->
        <div class="reports-table" id="reportsTable" style="display: none;">
            <div class="table-header">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i>
                    Détails des campagnes
                </h5>
            </div>
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 40px;"></th>
                            <th>Campagne</th>
                            <th>Statut</th>
                            <th>BU/Division</th>
                            <th>Type de dépôt</th>
                            <th>Total Entreprises</th>
                            <th>Exécution</th>
                            <th>Responsable</th>
                            <th>Date création</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="reportsTableBody">
                        <!-- Les données seront chargées ici -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/global-auth.js"></script>
    <!-- Script pour la gestion utilisateur -->
    <script src="js/user-header.js"></script>
    <script src="js/profile-menu.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/tasks.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/menu-permissions.js"></script>
    <script src="js/sidebar.js"></script>
    <script src="js/user-modals.js"></script>
    <script src="js/session-manager.js"></script>

    <script>
        // Variables globales
        const API = '/api/prospecting';
        let currentReportData = null;
        let businessUnits = [];
        let divisions = [];

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });

        function initializePage() {
            console.log('🚀 initializePage() appelée');
            
            // Afficher la date actuelle
            const currentDate = new Date();
            document.getElementById('currentDate').textContent = currentDate.toLocaleDateString('fr-FR', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            // Charger les données initiales
            loadBusinessUnits();
            loadDivisions();
            setupEventListeners();
            
            // Générer un rapport initial après le chargement des filtres
            setTimeout(() => {
                console.log('🔄 Génération du rapport initial...');
                generateReport();
            }, 1000);
        }

        function setupEventListeners() {
            console.log('🔧 Configuration des événements...');
            
            // Filtre de période personnalisée
            const periodFilter = document.getElementById('periodFilter');
            if (periodFilter) {
                periodFilter.addEventListener('change', function() {
                    const customRow = document.getElementById('customPeriodRow');
                    if (this.value === 'custom') {
                        customRow.style.display = 'block';
                    } else {
                        customRow.style.display = 'none';
                    }
                    generateReport();
                });
            }

            // Filtres qui déclenchent la génération du rapport
            const businessUnitFilter = document.getElementById('businessUnitFilter');
            if (businessUnitFilter) {
                businessUnitFilter.addEventListener('change', function() {
                    loadDivisionsForBusinessUnit();
                    generateReport();
                });
            }

            const divisionFilter = document.getElementById('divisionFilter');
            if (divisionFilter) {
                divisionFilter.addEventListener('change', generateReport);
            }

            const statusFilter = document.getElementById('statusFilter');
            if (statusFilter) {
                statusFilter.addEventListener('change', generateReport);
            }
            
            // Filtres de date
            const startDate = document.getElementById('startDate');
            if (startDate) {
                startDate.addEventListener('change', generateReport);
            }

            const endDate = document.getElementById('endDate');
            if (endDate) {
                endDate.addEventListener('change', generateReport);
            }
            
            // Bouton de génération manuelle
            const generateReportBtn = document.getElementById('generateReportBtn');
            if (generateReportBtn) {
                generateReportBtn.addEventListener('click', generateReport);
            }
            
            // Bouton de réinitialisation des filtres
            const clearFiltersBtn = document.getElementById('clearFiltersBtn');
            if (clearFiltersBtn) {
                clearFiltersBtn.addEventListener('click', function() {
                    clearFilters();
                    generateReport();
                });
            }
            
            console.log('✅ Événements configurés');
        }

        function getAuthHeader() {
            const token = localStorage.getItem('authToken');
            return {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
        }

        function showAlert(message, type = 'info') {
            // Créer une alerte Bootstrap moderne
            const alertContainer = document.createElement('div');
            alertContainer.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertContainer.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertContainer.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertContainer);
            
            // Auto-suppression après 5 secondes
            setTimeout(() => {
                if (alertContainer.parentNode) {
                    alertContainer.remove();
                }
            }, 5000);
        }

        function showActiveFilters(filters) {
            const activeFilters = [];
            
            if (filters.businessUnitId) {
                const buSelect = document.getElementById('businessUnitFilter');
                const selectedOption = buSelect.options[buSelect.selectedIndex];
                activeFilters.push(`BU: ${selectedOption.text}`);
            }
            
            if (filters.divisionId) {
                const divSelect = document.getElementById('divisionFilter');
                const selectedOption = divSelect.options[divSelect.selectedIndex];
                activeFilters.push(`Division: ${selectedOption.text}`);
            }
            
            if (filters.status) {
                const statusSelect = document.getElementById('statusFilter');
                const selectedOption = statusSelect.options[statusSelect.selectedIndex];
                activeFilters.push(`Statut: ${selectedOption.text}`);
            }
            
            if (filters.dateRange) {
                const periodSelect = document.getElementById('periodFilter');
                const selectedOption = periodSelect.options[periodSelect.selectedIndex];
                activeFilters.push(`Période: ${selectedOption.text}`);
            }
            
            if (activeFilters.length > 0) {
                const filtersContainer = document.getElementById('activeFiltersContainer');
                if (filtersContainer) {
                    filtersContainer.innerHTML = `
                        <div class="alert alert-info alert-dismissible fade show" role="alert">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <i class="fas fa-filter me-2"></i>
                                    <strong>Filtres actifs:</strong> ${activeFilters.join(' | ')}
                                </div>
                                <div>
                                    <button class="btn btn-outline-secondary btn-sm me-2" onclick="clearFilters()">
                                        <i class="fas fa-times me-1"></i>
                                        Effacer
                                    </button>
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } else {
                // Effacer le conteneur des filtres actifs
                const filtersContainer = document.getElementById('activeFiltersContainer');
                if (filtersContainer) {
                    filtersContainer.innerHTML = '';
                }
            }
        }

        // Fonctions de chargement des données
        async function loadBusinessUnits() {
            try {
                console.log('🔧 Chargement des Business Units...');
                const response = await fetch('/api/business-units?limit=100', {
                    headers: getAuthHeader()
                });
                
                if (response.ok) {
                    const data = await response.json();
                    businessUnits = data.data || [];
                    
                    // Filtrer seulement les BU actives
                    const activeBusinessUnits = businessUnits.filter(bu => bu.statut === 'ACTIF');
                    
                    const select = document.getElementById('businessUnitFilter');
                    select.innerHTML = '<option value="">Toutes les Business Units</option>';
                    
                    if (activeBusinessUnits.length > 0) {
                        activeBusinessUnits.forEach(bu => {
                            const option = document.createElement('option');
                            option.value = bu.id;
                            option.textContent = bu.nom;
                            select.appendChild(option);
                        });
                        console.log(`✅ ${activeBusinessUnits.length} Business Units actives chargées`);
                    } else {
                        const option = document.createElement('option');
                        option.value = "";
                        option.textContent = "Aucune Business Unit active disponible";
                        option.disabled = true;
                        select.appendChild(option);
                        console.log('⚠️ Aucune Business Unit active disponible');
                    }
                }
            } catch (error) {
                console.error('❌ Erreur chargement BU:', error);
            }
        }

        async function loadDivisions() {
            try {
                console.log('🔧 Chargement des divisions...');
                const response = await fetch('/api/divisions?limit=100', {
                    headers: getAuthHeader()
                });
                
                if (response.ok) {
                    const data = await response.json();
                    divisions = data.data || [];
                    
                    // Filtrer seulement les divisions actives
                    const activeDivisions = divisions.filter(div => div.statut === 'ACTIF');
                    
                    const select = document.getElementById('divisionFilter');
                    select.innerHTML = '<option value="">Toutes les divisions</option>';
                    
                    if (activeDivisions.length > 0) {
                        activeDivisions.forEach(div => {
                            const option = document.createElement('option');
                            option.value = div.id;
                            option.textContent = div.nom;
                            select.appendChild(option);
                        });
                        console.log(`✅ ${activeDivisions.length} divisions actives chargées`);
                    } else {
                        const option = document.createElement('option');
                        option.value = "";
                        option.textContent = "Aucune division active disponible";
                        option.disabled = true;
                        select.appendChild(option);
                        console.log('⚠️ Aucune division active disponible');
                    }
                }
            } catch (error) {
                console.error('❌ Erreur chargement divisions:', error);
            }
        }

        // Fonction pour charger les divisions d'une business unit
        async function loadDivisionsForBusinessUnit() {
            const businessUnitId = document.getElementById('businessUnitFilter').value;
            const divisionSelect = document.getElementById('divisionFilter');
            
            // Réinitialiser le sélecteur de division
            divisionSelect.innerHTML = '<option value="">Toutes les divisions</option>';
            
            if (!businessUnitId) {
                // Si aucune BU sélectionnée, charger toutes les divisions actives
                await loadDivisions();
                return;
            }
            
            try {
                console.log('🔧 Chargement des divisions pour BU:', businessUnitId);
                const response = await fetch(`/api/divisions?business_unit_id=${businessUnitId}&limit=100`, {
                    headers: getAuthHeader()
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const buDivisions = data.data || [];
                    
                    // Filtrer seulement les divisions actives
                    const activeDivisions = buDivisions.filter(div => div.statut === 'ACTIF');
                    
                    if (activeDivisions.length > 0) {
                        activeDivisions.forEach(div => {
                            const option = document.createElement('option');
                            option.value = div.id;
                            option.textContent = div.nom;
                            divisionSelect.appendChild(option);
                        });
                        console.log(`✅ ${activeDivisions.length} divisions actives chargées pour cette BU`);
                    } else {
                        const option = document.createElement('option');
                        option.value = "";
                        option.textContent = "Aucune division active pour cette BU";
                        option.disabled = true;
                        divisionSelect.appendChild(option);
                        console.log('⚠️ Aucune division active pour cette BU');
                    }
                }
            } catch (error) {
                console.error('❌ Erreur chargement divisions pour BU:', error);
            }
        }

        function clearFilters() {
            console.log('🧹 Effacement des filtres...');
            document.getElementById('businessUnitFilter').value = '';
            document.getElementById('divisionFilter').value = '';
            document.getElementById('periodFilter').value = 'all';
            document.getElementById('statusFilter').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('customPeriodRow').style.display = 'none';
            
            // Recharger les données avec les filtres effacés
            setTimeout(() => {
                generateReport();
            }, 100);
        }

        function getDateRange() {
            const period = document.getElementById('periodFilter').value;
            const now = new Date();
            let startDate, endDate;

            switch (period) {
                case 'today':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
                    break;
                case 'yesterday':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
                    endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1, 23, 59, 59);
                    break;
                case 'week':
                    const dayOfWeek = now.getDay();
                    const diff = now.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
                    startDate = new Date(now.getFullYear(), now.getMonth(), diff);
                    endDate = new Date(now.getFullYear(), now.getMonth(), diff + 6, 23, 59, 59);
                    break;
                case 'last_week':
                    const lastWeekDayOfWeek = now.getDay();
                    const lastWeekDiff = now.getDate() - lastWeekDayOfWeek + (lastWeekDayOfWeek === 0 ? -6 : 1) - 7;
                    startDate = new Date(now.getFullYear(), now.getMonth(), lastWeekDiff);
                    endDate = new Date(now.getFullYear(), now.getMonth(), lastWeekDiff + 6, 23, 59, 59);
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
                    break;
                case 'last_month':
                    startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    endDate = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59);
                    break;
                case 'quarter':
                    const quarter = Math.floor(now.getMonth() / 3);
                    startDate = new Date(now.getFullYear(), quarter * 3, 1);
                    endDate = new Date(now.getFullYear(), (quarter + 1) * 3, 0, 23, 59, 59);
                    break;
                case 'year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    endDate = new Date(now.getFullYear(), 11, 31, 23, 59, 59);
                    break;
                case 'custom':
                    startDate = new Date(document.getElementById('startDate').value);
                    endDate = new Date(document.getElementById('endDate').value);
                    endDate.setHours(23, 59, 59);
                    break;
                default:
                    return null;
            }

            return { startDate, endDate };
        }

        // Fonction principale de génération de rapport
        async function generateReport() {
            console.log('🚀 generateReport() appelée');
            try {
                // Afficher le spinner de chargement
                document.getElementById('statsGrid').innerHTML = `
                    <div class="loading-spinner text-center py-5">
                        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">Génération du rapport...</span>
                        </div>
                        <h5 class="text-muted">Génération du rapport en cours...</h5>
                        <p class="text-muted">Veuillez patienter pendant que nous récupérons vos données</p>
                    </div>
                `;

                // Récupérer les filtres
                const filters = {
                    businessUnitId: document.getElementById('businessUnitFilter').value,
                    divisionId: document.getElementById('divisionFilter').value,
                    status: document.getElementById('statusFilter').value,
                    dateRange: getDateRange()
                };

                console.log('🔍 Filtres appliqués:', filters);

                // Construire l'URL avec les paramètres
                const params = new URLSearchParams();
                if (filters.businessUnitId) params.append('business_unit_id', filters.businessUnitId);
                if (filters.divisionId) params.append('division_id', filters.divisionId);
                if (filters.status) params.append('status', filters.status);
                if (filters.dateRange) {
                    params.append('start_date', filters.dateRange.startDate.toISOString());
                    params.append('end_date', filters.dateRange.endDate.toISOString());
                }

                console.log('🔍 Paramètres URL:', params.toString());

                // Appeler l'API
                const response = await fetch(`${API}/reports?${params.toString()}`, {
                    headers: getAuthHeader()
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Erreur API:', response.status, errorText);
                    throw new Error(`Erreur ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                console.log('📊 Données reçues de l\'API:', data);
                
                if (data.success && data.data) {
                    currentReportData = data.data;

                    // Afficher les statistiques
                    renderStatistics(data.data.statistics);
                    
                    // Afficher le tableau
                    renderTable(data.data.campaigns);
                    
                    // Afficher un résumé des filtres actifs
                    showActiveFilters(filters);
                } else {
                    throw new Error('Format de données invalide');
                }
                
                // Afficher les boutons d'export
                document.getElementById('exportButtons').style.display = 'flex';

            } catch (error) {
                console.error('Erreur génération rapport:', error);
                
                // Afficher un message d'erreur plus informatif
                document.getElementById('statsGrid').innerHTML = `
                    <div class="alert alert-danger">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-triangle me-3" style="font-size: 2rem; color: #dc3545;"></i>
                            <div>
                                <h5 class="alert-heading mb-2">Erreur lors de la génération du rapport</h5>
                                <p class="mb-2">${error.message}</p>
                                <small class="text-muted">Vérifiez vos filtres ou contactez l'administrateur.</small>
                            </div>
                        </div>
                    </div>
                `;
                
                // Afficher un tableau vide
                renderTable([]);
                
                // Masquer les boutons d'export
                document.getElementById('exportButtons').style.display = 'none';
            }
        }

        function renderStatistics(stats) {
            const statsGrid = document.getElementById('statsGrid');
            
            // Vérifier si les statistiques existent
            if (!stats) {
                stats = {
                    totalCampaigns: 0,
                    totalCompanies: 0,
                    pendingCampaigns: 0,
                    approvedCampaigns: 0,
                    rejectedCampaigns: 0,
                    completionRate: 0,
                    totalDeposed: 0,
                    totalSent: 0,
                    totalConverted: 0,
                    avgExecutionRate: 0,
                    avgConversionRate: 0
                };
            }
            
            // Vérifier si toutes les statistiques sont à 0
            const allZero = Object.values(stats).every(value => !value || value === 0);
            if (allZero) {
                statsGrid.innerHTML = `
                    <div class="alert alert-info">
                        <div class="text-center py-4">
                            <i class="fas fa-info-circle mb-3" style="font-size: 3rem; color: #17a2b8;"></i>
                            <h5 class="alert-heading mb-3">Aucune donnée trouvée</h5>
                            <p class="mb-3">Aucune campagne de prospection ne correspond aux critères sélectionnés.</p>
                            <button class="btn btn-outline-info" onclick="clearFilters()">
                                <i class="fas fa-filter me-2"></i>
                                Effacer les filtres
                            </button>
                        </div>
                    </div>
                `;
                return;
            }
            
            statsGrid.innerHTML = `
                <!-- SECTION 1: VUE D'ENSEMBLE DES CAMPAGNES -->
                <div class="stats-section">
                    <h6 class="section-title">
                        <i class="fas fa-chart-line me-2"></i>
                        Vue d'ensemble des campagnes
                    </h6>
                    <div class="stats-row">
                        <div class="stat-card primary">
                            <div class="stat-icon">
                                <i class="fas fa-bullhorn"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number">${stats.totalCampaigns || 0}</div>
                                <div class="stat-label">Total Campagnes</div>
                            </div>
                        </div>
                        
                        <div class="stat-card warning">
                            <div class="stat-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number">${stats.pendingCampaigns || 0}</div>
                                <div class="stat-label">En Validation</div>
                            </div>
                        </div>
                        
                        <div class="stat-card success">
                            <div class="stat-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number">${stats.approvedCampaigns || 0}</div>
                                <div class="stat-label">Approuvées</div>
                            </div>
                        </div>
                        
                        <div class="stat-card danger">
                            <div class="stat-icon">
                                <i class="fas fa-times-circle"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number">${stats.rejectedCampaigns || 0}</div>
                                <div class="stat-label">Rejetées</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECTION 2: MÉTRIQUES DES ENTREPRISES -->
                <div class="stats-section">
                    <h6 class="section-title">
                        <i class="fas fa-building me-2"></i>
                        Métriques des entreprises
                    </h6>
                    <div class="stats-row">
                        <div class="stat-card info">
                            <div class="stat-icon">
                                <i class="fas fa-building"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number">${stats.totalCompanies || 0}</div>
                                <div class="stat-label">Total Entreprises</div>
                            </div>
                        </div>
                        
                        <div class="stat-card primary">
                            <div class="stat-icon">
                                <i class="fas fa-hand-holding"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number">${stats.totalDeposed || 0}</div>
                                <div class="stat-label">Courriers Déposés</div>
                            </div>
                        </div>
                        
                        <div class="stat-card success">
                            <div class="stat-icon">
                                <i class="fas fa-paper-plane"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number">${stats.totalSent || 0}</div>
                                <div class="stat-label">Emails Envoyés</div>
                            </div>
                        </div>
                        
                        <div class="stat-card warning">
                            <div class="stat-icon">
                                <i class="fas fa-exchange-alt"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number">${stats.totalConverted || 0}</div>
                                <div class="stat-label">Converties en Opportunités</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECTION 3: PERFORMANCE ET TAUX -->
                <div class="stats-section">
                    <h6 class="section-title">
                        <i class="fas fa-tachometer-alt me-2"></i>
                        Performance et taux
                    </h6>
                    <div class="stats-row">
                        <div class="stat-card purple">
                            <div class="stat-icon">
                                <i class="fas fa-percentage"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number">${stats.completionRate || 0}%</div>
                                <div class="stat-label">Taux de Complétion</div>
                            </div>
                        </div>
                        
                        <div class="stat-card blue">
                            <div class="stat-icon">
                                <i class="fas fa-play-circle"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number">${stats.avgExecutionRate || 0}%</div>
                                <div class="stat-label">Taux d'Exécution Moyen</div>
                            </div>
                        </div>
                        
                        <div class="stat-card green">
                            <div class="stat-icon">
                                <i class="fas fa-chart-pie"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number">${stats.avgConversionRate || 0}%</div>
                                <div class="stat-label">Taux de Conversion Moyen</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTable(campaigns) {
            const tableBody = document.getElementById('reportsTableBody');
            
            if (!campaigns || campaigns.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="11" class="text-center py-5">
                            <div class="empty-state">
                                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                <h6 class="text-muted mb-2">Aucune campagne trouvée</h6>
                                <p class="text-muted mb-3">Aucune campagne de prospection ne correspond aux critères sélectionnés.</p>
                                <button class="btn btn-outline-primary btn-sm" onclick="clearFilters()">
                                    <i class="fas fa-filter me-2"></i>
                                    Effacer les filtres
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            } else {
                tableBody.innerHTML = campaigns.map(campaign => `
                    <tr class="expandable-row" onclick="toggleCampaignDetails('${campaign.id}')">
                        <td>
                            <button class="expand-button" id="expand-${campaign.id}">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="campaign-icon me-2">
                                    <i class="fas fa-bullhorn"></i>
                                </div>
                                <div>
                                    <div class="fw-bold">${campaign.name || campaign.campaign_name || campaign.nom}</div>
                                    <small class="text-muted">${campaign.description || ''}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="status-badge status-${getStatusClass(campaign.validation_statut || campaign.statut)}">
                                ${getStatusText(campaign.validation_statut || campaign.statut)}
                            </span>
                        </td>
                        <td>
                            <div>${campaign.business_unit_name || 'N/A'}</div>
                            <small class="text-muted">${campaign.division_name || ''}</small>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="fas ${getTemplateTypeIcon(campaign.template_type || campaign.type_courrier)} me-1"></i>
                                <span>${campaign.template_name || 'N/A'}</span>
                            </div>
                        </td>
                        <td>
                            <div class="text-center">
                                <div class="fw-bold">${campaign.companies_count || 0}</div>
                                <small class="text-muted">Total</small>
                            </div>
                        </td>
                        <td>
                            <div class="progress-stats">
                                <div class="progress-item">
                                    <span class="badge bg-success">${campaign.deposed_count || 0}</span>
                                    <small>Déposés</small>
                                </div>
                                <div class="progress-item">
                                    <span class="badge bg-info">${campaign.sent_count || 0}</span>
                                    <small>Envoyés</small>
                                </div>
                                <div class="progress-item">
                                    <span class="badge bg-warning">${campaign.pending_execution_count || 0}</span>
                                    <small>En attente</small>
                                </div>
                                <div class="progress-item">
                                    <span class="badge bg-danger">${campaign.converted_count || 0}</span>
                                    <small>Converties</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="text-center">
                                <div class="fw-bold">${campaign.responsible_name || 'N/A'}</div>
                                <small class="text-muted">${campaign.responsible_prenom || ''}</small>
                            </div>
                        </td>
                        <td>
                            <small>${formatDate(campaign.created_at)}</small>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="event.stopPropagation(); viewCampaignDetails('${campaign.id}')" title="Voir détails">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-info" onclick="event.stopPropagation(); viewCampaignSummary('${campaign.id}')" title="Résumé">
                                    <i class="fas fa-file-alt"></i>
                                </button>
                                <button class="btn btn-outline-success" onclick="event.stopPropagation(); exportCampaign('${campaign.id}')" title="Exporter">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    <tr class="details-row" id="details-${campaign.id}" style="display: none;">
                        <td colspan="11">
                            <div class="p-3">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="mb-0">
                                        <i class="fas fa-building me-2"></i>
                                        Entreprises de la campagne
                                    </h6>
                                    <div class="spinner-border spinner-border-sm" role="status" id="loading-${campaign.id}">
                                        <span class="visually-hidden">Chargement...</span>
                                    </div>
                                </div>
                                <div id="companies-${campaign.id}">
                                    <!-- Les entreprises seront chargées ici -->
                                </div>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }
            
            document.getElementById('reportsTable').style.display = 'block';
        }

        // Fonctions utilitaires
        function getTemplateTypeIcon(type) {
            const icons = {
                'EMAIL': 'fa-envelope',
                'SMS': 'fa-sms',
                'CALL': 'fa-phone',
                'LETTER': 'fa-envelope-open-text',
                'PHYSICAL': 'fa-mail-bulk'
            };
            return icons[type] || 'fa-file-alt';
        }

        function getChannelText(channel) {
            const channels = {
                'EMAIL': 'Email',
                'SMS': 'SMS',
                'CALL': 'Appel',
                'LETTER': 'Courrier'
            };
            return channels[channel] || channel;
        }

        function getStatusClass(status) {
            const statusMap = {
                'BROUILLON': 'brouillon',
                'EN_VALIDATION': 'en-validation',
                'VALIDE': 'valide',
                'REJETE': 'rejete',
                'EN_COURS': 'en-cours',
                'TERMINEE': 'terminee'
            };
            return statusMap[status] || 'brouillon';
        }

        function getStatusText(status) {
            const statusMap = {
                'BROUILLON': 'Brouillon',
                'EN_VALIDATION': 'En validation',
                'VALIDE': 'Validée',
                'REJETE': 'Rejetée',
                'EN_COURS': 'En cours',
                'TERMINEE': 'Terminée'
            };
            return statusMap[status] || status;
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString('fr-FR');
        }

        function viewCampaignDetails(campaignId) {
            window.open(`/prospecting-campaigns.html?id=${campaignId}`, '_blank');
        }

        function viewCampaignSummary(campaignId) {
            window.open(`/prospecting-campaign-summary.html?id=${campaignId}`, '_blank');
        }

        // Fonctions d'export
        function exportToExcel() {
            if (!currentReportData) {
                showAlert('Aucune donnée à exporter. Générez d\'abord un rapport.', 'warning');
                return;
            }
            
            // Créer un fichier Excel simple (CSV avec extension .xlsx)
            const csvContent = generateCSVContent();
            downloadFile(csvContent, 'rapport_prospection.xlsx', 'text/csv');
        }

        function exportToPDF() {
            if (!currentReportData) {
                showAlert('Aucune donnée à exporter. Générez d\'abord un rapport.', 'warning');
                return;
            }
            
            // Pour l'instant, on génère un PDF simple
            showAlert('Fonctionnalité PDF en cours de développement', 'info');
        }

        function exportToCSV() {
            if (!currentReportData) {
                showAlert('Aucune donnée à exporter. Générez d\'abord un rapport.', 'warning');
                return;
            }
            
            const csvContent = generateCSVContent();
            downloadFile(csvContent, 'rapport_prospection.csv', 'text/csv');
        }

        function generateCSVContent() {
            if (!currentReportData || !currentReportData.campaigns) return '';
            
            const headers = [
                'Campagne',
                'Business Unit',
                'Division',
                'Canal',
                'Entreprises',
                'Statut',
                'Date création',
                'Responsable'
            ];
            
            const rows = currentReportData.campaigns.map(campaign => [
                campaign.name,
                campaign.business_unit_name || 'N/A',
                campaign.division_name || 'N/A',
                getChannelText(campaign.channel),
                campaign.companies_count || 0,
                getStatusText(campaign.validation_statut),
                formatDate(campaign.created_at),
                `${campaign.responsible_name || 'N/A'} ${campaign.responsible_prenom || ''}`
            ]);
            
            return [headers, ...rows]
                .map(row => row.map(cell => `"${cell}"`).join(','))
                .join('\n');
        }

        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        // Fonctions pour les lignes déroulantes
        async function toggleCampaignDetails(campaignId) {
            const detailsRow = document.getElementById(`details-${campaignId}`);
            const expandButton = document.getElementById(`expand-${campaignId}`);
            const loadingSpinner = document.getElementById(`loading-${campaignId}`);
            const companiesContainer = document.getElementById(`companies-${campaignId}`);
            
            if (detailsRow.style.display === 'none') {
                // Ouvrir les détails
                detailsRow.style.display = 'table-row';
                expandButton.classList.add('expanded');
                
                // Charger les entreprises si pas encore fait
                if (!companiesContainer.hasAttribute('data-loaded')) {
                    await loadCampaignCompanies(campaignId);
                }
            } else {
                // Fermer les détails
                detailsRow.style.display = 'none';
                expandButton.classList.remove('expanded');
            }
        }

        async function loadCampaignCompanies(campaignId) {
            const loadingSpinner = document.getElementById(`loading-${campaignId}`);
            const companiesContainer = document.getElementById(`companies-${campaignId}`);
            
            try {
                loadingSpinner.style.display = 'block';
                
                const response = await fetch(`${API}/campaigns/${campaignId}/companies?limit=1000`, {
                    headers: getAuthHeader()
                });
                
                if (!response.ok) {
                    throw new Error(`Erreur ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    renderCampaignCompanies(campaignId, result.data || []);
                    companiesContainer.setAttribute('data-loaded', 'true');
                } else {
                    throw new Error(result.error || 'Erreur lors du chargement des entreprises');
                }
                
            } catch (error) {
                console.error('Erreur chargement entreprises:', error);
                companiesContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Erreur lors du chargement des entreprises: ${error.message}
                    </div>
                `;
            } finally {
                loadingSpinner.style.display = 'none';
            }
        }

        function renderCampaignCompanies(campaignId, companies) {
            const companiesContainer = document.getElementById(`companies-${campaignId}`);
            
            if (!companies || companies.length === 0) {
                companiesContainer.innerHTML = `
                    <div class="text-center py-3">
                        <i class="fas fa-building fa-2x text-muted mb-2"></i>
                        <p class="text-muted">Aucune entreprise trouvée dans cette campagne</p>
                    </div>
                `;
                return;
            }
            
            const tableHTML = `
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Entreprise</th>
                                <th>Statut Validation</th>
                                <th>Statut Exécution</th>
                                <th>Notes</th>
                                <th>Fichier de preuve</th>
                                <th>Date exécution</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${companies.map(company => `
                                <tr class="company-row" onclick="showCompanyDetails('${campaignId}', '${company.id}')">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="company-icon me-2">
                                                <i class="fas fa-building"></i>
                                            </div>
                                            <div>
                                                <div class="fw-bold">${company.name}</div>
                                                <small class="text-muted">
                                                    ${company.industry || 'Secteur non défini'}
                                                    ${company.city ? ` • ${company.city}` : ''}
                                                </small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="company-status-badge status-${getCompanyValidationStatusClass(company.validation_status)}">
                                            ${getCompanyValidationStatusText(company.validation_status)}
                                        </span>
                                    </td>
                                    <td>
                                        ${company.validation_status === 'REJECTED' ? 
                                            '<span class="text-muted">Non applicable</span>' :
                                            `<span class="execution-status-badge execution-${getExecutionStatusClass(company.execution_status)}">
                                                ${getExecutionStatusText(company.execution_status)}
                                            </span>`
                                        }
                                    </td>
                                    <td>
                                        <div class="notes-cell" title="${company.execution_notes || 'Aucune note'}">
                                            ${company.execution_notes ? 
                                                (company.execution_notes.length > 50 ? 
                                                    company.execution_notes.substring(0, 50) + '...' : 
                                                    company.execution_notes) : 
                                                'Aucune note'}
                                        </div>
                                    </td>
                                    <td>
                                        ${company.validation_status === 'REJECTED' ? 
                                            '<span class="text-muted">Non applicable</span>' :
                                            (company.execution_file ? 
                                                `<a href="/uploads/executions/${company.execution_file}" target="_blank" class="proof-file-link">
                                                    <i class="fas fa-file-alt me-1"></i>Voir
                                                </a>` : 
                                                '<span class="text-muted">Aucun fichier</span>'
                                            )
                                        }
                                    </td>
                                    <td>
                                        <small>${company.validation_status === 'REJECTED' ? 
                                            'Non applicable' : 
                                            (company.execution_date ? formatDate(company.execution_date) : 'Non exécutée')
                                        }</small>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); showCompanyDetails('${campaignId}', '${company.id}')" title="Voir détails">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            companiesContainer.innerHTML = tableHTML;
        }

        function getCompanyValidationStatusClass(status) {
            const statusMap = {
                'APPROVED': 'approved',
                'REJECTED': 'rejected',
                'PENDING': 'pending'
            };
            return statusMap[status] || 'pending';
        }

        function getCompanyValidationStatusText(status) {
            const statusMap = {
                'APPROVED': 'Approuvée',
                'REJECTED': 'Rejetée',
                'PENDING': 'En attente'
            };
            return statusMap[status] || status;
        }

        function getExecutionStatusClass(status) {
            const statusMap = {
                'deposed': 'deposed',
                'sent': 'sent',
                'failed': 'failed',
                'pending_execution': 'pending'
            };
            return statusMap[status] || 'pending';
        }

        function getExecutionStatusText(status) {
            const statusMap = {
                'deposed': 'Déposé',
                'sent': 'Envoyé',
                'failed': 'Échec',
                'pending_execution': 'En attente'
            };
            return statusMap[status] || status;
        }

        async function showCompanyDetails(campaignId, companyId) {
            try {
                // Charger les détails de l'entreprise
                const response = await fetch(`${API}/campaigns/${campaignId}/companies/${companyId}`, {
                    headers: getAuthHeader()
                });
                
                if (!response.ok) {
                    throw new Error(`Erreur ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    displayCompanyDetailsModal(result.data);
                } else {
                    throw new Error(result.error || 'Erreur lors du chargement des détails');
                }
                
            } catch (error) {
                console.error('Erreur chargement détails entreprise:', error);
                showAlert('Erreur lors du chargement des détails de l\'entreprise: ' + error.message, 'danger');
            }
        }

        function displayCompanyDetailsModal(company) {
            const modalHTML = `
                <div class="modal fade" id="companyDetailsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-building me-2"></i>
                                    Détails de l'entreprise
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Informations générales</h6>
                                        <table class="table table-sm">
                                            <tr><td><strong>Nom:</strong></td><td>${company.name}</td></tr>
                                            <tr><td><strong>Secteur:</strong></td><td>${company.industry || 'Non défini'}</td></tr>
                                            <tr><td><strong>Ville:</strong></td><td>${company.city || 'Non définie'}</td></tr>
                                            <tr><td><strong>Email:</strong></td><td>${company.email || 'Non défini'}</td></tr>
                                            <tr><td><strong>Téléphone:</strong></td><td>${company.phone || 'Non défini'}</td></tr>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Statut dans la campagne</h6>
                                        <table class="table table-sm">
                                            <tr>
                                                <td><strong>Validation:</strong></td>
                                                <td>
                                                    <span class="company-status-badge status-${getCompanyValidationStatusClass(company.validation_status)}">
                                                        ${getCompanyValidationStatusText(company.validation_status)}
                                                    </span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><strong>Exécution:</strong></td>
                                                <td>
                                                    <span class="execution-status-badge execution-${getExecutionStatusClass(company.execution_status)}">
                                                        ${getExecutionStatusText(company.execution_status)}
                                                    </span>
                                                </td>
                                            </tr>
                                            <tr><td><strong>Date exécution:</strong></td><td>${company.execution_date ? formatDate(company.execution_date) : 'Non exécutée'}</td></tr>
                                            <tr><td><strong>Convertie:</strong></td><td>${company.converted_to_opportunity ? 'Oui' : 'Non'}</td></tr>
                                        </table>
                                    </div>
                                </div>
                                
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <h6>Notes d'exécution</h6>
                                        <div class="border rounded p-3 bg-light">
                                            ${company.execution_notes || 'Aucune note d\'exécution'}
                                        </div>
                                    </div>
                                </div>
                                
                                ${company.execution_file ? `
                                    <div class="row mt-3">
                                        <div class="col-12">
                                            <h6>Fichier de preuve</h6>
                                            <a href="/uploads/executions/${company.execution_file}" target="_blank" class="btn btn-outline-primary">
                                                <i class="fas fa-file-alt me-2"></i>
                                                Voir le fichier de preuve
                                            </a>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <h6>Historique des actions</h6>
                                        <div class="border rounded p-3 bg-light">
                                            <small class="text-muted">
                                                • Ajoutée à la campagne le ${formatDate(company.created_at)}<br>
                                                ${company.validation_status === 'APPROVED' ? `• Validée le ${formatDate(company.execution_date || company.created_at)}<br>` : ''}
                                                ${company.validation_status === 'REJECTED' ? `• Rejetée le ${formatDate(company.execution_date || company.created_at)}<br>` : ''}
                                                ${company.execution_status === 'deposed' ? `• Courrier déposé le ${formatDate(company.execution_date)}<br>` : ''}
                                                ${company.execution_status === 'sent' ? `• Email envoyé le ${formatDate(company.execution_date)}<br>` : ''}
                                                ${company.execution_status === 'failed' ? `• Échec d'exécution le ${formatDate(company.execution_date)}<br>` : ''}
                                                ${company.converted_to_opportunity ? `• Convertie en opportunité le ${formatDate(company.execution_date || company.created_at)}<br>` : ''}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Supprimer l'ancien modal s'il existe
            const oldModal = document.getElementById('companyDetailsModal');
            if (oldModal) {
                oldModal.remove();
            }
            
            // Ajouter le nouveau modal
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Afficher le modal
            const modal = new bootstrap.Modal(document.getElementById('companyDetailsModal'));
            modal.show();
        }
    </script>
</body>
</html>
