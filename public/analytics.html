<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics & Indicateurs</title>
    
    <!-- CSS Bootstrap et FontAwesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/vendor/fontawesome/css/all.min.css" rel="stylesheet">
    
    <!-- Sidebar CSS -->
    <link rel="stylesheet" href="css/modern-sidebar.css">
    
    <!-- CSS des variables de branding dynamiques -->
    <link rel="stylesheet" href="/config/themes/brand-variables.css">
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #f8f9fa;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
        }
        
        .page-wrapper {
            display: flex;
            min-height: 100vh;
        }

        .main-content-area {
            flex-grow: 1;
            padding: 2rem;
            padding-left: 3rem;
            background-color: var(--light-bg);
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .dashboard-header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .filter-section {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .kpi-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }
        
        .kpi-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        
        .kpi-label {
            font-size: 0.9rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
        }
        
        .kpi-trend {
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .kpi-trend.positive {
            color: var(--success-color);
        }
        
        .kpi-trend.negative {
            color: var(--danger-color);
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            min-height: 400px;
        }
        
        .chart-container canvas {
            max-height: 350px;
        }
        
        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        
        .table-container {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .table thead th {
            background-color: var(--primary-color);
            color: white;
            border: none;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }
        
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 300px;
        }
        
        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary-color);
            margin: 2rem 0 1rem 0;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary-color);
        }
    </style>
    
    <!-- Scripts de branding -->
    <script src="js/branding-loader.js"></script>
    <script src="js/sidebar-branding.js"></script>
</head>
<body>
    <!-- Bouton toggle sidebar mobile -->
    <button class="sidebar-toggle d-md-none">
        <i class="fas fa-bars"></i>
    </button>
    
    <div class="page-wrapper">
        <!-- Sidebar Container -->
        <div class="sidebar-container">
            <!-- La sidebar sera générée par JavaScript -->
        </div>

        <!-- Main Content Area -->
        <div class="main-content-area">
            <div class="container-fluid">
                <!-- Dashboard Header -->
                <div class="dashboard-header">
                    <div class="row align-items-center">
                        <div class="col-md-12">
                            <h1><i class="fas fa-chart-bar me-3"></i>Analytics & Indicateurs</h1>
                            <p class="mb-0">Vue d'ensemble des performances et KPIs stratégiques</p>
                        </div>
                    </div>
                </div>

                <!-- Filtres -->
                <div class="filter-section">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <label for="period-filter" class="form-label">Période</label>
                            <select class="form-select" id="period-filter">
                                <option value="30" selected>30 derniers jours</option>
                                <option value="90">3 derniers mois</option>
                                <option value="180">6 derniers mois</option>
                                <option value="365">12 derniers mois</option>
                            </select>
                            </div>
                        <div class="col-md-3">
                            <label for="business-unit-filter" class="form-label">Business Unit</label>
                            <select class="form-select" id="business-unit-filter">
                                <option value="">Toutes les BU</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="opportunity-type-filter" class="form-label">Type d'opportunité</label>
                            <select class="form-select" id="opportunity-type-filter">
                                <option value="">Tous les types</option>
                            </select>
                    </div>
                        <div class="col-md-3">
                            <button class="btn btn-primary mt-4 w-100" onclick="loadAllAnalytics()">
                                <i class="fas fa-sync-alt me-2"></i>Actualiser
                            </button>
                            </div>
                        </div>
                    </div>
                
                <!-- Section 1: KPIs Opportunités -->
                <div class="section-title">
                    <i class="fas fa-lightbulb me-2"></i>Analytics Commerciales
                            </div>
                
                <div class="row">
                    <div class="col-md-3">
                        <div class="kpi-card">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="kpi-number" id="conversion-rate">0%</div>
                                    <div class="kpi-label">Taux de conversion</div>
                                    <div class="kpi-trend positive" id="conversion-trend">
                                        <i class="fas fa-arrow-up"></i> +0%
                        </div>
                    </div>
                                <i class="fas fa-percentage fa-2x text-muted"></i>
                        </div>
                    </div>
                </div>

                    <div class="col-md-3">
                        <div class="kpi-card">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="kpi-number" id="total-revenue">0€</div>
                                    <div class="kpi-label">CA Opportunités</div>
                                    <div class="kpi-trend positive" id="revenue-trend">
                                        <i class="fas fa-arrow-up"></i> +0%
                                </div>
                            </div>
                                <i class="fas fa-euro-sign fa-2x text-muted"></i>
                        </div>
                    </div>
                </div>

                    <div class="col-md-3">
                        <div class="kpi-card">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="kpi-number" id="active-opportunities">0</div>
                                    <div class="kpi-label">Opportunités actives</div>
                                    <div class="kpi-trend positive" id="active-trend">
                                        <i class="fas fa-arrow-up"></i> +0%
                                </div>
                            </div>
                                <i class="fas fa-tasks fa-2x text-muted"></i>
                                    </div>
                                </div>
                                    </div>
                    
                    <div class="col-md-3">
                        <div class="kpi-card">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="kpi-number" id="avg-duration">0j</div>
                                    <div class="kpi-label">Durée moyenne</div>
                                    <div class="kpi-trend negative" id="duration-trend">
                                        <i class="fas fa-arrow-down"></i> 0%
                                </div>
                            </div>
                                <i class="fas fa-clock fa-2x text-muted"></i>
                </div>
            </div>
        </div>
    </div>

                <!-- Graphiques Opportunités -->
                        <div class="row">
                    <div class="col-md-6">
                        <div class="chart-container">
                            <div class="chart-title">
                                <i class="fas fa-chart-line me-2"></i>Évolution des opportunités
                            </div>
                            <canvas id="opportunities-timeline-chart"></canvas>
                            </div>
                        </div>
                    
                    <div class="col-md-6">
                        <div class="chart-container">
                            <div class="chart-title">
                                <i class="fas fa-chart-pie me-2"></i>Répartition par statut
                            </div>
                            <canvas id="status-distribution-chart"></canvas>
                            </div>
                        </div>
                            </div>
                
                <!-- Section 2: Performance par BU -->
                <div class="section-title">
                    <i class="fas fa-building me-2"></i>Performance par Business Unit
                            </div>
                
                        <div class="row">
                    <div class="col-md-6">
                        <div class="chart-container">
                            <div class="chart-title">
                                <i class="fas fa-chart-bar me-2"></i>CA par Business Unit
                            </div>
                            <canvas id="bu-performance-chart"></canvas>
                            </div>
                        </div>

                    <div class="col-md-6">
                        <div class="table-container">
                            <div class="chart-title">
                                <i class="fas fa-table me-2"></i>Détails par BU
                        </div>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Business Unit</th>
                                            <th class="text-center">Opportunités</th>
                                            <th class="text-center">Gagnées</th>
                                            <th class="text-end">CA</th>
                                        </tr>
                                    </thead>
                                    <tbody id="bu-performance-table">
                                        <tr>
                                            <td colspan="4" class="text-center text-muted">
                                                <i class="fas fa-spinner fa-spin me-2"></i>Chargement...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                </div>
            </div>
        </div>
    </div>

                <!-- Section 3: Top Collaborateurs -->
                <div class="section-title">
                    <i class="fas fa-users me-2"></i>Top Collaborateurs
                </div>
                
                        <div class="row">
                    <div class="col-md-12">
                        <div class="table-container">
                            <div class="chart-title">
                                <i class="fas fa-trophy me-2"></i>Meilleurs performances
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Collaborateur</th>
                                            <th class="text-center">Opportunités</th>
                                            <th class="text-center">Gagnées</th>
                                            <th class="text-center">Taux de conversion</th>
                                            <th class="text-center">Probabilité moyenne</th>
                                        </tr>
                                    </thead>
                                    <tbody id="top-collaborateurs-table">
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">
                                                <i class="fas fa-spinner fa-spin me-2"></i>Chargement...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                            </div>
                            </div>
                
                <!-- Section 4: Opportunités à risque -->
                <div class="section-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>Opportunités à risque
                        </div>
                
                        <div class="row">
                    <div class="col-md-12">
                        <div class="table-container">
                            <div class="chart-title">
                                <i class="fas fa-flag me-2"></i>Opportunités nécessitant une attention
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Opportunité</th>
                                            <th>Business Unit</th>
                                            <th>Type</th>
                                            <th class="text-center">Probabilité</th>
                                            <th class="text-end">Montant</th>
                                            <th class="text-center">Niveau de risque</th>
                                        </tr>
                                    </thead>
                                    <tbody id="risky-opportunities-table">
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">
                                                <i class="fas fa-spinner fa-spin me-2"></i>Chargement...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
        </div>
    </div>

                </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Scripts de base -->
    <script src="js/global-auth.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/menu-permissions.js"></script>
    <script src="js/sidebar.js" defer></script>
    <script src="js/session-manager.js"></script>
    <script src="js/user-header.js"></script>
    <script src="js/profile-menu.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/tasks.js"></script>
    
    <script>
        const API_BASE_URL = '/api';
        let charts = {};
        
        // Fonction pour récupérer les données avec authentification
        async function authenticatedFetch(url, options = {}) {
            const token = localStorage.getItem('authToken');
            return fetch(url, {
                ...options,
                headers: {
                    ...options.headers,
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
        }

        // Charger les Business Units
        async function loadBusinessUnits() {
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/business-units?limit=100`);
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('business-unit-filter');
                    data.data.forEach(bu => {
                                const option = document.createElement('option');
                                option.value = bu.id;
                                option.textContent = bu.nom;
                                select.appendChild(option);
                            });
                }
            } catch (error) {
                console.error('Erreur lors du chargement des BU:', error);
            }
        }

        // Charger les Types d'opportunité
        async function loadOpportunityTypes() {
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/opportunity-types`);
                const data = await response.json();
                        
                        if (data.success && data.data) {
                    const select = document.getElementById('opportunity-type-filter');
                    const types = Array.isArray(data.data) ? data.data : data.data.data || [];
                    types.forEach(type => {
                                const option = document.createElement('option');
                        option.value = type.id;
                        option.textContent = type.nom;
                                select.appendChild(option);
                            });
                        }
            } catch (error) {
                console.error('Erreur lors du chargement des types:', error);
                console.log('La fonctionnalité des types d\'opportunité sera désactivée');
            }
        }
        
        // Charger les analytics des opportunités
        async function loadOpportunitiesAnalytics() {
            const period = document.getElementById('period-filter').value;
            const businessUnit = document.getElementById('business-unit-filter').value;
            const opportunityType = document.getElementById('opportunity-type-filter').value;
            
            let url = `${API_BASE_URL}/analytics/opportunities?period=${period}`;
            if (businessUnit) url += `&business_unit_id=${businessUnit}`;
            if (opportunityType) url += `&opportunity_type_id=${opportunityType}`;
            
            try {
                const response = await authenticatedFetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.data) {
                    updateKPIs(data.data.kpis || {});
                    updateTimelineChart(data.data.opportunities_timeline || []);
                    updateStatusChart(data.data.status_distribution || []);
                    updateBUPerformance(data.data.business_unit_performance || []);
                    updateTopCollaborateurs(data.data.top_collaborateurs || []);
                } else {
                    console.warn('Données analytics non disponibles');
                    showEmptyState();
                }
            } catch (error) {
                console.error('Erreur lors du chargement des analytics:', error);
                showEmptyState();
            }
        }
        
        // Afficher un état vide en cas d'erreur
        function showEmptyState() {
            document.getElementById('conversion-rate').textContent = '0%';
            document.getElementById('total-revenue').textContent = '0€';
            document.getElementById('active-opportunities').textContent = '0';
            document.getElementById('avg-duration').textContent = '0j';
            
            updateTimelineChart([]);
            updateStatusChart([]);
            updateBUPerformance([]);
            updateTopCollaborateurs([]);
        }
        
        // Charger les opportunités à risque
        async function loadRiskyOpportunities() {
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/analytics/risky-opportunities`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.data) {
                    updateRiskyOpportunitiesTable(data.data.risky_opportunities || []);
                } else {
                    updateRiskyOpportunitiesTable([]);
                }
            } catch (error) {
                console.error('Erreur lors du chargement des opportunités à risque:', error);
                const tbody = document.getElementById('risky-opportunities-table');
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-warning"><i class="fas fa-exclamation-triangle me-2"></i>Données non disponibles</td></tr>';
            }
        }
        
        // Mettre à jour les KPIs
        function updateKPIs(kpis) {
            if (!kpis || typeof kpis !== 'object') {
                kpis = {
                    conversion_rate: 0,
                    total_revenue: 0,
                    active_opportunities: 0,
                    avg_duration: 0,
                    conversion_trend: 0,
                    revenue_trend: 0,
                    active_trend: 0,
                    duration_trend: 0
                };
            }
            
            document.getElementById('conversion-rate').textContent = (kpis.conversion_rate || 0).toFixed(1) + '%';
            document.getElementById('total-revenue').textContent = new Intl.NumberFormat('fr-FR', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 0
            }).format(kpis.total_revenue || 0);
            document.getElementById('active-opportunities').textContent = kpis.active_opportunities || 0;
            document.getElementById('avg-duration').textContent = Math.round(kpis.avg_duration || 0) + 'j';
            
            // Mise à jour des tendances
            updateTrend('conversion-trend', kpis.conversion_trend || 0);
            updateTrend('revenue-trend', kpis.revenue_trend || 0);
            updateTrend('active-trend', kpis.active_trend || 0);
            updateTrend('duration-trend', kpis.duration_trend || 0);
        }
        
        function updateTrend(elementId, value) {
            const element = document.getElementById(elementId);
            if (value >= 0) {
                element.className = 'kpi-trend positive';
                element.innerHTML = `<i class="fas fa-arrow-up"></i> +${value.toFixed(1)}%`;
            } else {
                element.className = 'kpi-trend negative';
                element.innerHTML = `<i class="fas fa-arrow-down"></i> ${value.toFixed(1)}%`;
            }
        }
        
        // Mettre à jour le graphique timeline
        function updateTimelineChart(data) {
            const ctx = document.getElementById('opportunities-timeline-chart');
            
            if (charts.timeline) {
                charts.timeline.destroy();
            }
            
            if (!data || data.length === 0) {
                // Afficher un message si pas de données
                ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
                const parent = ctx.parentElement;
                if (!parent.querySelector('.no-data-message')) {
                    const message = document.createElement('div');
                    message.className = 'no-data-message text-center text-muted py-5';
                    message.innerHTML = '<i class="fas fa-chart-line fa-3x mb-3"></i><br>Aucune donnée disponible pour cette période';
                    parent.appendChild(message);
                }
                return;
            }
            
            // Supprimer le message "pas de données" s'il existe
            const parent = ctx.parentElement;
            const noDataMsg = parent.querySelector('.no-data-message');
            if (noDataMsg) {
                noDataMsg.remove();
            }
            
            charts.timeline = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => new Date(d.date).toLocaleDateString('fr-FR')),
                    datasets: [
                        {
                            label: 'Nouvelles opportunités',
                            data: data.map(d => d.new_opportunities),
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Opportunités gagnées',
                            data: data.map(d => d.won_opportunities),
                            borderColor: '#27ae60',
                            backgroundColor: 'rgba(39, 174, 96, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }
        
        // Mettre à jour le graphique de statut
        function updateStatusChart(data) {
            const ctx = document.getElementById('status-distribution-chart');
            
            if (charts.status) {
                charts.status.destroy();
            }
            
            if (!data || data.length === 0) {
                ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
                const parent = ctx.parentElement;
                if (!parent.querySelector('.no-data-message')) {
                    const message = document.createElement('div');
                    message.className = 'no-data-message text-center text-muted py-5';
                    message.innerHTML = '<i class="fas fa-chart-pie fa-3x mb-3"></i><br>Aucune donnée disponible';
                    parent.appendChild(message);
                }
                return;
            }
            
            const parent = ctx.parentElement;
            const noDataMsg = parent.querySelector('.no-data-message');
            if (noDataMsg) {
                noDataMsg.remove();
            }
            
            charts.status = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(d => d.statut),
                    datasets: [{
                        data: data.map(d => d.count),
                        backgroundColor: [
                            '#3498db',
                            '#27ae60',
                            '#e74c3c',
                            '#f39c12',
                            '#9b59b6'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 1.5,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }
        
        // Mettre à jour la performance par BU
        function updateBUPerformance(data) {
            // Graphique
            const ctx = document.getElementById('bu-performance-chart');
            
            if (charts.buPerformance) {
                charts.buPerformance.destroy();
            }
            
            if (!data || data.length === 0) {
                ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
                const parent = ctx.parentElement;
                if (!parent.querySelector('.no-data-message')) {
                    const message = document.createElement('div');
                    message.className = 'no-data-message text-center text-muted py-5';
                    message.innerHTML = '<i class="fas fa-chart-bar fa-3x mb-3"></i><br>Aucune donnée disponible';
                    parent.appendChild(message);
                }
            } else {
                const parent = ctx.parentElement;
                const noDataMsg = parent.querySelector('.no-data-message');
                if (noDataMsg) {
                    noDataMsg.remove();
                }
                
                charts.buPerformance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.map(d => d.business_unit_name || 'Non assigné'),
                        datasets: [{
                            label: 'CA (€)',
                            data: data.map(d => d.revenue || 0),
                            backgroundColor: '#667eea'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 2,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return new Intl.NumberFormat('fr-FR', {
                                            style: 'currency',
                                            currency: 'EUR',
                                            minimumFractionDigits: 0
                                        }).format(value);
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Tableau
            const tbody = document.getElementById('bu-performance-table');
            tbody.innerHTML = '';
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Aucune donnée</td></tr>';
                return;
            }
            
            data.forEach(bu => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${bu.business_unit_name || 'Non assigné'}</td>
                    <td class="text-center">${bu.total_opportunities}</td>
                    <td class="text-center">${bu.won_opportunities}</td>
                    <td class="text-end">${new Intl.NumberFormat('fr-FR', {
                        style: 'currency',
                        currency: 'EUR',
                        minimumFractionDigits: 0
                    }).format(bu.revenue)}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Mettre à jour le tableau des top collaborateurs
        function updateTopCollaborateurs(data) {
            const tbody = document.getElementById('top-collaborateurs-table');
            tbody.innerHTML = '';
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted"><i class="fas fa-info-circle me-2"></i>Aucune donnée disponible</td></tr>';
                return;
            }
            
            data.forEach((collab, index) => {
                const totalOpp = parseInt(collab.total_opportunities) || 0;
                const wonOpp = parseInt(collab.won_opportunities) || 0;
                const conversionRate = totalOpp > 0 
                    ? (wonOpp / totalOpp * 100).toFixed(1) 
                    : '0.0';
                    
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${collab.collaborateur_name || 'Non assigné'}</td>
                    <td class="text-center">${totalOpp}</td>
                    <td class="text-center">${wonOpp}</td>
                    <td class="text-center">${conversionRate}%</td>
                    <td class="text-center">${parseFloat(collab.avg_probability || 0).toFixed(1)}%</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Mettre à jour le tableau des opportunités à risque
        function updateRiskyOpportunitiesTable(data) {
            const tbody = document.getElementById('risky-opportunities-table');
            tbody.innerHTML = '';
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-success"><i class="fas fa-check-circle me-2"></i>Aucune opportunité à risque détectée</td></tr>';
                return;
            }
            
            data.forEach(opp => {
                const riskClass = {
                    'CRITICAL': 'danger',
                    'HIGH': 'warning',
                    'MEDIUM': 'info',
                    'LOW': 'success'
                }[opp.risk_level] || 'secondary';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${opp.nom || 'Sans nom'}</td>
                    <td>${opp.business_unit_nom || 'Non assigné'}</td>
                    <td>${opp.opportunity_type_nom || 'Non défini'}</td>
                    <td class="text-center">${opp.probabilite || 0}%</td>
                    <td class="text-end">${new Intl.NumberFormat('fr-FR', {
                        style: 'currency',
                        currency: opp.devise || 'EUR',
                        minimumFractionDigits: 0
                    }).format(opp.montant_estime || 0)}</td>
                    <td class="text-center">
                        <span class="badge bg-${riskClass}">${opp.risk_level || 'N/A'}</span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Charger toutes les analytics
        function loadAllAnalytics() {
            loadOpportunitiesAnalytics();
            loadRiskyOpportunities();
        }
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            loadBusinessUnits();
            loadOpportunityTypes();
            loadAllAnalytics();
            
            // Écouteurs d'événements pour les filtres
            document.getElementById('period-filter').addEventListener('change', loadAllAnalytics);
            document.getElementById('business-unit-filter').addEventListener('change', loadAllAnalytics);
            document.getElementById('opportunity-type-filter').addEventListener('change', loadAllAnalytics);
        });
    </script>
    </body>
</html>

