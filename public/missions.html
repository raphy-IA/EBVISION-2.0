<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Missions</title>

    <!-- CSS Bootstrap et FontAwesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/vendor/fontawesome/css/all.min.css" rel="stylesheet">
    <!-- CSS de la sidebar moderne -->
    <link rel="stylesheet" href="css/modern-sidebar.css">


    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #f8f9fa;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            overflow-x: hidden;
            /* Emp√™che le d√©filement horizontal */
        }

        /* Le conteneur principal de la page qui contient la sidebar et le contenu */
        .page-wrapper {
            display: flex;
            min-height: 100vh;
        }

        /* Styles pour le contenu principal */
        .main-content-area {
            flex-grow: 1;
            /* Prend l'espace restant */
            padding: 2rem;
            background-color: var(--light-bg);
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .stat-card.success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .stat-card.warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .stat-card.info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
        }

        .table thead th {
            background-color: var(--primary-color);
            color: white;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-saisie {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        .status-soumise {
            background-color: #fff3e0;
            color: #f57c00;
        }

        .status-validee {
            background-color: #e8f5e8;
            color: #388e3c;
        }

        .status-rejetee {
            background-color: #ffebee;
            color: #d32f2f;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Ajustements pour les petits √©crans */
        @media (max-width: 768px) {
            .page-wrapper {
                flex-direction: column;
                /* Empile la sidebar et le contenu */
            }

            .main-content-area {
                padding: 1rem;
            }
        }

        /* Styles pour la sidebar unifi√©e */
        .main-content-wrapper {
            margin-left: 300px;
            transition: margin-left 0.3s ease;
            min-height: 100vh;
            padding: 0;
        }

        .main-content {
            padding: 2rem;
        }

        @media (max-width: 768px) {
            .main-content-wrapper {
                margin-left: 0;
            }

            .sidebar-container.open {
                transform: translateX(0);
            }

            .main-content {
                padding: 1rem;
            }
        }


        /* Table Layout Improvements */
        .table-responsive {
            overflow-x: auto;
        }

        .table th,
        .table td {
            vertical-align: middle;
            white-space: nowrap;
            /* Prevent wrapping by default for most cols */
        }

        /* Specific Column Widths & Alignments */
        .col-code {
            width: 100px;
        }

        .col-name {
            min-width: 250px;
            white-space: normal !important;
        }

        /* Allow wrapping for name if needed, or truncate */
        .col-client {
            min-width: 180px;
        }

        .col-date {
            width: 110px;
            text-align: center;
        }

        .col-status {
            width: 120px;
            text-align: center;
        }

        .col-budget {
            width: 140px;
            text-align: right;
        }

        .col-bu {
            min-width: 150px;
        }

        .col-actions {
            width: 140px;
            text-align: center;
        }

        /* Truncate long text with ellipsis */
        .text-truncate-cell {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: inline-block;
            vertical-align: middle;
        }

        .text-end {
            text-align: right !important;
        }

        .text-center {
            text-align: center !important;
        }
    </style>

    <script src="js/global-auth.js"></script>
    <script src="js/menu-permissions.js"></script>
    <script src="/js/page-permissions.js"></script>
    <!-- Script pour la gestion utilisateur -->
    <script src="js/user-header.js"></script>
    <script src="js/profile-menu.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/tasks.js"></script>
    <!-- Scripts pour la top bar EBVISION 2.0 -->




    <!-- CSS des variables de branding dynamiques -->
    <link rel="stylesheet" href="/config/themes/brand-variables.css">

    <!-- Scripts de branding -->
    <script src="js/branding-loader.js"></script>
    <script src="js/sidebar-branding.js"></script>
    <!-- Scripts de gestion des devises -->
    <script src="js/currency-config.js"></script>
    <script src="js/currency-context.js"></script>
</head>

<body>
    <!-- Bouton toggle sidebar mobile -->
    <button class="sidebar-toggle d-md-none">
        <i class="fas fa-bars"></i>
    </button>
    <div class="page-wrapper">
        <!-- Sidebar Container -->
        <div class="sidebar-container">
            <!-- La sidebar sera g√©n√©r√©e par JavaScript -->
        </div>

        <!-- Main Content Area -->
        <div class="main-content-area">
            <div id="missions-section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-tasks me-2"></i>Gestion des Missions</h2>
                    <div>
                        <a href="create-mission-step1.html" class="btn btn-success me-2" id="btn-create-from-opp"
                            style="display: none;">
                            <i class="fas fa-trophy me-2"></i>Cr√©er Mission depuis Opportunit√©
                        </a>
                        <a href="create-mission-step0.html" class="btn btn-primary" id="btn-create-new"
                            style="display: none;">
                            <i class="fas fa-plus me-2"></i>Nouvelle Mission
                        </a>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="card-body">
                                <h6 class="card-title text-white-50">Total Missions</h6>
                                <div class="stat-number" id="statsTotal">...</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card info">
                            <div class="card-body">
                                <h6 class="card-title text-white-50">En Cours</h6>
                                <div class="stat-number" id="statsActive">...</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card success">
                            <div class="card-body">
                                <h6 class="card-title text-white-50">Termin√©es</h6>
                                <div class="stat-number" id="statsFinished">...</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card warning">
                            <div class="card-body">
                                <h6 class="card-title text-white-50">Budget Total</h6>
                                <div class="stat-number" id="statsBudget">...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Filters -->
                <div class="d-flex gap-2 mb-4 overflow-auto pb-2">
                    <button class="btn btn-primary quick-filter active" onclick="switchView('my_scope', this)">
                        <i class="fas fa-user me-2"></i>Ma Vue
                    </button>
                    <button class="btn btn-outline-secondary quick-filter" onclick="switchView('active', this)">
                        <i class="fas fa-play me-2"></i>Missions En Cours
                    </button>
                    <button class="btn btn-outline-secondary quick-filter" onclick="switchView('finished', this)">
                        <i class="fas fa-check me-2"></i>Missions Termin√©es
                    </button>
                    <button class="btn btn-outline-secondary quick-filter" onclick="switchView('all', this)">
                        <i class="fas fa-list me-2"></i>Toutes les Missions
                    </button>
                </div>

                <!-- Filtres -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="statusFilter" class="form-label">Statut</label>
                                <select class="form-select" id="statusFilter">
                                    <option value="">Tous les statuts</option>
                                    <option value="EN_COURS">En cours</option>
                                    <option value="TERMINEE">Termin√©e</option>
                                    <option value="PLANIFIEE">Planifi√©e</option>
                                    <option value="ANNULEE">Annul√©e</option>
                                    <option value="ARCHIVEE">Archiv√©e</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="clientFilter" class="form-label">Client</label>
                                <select class="form-select" id="clientFilter">
                                    <option value="">Tous les clients</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="buFilter" class="form-label">Unit√© d'affaires</label>
                                <select class="form-select" id="buFilter">
                                    <option value="">Toutes les unit√©s</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="divisionFilter" class="form-label">Division</label>
                                <select class="form-select" id="divisionFilter">
                                    <option value="">Toutes les divisions</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="searchInput" class="form-label">Recherche</label>
                                <input type="text" class="form-control" id="searchInput"
                                    placeholder="Rechercher une mission...">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="codeFilter" class="form-label">Code</label>
                                <input type="text" class="form-control" id="codeFilter"
                                    placeholder="Code mission (ex: MIS-001)">
                            </div>
                            <div class="col-md-3 mb-3 d-flex align-items-end">
                                <button class="btn btn-outline-secondary w-100" onclick="resetFilters()">
                                    <i class="fas fa-refresh me-2"></i>R√©initialiser
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tableau des missions -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-list me-2"></i>Liste des Missions
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th class="col-code">Code</th>
                                        <th class="col-name">Nom</th>
                                        <th class="col-client">Client</th>
                                        <th class="col-date">Date d√©but</th>
                                        <th class="col-date">Date fin</th>
                                        <th class="col-status">Statut</th>
                                        <th class="col-budget">Budget</th>
                                        <th class="col-date">Date cr√©ation</th>
                                        <th class="col-bu">Business Unit</th>
                                        <th class="col-division">Division</th>
                                        <th class="col-actions">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="missionsTableBody">
                                    <tr>
                                        <td colspan="8" class="text-center">
                                            <div id="loadingSpinner" class="loading">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Chargement...</span>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div class="text-muted small">
                                Affichage de <span id="paginationStart">0</span> √† <span id="paginationEnd">0</span> sur
                                <span id="paginationTotal">0</span> missions
                            </div>
                            <nav aria-label="Page navigation">
                                <ul class="pagination pagination-sm mb-0" id="paginationControls">
                                    <!-- Les contr√¥les seront g√©n√©r√©s par JS -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    </div>
    <!-- Modal Ajout Mission -->
    <div class="modal fade" id="addMissionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="missionModalTitle">
                        <i class="fas fa-plus me-2"></i>Nouvelle Mission
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="missionForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="missionCode" class="form-label">Code Mission *</label>
                                <input type="text" class="form-control" id="missionCode" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="missionName" class="form-label">Nom Mission *</label>
                                <input type="text" class="form-control" id="missionName" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="missionClient" class="form-label">Client *</label>
                                <select class="form-select" id="missionClient" required>
                                    <option value="">S√©lectionner un client</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="missionStatus" class="form-label">Statut</label>
                                <select class="form-select" id="missionStatus">
                                    <option value="PLANIFIEE">Planifi√©e</option>
                                    <option value="EN_COURS">En cours</option>
                                    <option value="TERMINEE">Termin√©e</option>
                                    <option value="ANNULEE">Annul√©e</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="missionStartDate" class="form-label">Date de d√©but</label>
                                <input type="date" class="form-control" id="missionStartDate">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="missionEndDate" class="form-label">Date de fin</label>
                                <input type="date" class="form-control" id="missionEndDate">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="missionDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="missionDescription" rows="3"></textarea>
                        </div>
                        <!-- Champs financiers uniquement pour la cr√©ation; masqu√©s √† l'√©dition basique -->
                        <div class="row" id="createOnlyFinancialRow">
                            <div class="col-md-6 mb-3">
                                <label for="missionBudget" class="form-label">Budget (<span
                                        class="currency-symbol">‚Ç¨</span>)</label>
                                <input type="number" class="form-control" id="missionBudget" min="0" step="0.01">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="missionRate" class="form-label">Taux horaire (<span
                                        class="currency-symbol">‚Ç¨</span>/h)</label>
                                <input type="number" class="form-control" id="missionRate" min="0" step="0.01">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="saveMission()">
                        <i class="fas fa-save me-2"></i>Enregistrer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Edition basique (Nom + Description seulement) -->
    <div class="modal fade" id="editMissionBasicModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Modifier la Mission</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editMissionBasicForm">
                        <div class="mb-3">
                            <label class="form-label">Nom</label>
                            <input type="text" class="form-control" id="editMissionName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="editMissionDescription" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button class="btn btn-primary" onclick="updateMissionBasic()"><i
                            class="fas fa-save me-2"></i>Enregistrer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/sidebar.js" defer></script>
    <!-- SessionManager pour la gestion centralis√©e des sessions -->
    <script src="js/session-manager.js"></script>
    <script>
        // Variables globales
        let missions = [];
        let clients = [];
        let currentMissionId = null;

        // Determine default view based on role
        const userGlobal = JSON.parse(localStorage.getItem('user')) || {};
        const rolesGlobal = userGlobal.roles || [];
        const hasBroadAccess = rolesGlobal.some(r => ['SUPER_ADMIN', 'ADMIN', 'SENIOR_PARTNER', 'DIRECTOR'].includes(r));

        let currentView = hasBroadAccess ? 'all' : 'my_scope';
        let currentPage = 1;
        const itemsPerPage = 20;

        // Fonction utilitaire pour les appels API authentifi√©s
        async function authenticatedFetch(url, options = {}) {
            const token = localStorage.getItem('authToken');
            const defaultHeaders = {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };

            return fetch(url, {
                ...options,
                headers: {
                    ...defaultHeaders,
                    ...options.headers
                }
            });
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function () {
            applyButtonPermissions(); // Apply permissions first
            updateActiveViewButton(); // Update UI to reflect default view
            loadStats();
            loadMissions();
            loadClients();
            loadBusinessUnits();
            loadDivisions();
            setupEventListeners();
        });

        function updateActiveViewButton() {
            // Remove active from all
            document.querySelectorAll('.quick-filter').forEach(btn => btn.classList.remove('active', 'btn-primary'));
            document.querySelectorAll('.quick-filter').forEach(btn => btn.classList.add('btn-outline-secondary'));

            // Find key to match (logic from switchView)
            // 'my_scope' -> 'Ma Vue' button
            // 'all' -> 'Toutes les Missions' button
            const buttons = document.querySelectorAll('.quick-filter');
            let targetBtn;

            if (currentView === 'my_scope') targetBtn = buttons[0];
            else if (currentView === 'active') targetBtn = buttons[1];
            else if (currentView === 'finished') targetBtn = buttons[2];
            else if (currentView === 'all') targetBtn = buttons[3];

            if (targetBtn) {
                targetBtn.classList.remove('btn-outline-secondary');
                targetBtn.classList.add('active', 'btn-primary');
            }
        }

        // Gestion des permissions des boutons
        function applyButtonPermissions() {
            const user = JSON.parse(localStorage.getItem('user')) || {};
            const roles = user.roles || [];

            const btnFromOpp = document.getElementById('btn-create-from-opp');
            const btnNew = document.getElementById('btn-create-new');

            // Roles definition
            const isManager = roles.includes('MANAGER');
            const isDirector = roles.includes('DIRECTOR');
            const isPartner = roles.includes('PARTNER') || roles.includes('ASSOCIE'); // Handle both naming conventions if any
            const isSeniorPartner = roles.includes('SENIOR_PARTNER');
            const isAdmin = roles.includes('ADMIN');
            const isSuperAdmin = roles.includes('SUPER_ADMIN');

            // Logic:
            // Manager -> "From Opportunity" ONLY
            // Director, Partner, Senior Partner, Admin, Super Admin -> BOTH
            // Others -> NONE

            const canCreateFromOpp = isManager || isDirector || isPartner || isSeniorPartner || isAdmin || isSuperAdmin;
            const canCreateNew = isDirector || isPartner || isSeniorPartner || isAdmin || isSuperAdmin;

            if (btnFromOpp && canCreateFromOpp) {
                btnFromOpp.style.display = 'inline-block';
            }
            if (btnNew && canCreateNew) {
                btnNew.style.display = 'inline-block';
            }
        }

        // Configuration des √©v√©nements
        function setupEventListeners() {
            document.getElementById('statusFilter').addEventListener('change', () => filterMissions(true));
            document.getElementById('clientFilter').addEventListener('change', () => filterMissions(true));
            document.getElementById('buFilter').addEventListener('change', () => filterMissions(true));
            document.getElementById('divisionFilter').addEventListener('change', () => filterMissions(true));
            document.getElementById('searchInput').addEventListener('input', debounce(() => filterMissions(true), 500));
            document.getElementById('codeFilter').addEventListener('input', debounce(() => filterMissions(true), 500));
        }

        // Debounce utility
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Fonction pour afficher/masquer le loading
        function showLoading(show) {
            const loadingElement = document.getElementById('loadingSpinner');
            if (loadingElement) {
                loadingElement.style.display = show ? 'block' : 'none';
            }
        }

        // Chargement des missions
        async function loadMissions(page = 1) {
            showLoading(true);
            currentPage = page;

            try {
                const params = new URLSearchParams({
                    page: currentPage,
                    limit: itemsPerPage,
                    view: currentView,
                    statut: document.getElementById('statusFilter').value || '',
                    client_id: document.getElementById('clientFilter').value || '',
                    business_unit_id: document.getElementById('buFilter').value || '',
                    division_id: document.getElementById('divisionFilter').value || '',
                    code: document.getElementById('codeFilter').value || '',
                    search: document.getElementById('searchInput').value || ''
                });
                // supprimer les vides
                Array.from(params.keys()).forEach(k => { if (!params.get(k)) params.delete(k); });
                console.log('üîé loadMissions params', Object.fromEntries(params.entries()));
                const response = await authenticatedFetch(`/api/missions?${params.toString()}`);
                if (response.ok) {
                    const data = await response.json();
                    // L'API missions retourne {data: Array, pagination: Object}
                    missions = data.data || [];
                    const pagination = data.pagination || { total: 0, totalPages: 0, page: 1, limit: 20 };

                    // Mettre √† jour les options de filtres au r√©el des missions affich√©es (optionnel, peut √™tre limit√© avec pagination)
                    // Mettre √† jour les options de filtres au r√©el des missions affich√©es (optionnel, peut √™tre limit√© avec pagination)
                    // populateFilterOptionsFromMissions(missions); // D√âSACTIV√â: Cela masquerait les BUs non pr√©sentes sur la page 1

                    displayMissions(missions);
                    updatePaginationControls(pagination);
                } else {
                    console.error('Erreur lors du chargement des missions');
                }
            } catch (error) {
                console.error('Erreur:', error);
            } finally {
                showLoading(false);
            }
        }

        function updatePaginationControls(pagination) {
            const start = (pagination.page - 1) * pagination.limit + 1;
            const end = Math.min(pagination.page * pagination.limit, pagination.total);

            document.getElementById('paginationStart').textContent = pagination.total > 0 ? start : 0;
            document.getElementById('paginationEnd').textContent = end;
            document.getElementById('paginationTotal').textContent = pagination.total;

            const controls = document.getElementById('paginationControls');
            controls.innerHTML = '';

            // Previous
            const liPrev = document.createElement('li');
            liPrev.className = `page-item ${pagination.page <= 1 ? 'disabled' : ''}`;
            liPrev.innerHTML = `<a class="page-link" href="#" onclick="event.preventDefault(); loadMissions(${pagination.page - 1})">Pr√©c√©dent</a>`;
            controls.appendChild(liPrev);

            // Pages
            // Simple logic: show current, prev, next, first, last
            const totalPages = pagination.totalPages;

            if (totalPages <= 7) {
                for (let i = 1; i <= totalPages; i++) {
                    addPageItem(i, pagination.page, controls);
                }
            } else {
                // Complex logic with ellipsis can go here, keep simple for now
                addPageItem(1, pagination.page, controls);
                if (pagination.page > 3) addEllipsis(controls);

                for (let i = Math.max(2, pagination.page - 1); i <= Math.min(totalPages - 1, pagination.page + 1); i++) {
                    addPageItem(i, pagination.page, controls);
                }

                if (pagination.page < totalPages - 2) addEllipsis(controls);
                addPageItem(totalPages, pagination.page, controls);
            }

            // Next
            const liNext = document.createElement('li');
            liNext.className = `page-item ${pagination.page >= pagination.totalPages ? 'disabled' : ''}`;
            liNext.innerHTML = `<a class="page-link" href="#" onclick="event.preventDefault(); loadMissions(${pagination.page + 1})">Suivant</a>`;
            controls.appendChild(liNext);
        }

        function addPageItem(page, current, container) {
            const li = document.createElement('li');
            li.className = `page-item ${page === current ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" onclick="event.preventDefault(); loadMissions(${page})">${page}</a>`;
            container.appendChild(li);
        }

        function addEllipsis(container) {
            const li = document.createElement('li');
            li.className = `page-item disabled`;
            li.innerHTML = `<span class="page-link">...</span>`;
            container.appendChild(li);
        }

        // Chargement des clients
        async function loadClients() {
            try {
                const response = await authenticatedFetch('/api/clients?limit=1000');
                if (response.ok) {
                    const result = await response.json();
                    let clientsData = [];
                    // Handle different possible structures {data: ...} or direct array
                    if (result.success && result.data) {
                        if (Array.isArray(result.data)) clientsData = result.data;
                        else if (result.data.clients && Array.isArray(result.data.clients)) clientsData = result.data.clients;
                    } else if (Array.isArray(result)) {
                        clientsData = result;
                    }

                    clients = clientsData;

                    const clientFilter = document.getElementById('clientFilter');
                    const currentValue = clientFilter.value;
                    const cSelect = document.getElementById('missionClient');
                    const cEditSelect = document.getElementById('editMissionClient');

                    // Filter dropdown
                    clientFilter.innerHTML = '<option value="">Tous les clients</option>' +
                        clientsData.sort((a, b) => (a.nom || '').localeCompare(b.nom || '')).map(c => `<option value="${c.id}">${c.nom}</option>`).join('');

                    if (currentValue) clientFilter.value = currentValue;

                    // Form dropdowns (if existing)
                    if (cSelect) {
                        cSelect.innerHTML = '<option value="" disabled selected>Choisir un client</option>' +
                            clientsData.sort((a, b) => (a.nom || '').localeCompare(b.nom || '')).map(c => `<option value="${c.id}">${c.nom}</option>`).join('');
                    }
                    if (cEditSelect) {
                        cEditSelect.innerHTML = '<option value="" disabled selected>Choisir un client</option>' +
                            clientsData.sort((a, b) => (a.nom || '').localeCompare(b.nom || '')).map(c => `<option value="${c.id}">${c.nom}</option>`).join('');
                    }
                }
            } catch (error) {
                console.error('Erreur chargement clients:', error);
            }
        }

        async function loadBusinessUnits() {
            try {
                const response = await authenticatedFetch('/api/business-units');
                if (response.ok) {
                    const result = await response.json();
                    let bus = [];
                    if (result.success && Array.isArray(result.data)) {
                        bus = result.data;
                    } else if (Array.isArray(result)) {
                        bus = result;
                    }

                    const buFilter = document.getElementById('buFilter');
                    const currentValue = buFilter.value;

                    buFilter.innerHTML = '<option value="">Toutes les unit√©s</option>' +
                        bus.sort((a, b) => (a.nom || '').localeCompare(b.nom || ''))
                            .map(bu => `<option value="${bu.id}">${bu.nom}</option>`).join('');

                    if (currentValue) buFilter.value = currentValue;
                }
            } catch (error) {
                console.error('Erreur chargement BUs:', error);
            }
        }

        async function loadDivisions() {
            try {
                const response = await authenticatedFetch('/api/divisions');
                if (response.ok) {
                    const result = await response.json();
                    let divisions = [];

                    // Division API logic check
                    if (result.success && Array.isArray(result.data)) {
                        divisions = result.data;
                    } else if (Array.isArray(result)) {
                        divisions = result;
                    }

                    const divisionFilter = document.getElementById('divisionFilter');
                    const currentValue = divisionFilter.value;

                    divisionFilter.innerHTML = '<option value="">Toutes les divisions</option>' +
                        divisions.sort((a, b) => (a.nom || '').localeCompare(b.nom || ''))
                            .map(d => `<option value="${d.id}">${d.nom}</option>`).join('');

                    if (currentValue) divisionFilter.value = currentValue;
                }
            } catch (error) {
                console.error('Erreur chargement Divisions:', error);
            }
        }

        // Affichage des missions
        function displayMissions(missionsToShow) {
            const tbody = document.getElementById('missionsTableBody');

            // R√©initialise le tableau pour √©viter les doublons
            if (tbody) {
                tbody.innerHTML = '';
            }

            if (!missionsToShow || missionsToShow.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" class="text-center text-muted">
                            <i class="fas fa-inbox fa-2x mb-3"></i>
                            <p>Aucune mission trouv√©e</p>
                        </td>
                    </tr>
                `;
                return;
            }

            missionsToShow.forEach(mission => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${mission.code || 'N/A'}</strong></td>
                    <td><span class="d-inline-block text-truncate" style="max-width: 250px;" title="${mission.nom || ''}">${mission.nom || 'N/A'}</span></td>
                    <td><span class="d-inline-block text-truncate" style="max-width: 180px;" title="${mission.client_nom || ''}">${mission.client_nom || 'N/A'}</span></td>
                    <td class="text-center">${formatDate(mission.date_debut)}</td>
                    <td class="text-center">${formatDate(mission.date_fin)}</td>
                    <td class="text-center"><span class="status-badge status-${mission.statut?.toLowerCase()}">${mission.statut || 'N/A'}</span></td>
                    <td class="text-end font-monospace">${formatCurrency(mission.budget_estime || mission.budget_reel || 0, mission.devise)}</td>
                    <td class="text-center">${formatDate(mission.created_at)}</td>
                    <td><span class="d-inline-block text-truncate" style="max-width: 150px;" title="${mission.business_unit_nom || ''}">${mission.business_unit_nom || 'N/A'}</span></td>
                    <td><span class="d-inline-block text-truncate" style="max-width: 150px;" title="${mission.division_nom || ''}">${mission.division_nom || 'N/A'}</span></td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-info me-1" onclick="viewMissionDetails('${mission.id}')" title="Voir les d√©tails">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="openEditMissionBasic('${mission.id}')" title="Modifier">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteMission('${mission.id}')" title="Supprimer">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Filtrage des missions
        function filterMissions(resetPage = false) {
            if (resetPage) currentPage = 1;
            loadMissions(currentPage);
            loadStats(); // Update stats when filters change
        }

        // Stats & Vue Rapide
        async function loadStats() {
            try {
                console.log('üîÑ Chargement des statistiques...');

                const params = new URLSearchParams({
                    view: currentView,
                    statut: document.getElementById('statusFilter').value || '',
                    client_id: document.getElementById('clientFilter').value || '',
                    business_unit_id: document.getElementById('buFilter').value || '',
                    division_id: document.getElementById('divisionFilter').value || '',
                    code: document.getElementById('codeFilter').value || '',
                    search: document.getElementById('searchInput').value || ''
                });
                // Remove empty params
                Array.from(params.keys()).forEach(k => { if (!params.get(k)) params.delete(k); });

                const response = await authenticatedFetch(`/api/missions/stats?${params.toString()}`);
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const data = result.data;
                        console.log('üìä Stats re√ßues:', data);

                        document.getElementById('statsTotal').textContent = data.total_missions || '0';
                        document.getElementById('statsActive').textContent = data.missions_actives || '0';
                        document.getElementById('statsFinished').textContent = data.missions_terminees || '0';

                        // Conversion explicite pour formatCurrency
                        const budget = parseFloat(data.total_budget || 0);
                        document.getElementById('statsBudget').textContent = formatCurrency(budget);
                    }
                } else {
                    console.error('‚ùå Erreur r√©ponse stats:', response.status);
                    document.getElementById('statsTotal').textContent = '-';
                    document.getElementById('statsActive').textContent = '-';
                    document.getElementById('statsFinished').textContent = '-';
                    document.getElementById('statsBudget').textContent = '-';
                }
            } catch (e) {
                console.error('‚ùå Exception stats:', e);
                document.getElementById('statsTotal').textContent = '!';
            }
        }

        function switchView(view, btn) {
            currentView = view;

            // Update buttons
            document.querySelectorAll('.quick-filter').forEach(b => {
                b.classList.remove('btn-primary', 'active');
                b.classList.add('btn-outline-secondary');
            });
            if (btn) {
                btn.classList.remove('btn-outline-secondary');
                btn.classList.add('btn-primary', 'active');
            }

            loadMissions();
        }

        // R√©initialisation des filtres
        function resetFilters() {
            document.getElementById('statusFilter').value = '';
            document.getElementById('clientFilter').value = '';
            document.getElementById('buFilter').value = '';
            document.getElementById('divisionFilter').value = '';
            document.getElementById('searchInput').value = '';
            document.getElementById('codeFilter').value = '';
            loadMissions();
        }

        // Remplissage du s√©lecteur client du formulaire (tous les clients)
        function populateClientFilters() {
            const missionClient = document.getElementById('missionClient');

            // V√©rifier que clients est un tableau
            if (!Array.isArray(clients)) {
                console.error('Erreur: clients n\'est pas un tableau:', clients);
                clients = [];
            }

            const clientOptions = clients.map(client =>
                `<option value="${client.id}">${client.nom || client.raison_sociale}</option>`
            ).join('');

            missionClient.innerHTML = '<option value="">S√©lectionner un client</option>' + clientOptions;
        }

        // Construire les listes des filtres (Client, BU, Division) √† partir des missions affich√©es
        function populateFilterOptionsFromMissions(list) {
            const clientFilter = document.getElementById('clientFilter');
            const buFilter = document.getElementById('buFilter');
            const divisionFilter = document.getElementById('divisionFilter');

            const selectedClient = clientFilter.value;
            const selectedBU = buFilter.value;
            const selectedDivision = divisionFilter.value;

            const clientsMap = new Map();
            const buMap = new Map();
            const divMap = new Map();

            (list || []).forEach(m => {
                if (m.client_id) clientsMap.set(m.client_id, m.client_nom || m.client_id);
                if (m.business_unit_id) buMap.set(m.business_unit_id, m.business_unit_nom || m.business_unit_id);
                if (m.division_id) divMap.set(m.division_id, m.division_nom || m.division_id);
            });

            clientFilter.innerHTML = '<option value="">Tous les clients</option>' +
                Array.from(clientsMap.entries())
                    .sort((a, b) => a[1].localeCompare(b[1]))
                    .map(([id, nom]) => `<option value="${id}">${nom}</option>`)
                    .join('');
            buFilter.innerHTML = '<option value="">Toutes les unit√©s</option>' +
                Array.from(buMap.entries())
                    .sort((a, b) => a[1].localeCompare(b[1]))
                    .map(([id, nom]) => `<option value="${id}">${nom}</option>`)
                    .join('');
            divisionFilter.innerHTML = '<option value="">Toutes les divisions</option>' +
                Array.from(divMap.entries())
                    .sort((a, b) => a[1].localeCompare(b[1]))
                    .map(([id, nom]) => `<option value="${id}">${nom}</option>`)
                    .join('');

            // Restaurer s√©lection si toujours disponible
            if ([...clientsMap.keys()].includes(selectedClient)) clientFilter.value = selectedClient; else clientFilter.value = '';
            if ([...buMap.keys()].includes(selectedBU)) buFilter.value = selectedBU; else buFilter.value = '';
            if ([...divMap.keys()].includes(selectedDivision)) divisionFilter.value = selectedDivision; else divisionFilter.value = '';
        }

        // Sauvegarde d'une mission
        async function saveMission() {
            const formData = {
                code: document.getElementById('missionCode').value,
                nom: document.getElementById('missionName').value,
                client_id: document.getElementById('missionClient').value,
                statut: document.getElementById('missionStatus').value,
                date_debut: document.getElementById('missionStartDate').value,
                date_fin: document.getElementById('missionEndDate').value,
                description: document.getElementById('missionDescription').value,
                budget: parseFloat(document.getElementById('missionBudget').value) || 0,
                taux_horaire: parseFloat(document.getElementById('missionRate').value) || 0
            };

            try {
                const url = currentMissionId ? `/api/missions/${currentMissionId}` : '/api/missions';
                const method = currentMissionId ? 'PUT' : 'POST';

                const response = await authenticatedFetch(url, {
                    method: method,
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    showAlert('Mission sauvegard√©e avec succ√®s', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addMissionModal')).hide();
                    loadMissions();
                    resetMissionForm();
                } else {
                    showAlert('Erreur lors de la sauvegarde', 'danger');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showAlert('Erreur de connexion', 'danger');
            }
        }

        // √âdition basique (Nom + Description seulement)
        let editBasicMissionId = null;
        function openEditMissionBasic(missionId) {
            const mission = missions.find(m => m.id === missionId);
            if (!mission) return;
            editBasicMissionId = missionId;
            document.getElementById('editMissionName').value = mission.nom || '';
            document.getElementById('editMissionDescription').value = mission.description || '';
            new bootstrap.Modal(document.getElementById('editMissionBasicModal')).show();
        }

        async function updateMissionBasic() {
            if (!editBasicMissionId) return;
            const payload = {
                nom: document.getElementById('editMissionName').value,
                description: document.getElementById('editMissionDescription').value
            };
            try {
                const response = await authenticatedFetch(`/api/missions/${editBasicMissionId}`, {
                    method: 'PUT',
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    try {
                        const text = await response.text();
                        console.error('Erreur MAJ mission:', text);
                    } catch (_) { }
                    showAlert('Erreur lors de la mise √† jour', 'danger');
                    return;
                }
                bootstrap.Modal.getInstance(document.getElementById('editMissionBasicModal')).hide();
                showAlert('Mission mise √† jour avec succ√®s', 'success');
                loadMissions();
            } catch (e) {
                showAlert('Erreur de connexion', 'danger');
            }
        }

        // Affichage des d√©tails d'une mission
        function viewMissionDetails(missionId) {
            window.location.href = `mission-details.html?id=${missionId}`;
        }

        // Suppression d'une mission
        async function deleteMission(missionId) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette mission ?')) {
                try {
                    const response = await authenticatedFetch(`/api/missions/${missionId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        showAlert('Mission supprim√©e avec succ√®s', 'success');
                        loadMissions();
                    } else {
                        showAlert('Erreur lors de la suppression', 'danger');
                    }
                } catch (error) {
                    showAlert('Erreur de connexion', 'danger');
                }
            }
        }

        // R√©initialisation du formulaire
        function resetMissionForm() {
            currentMissionId = null;
            document.getElementById('missionModalTitle').innerHTML = '<i class="fas fa-plus me-2"></i>Nouvelle Mission';
            document.getElementById('missionForm').reset();
        }

        // Utilitaires
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString('fr-FR');
        }



        // Gestion du modal
        document.getElementById('addMissionModal').addEventListener('hidden.bs.modal', function () {
            resetMissionForm();
        });

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            const container = document.querySelector('.main-content-area');
            if (container) {
                container.insertBefore(alertDiv, container.firstChild);
            } else {
                document.body.appendChild(alertDiv);
            }

            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
    </script>
</body>

</html>