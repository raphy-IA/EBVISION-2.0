<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EBVISION 2.0 - Détails de Campagne</title>
    
    <!-- CSS Bootstrap et FontAwesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- CSS de la sidebar moderne -->
    <link rel="stylesheet" href="css/modern-sidebar.css">
    
    <link rel="stylesheet" href="css/app-title.css">
    
    <!-- Scripts pour la top bar EBVISION 2.0 -->
    <script src="js/global-auth.js"></script>
    <!-- Script pour la gestion utilisateur -->
    <script src="js/user-header.js"></script>
    <script src="js/profile-menu.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/tasks.js"></script>
    
    
    
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #f8f9fa;
            --card-shadow: 0 2px 10px rgba(0,0,0,0.08);
            --border-radius: 12px;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            color: #2c3e50;
        }
        
        .page-wrapper {
            display: flex;
            min-height: 100vh;
        }
        
        .main-content-area {
            flex-grow: 1;
            padding: 2rem;
        }
        
        /* Header de la campagne */
        .campaign-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--card-shadow);
        }
        
        .campaign-title {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .campaign-subtitle {
            opacity: 0.9;
            font-size: 1rem;
        }
        
        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-draft { background: #e9ecef; color: #6c757d; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-validated { background: #d4edda; color: #155724; }
        .status-rejected { background: #f8d7da; color: #721c24; }
        
        /* Cards principales */
        .info-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--card-shadow);
            border: none;
        }
        
        .info-card h5 {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .info-card h5 i {
            color: var(--secondary-color);
        }
        
        /* Statistiques */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--card-shadow);
            border-left: 4px solid var(--secondary-color);
            transition: transform 0.2s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--secondary-color);
            display: block;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 0.5rem;
        }
        
        /* Liste des entreprises */
        .company-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .company-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-left: 3px solid var(--success-color);
            transition: all 0.2s ease;
        }
        
        .company-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        
        .company-item.rejected {
            border-left-color: var(--danger-color);
        }
        
        .company-name {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .company-details {
            color: #6c757d;
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }
        
        /* Validateurs */
        .validators-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--card-shadow);
        }
        
        .validator-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }
        
        .validator-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .validator-info h6 {
            margin: 0;
            color: var(--primary-color);
        }
        
        .validator-role {
            background: var(--secondary-color);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        /* Boutons d'action */
        .action-buttons {
            position: sticky;
            bottom: 2rem;
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            margin-top: 2rem;
        }
        
        .btn-modern {
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s ease;
        }
        
        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .main-content-area {
                padding: 1rem;
            }
            
            .campaign-header {
                padding: 1.5rem;
            }
            
            .campaign-title {
                font-size: 1.5rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Loading */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: var(--secondary-color);
        }
        
        /* Alertes */
        .alert-modern {
            border-radius: var(--border-radius);
            border: none;
            box-shadow: var(--card-shadow);
        }
    </style>
</head>
<body>
    <!-- Bouton toggle sidebar mobile -->
    <button class="sidebar-toggle d-md-none">
        <i class="fas fa-bars"></i>
    </button>
    
    <div class="page-wrapper">
        <!-- Sidebar Container -->
        <div class="sidebar-container">
            <!-- La sidebar sera générée par JavaScript -->
        </div>

        <!-- Main Content Area -->
        <div class="main-content-area">
            <!-- Header de la campagne -->
            <div class="campaign-header">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1 class="campaign-title" id="campaignName">
                            <i class="fas fa-bullhorn me-2"></i>Chargement...
                        </h1>
                        <p class="campaign-subtitle" id="campaignDescription">
                            <i class="fas fa-clock me-2"></i>Créée le <span id="campaignCreatedDate">...</span>
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <span class="status-badge" id="campaignStatus">...</span>
                        <div class="mt-3">
                            <a href="prospecting-campaigns.html" class="btn btn-outline-light btn-modern">
                                <i class="fas fa-arrow-left me-2"></i>Retour
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alertes -->
            <div id="alertsContainer"></div>

            <!-- Statistiques principales -->
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-number" id="totalCompanies">0</span>
                    <span class="stat-label">Entreprises</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="approvedCompanies">0</span>
                    <span class="stat-label">Approuvées</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="rejectedCompanies">0</span>
                    <span class="stat-label">Rejetées</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="totalSources">0</span>
                    <span class="stat-label">Sources</span>
                </div>
            </div>

            <!-- Informations de la campagne -->
            <div class="row">
                <div class="col-md-6">
                    <div class="info-card">
                        <h5><i class="fas fa-info-circle"></i>Informations générales</h5>
                        <div class="row">
                            <div class="col-6">
                                <p><strong>Canal:</strong><br><span id="campaignChannelDetail">...</span></p>
                                <p><strong>Priorité:</strong><br><span id="campaignPriority">...</span></p>
                                <p><strong>Modèle:</strong><br><span id="campaignTemplate">...</span></p>
                            </div>
                            <div class="col-6">
                                <p><strong>Business Unit:</strong><br><span id="campaignBU">...</span></p>
                                <p><strong>Division:</strong><br><span id="campaignDivision">...</span></p>
                                <p><strong>Responsable:</strong><br><span id="campaignResponsible">...</span></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="info-card">
                        <h5><i class="fas fa-calendar-alt"></i>Planning</h5>
                        <p><strong>Date planifiée:</strong><br><span id="campaignScheduledDate">...</span></p>
                        <p><strong>Date de soumission:</strong><br><span id="campaignSubmissionDate">...</span></p>
                        <p><strong>Date de validation:</strong><br><span id="campaignValidationDate">...</span></p>
                        <p><strong>Créé par:</strong><br><span id="campaignCreator">...</span></p>
                    </div>
                </div>
            </div>

            <!-- Section des validateurs -->
            <div class="validators-section" id="validatorsSection" style="display: none;">
                <h5><i class="fas fa-users"></i>Validateurs assignés</h5>
                <div id="validatorsList"></div>
            </div>

            <!-- Liste des entreprises -->
            <div class="info-card">
                <h5><i class="fas fa-building"></i>Entreprises de la campagne</h5>
                <div class="company-list" id="companiesList">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p class="mt-2">Chargement des entreprises...</p>
                    </div>
                </div>
            </div>

            <!-- Boutons d'action -->
            <div class="action-buttons">
                <div class="row">
                    <div class="col-md-6">
                        <button class="btn btn-success btn-modern me-2" id="submitCampaignBtn" onclick="submitForValidation()" style="display: none;">
                            <i class="fas fa-paper-plane me-2"></i>Soumettre pour validation
                        </button>
                        <button class="btn btn-primary btn-modern me-2" onclick="editCurrentCampaign()">
                            <i class="fas fa-edit me-2"></i>Modifier
                        </button>
                    </div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-outline-secondary btn-modern me-2" onclick="exportCampaignData()">
                            <i class="fas fa-download me-2"></i>Exporter
                        </button>
                        <a href="#" class="btn btn-info btn-modern" id="executionBtn" style="display: none;">
                            <i class="fas fa-play me-2"></i>Exécuter
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/menu-permissions.js"></script>
    <script src="js/session-manager.js"></script>
    
    <script>
        let currentCampaignId = null;
        const API = '/api/prospecting';

        function getAuthHeader() {
            return {
                'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                'Content-Type': 'application/json'
            };
        }

        function showAlert(message, type = 'info') {
            const alertsContainer = document.getElementById('alertsContainer');
            const alertId = 'alert-' + Date.now();
            
            alertsContainer.innerHTML = `
                <div id="${alertId}" class="alert alert-${type} alert-modern alert-dismissible fade show" role="alert">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) {
                    alert.remove();
                }
            }, 5000);
        }

        function getInitials(name) {
            return name.split(' ').map(word => word.charAt(0)).join('').toUpperCase().substring(0, 2);
        }

        function updateStatusBadge(status) {
            const badge = document.getElementById('campaignStatus');
            let className = 'status-draft';
            let text = 'Brouillon';
            
            switch(status) {
                case 'DRAFT':
                    className = 'status-draft';
                    text = 'Brouillon';
                    break;
                case 'PENDING_VALIDATION':
                case 'EN_VALIDATION':
                    className = 'status-pending';
                    text = 'En validation';
                    break;
                case 'VALIDATED':
                case 'VALIDE':
                    className = 'status-validated';
                    text = 'Validée';
                    break;
                case 'REJECTED':
                case 'REJETE':
                    className = 'status-rejected';
                    text = 'Rejetée';
                    break;
            }
            
            badge.className = `status-badge ${className}`;
            badge.textContent = text;
        }

        async function loadCampaignData() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                currentCampaignId = urlParams.get('id');
                
                if (!currentCampaignId) {
                    showAlert('ID de campagne manquant', 'danger');
                    return;
                }

                console.log('🔍 Chargement de la campagne:', currentCampaignId);
                
                const response = await fetch(`${API}/campaigns/${currentCampaignId}`, {
                    headers: getAuthHeader()
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const campaign = result.data;
                    console.log('📋 Campagne chargée:', campaign);
                    
                    // Mettre à jour les informations de base
                    document.getElementById('campaignName').textContent = campaign.name;
                    document.getElementById('campaignDescription').innerHTML = `
                        <i class="fas fa-clock me-2"></i>Créée le ${new Date(campaign.created_at).toLocaleDateString('fr-FR')}
                    `;
                    
                    // Statut
                    updateStatusBadge(campaign.validation_statut || campaign.status);
                    
                    // Informations générales
                    document.getElementById('campaignChannelDetail').textContent = campaign.channel || 'Non défini';
                    document.getElementById('campaignPriority').textContent = campaign.priority || 'Normale';
                    document.getElementById('campaignTemplate').textContent = campaign.template_name || 'Non défini';
                    document.getElementById('campaignBU').textContent = campaign.business_unit_name || 'Non défini';
                    document.getElementById('campaignDivision').textContent = campaign.division_name || 'Non défini';
                    document.getElementById('campaignResponsible').textContent = campaign.responsible_name || 'Non défini';
                    
                    // Planning
                    document.getElementById('campaignScheduledDate').textContent = campaign.scheduled_date ? new Date(campaign.scheduled_date).toLocaleDateString('fr-FR') : 'Non définie';
                    document.getElementById('campaignSubmissionDate').textContent = campaign.date_soumission ? new Date(campaign.date_soumission).toLocaleDateString('fr-FR') : 'Non soumise';
                    document.getElementById('campaignValidationDate').textContent = campaign.date_validation ? new Date(campaign.date_validation).toLocaleDateString('fr-FR') : 'Non validée';
                    document.getElementById('campaignCreator').textContent = campaign.creator_name || 'Système';
                    
                    // Charger les entreprises
                    await loadCompanies();
                    
                    // Charger les validateurs si la campagne est en validation ou validée
                    if (['EN_VALIDATION', 'VALIDE', 'VALIDATED'].includes(campaign.validation_statut || campaign.status)) {
                        await loadValidators();
                    }
                    
                    // Gérer les boutons selon le statut
                    updateActionButtons(campaign.validation_statut || campaign.status);
                    
                } else {
                    showAlert('Erreur lors du chargement de la campagne: ' + result.error, 'danger');
                }
            } catch (error) {
                console.error('Erreur chargement campagne:', error);
                showAlert('Erreur lors du chargement de la campagne', 'danger');
            }
        }

        async function loadCompanies() {
            try {
                console.log('🔍 Chargement des entreprises de la campagne');
                
                const response = await fetch(`${API}/campaigns/${currentCampaignId}/companies?limit=1000`, {
                    headers: getAuthHeader()
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const companies = result.data || [];
                    console.log('📊 Entreprises chargées:', companies.length);
                    
                    renderCompanies(companies);
                    updateStats(companies);
                } else {
                    showAlert('Erreur lors du chargement des entreprises: ' + result.error, 'danger');
                }
            } catch (error) {
                console.error('Erreur chargement entreprises:', error);
                showAlert('Erreur lors du chargement des entreprises', 'danger');
            }
        }

        function renderCompanies(companies) {
            const container = document.getElementById('companiesList');
            
            if (companies.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-building fa-2x text-muted"></i>
                        <p class="text-muted mt-2">Aucune entreprise trouvée dans cette campagne</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            companies.forEach(company => {
                const validationStatus = company.validation_status || 'PENDING';
                const isRejected = validationStatus === 'REJECTED';
                const isApproved = validationStatus === 'APPROVED';
                const isPending = validationStatus === 'PENDING';
                
                let statusClass = '';
                let statusIcon = '';
                let statusText = '';
                
                if (isRejected) {
                    statusClass = 'rejected';
                    statusIcon = 'fa-times-circle text-danger';
                    statusText = 'Rejetée';
                } else if (isApproved) {
                    statusClass = 'approved';
                    statusIcon = 'fa-check-circle text-success';
                    statusText = 'Approuvée';
                } else {
                    statusClass = 'pending';
                    statusIcon = 'fa-clock text-warning';
                    statusText = 'En attente';
                }
                
                html += `
                    <div class="company-item ${statusClass}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="company-name">${company.name}</div>
                                <div class="company-details">
                                    <i class="fas fa-industry me-1"></i>${company.industry || 'Secteur non défini'}
                                    ${company.city ? `<i class="fas fa-map-marker-alt ms-2 me-1"></i>${company.city}` : ''}
                                    ${company.email ? `<i class="fas fa-envelope ms-2 me-1"></i>${company.email}` : ''}
                                </div>
                            </div>
                            <div class="text-end">
                                <i class="fas ${statusIcon}"></i>
                                <div class="small text-muted">${statusText}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function updateStats(companies) {
            const total = companies.length;
            const approved = companies.filter(c => c.validation_status === 'APPROVED').length;
            const rejected = companies.filter(c => c.validation_status === 'REJECTED').length;
            
            document.getElementById('totalCompanies').textContent = total;
            document.getElementById('approvedCompanies').textContent = approved;
            document.getElementById('rejectedCompanies').textContent = rejected;
            document.getElementById('totalSources').textContent = companies.filter(c => c.source_id).length;
        }

        async function loadValidators() {
            try {
                const response = await fetch(`${API}/campaigns/${currentCampaignId}/validators`, {
                    headers: getAuthHeader()
                });
                
                const result = await response.json();
                
                if (result.success) {
                    renderValidatorsList(result.data);
                    document.getElementById('validatorsSection').style.display = 'block';
                }
            } catch (error) {
                console.error('Erreur chargement validateurs:', error);
            }
        }

        function renderValidatorsList(validators) {
            const container = document.getElementById('validatorsList');
            
            if (validators.length === 0) {
                container.innerHTML = '<p class="text-muted">Aucun validateur assigné</p>';
                return;
            }
            
            let html = '';
            validators.forEach(validator => {
                html += `
                    <div class="validator-item">
                        <div class="validator-avatar">
                            ${getInitials(`${validator.prenom} ${validator.nom}`)}
                        </div>
                        <div class="flex-grow-1">
                            <h6>${validator.prenom} ${validator.nom}</h6>
                            <div class="d-flex align-items-center gap-2">
                                <span class="validator-role">${validator.role}</span>
                                <small class="text-muted">${validator.type}</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function updateActionButtons(status) {
            const submitBtn = document.getElementById('submitCampaignBtn');
            const executionBtn = document.getElementById('executionBtn');
            
            // Bouton de soumission
            if (status === 'DRAFT' || status === 'BROUILLON') {
                submitBtn.style.display = 'inline-block';
            } else {
                submitBtn.style.display = 'none';
            }
            
            // Bouton d'exécution
            if (status === 'VALIDATED' || status === 'VALIDE') {
                executionBtn.style.display = 'inline-block';
                executionBtn.href = `campaign-execution.html?id=${currentCampaignId}`;
            } else {
                executionBtn.style.display = 'none';
            }
        }

        async function submitForValidation() {
            try {
                const submitBtn = document.getElementById('submitCampaignBtn');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></i>Soumission...';
                
                const response = await fetch(`${API}/campaigns/${currentCampaignId}/submit`, {
                    method: 'POST',
                    headers: getAuthHeader()
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('Campagne soumise avec succès pour validation !', 'success');
                    
                    setTimeout(async () => {
                        await loadCampaignData();
                        await loadValidators();
                    }, 1000);
                } else {
                    throw new Error(result.error || 'Erreur lors de la soumission');
                }
                
            } catch (error) {
                console.error('Erreur soumission:', error);
                showAlert('Erreur lors de la soumission : ' + error.message, 'danger');
            } finally {
                const submitBtn = document.getElementById('submitCampaignBtn');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Soumettre pour validation';
            }
        }

        function exportCampaignData() {
            try {
                const campaignData = {
                    nom: document.getElementById('campaignName').textContent,
                    statut: document.getElementById('campaignStatus').textContent,
                    entreprises: document.getElementById('totalCompanies').textContent,
                    approuvees: document.getElementById('approvedCompanies').textContent,
                    rejetees: document.getElementById('rejectedCompanies').textContent,
                    dateExport: new Date().toLocaleString('fr-FR')
                };
                
                const dataStr = JSON.stringify(campaignData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `campagne_${campaignData.nom.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                showAlert('Données de la campagne exportées avec succès !', 'success');
            } catch (error) {
                console.error('Erreur export:', error);
                showAlert('Erreur lors de l\'export des données', 'danger');
            }
        }

        function editCurrentCampaign() {
            if (currentCampaignId) {
                window.location.href = `prospecting-campaigns.html?edit=${currentCampaignId}`;
            } else {
                showAlert('Impossible de modifier la campagne : ID manquant', 'danger');
            }
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            loadCampaignData();
        });
    </script>
    
    <!-- Script pour la sidebar -->
    <script src="js/sidebar.js" defer></script>
</body>
</html>
