<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D√©tails de Campagne</title>

    <!-- CSS Bootstrap et FontAwesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/vendor/fontawesome/css/all.min.css" rel="stylesheet">

    <!-- CSS de la sidebar moderne -->
    <link rel="stylesheet" href="css/modern-sidebar.css">

    <link rel="stylesheet" href="css/app-title.css">

    <!-- Scripts pour la top bar EBVISION 2.0 -->
    <script src="js/global-auth.js"></script>
    <!-- Script pour la gestion utilisateur -->
    <script src="js/user-header.js"></script>
    <script src="js/profile-menu.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/tasks.js"></script>




    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #f8f9fa;
            --card-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            --border-radius: 12px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            color: #2c3e50;
        }

        .page-wrapper {
            display: flex;
            min-height: 100vh;
        }

        .main-content-area {
            flex-grow: 1;
            padding: 2rem;
        }

        /* Header de la campagne */
        .campaign-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--card-shadow);
        }

        .campaign-title {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .campaign-subtitle {
            opacity: 0.9;
            font-size: 1rem;
        }

        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-draft {
            background: #e9ecef;
            color: #6c757d;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-validated {
            background: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        /* Cards principales */
        .info-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--card-shadow);
            border: none;
        }

        .info-card h5 {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .info-card h5 i {
            color: var(--secondary-color);
        }

        /* Statistiques */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--card-shadow);
            border-left: 4px solid var(--secondary-color);
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--secondary-color);
            display: block;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 0.5rem;
        }

        /* Liste des entreprises */
        .company-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .company-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-left: 3px solid var(--success-color);
            transition: all 0.2s ease;
        }

        .company-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .company-item.rejected {
            border-left-color: var(--danger-color);
        }

        .company-name {
            font-weight: 600;
            color: var(--primary-color);
        }

        .company-details {
            color: #6c757d;
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }

        /* Validateurs */
        .validators-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--card-shadow);
        }

        .validator-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .validator-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .validator-info h6 {
            margin: 0;
            color: var(--primary-color);
        }

        .validator-role {
            background: var(--secondary-color);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Boutons d'action */
        .action-buttons {
            position: sticky;
            bottom: 2rem;
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            margin-top: 2rem;
        }

        .btn-modern {
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s ease;
        }

        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-content-area {
                padding: 1rem;
            }

            .campaign-header {
                padding: 1.5rem;
            }

            .campaign-title {
                font-size: 1.5rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Loading */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: var(--secondary-color);
        }

        /* Alertes */
        .alert-modern {
            border-radius: var(--border-radius);
            border: none;
            box-shadow: var(--card-shadow);
        }
    </style>

    <!-- CSS des variables de branding dynamiques -->
    <link rel="stylesheet" href="/config/themes/brand-variables.css">

    <!-- Scripts de branding -->
    <script src="js/branding-loader.js"></script>
    <script src="js/sidebar-branding.js"></script>
</head>

<body>
    <!-- Bouton toggle sidebar mobile -->
    <button class="sidebar-toggle d-md-none">
        <i class="fas fa-bars"></i>
    </button>

    <div class="page-wrapper">
        <!-- Sidebar Container -->
        <div class="sidebar-container">
            <!-- La sidebar sera g√©n√©r√©e par JavaScript -->
        </div>

        <!-- Main Content Area -->
        <div class="main-content-area">
            <!-- Header de la campagne -->
            <div class="campaign-header">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1 class="campaign-title" id="campaignName">
                            <i class="fas fa-bullhorn me-2"></i>Chargement...
                        </h1>
                        <p class="campaign-subtitle" id="campaignDescription">
                            <i class="fas fa-clock me-2"></i>Cr√©√©e le <span id="campaignCreatedDate">...</span>
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <span class="status-badge fs-5 py-2 px-3 shadow-sm" id="campaignStatus">...</span>
                    </div>
                </div>
            </div>

            <!-- Alertes -->
            <div id="alertsContainer"></div>

            <!-- Statistiques principales -->
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-number" id="totalCompanies">0</span>
                    <span class="stat-label">Entreprises</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="approvedCompanies">0</span>
                    <span class="stat-label">Approuv√©es</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="rejectedCompanies">0</span>
                    <span class="stat-label">Rejet√©es</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="totalSources">0</span>
                    <span class="stat-label">Sources</span>
                </div>
            </div>

            <!-- Informations de la campagne -->
            <div class="row">
                <div class="col-md-6">
                    <div class="info-card">
                        <h5><i class="fas fa-info-circle"></i>Informations g√©n√©rales</h5>
                        <div class="row">
                            <div class="col-6">
                                <p><strong>Canal:</strong><br><span id="campaignChannelDetail">...</span></p>
                                <p><strong>Priorit√©:</strong><br><span id="campaignPriority">...</span></p>
                                <p><strong>Mod√®le:</strong><br><span id="campaignTemplate">...</span></p>
                            </div>
                            <div class="col-6">
                                <p><strong>Business Unit:</strong><br><span id="campaignBU">...</span></p>
                                <p><strong>Division:</strong><br><span id="campaignDivision">...</span></p>
                                <p><strong>Responsable:</strong><br><span id="campaignResponsible">...</span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="info-card">
                        <h5><i class="fas fa-calendar-alt"></i>Planning</h5>
                        <p><strong>Date planifi√©e:</strong><br><span id="campaignScheduledDate">...</span></p>
                        <p><strong>Date de soumission:</strong><br><span id="campaignSubmissionDate">...</span></p>
                        <p><strong>Date de validation:</strong><br><span id="campaignValidationDate">...</span></p>
                        <p><strong>Cr√©√© par:</strong><br><span id="campaignCreator">...</span></p>
                    </div>
                </div>
            </div>

            <!-- Section des validateurs -->
            <div class="validators-section" id="validatorsSection" style="display: none;">
                <h5><i class="fas fa-users"></i>Validateurs assign√©s</h5>
                <div id="validatorsList"></div>
            </div>

            <!-- Liste des entreprises -->
            <div class="info-card">
                <h5><i class="fas fa-building"></i>Entreprises de la campagne</h5>
                <div class="company-list" id="companiesList">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p class="mt-2">Chargement des entreprises...</p>
                    </div>
                </div>
            </div>

            <!-- Boutons d'action -->
            <div class="action-buttons">
                <div class="row">
                    <div class="col-md-6">
                        <a href="prospecting-campaigns.html" class="btn btn-outline-secondary btn-modern me-2">
                            <i class="fas fa-arrow-left me-2"></i>Retour
                        </a>
                        <button class="btn btn-success btn-modern me-2" id="submitCampaignBtn"
                            onclick="submitForValidation()" style="display: none;">
                            <i class="fas fa-paper-plane me-2"></i>Soumettre pour validation
                        </button>
                        <button class="btn btn-primary btn-modern me-2" id="editCampaignBtn"
                            onclick="editCurrentCampaign()">
                            <i class="fas fa-edit me-2"></i>Modifier
                        </button>
                    </div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-outline-secondary btn-modern me-2" onclick="exportCampaignData()">
                            <i class="fas fa-download me-2"></i>Exporter
                        </button>
                        <a href="#" class="btn btn-info btn-modern" id="executionBtn" style="display: none;">
                            <i class="fas fa-play me-2"></i>Ex√©cuter
                        </a>
                    </div>
                </div>
            </div>
            <!-- Modal d'√©dition d'entreprise -->
            <div class="modal fade" id="editCompanyModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Modifier l'entreprise</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="editCompanyForm">
                                <input type="hidden" id="editCompanyId">

                                <ul class="nav nav-tabs mb-3" id="editCompanyTabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="general-tab" data-bs-toggle="tab"
                                            data-bs-target="#general" type="button" role="tab">Informations
                                            G√©n√©rales</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="contacts-tab" data-bs-toggle="tab"
                                            data-bs-target="#contacts" type="button" role="tab">Contacts &
                                            Admin</button>
                                    </li>
                                </ul>

                                <div class="tab-content" id="editCompanyTabContent">
                                    <!-- Onglet G√©n√©ral -->
                                    <div class="tab-pane fade show active" id="general" role="tabpanel">
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label class="form-label">Nom de l'entreprise *</label>
                                                <input type="text" class="form-control" id="editName" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Secteur d'activit√©</label>
                                                <input type="text" class="form-control" id="editIndustry">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Email g√©n√©ral</label>
                                                <input type="email" class="form-control" id="editEmail">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">T√©l√©phone standard</label>
                                                <input type="text" class="form-control" id="editPhone">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Site web</label>
                                                <input type="url" class="form-control" id="editWebsite">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Ville</label>
                                                <input type="text" class="form-control" id="editCity">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Onglet Contacts -->
                                    <div class="tab-pane fade" id="contacts" role="tabpanel">
                                        <h6 class="mb-3 text-primary"><i class="fas fa-user me-2"></i>Contact Principal
                                        </h6>
                                        <div class="row g-3 mb-4">
                                            <div class="col-md-4">
                                                <label class="form-label">Nom du contact</label>
                                                <input type="text" class="form-control" id="editContactNom">
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">Email contact</label>
                                                <input type="email" class="form-control" id="editContactEmail">
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">T√©l contact</label>
                                                <input type="text" class="form-control" id="editContactTel">
                                            </div>
                                        </div>

                                        <h6 class="mb-3 text-secondary"><i
                                                class="fas fa-user-shield me-2"></i>Administrateur / Dirigeant</h6>
                                        <div class="row g-3">
                                            <div class="col-md-4">
                                                <label class="form-label">Nom Administrateur</label>
                                                <input type="text" class="form-control" id="editAdminNom">
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">Email Admin</label>
                                                <input type="email" class="form-control" id="editAdminEmail">
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">Contact Admin (Tel)</label>
                                                <input type="text" class="form-control" id="editAdminContact">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                            <button type="button" class="btn btn-primary"
                                onclick="saveCompanyDetails()">Enregistrer</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal d'affectation d'entreprises -->
            <div class="modal fade" id="assignModal" tabindex="-1" aria-labelledby="assignModalLabel"
                aria-hidden="true">
                <div class="modal-dialog modal-fullscreen-lg-down modal-xl" style="max-width: 95vw;">
                    <div class="modal-content" style="height: 90vh;">
                        <div class="modal-header">
                            <h5 class="modal-title" id="assignModalLabel">
                                <i class="fas fa-users me-2"></i>Affecter des entreprises √† la campagne
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body" style="height: calc(90vh - 140px); overflow-y: auto;">
                            <div class="row h-100">
                                <!-- Section gauche : S√©lection et ajout d'entreprises -->
                                <div class="col-md-7">
                                    <div class="card h-100">
                                        <div class="card-header">
                                            <h6 class="mb-0"><i class="fas fa-plus me-2"></i>Ajouter des entreprises
                                            </h6>
                                        </div>
                                        <div class="card-body d-flex flex-column">
                                            <!-- S√©lection de source -->
                                            <div class="mb-3">
                                                <label class="form-label">Source d'entreprises :</label>
                                                <select id="sourceSelect" class="form-select"
                                                    onchange="loadSourceCompanies()">
                                                    <option value="">S√©lectionnez une source...</option>
                                                </select>
                                            </div>

                                            <!-- Filtres avanc√©s -->
                                            <div class="mb-3" id="filtersSection" style="display: none;">
                                                <div class="row">
                                                    <div class="col-md-4">
                                                        <label class="form-label">Secteur d'activit√©</label>
                                                        <select id="filterIndustry" class="form-select form-select-sm"
                                                            onchange="applyFilters()">
                                                            <option value="">Tous les secteurs</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <label class="form-label">Ville</label>
                                                        <select id="filterCity" class="form-select form-select-sm"
                                                            onchange="applyFilters()">
                                                            <option value="">Toutes les villes</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <label class="form-label">Taille</label>
                                                        <select id="filterSize" class="form-select form-select-sm"
                                                            onchange="applyFilters()">
                                                            <option value="">Toutes les tailles</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Recherche dans la source -->
                                            <div class="mb-3">
                                                <div class="input-group">
                                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                                    <input type="text" id="companySearch" class="form-control"
                                                        placeholder="Rechercher une entreprise..."
                                                        oninput="filterCompanies()">
                                                    <button class="btn btn-outline-secondary" type="button"
                                                        onclick="clearFilters()">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            </div>

                                            <!-- Liste des entreprises de la source -->
                                            <div class="mb-3 flex-grow-1">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <small class="text-muted">
                                                        Entreprises de la source
                                                        <span id="companiesCount"
                                                            class="badge bg-secondary ms-2">0</span>
                                                    </small>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox"
                                                            id="selectAllSource" onchange="toggleSelectAllSource()">
                                                        <label class="form-check-label" for="selectAllSource">Tout
                                                            s√©lectionner</label>
                                                    </div>
                                                </div>
                                                <div id="sourceCompaniesList"
                                                    style="height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem;">
                                                    <div class="text-center py-4">
                                                        <i class="fas fa-database fa-2x text-muted"></i>
                                                        <p class="text-muted mt-2">S√©lectionnez une source pour voir les
                                                            entreprises</p>
                                                    </div>
                                                </div>

                                                <!-- Pagination -->
                                                <div class="d-flex justify-content-between align-items-center mt-2"
                                                    id="paginationSection" style="display: none;">
                                                    <div class="d-flex align-items-center">
                                                        <span class="text-muted me-2">Page</span>
                                                        <select id="pageSelect" class="form-select form-select-sm"
                                                            style="width: auto;" onchange="goToPage()">
                                                        </select>
                                                        <span class="text-muted ms-2">sur <span
                                                                id="totalPages">0</span></span>
                                                    </div>
                                                    <div class="btn-group btn-group-sm">
                                                        <button class="btn btn-outline-secondary"
                                                            onclick="previousPage()" id="prevBtn">
                                                            <i class="fas fa-chevron-left"></i>
                                                        </button>
                                                        <button class="btn btn-outline-secondary" onclick="nextPage()"
                                                            id="nextBtn">
                                                            <i class="fas fa-chevron-right"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Bouton d'ajout -->
                                            <button class="btn btn-primary w-100" onclick="addSelectedCompanies()"
                                                id="addCompaniesBtn" disabled>
                                                <i class="fas fa-plus me-2"></i>Ajouter les entreprises s√©lectionn√©es
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Section droite : Entreprises de la campagne -->
                                <div class="col-md-5">
                                    <div class="row h-100">
                                        <!-- Entreprises s√©lectionn√©es pour ajout -->
                                        <div class="col-12 mb-3">
                                            <div class="card">
                                                <div class="card-header">
                                                    <h6 class="mb-0"><i class="fas fa-clock me-2"></i>√Ä ajouter (<span
                                                            id="selectedCount">0</span>)</h6>
                                                </div>
                                                <div class="card-body">
                                                    <div id="selectedCompaniesList"
                                                        style="max-height: 200px; overflow-y: auto;">
                                                        <div class="text-center py-3">
                                                            <i class="fas fa-list fa-2x text-muted"></i>
                                                            <p class="text-muted mt-2">Aucune entreprise s√©lectionn√©e
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Entreprises d√©j√† affect√©es -->
                                        <div class="col-12 flex-grow-1">
                                            <div class="card h-100">
                                                <div class="card-header">
                                                    <h6 class="mb-0"><i class="fas fa-check me-2"></i>D√©j√† affect√©es
                                                        (<span id="assignedCount">0</span>)</h6>
                                                </div>
                                                <div class="card-body">
                                                    <div id="assignedCompaniesList"
                                                        style="height: 300px; overflow-y: auto;">
                                                        <div class="text-center py-3">
                                                            <div class="spinner-border spinner-border-sm" role="status">
                                                                <span class="visually-hidden">Chargement...</span>
                                                            </div>
                                                            <p class="text-muted mt-2">Chargement...</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                            <button type="button" class="btn btn-success" onclick="saveAssignments()"
                                id="saveAssignmentsBtn">
                                <i class="fas fa-save me-2"></i>Sauvegarder les affectations
                            </button>
                        </div>
                    </div>

                    <script src="js/auth.js"></script>
                    <script src="js/menu-permissions.js"></script>
                    <script src="/js/page-permissions.js"></script>
                    <script src="js/session-manager.js"></script>

                    <script>
                        let currentCampaignId = null;
                        const API = '/api/prospecting';

                        function getAuthHeader() {
                            return {
                                'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                                'Content-Type': 'application/json'
                            };
                        }

                        function showAlert(message, type = 'info') {
                            const alertsContainer = document.getElementById('alertsContainer');
                            const alertId = 'alert-' + Date.now();

                            alertsContainer.innerHTML = `
                <div id="${alertId}" class="alert alert-${type} alert-modern alert-dismissible fade show" role="alert">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;

                            setTimeout(() => {
                                const alert = document.getElementById(alertId);
                                if (alert) {
                                    alert.remove();
                                }
                            }, 5000);
                        }

                        function getInitials(name) {
                            return name.split(' ').map(word => word.charAt(0)).join('').toUpperCase().substring(0, 2);
                        }

                        function updateStatusBadge(status) {
                            const badge = document.getElementById('campaignStatus');
                            let className = 'status-draft';
                            let text = 'Brouillon';

                            switch (status) {
                                case 'DRAFT':
                                    className = 'status-draft';
                                    text = 'Brouillon';
                                    break;
                                case 'PENDING_VALIDATION':
                                case 'EN_VALIDATION':
                                    className = 'status-pending';
                                    text = 'En validation';
                                    break;
                                case 'VALIDATED':
                                case 'VALIDE':
                                    className = 'status-validated';
                                    text = 'Valid√©e';
                                    break;
                                case 'REJECTED':
                                case 'REJETE':
                                    className = 'status-rejected';
                                    text = 'Rejet√©e';
                                    break;
                            }

                            badge.className = `status-badge ${className}`;
                            badge.textContent = text;
                        }

                        async function loadCampaignData() {
                            try {
                                const urlParams = new URLSearchParams(window.location.search);
                                currentCampaignId = urlParams.get('id');

                                if (!currentCampaignId) {
                                    showAlert('ID de campagne manquant', 'danger');
                                    return;
                                }

                                console.log('üîç Chargement de la campagne:', currentCampaignId);

                                const response = await fetch(`${API}/campaigns/${currentCampaignId}`, {
                                    headers: getAuthHeader()
                                });

                                const result = await response.json();

                                if (result.success) {
                                    const campaign = result.data;
                                    console.log('üìã Campagne charg√©e:', campaign);

                                    // Mettre √† jour les informations de base
                                    document.getElementById('campaignName').textContent = campaign.name;
                                    document.getElementById('campaignDescription').innerHTML = `
                        <i class="fas fa-clock me-2"></i>Cr√©√©e le ${new Date(campaign.created_at).toLocaleDateString('fr-FR')}
                    `;

                                    // Statut
                                    updateStatusBadge(campaign.validation_statut || campaign.status);

                                    // Informations g√©n√©rales
                                    document.getElementById('campaignChannelDetail').textContent = campaign.channel || 'Non d√©fini';
                                    document.getElementById('campaignPriority').textContent = campaign.priority || 'Normale';
                                    document.getElementById('campaignTemplate').textContent = campaign.template_name || 'Non d√©fini';
                                    document.getElementById('campaignBU').textContent = campaign.business_unit_name || 'Non d√©fini';
                                    document.getElementById('campaignDivision').textContent = campaign.division_name || 'Non d√©fini';
                                    document.getElementById('campaignResponsible').textContent = campaign.responsible_name || 'Non d√©fini';

                                    // Planning
                                    document.getElementById('campaignScheduledDate').textContent = campaign.scheduled_date ? new Date(campaign.scheduled_date).toLocaleDateString('fr-FR') : 'Non d√©finie';
                                    document.getElementById('campaignSubmissionDate').textContent = campaign.date_soumission ? new Date(campaign.date_soumission).toLocaleDateString('fr-FR') : 'Non soumise';
                                    document.getElementById('campaignValidationDate').textContent = campaign.date_validation ? new Date(campaign.date_validation).toLocaleDateString('fr-FR') : 'Non valid√©e';
                                    document.getElementById('campaignCreator').textContent = campaign.creator_name || 'Syst√®me';

                                    // Charger les entreprises
                                    await loadCompanies();

                                    // Charger les validateurs si la campagne est en validation ou valid√©e
                                    if (['EN_VALIDATION', 'VALIDE', 'VALIDATED'].includes(campaign.validation_statut || campaign.status)) {
                                        await loadValidators();
                                    }

                                    // G√©rer les boutons selon le statut
                                    updateActionButtons(campaign.validation_statut || campaign.status);

                                } else {
                                    showAlert('Erreur lors du chargement de la campagne: ' + result.error, 'danger');
                                }
                            } catch (error) {
                                console.error('Erreur chargement campagne:', error);
                                showAlert('Erreur lors du chargement de la campagne', 'danger');
                            }
                        }

                        async function loadCompanies() {
                            try {
                                console.log('üîç Chargement des entreprises de la campagne');

                                const response = await fetch(`${API}/campaigns/${currentCampaignId}/companies?limit=1000`, {
                                    headers: getAuthHeader()
                                });

                                const result = await response.json();

                                if (result.success) {
                                    const companies = result.data || [];
                                    console.log('üìä Entreprises charg√©es:', companies.length);

                                    renderCompanies(companies);
                                    updateStats(companies);
                                } else {
                                    showAlert('Erreur lors du chargement des entreprises: ' + result.error, 'danger');
                                }
                            } catch (error) {
                                console.error('Erreur chargement entreprises:', error);
                                showAlert('Erreur lors du chargement des entreprises', 'danger');
                            }
                        }

                        function renderCompanies(companies) {
                            const container = document.getElementById('companiesList');

                            if (companies.length === 0) {
                                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-building fa-2x text-muted"></i>
                        <p class="text-muted mt-2">Aucune entreprise trouv√©e dans cette campagne</p>
                    </div>
                `;
                                return;
                            }

                            let html = '';
                            companies.forEach(company => {
                                const validationStatus = company.validation_status || 'PENDING';
                                const isRejected = validationStatus === 'REJECTED';
                                const isApproved = validationStatus === 'APPROVED';
                                const isPending = validationStatus === 'PENDING';

                                let statusClass = '';
                                let statusIcon = '';
                                let statusText = '';

                                if (isRejected) {
                                    statusClass = 'rejected';
                                    statusIcon = 'fa-times-circle text-danger';
                                    statusText = 'Rejet√©e';
                                } else if (isApproved) {
                                    statusClass = 'approved';
                                    statusIcon = 'fa-check-circle text-success';
                                    statusText = 'Approuv√©e';
                                } else {

                                    // V√©rifier le statut de la campagne (via le DOM car campaign n'est pas pass√©)
                                    const campaignStatusEl = document.getElementById('campaignStatus');
                                    const campaignStatusText = campaignStatusEl ? campaignStatusEl.textContent.trim().toUpperCase() : '';

                                    if (campaignStatusText === 'BROUILLON' || campaignStatusText === 'DRAFT') {
                                        statusClass = '';
                                        statusIcon = 'fa-file-alt text-secondary';
                                        statusText = 'Brouillon';
                                    } else {
                                        statusClass = 'pending';
                                        statusIcon = 'fa-clock text-warning';
                                        statusText = 'En attente';
                                    }
                                }

                                html += `
                    <div class="company-item ${statusClass}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="company-name">${company.name}</div>
                                <div class="company-details">
                                    <i class="fas fa-industry me-1"></i>${company.industry || 'Secteur non d√©fini'}
                                    ${company.city ? `<i class="fas fa-map-marker-alt ms-2 me-1"></i>${company.city}` : ''}
                                    ${company.email ? `<i class="fas fa-envelope ms-2 me-1"></i>${company.email}` : ''}
                                </div>
                            </div>
                            <div class="d-flex align-items-center gap-3">
                                <div class="text-end">
                                    <div class="small fw-bold mb-0">
                                        <i class="fas ${statusIcon} me-1"></i>${statusText}
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-outline-primary" onclick="openEditCompanyModal('${company.id}')" title="Modifier l'entreprise">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                            });

                            container.innerHTML = html;
                        }

                        function updateStats(companies) {
                            const total = companies.length;
                            const approved = companies.filter(c => c.validation_status === 'APPROVED').length;
                            const rejected = companies.filter(c => c.validation_status === 'REJECTED').length;

                            document.getElementById('totalCompanies').textContent = total;
                            document.getElementById('approvedCompanies').textContent = approved;
                            document.getElementById('rejectedCompanies').textContent = rejected;
                            document.getElementById('totalSources').textContent = companies.filter(c => c.source_id).length;
                        }

                        async function loadValidators() {
                            try {
                                const response = await fetch(`${API}/campaigns/${currentCampaignId}/validators`, {
                                    headers: getAuthHeader()
                                });

                                const result = await response.json();

                                if (result.success) {
                                    renderValidatorsList(result.data);
                                    document.getElementById('validatorsSection').style.display = 'block';
                                }
                            } catch (error) {
                                console.error('Erreur chargement validateurs:', error);
                            }
                        }

                        function renderValidatorsList(validators) {
                            const container = document.getElementById('validatorsList');

                            if (validators.length === 0) {
                                container.innerHTML = '<p class="text-muted">Aucun validateur assign√©</p>';
                                return;
                            }

                            let html = '';
                            validators.forEach(validator => {
                                html += `
                    <div class="validator-item">
                        <div class="validator-avatar">
                            ${getInitials(`${validator.prenom} ${validator.nom}`)}
                        </div>
                        <div class="flex-grow-1">
                            <h6>${validator.prenom} ${validator.nom}</h6>
                            <div class="d-flex align-items-center gap-2">
                                <span class="validator-role">${validator.role}</span>
                                <small class="text-muted">${validator.type}</small>
                            </div>
                        </div>
                    </div>
                `;
                            });

                            container.innerHTML = html;
                        }

                        function updateActionButtons(status) {
                            const submitBtn = document.getElementById('submitCampaignBtn');
                            const executionBtn = document.getElementById('executionBtn');

                            const editBtn = document.getElementById('editCampaignBtn');

                            // Bouton de soumission
                            if (status === 'DRAFT' || status === 'BROUILLON' || status === 'REJECTED' || status === 'REJETE') {
                                submitBtn.style.display = 'inline-block';
                            } else {
                                submitBtn.style.display = 'none';
                            }

                            // Bouton d'√©dition : visible seulement en brouillon ou rejet√©
                            if (status === 'DRAFT' || status === 'BROUILLON' || status === 'REJECTED' || status === 'REJETE') {
                                if (editBtn) editBtn.style.display = 'inline-block';
                            } else {
                                if (editBtn) editBtn.style.display = 'none';
                            }

                            // Bouton d'ex√©cution
                            if (status === 'VALIDATED' || status === 'VALIDE') {
                                executionBtn.style.display = 'inline-block';
                                executionBtn.href = `campaign-execution.html?id=${currentCampaignId}`;
                            } else {
                                executionBtn.style.display = 'none';
                            }
                        }

                        async function submitForValidation() {
                            try {
                                const submitBtn = document.getElementById('submitCampaignBtn');
                                submitBtn.disabled = true;
                                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></i>Soumission...';

                                const response = await fetch(`${API}/campaigns/${currentCampaignId}/submit`, {
                                    method: 'POST',
                                    headers: getAuthHeader()
                                });

                                const result = await response.json();

                                if (result.success) {
                                    showAlert('Campagne soumise avec succ√®s pour validation !', 'success');

                                    setTimeout(async () => {
                                        await loadCampaignData();
                                        await loadValidators();
                                    }, 1000);
                                } else {
                                    throw new Error(result.error || 'Erreur lors de la soumission');
                                }

                            } catch (error) {
                                console.error('Erreur soumission:', error);
                                showAlert('Erreur lors de la soumission : ' + error.message, 'danger');
                            } finally {
                                const submitBtn = document.getElementById('submitCampaignBtn');
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Soumettre pour validation';
                            }
                        }

                        function exportCampaignData() {
                            try {
                                const campaignData = {
                                    nom: document.getElementById('campaignName').textContent,
                                    statut: document.getElementById('campaignStatus').textContent,
                                    entreprises: document.getElementById('totalCompanies').textContent,
                                    approuvees: document.getElementById('approvedCompanies').textContent,
                                    rejetees: document.getElementById('rejectedCompanies').textContent,
                                    dateExport: new Date().toLocaleString('fr-FR')
                                };

                                const dataStr = JSON.stringify(campaignData, null, 2);
                                const dataBlob = new Blob([dataStr], { type: 'application/json' });

                                const link = document.createElement('a');
                                link.href = URL.createObjectURL(dataBlob);
                                link.download = `campagne_${campaignData.nom.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.json`;
                                link.click();

                                showAlert('Donn√©es de la campagne export√©es avec succ√®s !', 'success');
                            } catch (error) {
                                console.error('Erreur export:', error);
                                showAlert('Erreur lors de l\'export des donn√©es', 'danger');
                            }
                        }

                        function editCurrentCampaign() {
                            if (currentCampaignId) {
                                window.location.href = `prospecting-campaigns.html?edit=${currentCampaignId}`;
                            } else {
                                showAlert('Impossible de modifier la campagne : ID manquant', 'danger');
                            }
                        }

                        let editCompanyModal;

                        async function openEditCompanyModal(companyId) {
                            try {
                                // Initialiser le modal si pas encore fait
                                if (!editCompanyModal) {
                                    editCompanyModal = new bootstrap.Modal(document.getElementById('editCompanyModal'));
                                }

                                // Charger les d√©tails de l'entreprise
                                const response = await fetch(`${API}/companies/${companyId}`, {
                                    headers: getAuthHeader()
                                });

                                const result = await response.json();

                                if (result.success) {
                                    const company = result.data;

                                    // Remplir le formulaire
                                    document.getElementById('editCompanyId').value = company.id;

                                    // Champs g√©n√©raux
                                    document.getElementById('editName').value = company.name || '';
                                    document.getElementById('editIndustry').value = company.industry || '';
                                    document.getElementById('editEmail').value = company.email || '';
                                    document.getElementById('editPhone').value = company.phone || '';
                                    document.getElementById('editWebsite').value = company.website || '';
                                    document.getElementById('editCity').value = company.city || '';

                                    // Nouveaux champs contacts
                                    document.getElementById('editContactNom').value = company.contact_nom || '';
                                    document.getElementById('editContactEmail').value = company.contact_email || '';
                                    document.getElementById('editContactTel').value = company.contact_tel || '';

                                    document.getElementById('editAdminNom').value = company.admin_nom || '';
                                    document.getElementById('editAdminEmail').value = company.admin_email || '';
                                    document.getElementById('editAdminContact').value = company.admin_contact || '';

                                    // Ouvrir le modal
                                    editCompanyModal.show();
                                } else {
                                    showAlert('Erreur lors du chargement des d√©tails de l\'entreprise', 'danger');
                                }
                            } catch (error) {
                                console.error('Erreur chargement entreprise:', error);
                                showAlert('Erreur technique lors du chargement', 'danger');
                            }
                        }

                        async function saveCompanyDetails() {
                            try {
                                const id = document.getElementById('editCompanyId').value;
                                const name = document.getElementById('editName').value;

                                if (!name.trim()) {
                                    alert('Le nom de l\'entreprise est obligatoire');
                                    return;
                                }

                                const data = {
                                    name: name,
                                    industry: document.getElementById('editIndustry').value,
                                    email: document.getElementById('editEmail').value,
                                    phone: document.getElementById('editPhone').value,
                                    website: document.getElementById('editWebsite').value,
                                    city: document.getElementById('editCity').value,

                                    contact_nom: document.getElementById('editContactNom').value,
                                    contact_email: document.getElementById('editContactEmail').value,
                                    contact_tel: document.getElementById('editContactTel').value,

                                    admin_nom: document.getElementById('editAdminNom').value,
                                    admin_email: document.getElementById('editAdminEmail').value,
                                    admin_contact: document.getElementById('editAdminContact').value
                                };

                                const response = await fetch(`${API}/companies/${id}`, {
                                    method: 'PUT',
                                    headers: getAuthHeader(),
                                    body: JSON.stringify(data)
                                });

                                const result = await response.json();

                                if (result.success) {
                                    editCompanyModal.hide();
                                    showAlert('Entreprise mise √† jour avec succ√®s', 'success');
                                    // Recharger la liste
                                    loadCompanies();
                                } else {
                                    showAlert('Erreur lors de la mise √† jour: ' + result.error, 'danger');
                                }
                            } catch (error) {
                                console.error('Erreur sauvegarde:', error);
                                showAlert('Erreur lors de la sauvegarde', 'danger');
                            }
                        }

                        // Initialisation
                        document.addEventListener('DOMContentLoaded', () => {
                            loadCampaignData();
                        });
                    </script>

                    <!-- Bootstrap JS pour les modals (notifications, etc.) -->
                    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

                    <!-- Script pour la sidebar -->
                    <script src="js/sidebar.js" defer></script>
</body>

</html>