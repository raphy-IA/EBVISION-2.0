<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Utilisateurs</title>

    <!-- Pr√©connexion CDN pour acc√©l√©rer le chargement -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

    <!-- CSS Bootstrap et FontAwesome (FontAwesome en priorit√© pour les ic√¥nes) -->
    <link href="/vendor/fontawesome/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- CSS de la sidebar moderne -->
    <link rel="stylesheet" href="css/modern-sidebar.css">


    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #f8f9fa;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            overflow-x: hidden;
            /* Emp√™che le d√©filement horizontal */
        }

        /* Le conteneur principal de la page qui contient la sidebar et le contenu */
        .page-wrapper {
            display: flex;
            min-height: 100vh;
        }

        /* Styles pour le contenu principal */
        .main-content-area {
            flex-grow: 1;
            /* Prend l'espace restant */
            padding: 2rem;
            background-color: var(--light-bg);
        }

        /* Ajustements pour les petits √©crans */
        @media (max-width: 768px) {
            .page-wrapper {
                flex-direction: column;
                /* Empile la sidebar et le contenu */
            }

            .main-content-area {
                padding: 1rem;
            }
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .stat-card.success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .stat-card.warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .stat-card.info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
        }

        .table thead th {
            background-color: var(--primary-color);
            color: white;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* FIX: Emp√™cher les modals de bloquer les clics quand ils sont cach√©s */
        .modal {
            pointer-events: none !important;
        }

        .modal.show {
            pointer-events: auto !important;
        }

        .modal-dialog {
            pointer-events: auto !important;
        }

        .status-saisie {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        .status-soumise {
            background-color: #fff3e0;
            color: #f57c00;
        }

        .status-validee {
            background-color: #e8f5e8;
            color: #388e3c;
        }

        .status-rejetee {
            background-color: #ffebee;
            color: #d32f2f;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Ajustements pour les petits √©crans */
        @media (max-width: 768px) {
            .page-wrapper {
                flex-direction: column;
                /* Empile la sidebar et le contenu */
            }

            .main-content-area {
                padding: 1rem;
            }
        }

        .role-badge {
            font-size: 0.8rem;
            padding: 0.3rem 0.6rem;
        }

        /* Styles pour la sidebar unifi√©e */
        .main-content-wrapper {
            margin-left: 300px;
            transition: margin-left 0.3s ease;
            min-height: 100vh;
            padding: 0;
        }

        .main-content {
            padding: 2rem;
        }

        @media (max-width: 768px) {
            .main-content-wrapper {
                margin-left: 0;
            }

            .sidebar-container.open {
                transform: translateX(0);
            }

            .main-content {
                padding: 1rem;
            }
        }
    </style>
    <!-- Scripts pour la top bar EBVISION 2.0 -->
    <!-- Charg√©s par le template sidebar -->

    <!-- CSS des variables de branding dynamiques -->
    <link rel="stylesheet" href="/config/themes/brand-variables.css">

    <!-- Scripts de branding -->
    <script src="js/branding-loader.js"></script>
    <script src="js/sidebar-branding.js"></script>
</head>

<body>
    <!-- Bouton toggle sidebar mobile -->
    <button class="sidebar-toggle d-md-none">
        <i class="fas fa-bars"></i>
    </button>
    <div class="page-wrapper">
        <!-- Sidebar Container -->
        <div class="sidebar-container">
            <!-- La sidebar sera g√©n√©r√©e par JavaScript -->
        </div>

        <!-- Main Content Area -->
        <div class="main-content-area">
            <div id="users-section">
                <!-- Header -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <h2><i class="fas fa-user-shield me-2"></i>Gestion des Utilisateurs</h2>
                            <div class="btn-group">
                                <button class="btn btn-primary" onclick="showNewUserModal()">
                                    <i class="fas fa-plus me-2"></i>Nouvel Utilisateur
                                </button>
                                <button class="btn btn-warning btn-sm" onclick="debugClickIssues()" title="Debug Clics">
                                    <i class="fas fa-bug"></i>
                                </button>
                                <button class="btn btn-success btn-sm" onclick="forceEnableClicks()"
                                    title="Forcer Clics">
                                    <i class="fas fa-mouse-pointer"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Statistics Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="card-body text-center">
                                <i class="fas fa-users fa-2x mb-2"></i>
                                <h4 id="total-users">-</h4>
                                <p class="mb-0">Total Utilisateurs</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card success">
                            <div class="card-body text-center">
                                <i class="fas fa-user-check fa-2x mb-2"></i>
                                <h4 id="active-users">-</h4>
                                <p class="mb-0">Utilisateurs Actifs</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card warning">
                            <div class="card-body text-center">
                                <i class="fas fa-user-clock fa-2x mb-2"></i>
                                <h4 id="recent-users">-</h4>
                                <p class="mb-0">Nouveaux (30j)</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card info">
                            <div class="card-body text-center">
                                <i class="fas fa-user-shield fa-2x mb-2"></i>
                                <h4 id="admin-users">-</h4>
                                <p class="mb-0">Administrateurs</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Search and Filters -->
                <div class="row mb-4">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="search-input" class="form-label">Recherche</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                                            <input type="text" class="form-control" id="search-input"
                                                placeholder="Nom, pr√©nom, email, login...">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="role-filter" class="form-label">R√¥le</label>
                                        <select class="form-select" id="role-filter">
                                            <option value="">Tous les r√¥les</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label for="status-filter" class="form-label">Statut</label>
                                        <select class="form-select" id="status-filter">
                                            <option value="">Tous les statuts</option>
                                            <option value="ACTIF">Actif</option>
                                            <option value="INACTIF">Inactif</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label for="type-filter" class="form-label">Type</label>
                                        <select class="form-select" id="type-filter">
                                            <option value="">Tous les types</option>
                                            <option value="linked">Li√©s √† collaborateur</option>
                                            <option value="free">Libres</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label for="show-deleted" class="form-label">Affichage</label>
                                        <select class="form-select" id="show-deleted">
                                            <option value="active">Utilisateurs actifs</option>
                                            <option value="deleted">Utilisateurs supprim√©s</option>
                                            <option value="all">Tous les utilisateurs</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">Actions rapides</h6>
                                        <small class="text-muted">Filtres et actions</small>
                                    </div>
                                    <div>
                                        <button class="btn btn-outline-secondary btn-sm" onclick="clearFilters()">
                                            <i class="fas fa-times me-1"></i>Effacer
                                        </button>
                                        <button class="btn btn-outline-primary btn-sm" onclick="exportUsers()">
                                            <i class="fas fa-download me-1"></i>Exporter
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Users Table -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0"><i class="fas fa-list me-2"></i>Liste des Utilisateurs</h5>
                    </div>
                    <div class="card-body">
                        <div id="users-loading" class="loading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Chargement...</span>
                            </div>
                        </div>
                        <div id="users-content">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Login</th>
                                            <th>Nom</th>
                                            <th>Pr√©nom</th>
                                            <th>Email</th>
                                            <th>R√¥le</th>
                                            <th>Type</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="users-table">
                                        <!-- Users will be loaded here by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add User Modal -->
    <div class="modal fade" id="addUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plus me-2"></i>
                        Ajouter un Utilisateur
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addUserForm">
                        <div class="mb-3">
                            <label for="userLogin" class="form-label">Login (optionnel - g√©n√©r√© automatiquement si
                                vide)</label>
                            <input type="text" class="form-control" id="userLogin" maxlength="50"
                                placeholder="Ex: jdupont" autocomplete="off">
                        </div>
                        <div class="mb-3">
                            <label for="userPassword" class="form-label">Mot de passe *</label>
                            <input type="password" class="form-control" id="userPassword" required
                                autocomplete="new-password">
                            <div class="form-text">
                                Le mot de passe doit contenir au moins 8 caract√®res, une minuscule, une majuscule, un
                                chiffre et un caract√®re sp√©cial.
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="addUserName" class="form-label">Nom *</label>
                            <input type="text" class="form-control" id="addUserName" required autocomplete="off">
                        </div>
                        <div class="mb-3">
                            <label for="userFirstName" class="form-label">Pr√©nom *</label>
                            <input type="text" class="form-control" id="userFirstName" required autocomplete="off">
                        </div>
                        <div class="mb-3">
                            <label for="userEmail" class="form-label">Email *</label>
                            <input type="email" class="form-control" id="userEmail" required autocomplete="off">
                        </div>
                        <div class="mb-3">
                            <label for="userRoles" class="form-label">R√¥les *</label>
                            <div id="userRolesContainer">
                                <div class="form-text mb-2">
                                    <i class="fas fa-info-circle text-info"></i>
                                    S√©lectionnez un ou plusieurs r√¥les pour cet utilisateur
                                </div>
                                <div id="userRolesCheckboxes" class="row">
                                    <!-- Les r√¥les seront charg√©s dynamiquement -->
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="addUser()">
                        <i class="fas fa-save me-1"></i>
                        Enregistrer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-edit me-2"></i>
                        Modifier l'Utilisateur
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId">
                        <div class="mb-3">
                            <label for="editUserLogin" class="form-label">Login</label>
                            <input type="text" class="form-control" id="editUserLogin" maxlength="50"
                                placeholder="Ex: jdupont ou jdupont2">
                            <div class="form-text">
                                <i class="fas fa-info-circle text-info"></i>
                                Le login doit √™tre unique. S'il existe d√©j√†, un num√©ro sera ajout√© automatiquement.
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editUserPassword" class="form-label">Nouveau Mot de passe (laisser vide pour ne
                                pas changer)</label>
                            <input type="password" class="form-control" id="editUserPassword"
                                placeholder="Ex: MonMotDePasse123!">
                            <div class="form-text">
                                <i class="fas fa-info-circle text-info"></i>
                                <strong>R√®gles de s√©curit√© :</strong>
                                <ul class="mt-1 mb-0">
                                    <li>Au moins 8 caract√®res</li>
                                    <li>Au moins une minuscule (a-z)</li>
                                    <li>Au moins une majuscule (A-Z)</li>
                                    <li>Au moins un chiffre (0-9)</li>
                                    <li>Au moins un caract√®re sp√©cial (@$!%*?&)</li>
                                </ul>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editUserName" class="form-label">Nom *</label>
                            <input type="text" class="form-control" id="editUserName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editUserFirstName" class="form-label">Pr√©nom *</label>
                            <input type="text" class="form-control" id="editUserFirstName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editUserEmail" class="form-label">Email *</label>
                            <input type="email" class="form-control" id="editUserEmail" required>
                        </div>
                        <!-- Section R√¥les Multiples -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-user-shield me-2"></i>R√¥les *
                                <small class="text-muted">(au moins un requis)</small>
                            </label>
                            <div class="card" style="border: 1px solid #dee2e6;">
                                <div class="card-body p-2"
                                    style="max-height: 280px; overflow-y: auto; background-color: #f8f9fa;">
                                    <div id="editUserRolesContainer" class="row g-1">
                                        <!-- Les checkboxes des r√¥les seront charg√©es ici -->
                                        <div class="col-12 text-center py-3">
                                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                <span class="visually-hidden">Chargement...</span>
                                            </div>
                                            <span class="ms-2 text-muted"
                                                style="font-size: 0.85rem;">Chargement...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-text" style="font-size: 0.8rem;">
                                <i class="fas fa-info-circle me-1"></i>
                                S√©lectionnez un ou plusieurs r√¥les
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="updateUser()">
                        <i class="fas fa-save me-1"></i>
                        Mettre √† jour
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle me-2 text-warning"></i>
                        Confirmer la suppression
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>√ätes-vous s√ªr de vouloir supprimer cet utilisateur ?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                        <i class="fas fa-trash me-1"></i>
                        Supprimer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Deactivate Confirmation Modal -->
    <div class="modal fade" id="deactivateConfirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-pause me-2 text-warning"></i>
                        Confirmer la d√©sactivation
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>√ätes-vous s√ªr de vouloir d√©sactiver cet utilisateur ?</p>
                    <p class="text-muted">L'utilisateur ne pourra plus se connecter mais ses donn√©es seront conserv√©es.
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-warning" onclick="confirmDeactivate()">
                        <i class="fas fa-pause me-1"></i>
                        D√©sactiver
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Collaborateur Modal -->
    <div class="modal fade" id="viewCollaborateurModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-tie me-2 text-info"></i>
                        Informations du Collaborateur
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Nom</label>
                                <p id="collaborateur-nom" class="form-control-plaintext"></p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Pr√©nom</label>
                                <p id="collaborateur-prenom" class="form-control-plaintext"></p>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Email</label>
                                <p id="collaborateur-email" class="form-control-plaintext"></p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">T√©l√©phone</label>
                                <p id="collaborateur-telephone" class="form-control-plaintext"></p>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Business Unit</label>
                                <p id="collaborateur-business-unit" class="form-control-plaintext"></p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Division</label>
                                <p id="collaborateur-division" class="form-control-plaintext"></p>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Poste</label>
                                <p id="collaborateur-poste" class="form-control-plaintext"></p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Grade</label>
                                <p id="collaborateur-grade" class="form-control-plaintext"></p>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Statut</label>
                                <p id="collaborateur-statut" class="form-control-plaintext"></p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Date d'embauche</label>
                                <p id="collaborateur-date-embauche" class="form-control-plaintext"></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                    <button type="button" class="btn btn-primary" onclick="window.location.href='/collaborateurs.html'">
                        <i class="fas fa-users me-1"></i>
                        Voir tous les collaborateurs
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="/js/auth.js" defer></script>
    <script src="/js/page-permissions.js" defer></script>
    <script src="/js/sidebar.js" defer></script>

    <!-- Scripts de zone utilisateur -->
    <script src="js/user-header.js"></script>
    <script src="js/menu-permissions.js"></script>
    <script src="js/profile-menu.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/tasks.js"></script>
    <!-- SessionManager pour la gestion centralis√©e des sessions -->
    <script src="js/session-manager.js"></script>
    <!-- <script src="js/user-modals.js"></script> -->
    <script>
        const API_BASE_URL = '/api';
        // Fonction utilitaire pour les appels API authentifi√©s
        async function authenticatedFetch(url, options = {}) {
            const token = localStorage.getItem('authToken');
            const defaultHeaders = {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };

            return fetch(url, {
                ...options,
                headers: {
                    ...defaultHeaders,
                    ...options.headers
                }
            });
        }

        let userToDelete = null;
        let userToDeactivate = null;

        // Helper: R√©cup√©rer les r√¥les de l'utilisateur connect√©
        async function getCurrentUserRoles() {
            try {
                // R√©cup√©rer depuis SessionManager si disponible
                if (typeof SessionManager !== 'undefined' && SessionManager.getUserData) {
                    const userData = SessionManager.getUserData();
                    return userData?.roles || [];
                }

                // Sinon, appeler l'API
                const response = await authenticatedFetch(`${API_BASE_URL}/auth/me`);
                const data = await response.json();
                return data?.data?.roles || data?.roles || [];
            } catch (error) {
                console.error('Erreur r√©cup√©ration r√¥les utilisateur:', error);
                return [];
            }
        }

        // Helper: V√©rifier si l'utilisateur est SUPER_ADMIN
        async function isCurrentUserSuperAdmin() {
            const roles = await getCurrentUserRoles();
            return roles.some(r => r.name === 'SUPER_ADMIN' || r === 'SUPER_ADMIN');
        }

        document.addEventListener('DOMContentLoaded', function () {
            console.log('üöÄ DOM charg√©, appel de loadRoles()...');
            loadRoles();
            loadUsers();
            loadStatistics();
            setupEventListeners();

            // Debug: V√©rifier les probl√®mes de clics
            debugClickIssues();
        });

        // Variables globales pour les filtres
        let allUsers = [];
        let filteredUsers = [];

        function setupEventListeners() {
            // Recherche en temps r√©el
            document.getElementById('search-input').addEventListener('input', filterUsers);
            document.getElementById('role-filter').addEventListener('change', filterUsers);
            document.getElementById('status-filter').addEventListener('change', loadUsers);
            document.getElementById('type-filter').addEventListener('change', filterUsers);
            document.getElementById('show-deleted').addEventListener('change', loadUsers);
        }

        async function loadRoles() {
            try {
                console.log('üîÑ Chargement des r√¥les...');
                const token = localStorage.getItem('authToken');
                console.log('üîë Token pr√©sent:', !!token);

                const response = await authenticatedFetch(`${API_BASE_URL}/users/roles`, {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                console.log('üì° R√©ponse API:', response.status, response.statusText);

                const responseData = await response.json();
                console.log('üìã R√©ponse API r√¥les:', responseData);

                // G√©rer le format de r√©ponse
                let roles;
                if (Array.isArray(responseData)) {
                    roles = responseData;
                } else if (responseData.success && responseData.data) {
                    roles = responseData.data;
                } else {
                    throw new Error('Format de r√©ponse inattendu');
                }

                console.log('üìã R√¥les extraits:', roles);

                // Mettre √† jour le filtre de r√¥les
                const roleFilter = document.getElementById('role-filter');
                roleFilter.innerHTML = '<option value="">Tous les r√¥les</option>';
                roles.forEach(role => {
                    const displayText = role.description ? `${role.name} - ${role.description}` : role.name;
                    roleFilter.innerHTML += `<option value="${role.name}">${displayText}</option>`;
                });

                // Note: Les r√¥les dans le modal d'ajout sont maintenant charg√©s dynamiquement
                // via loadRolesForModal() avec des checkboxes multiples
                // Les r√¥les dans le modal de modification sont charg√©s dynamiquement
                // via loadUserRolesForEdit() avec des checkboxes multiples

                console.log(`‚úÖ ${roles.length} r√¥les charg√©s avec succ√®s`);

            } catch (error) {
                console.error('‚ùå Erreur lors du chargement des r√¥les:', error);
                showAlert('Erreur lors du chargement des r√¥les. Veuillez recharger la page.', 'danger');
            }
        }

        function updateRoleSelectors(roles) {
            // Mettre √† jour le filtre de r√¥les
            const roleFilter = document.getElementById('role-filter');
            roleFilter.innerHTML = '<option value="">Tous les r√¥les</option>';
            roles.forEach(role => {
                const displayText = role.description ? `${role.name} - ${role.description}` : role.name;
                roleFilter.innerHTML += `<option value="${role.name}">${displayText}</option>`;
            });

            // Note: Le modal d'ajout utilise maintenant des checkboxes multiples
            // charg√©es dynamiquement via loadRolesForModal()

            // Mettre √† jour le s√©lecteur de r√¥le dans le modal de modification
            const editUserRole = document.getElementById('editUserRole');
            editUserRole.innerHTML = '<option value="">S√©lectionner un r√¥le</option>';
            roles.forEach(role => {
                const displayText = role.description ? `${role.name} - ${role.description}` : role.name;
                editUserRole.innerHTML += `<option value="${role.name}">${displayText}</option>`;
            });
        }

        async function loadStatistics() {
            try {
                const token = localStorage.getItem('authToken');
                const response = await authenticatedFetch(`${API_BASE_URL}/users/statistics`);
                const data = await response.json();

                if (data.success) {
                    updateStatistics(data.data);
                }
            } catch (error) {
                console.error('Erreur lors du chargement des statistiques:', error);
            }
        }

        function updateStatistics(stats) {
            document.getElementById('total-users').textContent = stats.total || 0;
            document.getElementById('active-users').textContent = stats.active || 0;
            document.getElementById('recent-users').textContent = stats.recent || 0;
            document.getElementById('admin-users').textContent = stats.admins || 0;
        }

        function filterUsers() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const roleFilter = document.getElementById('role-filter').value;
            const typeFilter = document.getElementById('type-filter').value;

            filteredUsers = allUsers.filter(user => {
                const isLinked = user.collaborateur_id || user.linked_to_collaborateur;

                const matchesSearch = !searchTerm ||
                    user.nom.toLowerCase().includes(searchTerm) ||
                    user.prenom.toLowerCase().includes(searchTerm) ||
                    user.email.toLowerCase().includes(searchTerm) ||
                    (user.login && user.login.toLowerCase().includes(searchTerm));

                const matchesRole = !roleFilter || (user.roles && user.roles.includes(roleFilter));
                const matchesType = !typeFilter ||
                    (typeFilter === 'linked' && isLinked) ||
                    (typeFilter === 'free' && !isLinked);

                return matchesSearch && matchesRole && matchesType;
            });

            displayUsers(filteredUsers);
            updateFilteredCount();
        }

        function updateFilteredCount() {
            const totalCount = allUsers.length;
            const filteredCount = filteredUsers.length;

            // Mettre √† jour le titre du tableau
            const tableTitle = document.querySelector('.card-title');
            if (tableTitle) {
                tableTitle.innerHTML = `<i class="fas fa-list me-2"></i>Liste des Utilisateurs (${filteredCount}/${totalCount})`;
            }
        }

        function clearFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('role-filter').value = '';
            document.getElementById('status-filter').value = '';
            document.getElementById('type-filter').value = '';
            document.getElementById('show-deleted').value = 'active';
            loadUsers(); // Recharger les donn√©es au lieu de filtrer
        }

        function exportUsers() {
            const csvContent = generateCSV(filteredUsers);
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `utilisateurs_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function generateCSV(users) {
            const headers = ['Login', 'Nom', 'Pr√©nom', 'Email', 'R√¥le', 'Statut', 'Derni√®re connexion'];
            const rows = users.map(user => [
                user.login || '',
                user.nom || '',
                user.prenom || '',
                user.email || '',
                user.role || '',
                user.statut || '',
                user.last_login || ''
            ]);

            return [headers, ...rows].map(row =>
                row.map(field => `"${field}"`).join(',')
            ).join('\n');
        }

        async function loadUsers() {
            showLoading(true);
            try {
                const token = localStorage.getItem('authToken');
                const statusFilter = document.getElementById('status-filter').value;
                const showDeleted = document.getElementById('show-deleted').value;

                let url = `${API_BASE_URL}/users?limit=100`;

                // Priorit√© au filtre status-filter, sinon utiliser show-deleted
                if (statusFilter) {
                    url += `&status=${statusFilter}`;
                } else if (showDeleted === 'deleted') {
                    url += '&status=INACTIF';
                } else if (showDeleted === 'active') {
                    url += '&status=ACTIF';
                }

                const response = await authenticatedFetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                if (data.success) {
                    allUsers = data.data;
                    filteredUsers = [...allUsers];
                    displayUsers(filteredUsers);
                    updateFilteredCount();
                    console.log(`üìä ${data.data.length} utilisateurs charg√©s sur ${data.pagination.total} total`);
                } else {
                    showAlert('Erreur lors du chargement des utilisateurs', 'danger');
                }
            } catch (error) {
                console.error('Erreur fetch:', error);
                showAlert('Erreur de connexion', 'danger');
            } finally {
                showLoading(false);
            }
        }

        function displayUsers(users) {
            const tbody = document.getElementById('users-table');
            tbody.innerHTML = '';
            if (users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            <i class="fas fa-user-shield fa-2x mb-3"></i>
                            <p>Aucun utilisateur trouv√©</p>
                        </td>
                    </tr>
                `;
                return;
            }

            users.forEach(user => {
                const isLinked = user.collaborateur_id || user.linked_to_collaborateur;
                const isDeleted = user.statut === 'INACTIF';
                const row = document.createElement('tr');

                if (isLinked) row.className = 'table-info';
                if (isDeleted) row.className = 'table-danger';

                row.innerHTML = `
                    <td>
                        <code>${user.login || '-'}</code>
                        ${isLinked ? '<br><small class="text-muted">üîó Li√© √† collaborateur</small>' : ''}
                        ${isDeleted ? '<br><small class="text-danger">üóëÔ∏è Supprim√©</small>' : ''}
                    </td>
                    <td>
                        ${user.nom}
                        ${isLinked ? '<br><small class="text-muted">(via collaborateur)</small>' : ''}
                    </td>
                    <td>
                        ${user.prenom}
                        ${isLinked ? '<br><small class="text-muted">(via collaborateur)</small>' : ''}
                    </td>
                    <td>
                        ${user.email}
                        ${isLinked ? '<br><small class="text-muted">(via collaborateur)</small>' : ''}
                    </td>
                    <td>
                        ${user.roles_details && user.roles_details.length > 0
                        ? user.roles_details.map(role => {
                            const bgColor = role.badge_hex_color || '#6c757d';
                            const textColor = role.badge_text_class || '#ffffff';
                            return `<span class="badge me-1" style="background-color: ${bgColor}; color: ${textColor};">${role.name}</span>`;
                        }).join('')
                        : '<span class="badge bg-secondary">Aucun r√¥le</span>'
                    }
                    </td>
                    <td>
                        <span class="badge ${isLinked ? 'bg-info' : 'bg-secondary'}">
                            ${isLinked ? 'Li√©' : 'Libre'}
                        </span>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            ${!isDeleted ? `
                                ${isLinked ? `
                                    <button class="btn btn-outline-success" onclick="manageUserAccount('${user.collaborateur_id}', '${user.id}')" title="G√©rer le compte">
                                        <i class="fas fa-user-shield"></i>
                                    </button>
                                ` : `
                                    <button class="btn btn-outline-warning" onclick="editUser('${user.id}', ${isLinked})" title="Modifier">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                `}
                                <button class="btn btn-outline-secondary" onclick="deactivateUser('${user.id}')" title="D√©sactiver">
                                    <i class="fas fa-pause"></i>
                                </button>
                                ${isLinked ? `
                                    <button class="btn btn-outline-info" onclick="viewCollaborateur('${user.collaborateur_id}')" title="Voir le collaborateur">
                                        <i class="fas fa-user-tie"></i>
                                    </button>
                                ` : ''}
                                ${!isLinked ? `
                                    <button class="btn btn-outline-danger" onclick="deleteUser('${user.id}')" title="Supprimer d√©finitivement">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                ` : ''}
                            ` : `
                                <button class="btn btn-outline-success" onclick="restoreUser('${user.id}')" title="Activer">
                                    <i class="fas fa-play"></i>
                                </button>
                            `}
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function showNewUserModal() {
            console.log('üîÑ Ouverture du modal "Ajouter un Utilisateur"...');

            // R√©initialiser le formulaire AVANT de charger les r√¥les
            const form = document.getElementById('addUserForm');
            if (form) {
                form.reset();

                // Vider explicitement tous les champs pour √©viter l'autofill
                const loginField = document.getElementById('userLogin');
                const passwordField = document.getElementById('userPassword');
                const nameField = document.getElementById('addUserName');
                const firstNameField = document.getElementById('userFirstName');
                const emailField = document.getElementById('userEmail');

                if (loginField) loginField.value = '';
                if (passwordField) passwordField.value = '';
                if (nameField) nameField.value = '';
                if (firstNameField) firstNameField.value = '';
                if (emailField) emailField.value = '';

                console.log('‚úÖ Formulaire r√©initialis√©');
            }

            // Charger les r√¥les
            await loadRolesForModal();

            // Ouvrir le modal
            const modal = new bootstrap.Modal(document.getElementById('addUserModal'));
            modal.show();

            console.log('‚úÖ Modal "Ajouter un Utilisateur" ouvert');
        }

        async function loadRolesForModal() {
            try {
                console.log('üîÑ Chargement des r√¥les pour le modal...');
                const token = localStorage.getItem('authToken');
                console.log('üîë Token pr√©sent:', !!token);

                // Utiliser le m√™me endpoint que loadRoles() qui fonctionne
                const response = await authenticatedFetch(`${API_BASE_URL}/users/roles`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });

                console.log('üì° R√©ponse API r√¥les modal:', response.status, response.statusText);

                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }

                const responseData = await response.json();
                console.log('üìã R√©ponse API compl√®te:', responseData);

                // G√©rer les deux formats de r√©ponse possibles
                let roles;
                if (Array.isArray(responseData)) {
                    // Format direct: [role1, role2, ...]
                    roles = responseData;
                } else if (responseData.success && responseData.data) {
                    // Format avec success: {success: true, data: [...]}
                    roles = responseData.data;
                } else {
                    throw new Error('Format de r√©ponse inattendu');
                }

                console.log('üìã R√¥les extraits pour modal:', roles);

                // üîí PROTECTION SUPER_ADMIN: Filtrer si l'utilisateur n'est pas SUPER_ADMIN
                const isSuperAdmin = await isCurrentUserSuperAdmin();
                if (!isSuperAdmin) {
                    roles = roles.filter(r => r.name !== 'SUPER_ADMIN');
                    console.log('üîí SUPER_ADMIN filtr√© - non visible pour cet utilisateur');
                }

                const rolesContainer = document.getElementById('userRolesCheckboxes');
                if (!rolesContainer) {
                    console.error('‚ùå Container userRolesCheckboxes non trouv√©');
                    return;
                }

                rolesContainer.innerHTML = '';

                if (roles && roles.length > 0) {
                    roles.forEach(role => {
                        const colDiv = document.createElement('div');
                        colDiv.className = 'col-md-6 mb-2';

                        colDiv.innerHTML = `
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="${role.id}" id="role_${role.id}">
                                <label class="form-check-label" for="role_${role.id}">
                                    <strong>${role.name}</strong>
                                    ${role.description ? `<br><small class="text-muted">${role.description}</small>` : ''}
                                </label>
                            </div>
                        `;

                        rolesContainer.appendChild(colDiv);
                    });
                    console.log(`‚úÖ ${roles.length} r√¥les charg√©s dans le modal`);
                } else {
                    console.warn('‚ö†Ô∏è Aucun r√¥le trouv√©');
                    rolesContainer.innerHTML = '<div class="col-12"><p class="text-muted">Aucun r√¥le disponible</p></div>';
                }

            } catch (error) {
                console.error('‚ùå Erreur lors du chargement des r√¥les pour le modal:', error);
                const rolesContainer = document.getElementById('userRolesCheckboxes');
                if (rolesContainer) {
                    rolesContainer.innerHTML = '<div class="col-12"><p class="text-danger">Erreur lors du chargement des r√¥les</p></div>';
                }
                showAlert('Erreur lors du chargement des r√¥les', 'danger');
            }
        }

        async function addUser() {
            const form = document.getElementById('addUserForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // R√©cup√©rer les r√¥les s√©lectionn√©s (UUIDs)
            const selectedRoles = [];
            const roleCheckboxes = document.querySelectorAll('#userRolesCheckboxes input[type="checkbox"]:checked');
            roleCheckboxes.forEach(checkbox => {
                selectedRoles.push(checkbox.value); // Les IDs de r√¥les sont des UUIDs, pas des entiers
            });

            if (selectedRoles.length === 0) {
                showAlert('Veuillez s√©lectionner au moins un r√¥le', 'warning');
                return;
            }

            const formData = {
                nom: document.getElementById('addUserName').value,
                prenom: document.getElementById('userFirstName').value,
                email: document.getElementById('userEmail').value,
                password: document.getElementById('userPassword').value,
                login: document.getElementById('userLogin').value || null,
                roles: selectedRoles // Envoyer les r√¥les multiples
            };

            try {
                console.log('üì§ Envoi des donn√©es utilisateur:', formData);
                const token = localStorage.getItem('authToken');
                const response = await authenticatedFetch(`${API_BASE_URL}/users`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                const data = await response.json();
                console.log('üì• R√©ponse du serveur:', data);

                if (data.success) {
                    showAlert('Utilisateur ajout√© avec succ√®s', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
                    loadUsers();
                } else {
                    // Afficher les erreurs d√©taill√©es si disponibles
                    let errorMessage = data.message || data.error || 'Erreur inconnue';
                    if (data.errors && Array.isArray(data.errors)) {
                        errorMessage += '\n' + data.errors.join('\n');
                    }
                    console.error('‚ùå Erreur de validation:', data);
                    showAlert(`Erreur lors de l'ajout: ${errorMessage}`, 'danger');
                }
            } catch (error) {
                console.error('‚ùå Erreur lors de l\'ajout:', error);
                showAlert('Erreur lors de l\'ajout: ' + error.message, 'danger');
            }
        }

        async function editUser(id, isLinked = false) {
            try {
                const token = localStorage.getItem('authToken');
                const response = await authenticatedFetch(`${API_BASE_URL}/users/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                if (data.success) {
                    const user = data.data;
                    document.getElementById('editUserId').value = user.id;
                    document.getElementById('editUserFirstName').value = user.prenom;
                    document.getElementById('editUserName').value = user.nom;
                    document.getElementById('editUserEmail').value = user.email;
                    document.getElementById('editUserLogin').value = user.login || '';
                    // Toujours vider le champ mot de passe √† l'ouverture du modal
                    // pour √©viter toute modification involontaire (auto-fill navigateur, ancienne valeur, etc.)
                    const passwordField = document.getElementById('editUserPassword');
                    if (passwordField) {
                        passwordField.value = '';
                    }

                    // Charger les r√¥les de l'utilisateur
                    await loadUserRolesForEdit(user.id);

                    // G√©rer les champs selon le type d'utilisateur
                    const nameField = document.getElementById('editUserName');
                    const firstNameField = document.getElementById('editUserFirstName');
                    const emailField = document.getElementById('editUserEmail');

                    if (isLinked) {
                        // Utilisateur li√© : d√©sactiver nom, pr√©nom, email
                        nameField.disabled = true;
                        firstNameField.disabled = true;
                        emailField.disabled = true;
                        nameField.classList.add('form-control-plaintext');
                        firstNameField.classList.add('form-control-plaintext');
                        emailField.classList.add('form-control-plaintext');

                        // Ajouter des messages d'aide
                        nameField.title = 'Ce champ est g√©r√© via le collaborateur associ√©. Cliquez sur "Voir le collaborateur" pour le modifier.';
                        firstNameField.title = 'Ce champ est g√©r√© via le collaborateur associ√©. Cliquez sur "Voir le collaborateur" pour le modifier.';
                        emailField.title = 'Ce champ est g√©r√© via le collaborateur associ√©. Cliquez sur "Voir le collaborateur" pour le modifier.';

                        // Ajouter une note explicative
                        const noteDiv = document.createElement('div');
                        noteDiv.className = 'alert alert-info mb-3';
                        noteDiv.innerHTML = `
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Compte li√© √† un collaborateur</strong><br>
                            <small class="text-muted">
                                Ce compte utilisateur est li√© √† un collaborateur. Seuls le login, le mot de passe et le r√¥le peuvent √™tre modifi√©s ici.<br>
                                Les informations de nom, pr√©nom et email sont synchronis√©es avec le collaborateur associ√©.
                            </small>
                        `;

                        // Ins√©rer la note au d√©but du formulaire
                        const form = document.getElementById('editUserForm');
                        form.insertBefore(noteDiv, form.firstChild);

                        // Mettre √† jour le titre du modal
                        document.querySelector('#editUserModal .modal-title').innerHTML =
                            '<i class="fas fa-user-shield me-2"></i>G√©rer le Compte Utilisateur (Li√© √† Collaborateur)';
                    } else {
                        // Utilisateur libre : activer tous les champs
                        nameField.disabled = false;
                        firstNameField.disabled = false;
                        emailField.disabled = false;
                        nameField.classList.remove('form-control-plaintext');
                        firstNameField.classList.remove('form-control-plaintext');
                        emailField.classList.remove('form-control-plaintext');

                        // Retirer les messages d'aide
                        nameField.title = '';
                        firstNameField.title = '';
                        emailField.title = '';

                        // Supprimer la note explicative si elle existe
                        const existingNote = document.querySelector('#editUserForm .alert-info');
                        if (existingNote) {
                            existingNote.remove();
                        }

                        // Mettre √† jour le titre du modal
                        document.querySelector('#editUserModal .modal-title').innerHTML =
                            '<i class="fas fa-edit me-2"></i>Modifier Utilisateur (Libre)';
                    }

                    new bootstrap.Modal(document.getElementById('editUserModal')).show();
                } else {
                    showAlert('Utilisateur non trouv√©', 'danger');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showAlert('Erreur de connexion', 'danger');
            }
        }

        async function updateUser() {
            const form = document.getElementById('editUserForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const id = document.getElementById('editUserId').value;
            const formData = {};

            // Ajouter login seulement s'il n'est pas vide
            const loginValue = document.getElementById('editUserLogin').value.trim();
            if (loginValue) {
                formData.login = loginValue;
            }

            // R√©cup√©rer les r√¥les s√©lectionn√©s
            const selectedRoles = getSelectedRoles();
            console.log('üìã R√¥les s√©lectionn√©s:', selectedRoles);

            // V√©rifier qu'au moins un r√¥le est s√©lectionn√©
            if (selectedRoles.length === 0) {
                showAlert('Veuillez s√©lectionner au moins un r√¥le', 'warning');
                return;
            }

            formData.roles = selectedRoles;

            // Ajouter nom, pr√©nom, email seulement si les champs ne sont pas d√©sactiv√©s et pas vides
            const nameField = document.getElementById('editUserName');
            const firstNameField = document.getElementById('editUserFirstName');
            const emailField = document.getElementById('editUserEmail');

            if (!nameField.disabled && nameField.value.trim()) {
                formData.nom = nameField.value.trim();
            }
            if (!firstNameField.disabled && firstNameField.value.trim()) {
                formData.prenom = firstNameField.value.trim();
            }
            if (!emailField.disabled && emailField.value.trim()) {
                formData.email = emailField.value.trim();
            }

            // Ajouter le nouveau mot de passe seulement s'il est fourni
            const newPassword = document.getElementById('editUserPassword').value.trim();
            if (newPassword) {
                formData.password = newPassword;
            }

            console.log('üì§ Donn√©es envoy√©es:', formData);

            try {
                const token = localStorage.getItem('authToken');
                const response = await authenticatedFetch(`${API_BASE_URL}/users/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                if (!response.ok) {
                    const data = await response.json();
                    let errorMessage = 'Erreur lors de la mise √† jour';

                    // Am√©liorer les messages d'erreur sp√©cifiques
                    if (data.errors && Array.isArray(data.errors)) {
                        errorMessage = 'Erreurs de validation :\n' + data.errors.map(err => `‚Ä¢ ${err}`).join('\n');
                    } else if (data.message && data.message.includes('mot de passe')) {
                        errorMessage = 'Le mot de passe ne respecte pas les r√®gles de s√©curit√©. V√©rifiez qu\'il contient au moins 8 caract√®res, une minuscule, une majuscule, un chiffre et un caract√®re sp√©cial (@$!%*?&).';
                    } else if (data.message && data.message.includes('email')) {
                        errorMessage = 'L\'email fourni est invalide ou existe d√©j√† dans le syst√®me.';
                    } else if (data.message) {
                        errorMessage = data.message;
                    }

                    showAlert(errorMessage, 'danger');
                    return;
                }

                const data = await response.json();
                if (data.success) {
                    showAlert('‚úÖ Utilisateur mis √† jour avec succ√®s ! Les modifications ont √©t√© appliqu√©es.', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
                    loadUsers();
                } else {
                    showAlert(data.message || 'Erreur inconnue', 'danger');
                }
            } catch (error) {
                console.error('Erreur lors de la mise √† jour:', error);
                showAlert('Erreur lors de la mise √† jour', 'danger');
            }
        }

        function deleteUser(id) {
            userToDelete = id;
            document.getElementById('deleteConfirmModal').querySelector('.modal-title').textContent = 'Supprimer d√©finitivement';
            document.getElementById('deleteConfirmModal').querySelector('.modal-body').innerHTML =
                '<p class="text-danger"><i class="fas fa-exclamation-triangle"></i> Attention : Cette action est irr√©versible !</p>' +
                '<p>L\'utilisateur sera d√©finitivement supprim√© de la base de donn√©es.</p>';
            new bootstrap.Modal(document.getElementById('deleteConfirmModal')).show();
        }

        function deactivateUser(id) {
            userToDeactivate = id;
            new bootstrap.Modal(document.getElementById('deactivateConfirmModal')).show();
        }

        async function confirmDelete() {
            if (!userToDelete) return;

            try {
                const token = localStorage.getItem('authToken');
                const response = await authenticatedFetch(`${API_BASE_URL}/users/${userToDelete}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                if (data.success) {
                    showAlert('Utilisateur supprim√© d√©finitivement', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal')).hide();
                    loadUsers();
                    loadStatistics();
                } else {
                    showAlert(`Erreur lors de la suppression: ${data.message || 'Erreur inconnue'}`, 'danger');
                }
            } catch (error) {
                console.error('Erreur lors de la suppression:', error);
                showAlert('Erreur lors de la suppression', 'danger');
            }
        }

        async function confirmDeactivate() {
            if (!userToDeactivate) return;

            try {
                const token = localStorage.getItem('authToken');
                const response = await authenticatedFetch(`${API_BASE_URL}/users/${userToDeactivate}/deactivate`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                if (data.success) {
                    showAlert('Utilisateur d√©sactiv√© avec succ√®s', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('deactivateConfirmModal')).hide();
                    loadUsers();
                    loadStatistics();
                } else {
                    showAlert(`Erreur lors de la d√©sactivation: ${data.message || 'Erreur inconnue'}`, 'danger');
                }
            } catch (error) {
                console.error('Erreur lors de la d√©sactivation:', error);
                showAlert('Erreur lors de la d√©sactivation', 'danger');
            }
        }

        async function restoreUser(id) {
            if (!confirm('√ätes-vous s√ªr de vouloir restaurer cet utilisateur ?')) {
                return;
            }

            try {
                const token = localStorage.getItem('authToken');
                const response = await authenticatedFetch(`${API_BASE_URL}/users/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        statut: 'ACTIF'
                    })
                });
                const data = await response.json();
                if (data.success) {
                    showAlert('Utilisateur restaur√© avec succ√®s', 'success');
                    loadUsers();
                    loadStatistics();
                } else {
                    showAlert(`Erreur lors de la restauration: ${data.message || 'Erreur inconnue'}`, 'danger');
                }
            } catch (error) {
                console.error('Erreur lors de la restauration:', error);
                showAlert('Erreur lors de la restauration', 'danger');
            }
        }

        async function viewCollaborateur(collaborateurId) {
            try {
                const token = localStorage.getItem('authToken');
                const response = await authenticatedFetch(`${API_BASE_URL}/collaborateurs/${collaborateurId}`);
                const data = await response.json();

                if (data.success) {
                    const collaborateur = data.data;

                    // Remplir le modal avec les informations du collaborateur
                    document.getElementById('collaborateur-nom').textContent = collaborateur.nom;
                    document.getElementById('collaborateur-prenom').textContent = collaborateur.prenom;
                    document.getElementById('collaborateur-email').textContent = collaborateur.email || '-';
                    document.getElementById('collaborateur-telephone').textContent = collaborateur.telephone || '-';
                    document.getElementById('collaborateur-business-unit').textContent = collaborateur.business_unit_nom || '-';
                    document.getElementById('collaborateur-division').textContent = collaborateur.division_nom || '-';
                    document.getElementById('collaborateur-poste').textContent = collaborateur.poste_nom || '-';
                    document.getElementById('collaborateur-grade').textContent = collaborateur.grade_nom || '-';
                    document.getElementById('collaborateur-statut').textContent = collaborateur.statut || '-';
                    document.getElementById('collaborateur-date-embauche').textContent = collaborateur.date_embauche ? new Date(collaborateur.date_embauche).toLocaleDateString('fr-FR') : '-';

                    // Afficher le modal
                    new bootstrap.Modal(document.getElementById('viewCollaborateurModal')).show();
                } else {
                    showAlert('Erreur lors de la r√©cup√©ration des informations du collaborateur', 'danger');
                }
            } catch (error) {
                console.error('Erreur lors de la r√©cup√©ration du collaborateur:', error);
                showAlert('Erreur lors de la r√©cup√©ration du collaborateur', 'danger');
            }
        }

        function manageUserAccount(collaborateurId, userId) {
            // Ouvrir le modal de modification pour l'utilisateur li√©
            editUser(userId, true);
        }

        // ===== GESTION DES R√îLES MULTIPLES =====

        /**
         * Charger tous les r√¥les disponibles et les r√¥les de l'utilisateur
         * @param {string} userId - ID de l'utilisateur
         */
        async function loadUserRolesForEdit(userId) {
            try {
                console.log('üîÑ Chargement des r√¥les pour l\'utilisateur:', userId);

                const container = document.getElementById('editUserRolesContainer');

                // Charger tous les r√¥les disponibles
                const allRolesResponse = await authenticatedFetch(`${API_BASE_URL}/users/roles`);
                if (!allRolesResponse.ok) {
                    throw new Error('Erreur lors du chargement des r√¥les');
                }
                const allRolesData = await allRolesResponse.json();
                const allRoles = allRolesData.data || [];
                console.log('üìã Tous les r√¥les:', allRoles);

                // üîí PROTECTION SUPER_ADMIN: Filtrer si l'utilisateur n'est pas SUPER_ADMIN
                const isSuperAdmin = await isCurrentUserSuperAdmin();
                const filteredRoles = isSuperAdmin
                    ? allRoles
                    : allRoles.filter(r => r.name !== 'SUPER_ADMIN');

                if (!isSuperAdmin && allRoles.length > filteredRoles.length) {
                    console.log('üîí SUPER_ADMIN filtr√© - non visible pour cet utilisateur');
                }

                // Charger les r√¥les de l'utilisateur
                const userRolesResponse = await authenticatedFetch(`${API_BASE_URL}/users/${userId}/roles`);
                let userRoles = [];
                if (userRolesResponse.ok) {
                    const userRolesData = await userRolesResponse.json();
                    userRoles = userRolesData.data || [];
                }
                console.log('üìä R√¥les de l\'utilisateur:', userRoles);

                // Cr√©er les checkboxes avec couleurs
                const roleColors = {
                    'SUPER_ADMIN': 'danger',
                    'ADMIN': 'primary',
                    'ADMIN_IT': 'info',
                    'ASSOCIE': 'warning',
                    'DIRECTEUR': 'success',
                    'MANAGER': 'secondary',
                    'SUPERVISEUR': 'dark',
                    'CONSULTANT': 'light',
                    'COLLABORATEUR': 'light',
                    'USER': 'light'
                };

                // Trier les r√¥les par ordre de priorit√© (hi√©rarchie)
                const rolePriority = {
                    'SUPER_ADMIN': 10,
                    'ADMIN': 9,
                    'ADMIN_IT': 8,
                    'ASSOCIE': 7,
                    'DIRECTEUR': 6,
                    'MANAGER': 5,
                    'SUPERVISEUR': 4,
                    'CONSULTANT': 3,
                    'COLLABORATEUR': 2,
                    'USER': 1
                };

                const sortedRoles = filteredRoles.sort((a, b) => {
                    const priorityA = rolePriority[a.name] || 0;
                    const priorityB = rolePriority[b.name] || 0;
                    return priorityB - priorityA;
                });

                // G√©n√©rer le HTML des checkboxes (design compact)
                const rolesHTML = sortedRoles.map(role => {
                    const isChecked = userRoles.some(ur => ur.id === role.id);
                    const colorClass = roleColors[role.name] || 'secondary';
                    const textColorClass = ['light', 'warning'].includes(colorClass) ? 'text-dark' : 'text-white';

                    return `
                        <div class="col-12">
                            <div class="form-check d-flex align-items-center py-1 px-2 role-check-item ${isChecked ? 'role-checked' : ''}" 
                                 style="border-left: 3px solid transparent; transition: all 0.2s;">
                                <input class="form-check-input me-2 mt-0" 
                                       type="checkbox" 
                                       id="role_${role.id}" 
                                       name="userRoles" 
                                       value="${role.id}"
                                       ${isChecked ? 'checked' : ''}
                                       style="cursor: pointer;">
                                <label class="form-check-label d-flex align-items-center w-100" 
                                       for="role_${role.id}" 
                                       style="cursor: pointer; margin-bottom: 0;">
                                    <span class="badge bg-${colorClass} ${textColorClass} me-2" style="min-width: 120px; font-size: 0.75rem;">${role.name}</span>
                                    <small class="text-muted" style="font-size: 0.8rem; line-height: 1.2;">${role.description || 'Aucune description'}</small>
                                </label>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = rolesHTML;
                console.log('‚úÖ R√¥les charg√©s et affich√©s');

                // Ajouter les √©v√©nements pour l'effet visuel au survol et √† la s√©lection
                const roleCheckItems = container.querySelectorAll('.role-check-item');
                roleCheckItems.forEach(item => {
                    const checkbox = item.querySelector('input[type="checkbox"]');

                    // Effet au survol
                    item.addEventListener('mouseenter', function () {
                        if (!checkbox.checked) {
                            this.style.backgroundColor = '#e9ecef';
                            this.style.borderLeftColor = '#6c757d';
                        }
                    });

                    item.addEventListener('mouseleave', function () {
                        if (!checkbox.checked) {
                            this.style.backgroundColor = 'transparent';
                            this.style.borderLeftColor = 'transparent';
                        }
                    });

                    // Effet √† la s√©lection
                    checkbox.addEventListener('change', function () {
                        if (this.checked) {
                            item.classList.add('role-checked');
                            item.style.backgroundColor = '#e7f3ff';
                            item.style.borderLeftColor = '#0d6efd';
                        } else {
                            item.classList.remove('role-checked');
                            item.style.backgroundColor = 'transparent';
                            item.style.borderLeftColor = 'transparent';
                        }
                    });

                    // Initialiser l'apparence pour les r√¥les d√©j√† coch√©s
                    if (checkbox.checked) {
                        item.style.backgroundColor = '#e7f3ff';
                        item.style.borderLeftColor = '#0d6efd';
                    }
                });

            } catch (error) {
                console.error('‚ùå Erreur lors du chargement des r√¥les:', error);
                const container = document.getElementById('editUserRolesContainer');
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Erreur lors du chargement des r√¥les. Veuillez r√©essayer.
                        </div>
                    </div>
                `;
            }
        }

        /**
         * R√©cup√©rer les r√¥les s√©lectionn√©s
         * @returns {Array<string>} IDs des r√¥les s√©lectionn√©s
         */
        function getSelectedRoles() {
            const checkboxes = document.querySelectorAll('input[name="userRoles"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        function showLoading(show) {
            document.getElementById('users-loading').style.display = show ? 'flex' : 'none';
            document.getElementById('users-content').style.display = show ? 'none' : 'block';
        }

        // Fonction de d√©bogage pour les probl√®mes de clics
        function debugClickIssues() {
            console.log('üîç D√©but du diagnostic des probl√®mes de clics...');

            // V√©rifier les modals actifs
            const activeModals = document.querySelectorAll('.modal.show');
            console.log('üìã Modals actifs:', activeModals.length);
            activeModals.forEach((modal, index) => {
                console.log(`  Modal ${index + 1}:`, modal.id);
            });

            // V√©rifier les backdrops
            const backdrops = document.querySelectorAll('.modal-backdrop');
            console.log('üñºÔ∏è Backdrops trouv√©s:', backdrops.length);
            backdrops.forEach((backdrop, index) => {
                console.log(`  Backdrop ${index + 1}:`, backdrop);
            });

            // V√©rifier les √©l√©ments avec pointer-events: none
            const allElements = document.querySelectorAll('*');
            let blockedElements = 0;
            allElements.forEach(el => {
                const style = window.getComputedStyle(el);
                if (style.pointerEvents === 'none') {
                    blockedElements++;
                    if (blockedElements <= 5) { // Limiter les logs
                        console.log('üö´ √âl√©ment bloqu√©:', el.tagName, el.className);
                    }
                }
            });
            console.log(`üö´ Total √©l√©ments bloqu√©s: ${blockedElements}`);

            // V√©rifier les z-index √©lev√©s
            let highZIndexElements = 0;
            allElements.forEach(el => {
                const style = window.getComputedStyle(el);
                const zIndex = parseInt(style.zIndex);
                if (zIndex > 1000) {
                    highZIndexElements++;
                    if (highZIndexElements <= 5) {
                        console.log('‚¨ÜÔ∏è Z-index √©lev√©:', el.tagName, el.className, zIndex);
                    }
                }
            });
            console.log(`‚¨ÜÔ∏è Total √©l√©ments avec z-index > 1000: ${highZIndexElements}`);

            // Test de clic sur le bouton principal
            const mainButton = document.querySelector('button[onclick="showNewUserModal()"]');
            if (mainButton) {
                console.log('üîò Bouton principal trouv√©:', mainButton);
                const style = window.getComputedStyle(mainButton);
                console.log('üîò Style du bouton:', {
                    pointerEvents: style.pointerEvents,
                    cursor: style.cursor,
                    zIndex: style.zIndex,
                    position: style.position
                });
            } else {
                console.log('‚ùå Bouton principal non trouv√©');
            }

            // Nettoyer les backdrops orphelins
            if (backdrops.length > 0) {
                console.log('üßπ Nettoyage des backdrops orphelins...');
                backdrops.forEach(backdrop => backdrop.remove());
            }

            console.log('‚úÖ Diagnostic termin√©');
        }

        // Fonction pour forcer le nettoyage et permettre les clics
        function forceEnableClicks() {
            console.log('üîß For√ßage de l\'activation des clics...');

            // Supprimer tous les backdrops
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());

            // Fermer tous les modals
            const modals = document.querySelectorAll('.modal.show');
            modals.forEach(modal => {
                const bsModal = bootstrap.Modal.getInstance(modal);
                if (bsModal) {
                    bsModal.hide();
                }
            });

            // Forcer pointer-events sur les √©l√©ments interactifs
            const interactiveElements = document.querySelectorAll('button, a, input, select, textarea, [onclick]');
            interactiveElements.forEach(el => {
                el.style.pointerEvents = 'auto';
                el.style.cursor = 'pointer';
            });

            // Supprimer les overlays invisibles
            const overlays = document.querySelectorAll('[style*="position: fixed"][style*="z-index"]');
            overlays.forEach(overlay => {
                const style = window.getComputedStyle(overlay);
                if (style.pointerEvents === 'none' || style.display === 'none') {
                    overlay.remove();
                }
            });

            console.log('‚úÖ Clics forc√©s activ√©s');
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            const container = document.querySelector('.main-content-area');
            if (container) {
                container.insertBefore(alertDiv, container.firstChild);
            } else {
                document.body.appendChild(alertDiv);
            }

            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
    </script>

    <!-- Notifications Modal -->
    <div class="modal fade" id="notificationsModal" tabindex="-1" aria-labelledby="notificationsModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="notificationsModalLabel">
                        <i class="fas fa-bell me-2"></i>Toutes les Notifications
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="notificationsContainerFull" class="list-group">
                        <!-- Liste compl√®te des notifications sera charg√©e ici -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Fermer
                    </button>
                    <button type="button" class="btn btn-info" onclick="markAllAsRead()">
                        <i class="fas fa-check-double me-1"></i>Marquer tout comme lu
                    </button>
                    <button type="button" class="btn btn-danger" onclick="clearReadNotifications()">
                        <i class="fas fa-trash me-1"></i>Supprimer les lues
                    </button>
                </div>
            </div>
        </div>
    </div>

</body>

</html>