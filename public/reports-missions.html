<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapports Missions</title>

    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/vendor/fontawesome/css/all.min.css">
    <link rel="stylesheet" href="css/modern-sidebar.css">
    <link rel="stylesheet" href="css/app-title.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary-color: #f093fb;
            --secondary-color: #f5576c;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            margin: 0;
            padding: 0;
        }

        .page-wrapper {
            display: flex;
            min-height: 100vh;
        }

        .main-content-area {
            flex-grow: 1;
            padding: 2rem;
            background-color: #f5f7fa;
        }

        .reports-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-3px);
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--secondary-color);
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }

        .filters-card,
        .chart-card,
        .table-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .chart-container {
            position: relative;
            height: 350px;
            max-height: 350px;
            width: 100%;
        }

        .chart-container canvas {
            max-height: 350px !important;
        }

        @media (max-width: 768px) {
            .page-wrapper {
                flex-direction: column;
            }

            .main-content-area {
                padding: 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>

    <!-- CSS des variables de branding dynamiques -->
    <link rel="stylesheet" href="/config/themes/brand-variables.css">

    <!-- Scripts de branding -->
    <script src="js/branding-loader.js"></script>
    <script src="js/sidebar-branding.js"></script>

    <!-- Configuration des devises -->
    <script src="js/currency-config.js"></script>
</head>

<body>
    <button class="sidebar-toggle d-md-none">
        <i class="fas fa-bars"></i>
    </button>

    <div class="page-wrapper">
        <div class="sidebar-container"></div>

        <div class="main-content-area">
            <div class="reports-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2><i class="fas fa-project-diagram me-3"></i>Rapports Missions</h2>
                        <p class="mb-0">Analyse d√©taill√©e des missions et projets</p>
                    </div>
                    <button class="btn btn-light" onclick="refreshData()">
                        <i class="fas fa-sync-alt me-1"></i> Actualiser
                    </button>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalMissions">0</div>
                    <div class="stat-label">Total missions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activeMissions">0</div>
                    <div class="stat-label">Missions actives</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completedMissions">0</div>
                    <div class="stat-label">Missions termin√©es</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalBudget"><span class="currency-symbol">‚Ç¨</span>0</div>
                    <div class="stat-label">Budget total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalRevenue"><span class="currency-symbol">‚Ç¨</span>0</div>
                    <div class="stat-label">Revenu r√©alis√©</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalClients">0</div>
                    <div class="stat-label">Clients actifs</div>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters-card">
                <h5 class="mb-3"><i class="fas fa-filter me-2"></i>Filtres</h5>
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="businessUnitFilter" class="form-label">Business Unit</label>
                        <select class="form-select" id="businessUnitFilter">
                            <option value="">Toutes</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="divisionFilter" class="form-label">Division</label>
                        <select class="form-select" id="divisionFilter">
                            <option value="">Toutes</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="clientFilter" class="form-label">Client</label>
                        <select class="form-select" id="clientFilter">
                            <option value="">Tous</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="typeFilter" class="form-label">Type de mission</label>
                        <select class="form-select" id="typeFilter">
                            <option value="">Tous</option>
                        </select>
                    </div>
                </div>

                <div class="row g-3 mt-2">
                    <div class="col-md-3">
                        <label for="statusFilter" class="form-label">Statut</label>
                        <select class="form-select" id="statusFilter">
                            <option value="">Tous</option>
                            <option value="EN_COURS">En cours</option>
                            <option value="TERMINE">Termin√©e</option>
                            <option value="EN_ATTENTE">En attente</option>
                            <option value="ANNULE">Annul√©e</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="minBudgetPrevue" class="form-label">Budget pr√©vu min (<span
                                class="currency-symbol">‚Ç¨</span>)</label>
                        <input type="number" class="form-control" id="minBudgetPrevue" placeholder="0">
                    </div>
                    <div class="col-md-3">
                        <label for="minBudgetReel" class="form-label">Budget r√©alis√© min (<span
                                class="currency-symbol">‚Ç¨</span>)</label>
                        <input type="number" class="form-control" id="minBudgetReel" placeholder="0">
                    </div>
                    <div class="col-md-3">
                        <label for="periodFilter" class="form-label">P√©riode</label>
                        <select class="form-select" id="periodFilter">
                            <option value="all">Toutes les p√©riodes</option>
                            <option value="today">Aujourd'hui</option>
                            <option value="yesterday">Hier</option>
                            <option value="week">Cette semaine</option>
                            <option value="last_week">Semaine pr√©c√©dente</option>
                            <option value="month">Ce mois</option>
                            <option value="last_month">Mois pr√©c√©dent</option>
                            <option value="quarter">Ce trimestre</option>
                            <option value="year">Cette ann√©e</option>
                            <option value="custom">P√©riode personnalis√©e</option>
                        </select>
                    </div>
                </div>

                <!-- P√©riode personnalis√©e (cach√©e par d√©faut) -->
                <div class="row g-3 mt-2" id="customPeriodRow" style="display: none;">
                    <div class="col-md-3">
                        <label for="startDate" class="form-label">Date de d√©but</label>
                        <input type="date" class="form-control" id="startDate">
                    </div>
                    <div class="col-md-3">
                        <label for="endDate" class="form-label">Date de fin</label>
                        <input type="date" class="form-control" id="endDate">
                    </div>
                </div>

                <div class="row g-3 mt-2">
                    <div class="col-12">
                        <button class="btn btn-primary" onclick="applyFilters()">
                            <i class="fas fa-search me-1"></i> Appliquer les filtres
                        </button>
                        <button class="btn btn-secondary ms-2" onclick="resetFilters()">
                            <i class="fas fa-undo me-1"></i> R√©initialiser
                        </button>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="row">
                <div class="col-md-6">
                    <div class="chart-card">
                        <h5 class="mb-3"><i class="fas fa-chart-pie me-2"></i>Par Statut</h5>
                        <div class="chart-container">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="chart-card">
                        <h5 class="mb-3"><i class="fas fa-chart-doughnut me-2"></i>Par Type</h5>
                        <div class="chart-container">
                            <canvas id="typeChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="chart-card">
                        <h5 class="mb-3"><i class="fas fa-chart-bar me-2"></i>Top 10 Clients par Budget</h5>
                        <div class="chart-container">
                            <canvas id="clientChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="chart-card">
                        <h5 class="mb-3"><i class="fas fa-chart-line me-2"></i>Top 10 Missions par Revenu</h5>
                        <div class="chart-container">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="table-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="fas fa-table me-2"></i>Liste des missions</h5>
                    <div class="text-muted" id="tableInfo">0 missions</div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Mission</th>
                                <th>Client</th>
                                <th>Business Unit</th>
                                <th>Type</th>
                                <th>Statut</th>
                                <th>Budget pr√©vu</th>
                                <th>Budget r√©el</th>
                                <th>Date d√©but</th>
                                <th>Date fin</th>
                            </tr>
                        </thead>
                        <tbody id="missionsTable">
                            <tr>
                                <td colspan="9" class="text-center">Chargement...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <!-- Pagination -->
                <div class="d-flex justify-content-between align-items-center mt-3" id="paginationControls"
                    style="display: none !important;">
                    <div>
                        <select class="form-select form-select-sm d-inline-block w-auto" id="itemsPerPage">
                            <option value="25">25 par page</option>
                            <option value="50" selected>50 par page</option>
                            <option value="100">100 par page</option>
                            <option value="200">200 par page</option>
                        </select>
                    </div>
                    <nav>
                        <ul class="pagination pagination-sm mb-0" id="paginationButtons">
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/global-auth.js"></script>
    <script src="js/user-header.js"></script>
    <script src="js/profile-menu.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/tasks.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/menu-permissions.js"></script>
    <script src="/js/page-permissions.js"></script>
    <script src="js/sidebar.js"></script>
    <script src="js/session-manager.js"></script>

    <script>
        const API_BASE_URL = '/api';
        let charts = {};
        let allMissions = [];
        let filteredMissions = []; // Pour la pagination
        let currentPage = 1;
        let itemsPerPage = 50;
        let financialDefaultCurrency = (typeof CURRENCY_CONFIG !== 'undefined' && CURRENCY_CONFIG.defaultCurrency) ? CURRENCY_CONFIG.defaultCurrency : 'XAF';

        document.addEventListener('DOMContentLoaded', function () {
            loadFilters();
            loadFinancialSettingsForReports()
                .catch(err => console.warn('Erreur chargement param√®tres financiers:', err))
                .finally(() => {
                    loadData();
                });

            // Event listener for period filter
            const periodFilter = document.getElementById('periodFilter');
            if (periodFilter) {
                periodFilter.addEventListener('change', function () {
                    const customRow = document.getElementById('customPeriodRow');
                    if (this.value === 'custom') {
                        customRow.style.display = 'flex';
                    } else {
                        customRow.style.display = 'none';
                    }
                });
            }

            // Event listener for Business Unit filter - cascade to divisions and mission types
            const buFilter = document.getElementById('businessUnitFilter');
            if (buFilter) {
                buFilter.addEventListener('change', function () {
                    updateDependentFilters(this.value);
                });
            }
        });

        // Stockage des donn√©es de filtres (pour coh√©rence, pas de d√©pendances fortes ici)
        let allBusinessUnits = [];
        let allDivisions = [];
        let allClients = [];
        let allMissionTypes = [];

        async function loadFilters() {
            try {
                const token = localStorage.getItem('authToken');
                const headers = { 'Authorization': `Bearer ${token}` };

                // Load Business Units
                const buResponse = await fetch(`${API_BASE_URL}/business-units?limit=1000`, { headers });
                if (buResponse.ok) {
                    const buData = await buResponse.json();
                    allBusinessUnits = buData.data.businessUnits || buData.data || [];
                    // Trier par ordre alphab√©tique
                    allBusinessUnits.sort((a, b) => (a.nom || '').localeCompare(b.nom || ''));
                    console.log('‚úÖ Business Units charg√©es:', allBusinessUnits.length);
                    const select = document.getElementById('businessUnitFilter');
                    allBusinessUnits.forEach(bu => {
                        const option = document.createElement('option');
                        option.value = bu.id;
                        option.textContent = bu.nom;
                        select.appendChild(option);
                    });
                }

                // Load Divisions
                const divResponse = await fetch(`${API_BASE_URL}/divisions?limit=1000`, { headers });
                if (divResponse.ok) {
                    const divData = await divResponse.json();
                    allDivisions = divData.data || [];
                    // Trier par ordre alphab√©tique
                    allDivisions.sort((a, b) => (a.nom || '').localeCompare(b.nom || ''));
                    console.log('‚úÖ Divisions charg√©es:', allDivisions.length);
                    const select = document.getElementById('divisionFilter');
                    allDivisions.forEach(div => {
                        const option = document.createElement('option');
                        option.value = div.id;
                        option.textContent = div.nom;
                        select.appendChild(option);
                    });
                }

                // Load clients
                const clientResponse = await fetch(`${API_BASE_URL}/clients?limit=1000`, { headers });
                if (clientResponse.ok) {
                    const clientData = await clientResponse.json();
                    allClients = clientData.data.clients || clientData.data || [];
                    // Trier par ordre alphab√©tique
                    allClients.sort((a, b) => {
                        const nameA = a.raison_sociale || a.nom || '';
                        const nameB = b.raison_sociale || b.nom || '';
                        return nameA.localeCompare(nameB);
                    });
                    console.log('‚úÖ Clients charg√©s:', allClients.length);
                    const select = document.getElementById('clientFilter');
                    allClients.forEach(client => {
                        const option = document.createElement('option');
                        option.value = client.id;
                        option.textContent = client.raison_sociale || client.nom;
                        select.appendChild(option);
                    });
                }

                // Load mission types
                console.log('üîç Chargement des types de mission...');
                const mtResponse = await fetch(`${API_BASE_URL}/mission-types?limit=1000`, { headers });
                console.log('üì° R√©ponse API mission-types:', mtResponse.status);
                if (mtResponse.ok) {
                    const mtData = await mtResponse.json();
                    console.log('üì¶ Donn√©es brutes mission-types:', mtData);
                    console.log('üì¶ mtData.data:', mtData.data);
                    console.log('üì¶ mtData.data.missionTypes:', mtData.data?.missionTypes);
                    allMissionTypes = mtData.data?.missionTypes || [];
                    // Trier par ordre alphab√©tique
                    allMissionTypes.sort((a, b) => {
                        const nameA = a.nom || a.name || a.libelle || a.codification || '';
                        const nameB = b.nom || b.name || b.libelle || b.codification || '';
                        return nameA.localeCompare(nameB);
                    });
                    console.log('‚úÖ Types de mission charg√©s:', allMissionTypes.length);
                    console.log('üìã Exemple type mission:', allMissionTypes[0]);
                    console.log('üìã Structure compl√®te:', JSON.stringify(allMissionTypes[0], null, 2));
                    const select = document.getElementById('typeFilter');
                    if (select) {
                        allMissionTypes.forEach(mt => {
                            const option = document.createElement('option');
                            option.value = mt.id;
                            // Essayer diff√©rentes propri√©t√©s possibles
                            option.textContent = mt.nom || mt.name || mt.libelle || mt.codification || 'Sans nom';
                            select.appendChild(option);
                            console.log('‚ûï Option ajout√©e:', option.textContent, '(id:', mt.id, ')');
                        });
                    } else {
                        console.error('‚ùå Element typeFilter introuvable!');
                    }
                } else {
                    console.error('‚ùå Erreur API mission-types:', mtResponse.status);
                }

                console.log('‚úÖ Filtres missions initialis√©s');
            } catch (error) {
                console.error('Erreur chargement filtres:', error);
            }
        }

        // Fonction pour mettre √† jour les filtres d√©pendants en fonction de la BU s√©lectionn√©e
        function updateDependentFilters(selectedBuId) {
            console.log('üîÑ Mise √† jour des filtres d√©pendants pour BU:', selectedBuId);

            // Filtrer les divisions
            const divisionSelect = document.getElementById('divisionFilter');
            divisionSelect.innerHTML = '<option value="">Toutes</option>';

            let filteredDivisions = allDivisions;
            if (selectedBuId) {
                filteredDivisions = allDivisions.filter(div =>
                    String(div.business_unit_id) === String(selectedBuId)
                );
            }

            filteredDivisions.forEach(div => {
                const option = document.createElement('option');
                option.value = div.id;
                option.textContent = div.nom;
                divisionSelect.appendChild(option);
            });
            console.log('‚úÖ Divisions filtr√©es:', filteredDivisions.length);

            // Filtrer les types de mission
            const typeSelect = document.getElementById('typeFilter');
            typeSelect.innerHTML = '<option value="">Tous</option>';

            let filteredMissionTypes = allMissionTypes;
            if (selectedBuId) {
                filteredMissionTypes = allMissionTypes.filter(mt => {
                    // Un type de mission peut avoir une BU directe ou via sa division
                    const hasDirectBu = mt.business_unit_id && String(mt.business_unit_id) === String(selectedBuId);
                    const hasBuViaDivision = mt.division_id && allDivisions.some(div =>
                        div.id === mt.division_id && String(div.business_unit_id) === String(selectedBuId)
                    );
                    return hasDirectBu || hasBuViaDivision;
                });
            }

            filteredMissionTypes.forEach(mt => {
                const option = document.createElement('option');
                option.value = mt.id;
                option.textContent = mt.nom || mt.name || mt.libelle || mt.codification || 'Sans nom';
                typeSelect.appendChild(option);
            });
            console.log('‚úÖ Types de mission filtr√©s:', filteredMissionTypes.length);
        }

        // Get Date Range based on period filter
        function getDateRange() {
            const period = document.getElementById('periodFilter').value;
            const now = new Date();
            let startDate, endDate;

            switch (period) {
                case 'today':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
                    break;
                case 'yesterday':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
                    endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1, 23, 59, 59);
                    break;
                case 'week':
                    const dayOfWeek = now.getDay();
                    const diff = now.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
                    startDate = new Date(now.getFullYear(), now.getMonth(), diff);
                    endDate = new Date(now.getFullYear(), now.getMonth(), diff + 6, 23, 59, 59);
                    break;
                case 'last_week':
                    const lastWeekDayOfWeek = now.getDay();
                    const lastWeekDiff = now.getDate() - lastWeekDayOfWeek + (lastWeekDayOfWeek === 0 ? -6 : 1) - 7;
                    startDate = new Date(now.getFullYear(), now.getMonth(), lastWeekDiff);
                    endDate = new Date(now.getFullYear(), now.getMonth(), lastWeekDiff + 6, 23, 59, 59);
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
                    break;
                case 'last_month':
                    startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    endDate = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59);
                    break;
                case 'quarter':
                    const quarter = Math.floor(now.getMonth() / 3);
                    startDate = new Date(now.getFullYear(), quarter * 3, 1);
                    endDate = new Date(now.getFullYear(), (quarter + 1) * 3, 0, 23, 59, 59);
                    break;
                case 'year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    endDate = new Date(now.getFullYear(), 11, 31, 23, 59, 59);
                    break;
                case 'custom':
                    const startInput = document.getElementById('startDate').value;
                    const endInput = document.getElementById('endDate').value;
                    if (startInput && endInput) {
                        startDate = new Date(startInput);
                        endDate = new Date(endInput);
                        endDate.setHours(23, 59, 59);
                    } else {
                        return null;
                    }
                    break;
                default:
                    return null;
            }

            return { startDate, endDate };
        }

        async function loadFinancialSettingsForReports() {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) return;

                const response = await fetch(`${API_BASE_URL}/financial-settings`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        financialDefaultCurrency = result.data.defaultCurrency || financialDefaultCurrency;
                        if (typeof CURRENCY_CONFIG !== 'undefined') {
                            CURRENCY_CONFIG.defaultCurrency = financialDefaultCurrency;
                        }
                    }
                }
            } catch (error) {
                console.warn('Impossible de charger les param√®tres financiers:', error);
            }
        }

        async function loadData() {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE_URL}/missions?limit=10000`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const result = await response.json();
                    allMissions = result.data || [];
                    console.log('Missions charg√©es:', allMissions.length);
                    applyFilters();
                } else {
                    console.error('Erreur API:', response.status);
                    document.getElementById('missionsTable').innerHTML =
                        '<tr><td colspan="9" class="text-center text-danger">Erreur de chargement</td></tr>';
                }
            } catch (error) {
                console.error('Erreur chargement:', error);
                document.getElementById('missionsTable').innerHTML =
                    '<tr><td colspan="9" class="text-center text-danger">Erreur: ' + error.message + '</td></tr>';
            }
        }

        function applyFilters() {
            const dateRange = getDateRange();
            const buFilter = document.getElementById('businessUnitFilter').value;
            const divisionFilter = document.getElementById('divisionFilter').value;
            const clientFilter = document.getElementById('clientFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const minBudgetPrevue = parseFloat(document.getElementById('minBudgetPrevue').value) || 0;
            const minBudgetReel = parseFloat(document.getElementById('minBudgetReel').value) || 0;

            console.log('Filtres appliqu√©s:', { dateRange, buFilter, divisionFilter, clientFilter, statusFilter, typeFilter, minBudgetPrevue, minBudgetReel });

            // Debug: afficher un √©chantillon de donn√©es
            if (allMissions.length > 0) {
                console.log('√âchantillon mission:', {
                    business_unit_id: allMissions[0].business_unit_id,
                    division_id: allMissions[0].division_id,
                    client_id: allMissions[0].client_id,
                    statut: allMissions[0].statut,
                    mission_type_id: allMissions[0].mission_type_id,
                    budget_prevue: allMissions[0].budget_prevue,
                    budget_reel: allMissions[0].budget_reel,
                    created_at: allMissions[0].created_at
                });
            }

            let filtered = allMissions.filter(mission => {
                // Filtre P√©riode (based on created_at)
                if (dateRange) {
                    const missionDate = new Date(mission.created_at);
                    if (missionDate < dateRange.startDate || missionDate > dateRange.endDate) {
                        return false;
                    }
                }

                // Filtre Business Unit
                if (buFilter) {
                    if (!mission.business_unit_id || String(mission.business_unit_id) !== String(buFilter)) {
                        return false;
                    }
                }

                // Filtre Division
                if (divisionFilter) {
                    if (!mission.division_id || String(mission.division_id) !== String(divisionFilter)) {
                        return false;
                    }
                }

                // Filtre Client
                if (clientFilter) {
                    if (!mission.client_id || String(mission.client_id) !== String(clientFilter)) {
                        return false;
                    }
                }

                // Filtre Statut
                if (statusFilter && mission.statut !== statusFilter) {
                    return false;
                }

                // Filtre Type de mission
                if (typeFilter && String(mission.mission_type_id) !== String(typeFilter)) {
                    return false;
                }

                // Filtre Budget pr√©vu minimum
                if (minBudgetPrevue && (parseFloat(mission.budget_prevue) || 0) < minBudgetPrevue) {
                    return false;
                }

                // Filtre Budget r√©alis√© minimum
                if (minBudgetReel && (parseFloat(mission.budget_reel) || 0) < minBudgetReel) {
                    return false;
                }

                return true;
            });

            console.log('Missions filtr√©es:', filtered.length);
            displayData(filtered);
        }

        function formatAmount(amount, currencyCode) {
            if (amount === null || amount === undefined || isNaN(amount)) {
                return '-';
            }

            const code = currencyCode || financialDefaultCurrency || 'XAF';

            if (typeof CURRENCY_CONFIG !== 'undefined' && typeof CURRENCY_CONFIG.format === 'function') {
                return CURRENCY_CONFIG.format(amount, code);
            }

            try {
                return new Intl.NumberFormat('fr-FR', {
                    style: 'currency',
                    currency: code,
                    minimumFractionDigits: 0
                }).format(amount);
            } catch (e) {
                return `${amount} ${code}`;
            }
        }

        function displayData(missions) {
            // Calculate statistics
            const total = missions.length;
            const active = missions.filter(m => m.statut === 'EN_COURS').length;
            const completed = missions.filter(m => m.statut === 'TERMINE').length;
            const totalBudget = missions.reduce((sum, m) => sum + (parseFloat(m.budget_prevue) || 0), 0);
            const totalRevenue = missions.reduce((sum, m) => sum + (parseFloat(m.budget_reel) || 0), 0);
            const clients = new Set(missions.map(m => m.client_id).filter(id => id)).size;

            // Update stats
            document.getElementById('totalMissions').textContent = total;
            document.getElementById('activeMissions').textContent = active;
            document.getElementById('completedMissions').textContent = completed;
            document.getElementById('totalBudget').textContent = formatAmount(totalBudget);
            document.getElementById('totalRevenue').textContent = formatAmount(totalRevenue);
            document.getElementById('totalClients').textContent = clients;

            updateCharts(missions);
            updateTable(missions);
        }

        function updateCharts(missions) {
            // Status chart
            const statusCounts = {};
            missions.forEach(m => {
                const status = m.statut || 'Non d√©fini';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });

            if (charts.statusChart) charts.statusChart.destroy();
            const ctx1 = document.getElementById('statusChart').getContext('2d');
            charts.statusChart = new Chart(ctx1, {
                type: 'pie',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: ['rgba(17,153,142,0.7)', 'rgba(102,126,234,0.7)',
                            'rgba(245,87,108,0.7)', 'rgba(168,237,234,0.7)']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // Type chart
            const typeCounts = {};
            missions.forEach(m => {
                const type = m.type_mission || 'Non d√©fini';
                typeCounts[type] = (typeCounts[type] || 0) + 1;
            });

            if (charts.typeChart) charts.typeChart.destroy();
            const ctx2 = document.getElementById('typeChart').getContext('2d');
            charts.typeChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(typeCounts),
                    datasets: [{
                        data: Object.values(typeCounts),
                        backgroundColor: ['rgba(240,147,251,0.7)', 'rgba(245,87,108,0.7)',
                            'rgba(79,172,254,0.7)', 'rgba(56,239,125,0.7)']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // Client chart (top 10 by budget)
            const clientBudgets = {};
            missions.forEach(m => {
                // Utiliser le sigle du client si disponible, sinon le nom
                const client = m.client_sigle || m.client_nom || 'Non d√©fini';
                clientBudgets[client] = (clientBudgets[client] || 0) + (parseFloat(m.budget_prevue) || 0);
            });
            const topClients = Object.entries(clientBudgets)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            if (charts.clientChart) charts.clientChart.destroy();
            const ctx3 = document.getElementById('clientChart').getContext('2d');
            charts.clientChart = new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: topClients.map(c => c[0]),
                    datasets: [{
                        label: 'Budget',
                        data: topClients.map(c => c[1]),
                        backgroundColor: 'rgba(102,126,234,0.7)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });

            // Revenue chart (top 10 by revenue)
            const sorted = [...missions].sort((a, b) =>
                (parseFloat(b.budget_reel) || 0) - (parseFloat(a.budget_reel) || 0)
            ).slice(0, 10);

            if (charts.revenueChart) charts.revenueChart.destroy();
            const ctx4 = document.getElementById('revenueChart').getContext('2d');
            charts.revenueChart = new Chart(ctx4, {
                type: 'bar',
                data: {
                    labels: sorted.map(m => m.titre || m.nom || 'Sans nom'),
                    datasets: [{
                        label: 'Revenu',
                        data: sorted.map(m => parseFloat(m.budget_reel) || 0),
                        backgroundColor: 'rgba(245,87,108,0.7)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: { x: { beginAtZero: true } }
                }
            });
        }

        function updateTable(missions) {
            filteredMissions = missions;
            currentPage = 1;
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('missionsTable');
            const tableInfo = document.getElementById('tableInfo');
            const paginationControls = document.getElementById('paginationControls');

            tbody.innerHTML = '';

            if (filteredMissions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center">Aucune mission trouv√©e</td></tr>';
                tableInfo.textContent = '0 missions';
                paginationControls.style.display = 'none';
                return;
            }

            // Calculer les indices de pagination
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredMissions.length);
            const pageMissions = filteredMissions.slice(startIndex, endIndex);

            // Afficher les missions de la page actuelle
            pageMissions.forEach(m => {
                const row = document.createElement('tr');
                const budgetPrevue = m.budget_prevue ?
                    formatAmount(m.budget_prevue, m.devise) : '-';
                const budgetReel = m.budget_reel ?
                    formatAmount(m.budget_reel, m.devise) : '-';
                const dateDebut = m.date_debut ? new Date(m.date_debut).toLocaleDateString('fr-FR') : '-';
                const dateFin = m.date_fin_prevue ? new Date(m.date_fin_prevue).toLocaleDateString('fr-FR') : '-';

                const statusClass = m.statut === 'TERMINE' ? 'success' :
                    m.statut === 'EN_COURS' ? 'primary' :
                        m.statut === 'ANNULE' ? 'danger' : 'secondary';

                // Utiliser le sigle du client si disponible
                const clientDisplay = m.client_sigle || m.client_nom || '-';

                row.innerHTML = `
                    <td><strong>${m.titre || m.nom || '-'}</strong></td>
                    <td>${clientDisplay}</td>
                    <td>${m.business_unit_nom || '-'}</td>
                    <td>${m.type_mission || '-'}</td>
                    <td><span class="badge bg-${statusClass}">${m.statut || 'N/A'}</span></td>
                    <td><strong>${budgetPrevue}</strong></td>
                    <td><strong>${budgetReel}</strong></td>
                    <td>${dateDebut}</td>
                    <td>${dateFin}</td>
                `;
                tbody.appendChild(row);
            });

            // Mettre √† jour les infos
            tableInfo.textContent = `${startIndex + 1}-${endIndex} sur ${filteredMissions.length} missions`;

            // Afficher/masquer la pagination
            if (filteredMissions.length > itemsPerPage) {
                paginationControls.style.display = 'flex';
                renderPagination();
            } else {
                paginationControls.style.display = 'none';
            }
        }

        function renderPagination() {
            const totalPages = Math.ceil(filteredMissions.length / itemsPerPage);
            const paginationButtons = document.getElementById('paginationButtons');
            paginationButtons.innerHTML = '';

            // Bouton Pr√©c√©dent
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">Pr√©c√©dent</a>`;
            paginationButtons.appendChild(prevLi);

            // Boutons de pages
            const maxButtons = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
            let endPage = Math.min(totalPages, startPage + maxButtons - 1);

            if (endPage - startPage < maxButtons - 1) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }

            if (startPage > 1) {
                const li = document.createElement('li');
                li.className = 'page-item';
                li.innerHTML = `<a class="page-link" href="#" onclick="changePage(1); return false;">1</a>`;
                paginationButtons.appendChild(li);

                if (startPage > 2) {
                    const li = document.createElement('li');
                    li.className = 'page-item disabled';
                    li.innerHTML = `<span class="page-link">...</span>`;
                    paginationButtons.appendChild(li);
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>`;
                paginationButtons.appendChild(li);
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const li = document.createElement('li');
                    li.className = 'page-item disabled';
                    li.innerHTML = `<span class="page-link">...</span>`;
                    paginationButtons.appendChild(li);
                }

                const li = document.createElement('li');
                li.className = 'page-item';
                li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${totalPages}); return false;">${totalPages}</a>`;
                paginationButtons.appendChild(li);
            }

            // Bouton Suivant
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">Suivant</a>`;
            paginationButtons.appendChild(nextLi);
        }

        function changePage(page) {
            const totalPages = Math.ceil(filteredMissions.length / itemsPerPage);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderTable();
        }

        // Event listener pour le changement de nombre d'items par page
        document.addEventListener('DOMContentLoaded', function () {
            const itemsPerPageSelect = document.getElementById('itemsPerPage');
            if (itemsPerPageSelect) {
                itemsPerPageSelect.addEventListener('change', function () {
                    itemsPerPage = parseInt(this.value);
                    currentPage = 1;
                    renderTable();
                });
            }
        });

        function resetFilters() {
            document.getElementById('periodFilter').value = 'all';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('customPeriodRow').style.display = 'none';
            document.getElementById('businessUnitFilter').value = '';
            document.getElementById('divisionFilter').value = '';
            document.getElementById('clientFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('typeFilter').value = '';
            document.getElementById('minBudgetPrevue').value = '';
            document.getElementById('minBudgetReel').value = '';
            applyFilters();
        }

        function refreshData() {
            loadData();
        }
    </script>
</body>

</html>