<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapports Missions</title>

    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/vendor/fontawesome/css/all.min.css">
    <link rel="stylesheet" href="css/modern-sidebar.css">
    <link rel="stylesheet" href="css/app-title.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary-color: #f093fb;
            --secondary-color: #f5576c;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            margin: 0;
            padding: 0;
        }

        .page-wrapper {
            display: flex;
            min-height: 100vh;
        }

        .main-content-area {
            flex-grow: 1;
            padding: 2rem;
            background-color: #f5f7fa;
        }

        .reports-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-3px);
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--secondary-color);
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }

        .filters-card,
        .chart-card,
        .table-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .chart-container {
            position: relative;
            height: 350px;
            max-height: 350px;
            width: 100%;
        }

        .chart-container canvas {
            max-height: 350px !important;
        }

        @media (max-width: 768px) {
            .page-wrapper {
                flex-direction: column;
            }

            .main-content-area {
                padding: 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>

    <!-- CSS des variables de branding dynamiques -->
    <link rel="stylesheet" href="/config/themes/brand-variables.css">

    <!-- Scripts de branding -->
    <script src="js/branding-loader.js"></script>
    <script src="js/sidebar-branding.js"></script>

    <!-- Configuration des devises -->
    <script src="js/currency-config.js"></script>
</head>

<body>
    <button class="sidebar-toggle d-md-none">
        <i class="fas fa-bars"></i>
    </button>

    <div class="page-wrapper">
        <div class="sidebar-container"></div>

        <div class="main-content-area">
            <div class="reports-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2><i class="fas fa-project-diagram me-3"></i>Rapports Missions</h2>
                        <p class="mb-0">Analyse détaillée des missions et projets</p>
                    </div>
                    <button class="btn btn-light" onclick="refreshData()">
                        <i class="fas fa-sync-alt me-1"></i> Actualiser
                    </button>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalMissions">0</div>
                    <div class="stat-label">Total missions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activeMissions">0</div>
                    <div class="stat-label">Missions actives</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completedMissions">0</div>
                    <div class="stat-label">Missions terminées</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalBudget"><span class="currency-symbol">€</span>0</div>
                    <div class="stat-label">Budget total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalRevenue"><span class="currency-symbol">€</span>0</div>
                    <div class="stat-label">Revenu réalisé</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalClients">0</div>
                    <div class="stat-label">Clients actifs</div>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters-card">
                <h5 class="mb-3"><i class="fas fa-filter me-2"></i>Filtres</h5>
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="periodFilter" class="form-label">Période</label>
                        <select class="form-select" id="periodFilter">
                            <option value="all">Toutes les périodes</option>
                            <option value="today">Aujourd'hui</option>
                            <option value="yesterday">Hier</option>
                            <option value="week">Cette semaine</option>
                            <option value="last_week">Semaine précédente</option>
                            <option value="month">Ce mois</option>
                            <option value="last_month">Mois précédent</option>
                            <option value="quarter">Ce trimestre</option>
                            <option value="year">Cette année</option>
                            <option value="custom">Période personnalisée</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="businessUnitFilter" class="form-label">Business Unit</label>
                        <select class="form-select" id="businessUnitFilter">
                            <option value="">Toutes</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="clientFilter" class="form-label">Client</label>
                        <select class="form-select" id="clientFilter">
                            <option value="">Tous</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="statusFilter" class="form-label">Statut</label>
                        <select class="form-select" id="statusFilter">
                            <option value="">Tous</option>
                            <option value="EN_COURS">En cours</option>
                            <option value="TERMINE">Terminée</option>
                            <option value="EN_ATTENTE">En attente</option>
                            <option value="ANNULE">Annulée</option>
                        </select>
                    </div>
                </div>

                <!-- Période personnalisée (cachée par défaut) -->
                <div class="row g-3 mt-2" id="customPeriodRow" style="display: none;">
                    <div class="col-md-3">
                        <label for="startDate" class="form-label">Date de début</label>
                        <input type="date" class="form-control" id="startDate">
                    </div>
                    <div class="col-md-3">
                        <label for="endDate" class="form-label">Date de fin</label>
                        <input type="date" class="form-control" id="endDate">
                    </div>
                </div>

                <div class="row g-3 mt-2">
                    <div class="col-md-3">
                        <label for="typeFilter" class="form-label">Type de mission</label>
                        <select class="form-select" id="typeFilter">
                            <option value="">Tous</option>
                            <option value="PROJET">Projet</option>
                            <option value="MAINTENANCE">Maintenance</option>
                            <option value="CONSULTING">Consulting</option>
                            <option value="FORMATION">Formation</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="minBudgetPrevue" class="form-label">Budget prévu min (<span
                                class="currency-symbol">€</span>)</label>
                        <input type="number" class="form-control" id="minBudgetPrevue" placeholder="0">
                    </div>
                    <div class="col-md-3">
                        <label for="minBudgetReel" class="form-label">Budget réalisé min (<span
                                class="currency-symbol">€</span>)</label>
                        <input type="number" class="form-control" id="minBudgetReel" placeholder="0">
                    </div>
                    <div class="col-12">
                        <button class="btn btn-primary" onclick="applyFilters()">
                            <i class="fas fa-search me-1"></i> Appliquer les filtres
                        </button>
                        <button class="btn btn-secondary ms-2" onclick="resetFilters()">
                            <i class="fas fa-undo me-1"></i> Réinitialiser
                        </button>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="row">
                <div class="col-md-6">
                    <div class="chart-card">
                        <h5 class="mb-3"><i class="fas fa-chart-pie me-2"></i>Par Statut</h5>
                        <div class="chart-container">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="chart-card">
                        <h5 class="mb-3"><i class="fas fa-chart-doughnut me-2"></i>Par Type</h5>
                        <div class="chart-container">
                            <canvas id="typeChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="chart-card">
                        <h5 class="mb-3"><i class="fas fa-chart-bar me-2"></i>Top 10 Clients par Budget</h5>
                        <div class="chart-container">
                            <canvas id="clientChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="chart-card">
                        <h5 class="mb-3"><i class="fas fa-chart-line me-2"></i>Top 10 Missions par Revenu</h5>
                        <div class="chart-container">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="table-card">
                <h5 class="mb-3"><i class="fas fa-table me-2"></i>Liste des missions</h5>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Mission</th>
                                <th>Client</th>
                                <th>Business Unit</th>
                                <th>Type</th>
                                <th>Statut</th>
                                <th>Budget prévu</th>
                                <th>Budget réel</th>
                                <th>Date début</th>
                                <th>Date fin</th>
                            </tr>
                        </thead>
                        <tbody id="missionsTable">
                            <tr>
                                <td colspan="9" class="text-center">Chargement...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/global-auth.js"></script>
    <script src="js/user-header.js"></script>
    <script src="js/profile-menu.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/tasks.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/menu-permissions.js"></script>
    <script src="/js/page-permissions.js"></script>
    <script src="js/sidebar.js"></script>
    <script src="js/session-manager.js"></script>

    <script>
        const API_BASE_URL = '/api';
        let charts = {};
        let allMissions = [];
        let financialDefaultCurrency = (typeof CURRENCY_CONFIG !== 'undefined' && CURRENCY_CONFIG.defaultCurrency) ? CURRENCY_CONFIG.defaultCurrency : 'XAF';

        document.addEventListener('DOMContentLoaded', function () {
            loadFilters();
            loadFinancialSettingsForReports()
                .catch(err => console.warn('Erreur chargement paramètres financiers:', err))
                .finally(() => {
                    loadData();
                });

            // Event listener for period filter
            const periodFilter = document.getElementById('periodFilter');
            if (periodFilter) {
                periodFilter.addEventListener('change', function () {
                    const customRow = document.getElementById('customPeriodRow');
                    if (this.value === 'custom') {
                        customRow.style.display = 'flex';
                    } else {
                        customRow.style.display = 'none';
                    }
                });
            }
        });

        // Stockage des données de filtres (pour cohérence, pas de dépendances fortes ici)
        let allBusinessUnits = [];
        let allClients = [];

        async function loadFilters() {
            try {
                const token = localStorage.getItem('authToken');
                const headers = { 'Authorization': `Bearer ${token}` };

                // Load Business Units
                const buResponse = await fetch(`${API_BASE_URL}/business-units?limit=1000`, { headers });
                if (buResponse.ok) {
                    const buData = await buResponse.json();
                    allBusinessUnits = buData.data.businessUnits || buData.data || [];
                    console.log('✅ Business Units chargées:', allBusinessUnits.length);
                    const select = document.getElementById('businessUnitFilter');
                    allBusinessUnits.forEach(bu => {
                        const option = document.createElement('option');
                        option.value = bu.id;
                        option.textContent = bu.nom;
                        select.appendChild(option);
                    });
                }

                // Load clients
                const clientResponse = await fetch(`${API_BASE_URL}/clients?limit=1000`, { headers });
                if (clientResponse.ok) {
                    const clientData = await clientResponse.json();
                    allClients = clientData.data.clients || clientData.data || [];
                    console.log('✅ Clients chargés:', allClients.length);
                    const select = document.getElementById('clientFilter');
                    allClients.forEach(client => {
                        const option = document.createElement('option');
                        option.value = client.id;
                        option.textContent = client.raison_sociale || client.nom;
                        select.appendChild(option);
                    });
                }

                console.log('✅ Filtres missions initialisés (pas de dépendances croisées)');
            } catch (error) {
                console.error('Erreur chargement filtres:', error);
            }
        }

        // Get Date Range based on period filter
        function getDateRange() {
            const period = document.getElementById('periodFilter').value;
            const now = new Date();
            let startDate, endDate;

            switch (period) {
                case 'today':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
                    break;
                case 'yesterday':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
                    endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1, 23, 59, 59);
                    break;
                case 'week':
                    const dayOfWeek = now.getDay();
                    const diff = now.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
                    startDate = new Date(now.getFullYear(), now.getMonth(), diff);
                    endDate = new Date(now.getFullYear(), now.getMonth(), diff + 6, 23, 59, 59);
                    break;
                case 'last_week':
                    const lastWeekDayOfWeek = now.getDay();
                    const lastWeekDiff = now.getDate() - lastWeekDayOfWeek + (lastWeekDayOfWeek === 0 ? -6 : 1) - 7;
                    startDate = new Date(now.getFullYear(), now.getMonth(), lastWeekDiff);
                    endDate = new Date(now.getFullYear(), now.getMonth(), lastWeekDiff + 6, 23, 59, 59);
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
                    break;
                case 'last_month':
                    startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    endDate = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59);
                    break;
                case 'quarter':
                    const quarter = Math.floor(now.getMonth() / 3);
                    startDate = new Date(now.getFullYear(), quarter * 3, 1);
                    endDate = new Date(now.getFullYear(), (quarter + 1) * 3, 0, 23, 59, 59);
                    break;
                case 'year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    endDate = new Date(now.getFullYear(), 11, 31, 23, 59, 59);
                    break;
                case 'custom':
                    const startInput = document.getElementById('startDate').value;
                    const endInput = document.getElementById('endDate').value;
                    if (startInput && endInput) {
                        startDate = new Date(startInput);
                        endDate = new Date(endInput);
                        endDate.setHours(23, 59, 59);
                    } else {
                        return null;
                    }
                    break;
                default:
                    return null;
            }

            return { startDate, endDate };
        }

        async function loadFinancialSettingsForReports() {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) return;

                const response = await fetch(`${API_BASE_URL}/financial-settings`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        financialDefaultCurrency = result.data.defaultCurrency || financialDefaultCurrency;
                        if (typeof CURRENCY_CONFIG !== 'undefined') {
                            CURRENCY_CONFIG.defaultCurrency = financialDefaultCurrency;
                        }
                    }
                }
            } catch (error) {
                console.warn('Impossible de charger les paramètres financiers:', error);
            }
        }

        async function loadData() {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE_URL}/missions?limit=10000`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const result = await response.json();
                    allMissions = result.data || [];
                    console.log('Missions chargées:', allMissions.length);
                    applyFilters();
                } else {
                    console.error('Erreur API:', response.status);
                    document.getElementById('missionsTable').innerHTML =
                        '<tr><td colspan="9" class="text-center text-danger">Erreur de chargement</td></tr>';
                }
            } catch (error) {
                console.error('Erreur chargement:', error);
                document.getElementById('missionsTable').innerHTML =
                    '<tr><td colspan="9" class="text-center text-danger">Erreur: ' + error.message + '</td></tr>';
            }
        }

        function applyFilters() {
            const dateRange = getDateRange();
            const buFilter = document.getElementById('businessUnitFilter').value;
            const clientFilter = document.getElementById('clientFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const minBudgetPrevue = parseFloat(document.getElementById('minBudgetPrevue').value) || 0;
            const minBudgetReel = parseFloat(document.getElementById('minBudgetReel').value) || 0;

            console.log('Filtres appliqués:', { dateRange, buFilter, clientFilter, statusFilter, typeFilter, minBudgetPrevue, minBudgetReel });

            // Debug: afficher un échantillon de données
            if (allMissions.length > 0) {
                console.log('Échantillon mission:', {
                    business_unit_id: allMissions[0].business_unit_id,
                    client_id: allMissions[0].client_id,
                    statut: allMissions[0].statut,
                    type_mission: allMissions[0].type_mission,
                    budget_prevue: allMissions[0].budget_prevue,
                    budget_reel: allMissions[0].budget_reel,
                    created_at: allMissions[0].created_at
                });
            }

            let filtered = allMissions.filter(mission => {
                // Filtre Période (based on created_at)
                if (dateRange) {
                    const missionDate = new Date(mission.created_at);
                    if (missionDate < dateRange.startDate || missionDate > dateRange.endDate) {
                        return false;
                    }
                }

                // Filtre Business Unit
                if (buFilter) {
                    if (!mission.business_unit_id || String(mission.business_unit_id) !== String(buFilter)) {
                        return false;
                    }
                }

                // Filtre Client
                if (clientFilter) {
                    if (!mission.client_id || String(mission.client_id) !== String(clientFilter)) {
                        return false;
                    }
                }

                // Filtre Statut
                if (statusFilter && mission.statut !== statusFilter) {
                    return false;
                }

                // Filtre Type de mission
                if (typeFilter && mission.type_mission !== typeFilter) {
                    return false;
                }

                // Filtre Budget prévu minimum
                if (minBudgetPrevue && (parseFloat(mission.budget_prevue) || 0) < minBudgetPrevue) {
                    return false;
                }

                // Filtre Budget réalisé minimum
                if (minBudgetReel && (parseFloat(mission.budget_reel) || 0) < minBudgetReel) {
                    return false;
                }

                return true;
            });

            console.log('Missions filtrées:', filtered.length);
            displayData(filtered);
        }

        function formatAmount(amount, currencyCode) {
            if (amount === null || amount === undefined || isNaN(amount)) {
                return '-';
            }

            const code = currencyCode || financialDefaultCurrency || 'XAF';

            if (typeof CURRENCY_CONFIG !== 'undefined' && typeof CURRENCY_CONFIG.format === 'function') {
                return CURRENCY_CONFIG.format(amount, code);
            }

            try {
                return new Intl.NumberFormat('fr-FR', {
                    style: 'currency',
                    currency: code,
                    minimumFractionDigits: 0
                }).format(amount);
            } catch (e) {
                return `${amount} ${code}`;
            }
        }

        function displayData(missions) {
            // Calculate statistics
            const total = missions.length;
            const active = missions.filter(m => m.statut === 'EN_COURS').length;
            const completed = missions.filter(m => m.statut === 'TERMINE').length;
            const totalBudget = missions.reduce((sum, m) => sum + (parseFloat(m.budget_prevue) || 0), 0);
            const totalRevenue = missions.reduce((sum, m) => sum + (parseFloat(m.budget_reel) || 0), 0);
            const clients = new Set(missions.map(m => m.client_id).filter(id => id)).size;

            // Update stats
            document.getElementById('totalMissions').textContent = total;
            document.getElementById('activeMissions').textContent = active;
            document.getElementById('completedMissions').textContent = completed;
            document.getElementById('totalBudget').textContent = formatAmount(totalBudget);
            document.getElementById('totalRevenue').textContent = formatAmount(totalRevenue);
            document.getElementById('totalClients').textContent = clients;

            updateCharts(missions);
            updateTable(missions);
        }

        function updateCharts(missions) {
            // Status chart
            const statusCounts = {};
            missions.forEach(m => {
                const status = m.statut || 'Non défini';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });

            if (charts.statusChart) charts.statusChart.destroy();
            const ctx1 = document.getElementById('statusChart').getContext('2d');
            charts.statusChart = new Chart(ctx1, {
                type: 'pie',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: ['rgba(17,153,142,0.7)', 'rgba(102,126,234,0.7)',
                            'rgba(245,87,108,0.7)', 'rgba(168,237,234,0.7)']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // Type chart
            const typeCounts = {};
            missions.forEach(m => {
                const type = m.type_mission || 'Non défini';
                typeCounts[type] = (typeCounts[type] || 0) + 1;
            });

            if (charts.typeChart) charts.typeChart.destroy();
            const ctx2 = document.getElementById('typeChart').getContext('2d');
            charts.typeChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(typeCounts),
                    datasets: [{
                        data: Object.values(typeCounts),
                        backgroundColor: ['rgba(240,147,251,0.7)', 'rgba(245,87,108,0.7)',
                            'rgba(79,172,254,0.7)', 'rgba(56,239,125,0.7)']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // Client chart (top 10 by budget)
            const clientBudgets = {};
            missions.forEach(m => {
                const client = m.client_nom || 'Non défini';
                clientBudgets[client] = (clientBudgets[client] || 0) + (parseFloat(m.budget_prevue) || 0);
            });
            const topClients = Object.entries(clientBudgets)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            if (charts.clientChart) charts.clientChart.destroy();
            const ctx3 = document.getElementById('clientChart').getContext('2d');
            charts.clientChart = new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: topClients.map(c => c[0]),
                    datasets: [{
                        label: 'Budget',
                        data: topClients.map(c => c[1]),
                        backgroundColor: 'rgba(102,126,234,0.7)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });

            // Revenue chart (top 10 by revenue)
            const sorted = [...missions].sort((a, b) =>
                (parseFloat(b.budget_reel) || 0) - (parseFloat(a.budget_reel) || 0)
            ).slice(0, 10);

            if (charts.revenueChart) charts.revenueChart.destroy();
            const ctx4 = document.getElementById('revenueChart').getContext('2d');
            charts.revenueChart = new Chart(ctx4, {
                type: 'bar',
                data: {
                    labels: sorted.map(m => m.titre || m.nom || 'Sans nom'),
                    datasets: [{
                        label: 'Revenu',
                        data: sorted.map(m => parseFloat(m.budget_reel) || 0),
                        backgroundColor: 'rgba(245,87,108,0.7)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: { x: { beginAtZero: true } }
                }
            });
        }

        function updateTable(missions) {
            const tbody = document.getElementById('missionsTable');
            tbody.innerHTML = '';

            if (missions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center">Aucune mission trouvée</td></tr>';
                return;
            }

            missions.slice(0, 50).forEach(m => {
                const row = document.createElement('tr');
                const budgetPrevue = m.budget_prevue ?
                    formatAmount(m.budget_prevue, m.devise) : '-';
                const budgetReel = m.budget_reel ?
                    formatAmount(m.budget_reel, m.devise) : '-';
                const dateDebut = m.date_debut ? new Date(m.date_debut).toLocaleDateString('fr-FR') : '-';
                const dateFin = m.date_fin_prevue ? new Date(m.date_fin_prevue).toLocaleDateString('fr-FR') : '-';

                const statusClass = m.statut === 'TERMINE' ? 'success' :
                    m.statut === 'EN_COURS' ? 'primary' :
                        m.statut === 'ANNULE' ? 'danger' : 'secondary';

                row.innerHTML = `
                    <td><strong>${m.titre || m.nom || '-'}</strong></td>
                    <td>${m.client_nom || '-'}</td>
                    <td>${m.business_unit_nom || '-'}</td>
                    <td>${m.type_mission || '-'}</td>
                    <td><span class="badge bg-${statusClass}">${m.statut || 'N/A'}</span></td>
                    <td><strong>${budgetPrevue}</strong></td>
                    <td><strong>${budgetReel}</strong></td>
                    <td>${dateDebut}</td>
                    <td>${dateFin}</td>
                `;
                tbody.appendChild(row);
            });

            if (missions.length > 50) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="9" class="text-center text-muted">... et ${missions.length - 50} autres missions</td>`;
                tbody.appendChild(row);
            }
        }

        function resetFilters() {
            document.getElementById('periodFilter').value = 'all';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('customPeriodRow').style.display = 'none';
            document.getElementById('businessUnitFilter').value = '';
            document.getElementById('clientFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('typeFilter').value = '';
            document.getElementById('minBudgetPrevue').value = '';
            document.getElementById('minBudgetReel').value = '';
            applyFilters();
        }

        function refreshData() {
            loadData();
        }
    </script>
</body>

</html>