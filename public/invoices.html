<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facturation</title>

    <!-- CSS Bootstrap et FontAwesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/vendor/fontawesome/css/all.min.css" rel="stylesheet">

    <!-- CSS de la sidebar moderne -->
    <link rel="stylesheet" href="css/modern-sidebar.css">


    <!-- Script d'authentification -->
    <script src="js/auth.js"></script>
    <script src="js/menu-permissions.js"></script>
    <script src="/js/page-permissions.js"></script>

    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #f8f9fa;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            overflow-x: hidden;
            /* Empêche le défilement horizontal */
        }

        /* Le conteneur principal de la page qui contient la sidebar et le contenu */
        .page-wrapper {
            display: flex;
            min-height: 100vh;
        }

        /* Styles pour le contenu principal */
        .main-content-area {
            flex-grow: 1;
            /* Prend l'espace restant */
            padding: 2rem;
            background-color: var(--light-bg);
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .stats-card.success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .stats-card.warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .stats-card.info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .invoice-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-brouillon {
            background-color: #6c757d;
            color: white;
        }

        .status-emise {
            background-color: #17a2b8;
            color: white;
        }

        .status-payee {
            background-color: #28a745;
            color: white;
        }

        .status-annulee {
            background-color: #dc3545;
            color: white;
        }

        .overdue-badge {
            background-color: #dc3545;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .filters-section {
            background-color: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .table-responsive {
            border-radius: 15px;
            overflow: hidden;
        }

        .table th {
            background-color: #f8f9fa;
            border: none;
            font-weight: 600;
            color: #495057;
        }

        .table td {
            border: none;
            border-bottom: 1px solid #dee2e6;
            vertical-align: middle;
        }

        .btn-action {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            margin: 0 0.125rem;
        }

        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 2rem;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Ajustements pour les petits écrans */
        @media (max-width: 768px) {
            .page-wrapper {
                flex-direction: column;
                /* Empile la sidebar et le contenu */
            }

            .main-content-area {
                padding: 1rem;
            }
        }
    </style>
    <!-- Scripts pour la top bar EBVISION 2.0 -->



    <!-- Script pour la gestion utilisateur -->
    <script src="js/user-header.js"></script>
    <script src="js/profile-menu.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/tasks.js"></script>

    <!-- CSS des variables de branding dynamiques -->
    <link rel="stylesheet" href="/config/themes/brand-variables.css">

    <!-- Scripts de branding -->
    <script src="js/branding-loader.js"></script>
    <script src="js/sidebar-branding.js"></script>
</head>

<body>
    <!-- Bouton toggle sidebar mobile -->
    <button class="sidebar-toggle d-md-none">
        <i class="fas fa-bars"></i>
    </button>
    <div class="page-wrapper">
        <!-- Sidebar Container -->
        <div class="sidebar-container">
            <!-- La sidebar sera générée par JavaScript -->
        </div>

        <!-- Main Content Area -->
        <div class="main-content-area">
            <!-- Header de la page -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-file-invoice me-2"></i>Facturation</h2>
                    <p class="text-muted mb-0">Gestion des factures et suivi des paiements</p>
                </div>
                <div>
                    <button type="button" class="btn btn-primary" onclick="openCreateInvoiceModal()">
                        <i class="fas fa-plus me-2"></i>Nouvelle Facture
                    </button>
                </div>
            </div>

            <!-- Statistiques -->
            <div class="row mb-4" id="statsSection">
                <div class="col-md-3">
                    <div class="card stats-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Total Factures</h6>
                                    <h3 id="totalInvoices">-</h3>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-file-invoice fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card success">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Factures Payées</h6>
                                    <h3 id="paidInvoices">-</h3>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-check-circle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card warning">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Montant Restant</h6>
                                    <h3 id="remainingAmount">-</h3>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-euro-sign fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <!-- Réduit les autres colonnes pour faire de la place ou passer en 5 colonnes -->
                    <div class="card stats-card info">
                        <div class="card-body p-2"> <!-- Padding réduit -->
                            <h6 class="card-title" style="font-size: 0.8rem;">En Retard</h6>
                            <h4 id="overdueInvoices">-</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card" style="background: linear-gradient(135deg, #ff9966 0%, #ff5e62 100%);">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Prochaine Échéance</h6>
                                    <h4 id="nextBillingDate">-</h4>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-calendar-alt fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section Facturation à venir (Billing Assistant) -->
            <div class="card mb-4 border-primary" id="billingAssistantSection" style="display: none;">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-magic me-2"></i>Assistant Facturation
                    </h5>
                    <span class="badge bg-light text-primary" id="upcomingCount">0 à facturer</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Mission</th>
                                    <th>Client</th>
                                    <th>Prochaine Échéance</th>
                                    <th>Montant Prévu</th>
                                    <th>Progression</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="upcomingBillingBody">
                                <!-- Rempli par JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Filtres Rapides (Modes de vue) -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="btn-group w-100" role="group" aria-label="Modes de vue">
                        <button type="button" class="btn btn-outline-primary active" id="btnViewMyScope"
                            onclick="switchView('my_scope')">
                            <i class="fas fa-user-circle me-2"></i>Ma Vue <small class="d-none d-md-inline">(Mes
                                missions)</small>
                        </button>
                        <button type="button" class="btn btn-outline-warning" id="btnViewActionNeeded"
                            onclick="switchView('action_needed')">
                            <i class="fas fa-exclamation-circle me-2"></i>À Traiter <small
                                class="d-none d-md-inline">(En attente)</small>
                        </button>
                        <button type="button" class="btn btn-outline-info" id="btnViewEmitted"
                            onclick="switchView('emitted')">
                            <i class="fas fa-paper-plane me-2"></i>Émises <small
                                class="d-none d-md-inline">(Finalisées)</small>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="btnViewSuggestions"
                            onclick="switchView('suggestions')">
                            <i class="fas fa-magic me-2"></i>Suggestions <small
                                class="d-none d-md-inline">(Assistant)</small>
                        </button>
                        <button type="button" class="btn btn-outline-dark" id="btnViewAll" onclick="switchView('all')">
                            <i class="fas fa-list me-2"></i>Tout voir
                        </button>
                        <button type="button" class="btn btn-outline-danger" id="btnViewLate"
                            onclick="switchView('late')">
                            <i class="fas fa-clock me-2"></i>En Retard
                        </button>
                    </div>
                </div>
            </div>

            <!-- Filtres Détaillés -->
            <div class="filters-section">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">Statut</label>
                        <select class="form-select" id="statusFilter">
                            <option value="">Tous les statuts</option>
                            <option value="BROUILLON">Brouillon</option>
                            <option value="EMISE">Emise</option>
                            <option value="PAYEE">Payée</option>
                            <option value="ANNULEE">Annulée</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Unité d'affaires</label>
                        <select class="form-select" id="buFilter">
                            <option value="">Toutes les unités</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Division</label>
                        <select class="form-select" id="divisionFilter">
                            <option value="">Toutes les divisions</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Client</label>
                        <select class="form-select" id="clientFilter">
                            <option value="">Tous les clients</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Date début</label>
                        <input type="date" class="form-control" id="dateDebutFilter">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Date fin</label>
                        <input type="date" class="form-control" id="dateFinFilter">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Recherche</label>
                        <input type="text" class="form-control" id="searchFilter" placeholder="Numéro, mission...">
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <button type="button" class="btn btn-primary me-2" onclick="applyFilters()">
                            <i class="fas fa-search me-2"></i>Filtrer
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="clearFilters()">
                            <i class="fas fa-times me-2"></i>Effacer
                        </button>
                    </div>
                </div>
            </div>

            <!-- Liste des factures -->
            <div class="card" id="invoicesListCard">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>Liste des Factures
                    </h5>
                </div>
                <div class="card-body">
                    <div class="loading-spinner" id="loadingSpinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Chargement...</span>
                        </div>
                        <p class="mt-2">Chargement des factures...</p>
                    </div>

                    <div class="empty-state" id="emptyState" style="display: none;">
                        <i class="fas fa-file-invoice"></i>
                        <h5>Aucune facture trouvée</h5>
                        <p>Commencez par créer votre première facture</p>
                        <button type="button" class="btn btn-primary" onclick="openCreateInvoiceModal()">
                            <i class="fas fa-plus me-2"></i>Créer une facture
                        </button>
                    </div>

                    <div class="table-responsive" id="invoicesTable" style="display: none;">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Numéro</th>
                                    <th>Mission</th>
                                    <th>Client</th>
                                    <th>Unité d'affaires</th>
                                    <th>Division</th>
                                    <th>Date émission</th>
                                    <th>Échéance</th>
                                    <th>Montant TTC</th>
                                    <th>Payé</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="invoicesTableBody">
                                <!-- Les factures seront chargées ici -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="pagination-container" id="paginationContainer" style="display: none;">
                        <nav>
                            <ul class="pagination" id="pagination">
                                <!-- La pagination sera générée ici -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de création de facture -->
    <div class="modal fade" id="createInvoiceModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plus me-2"></i>Nouvelle Facture
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createInvoiceForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Business Unit *</label>
                                <select class="form-select" id="buSelectModal" required onchange="onBuChangeModal()">
                                    <option value="">Sélectionner une BU...</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Division</label>
                                <select class="form-select" id="divisionSelectModal" onchange="onDivisionChangeModal()"
                                    disabled>
                                    <option value="">Sélectionner une BU d'abord...</option>
                                </select>
                            </div>
                            <div class="col-12 mb-3">
                                <label class="form-label">Mission *</label>
                                <select class="form-select" id="missionSelect" required disabled>
                                    <option value="">Sélectionner une BU d'abord...</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Notes (Optionnel)</label>
                                <textarea class="form-control" id="notesFacture" rows="2"
                                    placeholder="Notes internes..."></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="createInvoice()">
                        <i class="fas fa-save me-2"></i>Créer la facture
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let currentPage = 1;
        let totalPages = 1;
        let currentFilters = {};
        let missions = [];
        let clients = [];

        // Initialisation
        document.addEventListener('DOMContentLoaded', function () {
            console.log('Page de facturation chargée');
            loadStats();
            loadMissions();
            loadClients();
            loadUpcomingBilling();
            loadInvoices();
        });

        // Charger l'assistant de facturation
        async function loadUpcomingBilling() {
            try {
                const response = await fetch('/api/billing/upcoming', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
                });

                if (response.ok) {
                    const result = await response.json();
                    const items = result.data || [];

                    const section = document.getElementById('billingAssistantSection');
                    const tbody = document.getElementById('upcomingBillingBody');
                    const countBadge = document.getElementById('upcomingCount');

                    if (items.length > 0) {
                        section.style.display = 'block';
                        countBadge.textContent = `${items.length} à facturer`;

                        tbody.innerHTML = items.map(item => `
                            <tr>
                                <td>
                                    <strong>${item.mission_code || ''}</strong><br>
                                    ${item.mission_nom}
                                </td>
                                <td>${item.client_nom}</td>
                                <td>
                                    <span class="badge bg-info text-dark">
                                        ${item.next_condition.details || 'Tranche ' + (item.condition_index + 1)}
                                    </span>
                                    ${item.next_condition.date_prevue ? `<br><small class="text-muted">${formatDate(item.next_condition.date_prevue)}</small>` : ''}
                                </td>
                                <td>
                                    <strong>${formatCurrency(item.next_condition.montant_restant_tranche || (parseFloat(item.next_condition.montant_honoraires || 0) + parseFloat(item.next_condition.montant_debours || 0)))}</strong>
                                </td>
                                <td>
                                    <div class="progress" style="height: 5px;" title="${item.progress}% facturé">
                                        <div class="progress-bar" role="progressbar" style="width: ${item.progress}%"></div>
                                    </div>
                                    <small class="text-muted">${item.progress}% global</small>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-success" onclick="generateNextInvoice('${item.mission_id}', ${item.condition_index})">
                                        <i class="fas fa-file-invoice-dollar me-1"></i>Générer
                                    </button>
                                </td>
                            </tr>
                        `).join('');
                    } else {
                        section.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Erreur assistant facturation:', error);
            }
        }

        // Générer la prochaine facture
        async function generateNextInvoice(missionId, conditionIndex) {
            if (!confirm('Voulez-vous générer la facture pour cette échéance ?')) return;

            try {
                const response = await fetch('/api/billing/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({ mission_id: missionId, condition_index: conditionIndex })
                });

                const result = await response.json();
                if (result.success) {
                    // Recharger les données
                    loadUpcomingBilling();
                    loadInvoices();
                    loadStats();
                    // Ouvrir la facture créée (optionnel, ou juste notifier)
                    alert('Facture brouillon générée avec succès !');
                } else {
                    alert('Erreur: ' + result.error);
                }
            } catch (error) {
                console.error('Erreur génération:', error);
                alert('Erreur lors de la génération de la facture');
            }
        }

        // Charger les statistiques
        async function loadStats() {
            try {
                const [statsResponse, upcomingResponse] = await Promise.all([
                    fetch('/api/invoices/stats', { headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` } }),
                    fetch('/api/billing/upcoming', { headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` } })
                ]);

                if (statsResponse.ok) {
                    const result = await statsResponse.json();
                    const stats = result.data;

                    document.getElementById('totalInvoices').textContent = stats.total_factures || 0;
                    document.getElementById('paidInvoices').textContent = stats.factures_payees || 0;
                    document.getElementById('remainingAmount').textContent = formatCurrency(stats.total_montant_restant || 0);
                    document.getElementById('overdueInvoices').textContent = stats.factures_en_retard || 0;
                }

                if (upcomingResponse.ok) {
                    const result = await upcomingResponse.json();
                    const items = result.data || [];

                    // Trouver la date la plus proche
                    let nextDate = null;
                    items.forEach(item => {
                        if (item.next_condition && item.next_condition.date_prevue) {
                            const date = new Date(item.next_condition.date_prevue);
                            if (!nextDate || date < nextDate) {
                                nextDate = date;
                            }
                        }
                    });

                    const nextDateEl = document.getElementById('nextBillingDate');
                    if (nextDate) {
                        nextDateEl.textContent = formatDate(nextDate);
                        // Mettre en rouge si dépassé
                        if (nextDate < new Date()) {
                            nextDateEl.classList.add('text-warning');
                        }
                    } else {
                        nextDateEl.textContent = 'Aucune';
                    }
                }
            } catch (error) {
                console.error('Erreur lors du chargement des statistiques:', error);
            }
        }

        // Charger les missions (Unused globally now, only for manual loading in modal on change, but kept for compatibility logic elsewhere if any?)
        // The modal now loads missions dynamically. We can remove this initial full load to save bandwidth if it's not used for filters.
        function loadMissions() {
            // No-op or load for filters if needed.
            // Filters usually use a different endpoint or load all. 
            // If we want to populate the filter dropdown "searchFilter" or similar, we might still need it.
            // But for now, let's leave it empty to avoid conflict with the modal logic.
        }

        // Charger les clients
        async function loadClients() {
            try {
                const response = await fetch('/api/clients', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    clients = (result && (result.data?.clients || result.data || result.clients)) || [];

                    const clientFilter = document.getElementById('clientFilter');

                    if (clientFilter) {
                        clientFilter.innerHTML = '<option value="">Tous les clients</option>';

                        (clients || []).forEach(client => {
                            const option = document.createElement('option');
                            option.value = client.id;
                            option.textContent = `${client.sigle || 'N/A'} - ${client.nom}`;
                            clientFilter.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('Erreur lors du chargement des clients:', error);
            }
        }


        // Gestion des Vues
        let currentView = 'my_scope';

        function switchView(view) {
            currentView = view;

            // Mise à jour des classes active
            document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));

            let btnId = '';
            if (view === 'my_scope') btnId = 'btnViewMyScope';
            else if (view === 'action_needed') btnId = 'btnViewActionNeeded';
            else if (view === 'emitted') btnId = 'btnViewEmitted';
            else if (view === 'suggestions') btnId = 'btnViewSuggestions';
            else if (view === 'all') btnId = 'btnViewAll';

            const btn = document.getElementById(btnId);
            if (btn) btn.classList.add('active');

            // Gestion de l'affichage de la section Assistant
            const assistantSection = document.getElementById('billingAssistantSection');
            const invoicesCard = document.getElementById('invoicesListCard');
            const paginationContainer = document.getElementById('paginationContainer');

            if (assistantSection) {
                if (view === 'suggestions') {
                    assistantSection.style.display = 'block';
                    assistantSection.scrollIntoView({ behavior: 'smooth' });
                    // Masquer la liste principale
                    if (invoicesCard) invoicesCard.style.display = 'none';
                    if (paginationContainer) paginationContainer.style.display = 'none';
                } else {
                    assistantSection.style.display = 'none';
                    // Afficher la liste principale
                    if (invoicesCard) invoicesCard.style.display = 'block';
                    // La pagination s'affichera si nécessaire via renderPagination
                }
            }

            // Mise à jour de l'ID bouton actif pour 'late'
            if (view === 'late') {
                const btnLate = document.getElementById('btnViewLate');
                if (btnLate) btnLate.classList.add('active');
            }

            if (view === 'suggestions') {
                loadUpcomingBilling();
            }

            // Rechargement des données
            currentPage = 1;
            loadInvoices();
        }

        // Charger les Business Units
        async function loadBusinessUnits() {
            try {
                const response = await fetch('/api/business-units', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
                });
                if (response.ok) {
                    const result = await response.json();
                    const buFilter = document.getElementById('buFilter');
                    buFilter.innerHTML = '<option value="">Toutes les unités</option>';
                    (result.data || result).forEach(bu => {
                        const opt = document.createElement('option');
                        opt.value = bu.id;
                        opt.textContent = `${bu.code || ''} ${bu.nom}`.trim();
                        buFilter.appendChild(opt);
                    });
                }
            } catch (e) { console.error('Erreur BU:', e); }
        }

        // Charger les Divisions
        async function loadDivisions() {
            try {
                const response = await fetch('/api/divisions', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
                });
                if (response.ok) {
                    const result = await response.json();
                    const divisionFilter = document.getElementById('divisionFilter');
                    divisionFilter.innerHTML = '<option value="">Toutes les divisions</option>';
                    (result.data || result).forEach(div => {
                        const opt = document.createElement('option');
                        opt.value = div.id;
                        opt.textContent = `${div.code || ''} ${div.nom}`.trim();
                        divisionFilter.appendChild(opt);
                    });
                }
            } catch (e) { console.error('Erreur Divisions:', e); }
        }

        // Charger les factures
        async function loadInvoices() {
            try {
                showLoading(true);

                const params = new URLSearchParams({
                    page: currentPage,
                    limit: 10,
                    view: currentView,
                    ...currentFilters
                });

                const response = await fetch(`/api/invoices?${params}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    const invoices = result.data || [];
                    const pagination = result.pagination || {};

                    totalPages = pagination.pages || 1;
                    currentPage = pagination.page || 1;

                    try { console.log('Invoices sample:', invoices.slice(0, 3)); } catch (_) { }
                    renderInvoices(invoices);
                    renderPagination(pagination);
                    // Peupler dynamiquement les filtres BU/Division en fonction des factures visibles
                    populateOrgFiltersFromInvoices(invoices);
                }
            } catch (error) {
                console.error('Erreur lors du chargement des factures:', error);
                showError('Erreur lors du chargement des factures');
            } finally {
                showLoading(false);
            }
        }

        // Construire les filtres BU et Division depuis les données de factures affichées
        function populateOrgFiltersFromInvoices(invoices) {
            const buSelect = document.getElementById('buFilter');
            const divisionSelect = document.getElementById('divisionFilter');
            if (!buSelect || !divisionSelect) return;

            // Si les selects existent mais n'ont que l'option par défaut, on peuple; sinon on conserve l'état utilisateur
            const buHasOnlyDefault = buSelect.options.length <= 1;
            const divHasOnlyDefault = divisionSelect.options.length <= 1;
            if (!buHasOnlyDefault && !divHasOnlyDefault) return;

            const buMap = new Map();
            const divMap = new Map();
            invoices.forEach(inv => {
                if (inv.business_unit_id) {
                    buMap.set(inv.business_unit_id, inv.business_unit_nom || inv.business_unit_id);
                }
                if (inv.division_id) {
                    divMap.set(inv.division_id, inv.division_nom || inv.division_id);
                }
            });

            if (buHasOnlyDefault) {
                // Reset en gardant la première option
                buSelect.length = 1;
                Array.from(buMap.entries()).sort((a, b) => a[1].localeCompare(b[1])).forEach(([id, nom]) => {
                    const opt = document.createElement('option');
                    opt.value = id;
                    opt.textContent = nom;
                    buSelect.appendChild(opt);
                });
            }

            if (divHasOnlyDefault) {
                divisionSelect.length = 1;
                Array.from(divMap.entries()).sort((a, b) => a[1].localeCompare(b[1])).forEach(([id, nom]) => {
                    const opt = document.createElement('option');
                    opt.value = id;
                    opt.textContent = nom;
                    divisionSelect.appendChild(opt);
                });
            }
        }

        // Afficher les factures
        function renderInvoices(invoices) {
            const tableBody = document.getElementById('invoicesTableBody');
            const table = document.getElementById('invoicesTable');
            const emptyState = document.getElementById('emptyState');

            if (invoices.length === 0) {
                table.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            table.style.display = 'block';
            emptyState.style.display = 'none';

            tableBody.innerHTML = invoices.map(invoice => `
                <tr>
                    <td>
                        <strong>${invoice.numero_facture}</strong>
                        ${isOverdue(invoice) ? '<span class="overdue-badge ms-2">En retard</span>' : ''}
                    </td>
                    <td>${invoice.mission_nom || 'N/A'}</td>
                    <td>${invoice.client_nom || 'N/A'}</td>
                    <td>${invoice.business_unit_nom || 'N/A'}</td>
                    <td>${invoice.division_nom || 'N/A'}</td>
                    <td>${formatDate(invoice.date_emission)}</td>
                    <td>${formatDate(invoice.date_echeance)}</td>
                    <td><strong>${formatCurrency(invoice.montant_ttc)}</strong></td>
                    <td>${formatCurrency(invoice.montant_paye)}</td>
                    <td>
                        <span class="invoice-status status-${invoice.statut.toLowerCase()}">
                            ${getStatusLabel(invoice.statut)}
                        </span>
                    </td>
                    <td>
                        <button type="button" class="btn btn-sm btn-outline-primary btn-action" onclick="viewInvoice('${invoice.id}')" title="Voir">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary btn-action" onclick="editInvoice('${invoice.id}')" title="Modifier">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-success btn-action" onclick="generatePDF('${invoice.id}')" title="PDF">
                            <i class="fas fa-file-pdf"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger btn-action" onclick="deleteInvoice('${invoice.id}')" title="Supprimer">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Afficher la pagination
        function renderPagination(pagination) {
            const container = document.getElementById('paginationContainer');
            const paginationElement = document.getElementById('pagination');

            if (pagination.pages <= 1) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';

            let html = '';

            // Bouton précédent
            html += `
                <li class="page-item ${pagination.page <= 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${pagination.page - 1})">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
            `;

            // Pages
            for (let i = 1; i <= pagination.pages; i++) {
                if (i === 1 || i === pagination.pages || (i >= pagination.page - 2 && i <= pagination.page + 2)) {
                    html += `
                        <li class="page-item ${i === pagination.page ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                        </li>
                    `;
                } else if (i === pagination.page - 3 || i === pagination.page + 3) {
                    html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
            }

            // Bouton suivant
            html += `
                <li class="page-item ${pagination.page >= pagination.pages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${pagination.page + 1})">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            `;

            paginationElement.innerHTML = html;
        }

        // Changer de page
        function changePage(page) {
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                loadInvoices();
            }
        }

        // Appliquer les filtres
        function applyFilters() {
            currentFilters = {
                statut: document.getElementById('statusFilter').value,
                client_id: document.getElementById('clientFilter').value,
                business_unit_id: document.getElementById('buFilter').value,
                division_id: document.getElementById('divisionFilter').value,
                date_debut: document.getElementById('dateDebutFilter').value,
                date_fin: document.getElementById('dateFinFilter').value,
                search: document.getElementById('searchFilter').value
            };

            // Supprimer les valeurs vides
            Object.keys(currentFilters).forEach(key => {
                if (!currentFilters[key]) {
                    delete currentFilters[key];
                }
            });

            currentPage = 1;
            loadInvoices();
        }

        // Charger les suggestions de facturation
        async function loadUpcomingBilling() {
            try {
                const tbody = document.getElementById('upcomingBillingBody');
                if (!tbody) return;

                tbody.innerHTML = '<tr><td colspan="6" class="text-center"><div class="spinner-border text-primary spinner-border-sm" role="status"></div> Chargement...</td></tr>';

                const response = await fetch('/api/billing/upcoming', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
                });

                if (response.ok) {
                    const result = await response.json();
                    renderUpcomingBilling(result.data || []);
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Erreur lors du chargement des suggestions</td></tr>';
                }
            } catch (error) {
                console.error('Erreur suggestions:', error);
                const tbody = document.getElementById('upcomingBillingBody');
                if (tbody) tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Erreur technique</td></tr>';
            }
        }

        function renderUpcomingBilling(items) {
            const tbody = document.getElementById('upcomingBillingBody');
            if (!tbody) return;

            if (items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Aucune suggestion pour le moment</td></tr>';
                return;
            }

            tbody.innerHTML = items.map(item => {
                const cond = item.next_condition;
                const montant = parseFloat(cond.montant_honoraires || 0) + parseFloat(cond.montant_debours || 0);

                return `
                <tr>
                    <td><strong>${item.mission_nom}</strong><br><small class="text-muted">${item.client_nom}</small></td>
                    <td>${cond.description || cond.details || 'Échéance prévue'}</td>
                    <td>${formatDate(cond.date_prevue)}</td>
                    <td>${formatCurrency(montant)}</td>
                    <td><span class="badge bg-info text-dark">Suggestion</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="generateInvoiceFromSuggestion('${item.mission_id}', ${item.index})">
                            <i class="fas fa-plus"></i> Créer
                        </button>
                    </td>
                </tr>
                `;
            }).join('');
        }

        async function generateInvoiceFromSuggestion(missionId, index) {
            if (!confirm('Voulez-vous générer une facture brouillon pour cette suggestion ?')) return;

            try {
                const response = await fetch('/api/billing/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        mission_id: missionId,
                        condition_index: index,
                        type: 'CONDITION'
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    alert('Facture brouillon générée avec succès !');
                    // Rediriger ou recharger
                    switchView('my_scope'); // Retour à la liste pour voir le brouillon
                    loadStats();
                } else {
                    const err = await response.json();
                    alert('Erreur: ' + (err.error || 'Impossible de générer'));
                }
            } catch (e) {
                console.error(e);
                alert('Erreur technique lors de la génération');
            }
        }


        // Effacer les filtres
        function clearFilters() {
            document.getElementById('statusFilter').value = '';
            document.getElementById('clientFilter').value = '';
            document.getElementById('buFilter').value = '';
            document.getElementById('divisionFilter').value = '';
            document.getElementById('dateDebutFilter').value = '';
            document.getElementById('dateFinFilter').value = '';
            document.getElementById('searchFilter').value = '';

            currentFilters = {};
            currentPage = 1;
            loadInvoices();
        }

        // Ouvrir le modal de création
        // Ouvrir le modal de création
        async function openCreateInvoiceModal() {
            document.getElementById('createInvoiceForm').reset();

            const buSelect = document.getElementById('buSelectModal');
            const divSelect = document.getElementById('divisionSelectModal');
            const missionSelect = document.getElementById('missionSelect');

            buSelect.innerHTML = '<option value="">Chargement...</option>';
            divSelect.innerHTML = '<option value="">Sélectionner une BU d\'abord...</option>';
            divSelect.disabled = true;
            missionSelect.innerHTML = '<option value="">Sélectionner une BU d\'abord...</option>';
            missionSelect.disabled = true;

            const modal = new bootstrap.Modal(document.getElementById('createInvoiceModal'));
            modal.show();

            await loadBusinessUnits();
        }

        async function loadBusinessUnits() {
            const buSelect = document.getElementById('buSelectModal');
            try {
                const response = await fetch('/api/business-units', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
                });
                if (response.ok) {
                    const result = await response.json();
                    const bus = result.data || result.businessUnits || [];
                    buSelect.innerHTML = '<option value="">Sélectionner une BU...</option>';
                    bus.forEach(bu => {
                        const opt = document.createElement('option');
                        opt.value = bu.id;
                        opt.textContent = bu.nom;
                        buSelect.appendChild(opt);
                    });
                } else {
                    buSelect.innerHTML = '<option value="">Erreur de chargement</option>';
                    console.error('Erreur chargement BU:', await response.text());
                }
            } catch (e) {
                console.error(e);
                buSelect.innerHTML = '<option value="">Erreur technique</option>';
            }
        }

        async function onBuChangeModal() {
            const buId = document.getElementById('buSelectModal').value;
            const divSelect = document.getElementById('divisionSelectModal');
            const missionSelect = document.getElementById('missionSelect');

            divSelect.innerHTML = '<option value="">Chargement...</option>';
            divSelect.disabled = true;
            missionSelect.innerHTML = '<option value="">Sélectionner une division...</option>';
            missionSelect.disabled = true;

            if (!buId) {
                divSelect.innerHTML = '<option value="">Sélectionner une BU d\'abord...</option>';
                return;
            }

            // Load Divisions
            try {
                const response = await fetch(`/api/divisions?business_unit_id=${buId}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
                });
                if (response.ok) {
                    const result = await response.json();
                    const divs = result.data || [];

                    divSelect.innerHTML = '<option value="">Toutes les divisions (Optionnel)</option>';
                    divs.forEach(d => {
                        const opt = document.createElement('option');
                        opt.value = d.id;
                        opt.textContent = d.nom;
                        divSelect.appendChild(opt);
                    });
                    divSelect.disabled = false;
                }
            } catch (e) { console.error('Erreur loading divisions', e); }

            // Load Missions for BU
            await loadModalMissions(buId, null);
        }

        async function onDivisionChangeModal() {
            const buId = document.getElementById('buSelectModal').value;
            const divId = document.getElementById('divisionSelectModal').value;
            await loadModalMissions(buId, divId);
        }

        async function loadModalMissions(buId, divId) {
            const missionSelect = document.getElementById('missionSelect');
            missionSelect.innerHTML = '<option value="">Chargement...</option>';
            missionSelect.disabled = true;

            let url = `/api/missions?business_unit_id=${buId}`;
            if (divId) url += `&division_id=${divId}`;

            try {
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
                });
                if (response.ok) {
                    const result = await response.json();
                    const missions = result.data || [];

                    if (missions.length === 0) {
                        missionSelect.innerHTML = '<option value="">Aucune mission trouvée</option>';
                    } else {
                        missionSelect.innerHTML = '<option value="">Sélectionner une mission...</option>';
                        missions.forEach(m => {
                            const opt = document.createElement('option');
                            opt.value = m.id;
                            // Format: [CLIENT] - Code Nom
                            const clientSigle = m.client_sigle || m.client_nom || '?';
                            opt.textContent = `[${clientSigle}] - ${m.nom}`;
                            missionSelect.appendChild(opt);
                        });
                        missionSelect.disabled = false;
                    }
                }
            } catch (e) { console.error('Erreur loading missions', e); }
        }

        // Créer une facture
        async function createInvoice() {
            const missionId = document.getElementById('missionSelect').value;
            const notes = document.getElementById('notesFacture').value;

            if (!missionId) {
                alert('Veuillez sélectionner une mission.');
                return;
            }

            try {
                // 1. Récupérer les infos de la mission
                const missionResponse = await fetch(`/api/missions/${missionId}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
                });
                const missionData = await missionResponse.json();
                const mission = missionData.data;

                // 2. Vérifier s'il y a une suggestion de facturation
                const nextResponse = await fetch(`/api/billing/mission/${missionId}/next`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
                });
                const nextData = await nextResponse.json();
                const next = nextData.data;
                const devise = mission.devise || 'XAF';

                let confirmMsg = "Voulez-vous générer une facture pour cette mission ?";
                if (next) {
                    confirmMsg = `Générer la facture pour : ${next.description} ?\nMontant suggéré : ${formatCurrency(next.montant_total, devise)}`;
                }

                if (!confirm(confirmMsg)) return;

                // 3. Appel à l'API de génération
                if (next && next.type === 'CONDITION') {
                    // Cas Génération auto via condition
                    await generateWithEndpoint('/api/billing/generate', {
                        mission_id: missionId,
                        type: 'CONDITION',
                        condition_index: next.condition_index,
                        notes_facture: notes
                    });
                } else if (next && next.type === 'BALANCE') {
                    // Cas Solde - Création manuelle + Items
                    await createManualInvoice(mission, notes, next);
                } else {
                    // Cas Standard - Création manuelle vide
                    await createManualInvoice(mission, notes, null);
                }

            } catch (error) {
                console.error('Erreur lors de la création:', error);
                alert('Erreur lors de la création de la facture');
            }
        }

        async function generateWithEndpoint(url, body) {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                },
                body: JSON.stringify(body)
            });

            if (response.ok) {
                finalizeCreation();
            } else {
                const err = await response.json();
                alert('Erreur: ' + (err.error || 'Impossible de générer'));
            }
        }

        async function createManualInvoice(mission, notes, nextBlock) {
            const invoiceData = {
                mission_id: mission.id,
                client_id: mission.client_id,
                date_emission: new Date().toISOString().split('T')[0],
                date_echeance: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                statut: 'BROUILLON',
                conditions_paiement: nextBlock ? nextBlock.description : 'Facture standard',
                taux_tva: 19.25,
                adresse_facturation: mission.adresse_facturation || '',
                notes_facture: notes || (nextBlock ? `Généré automatiquement (Solde).` : `Facture générée pour la mission: ${mission.nom}`)
            };

            const response = await fetch('/api/invoices', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                },
                body: JSON.stringify(invoiceData)
            });

            if (response.ok) {
                const result = await response.json();
                const invoiceId = result.data.id;

                if (nextBlock && nextBlock.type === 'BALANCE') {
                    // Ajouter les lignes de solde
                    if (nextBlock.montant_honoraires > 0) {
                        await addItemToInvoice(invoiceId, 'Solde Honoraires', nextBlock.montant_honoraires);
                    }
                    if (nextBlock.montant_debours > 0) {
                        await addItemToInvoice(invoiceId, 'Solde Débours', nextBlock.montant_debours);
                    }
                    alert('Facture de solde générée avec succès !');
                } else {
                    alert('Facture brouillon créée. Veuillez ajouter les lignes.');
                }
                finalizeCreation();
            } else {
                const err = await response.json();
                alert('Erreur: ' + err.error);
            }
        }

        async function addItemToInvoice(invoiceId, desc, amount) {
            await fetch(`/api/invoices/${invoiceId}/items`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                },
                body: JSON.stringify({
                    description: desc,
                    quantite: 1,
                    unite: 'forfait',
                    prix_unitaire: amount,
                    taux_tva: 19.25
                })
            });
        }

        function finalizeCreation() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('createInvoiceModal'));
            modal.hide();
            loadStats();
            loadInvoices();
            loadUpcomingBilling();
        }

        // Voir une facture
        function viewInvoice(id) {
            window.open(`invoice-details.html?id=${id}`, '_blank');
        }

        // Modifier une facture
        function editInvoice(id) {
            window.open(`edit-invoice.html?id=${id}`, '_blank');
        }

        // Générer PDF
        function generatePDF(id) {
            window.open(`/api/invoices/${id}/pdf`, '_blank');
        }

        // Supprimer une facture
        async function deleteInvoice(id) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer cette facture ?')) {
                return;
            }

            try {
                const response = await fetch(`/api/invoices/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (response.ok) {
                    alert('Facture supprimée avec succès !');
                    loadStats();
                    loadInvoices();
                } else {
                    const error = await response.json();
                    alert('Erreur lors de la suppression: ' + (error.error || 'Erreur inconnue'));
                }
            } catch (error) {
                console.error('Erreur lors de la suppression de la facture:', error);
                alert('Erreur lors de la suppression de la facture');
            }
        }

        // Fonctions utilitaires
        function showLoading(show) {
            const spinner = document.getElementById('loadingSpinner');
            const table = document.getElementById('invoicesTable');
            const emptyState = document.getElementById('emptyState');

            if (show) {
                spinner.style.display = 'block';
                table.style.display = 'none';
                emptyState.style.display = 'none';
            } else {
                spinner.style.display = 'none';
            }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('fr-FR', {
                style: 'currency',
                currency: 'EUR'
            }).format(amount || 0);
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString('fr-FR');
        }

        function getStatusLabel(statut) {
            const labels = {
                'BROUILLON': 'Brouillon',
                'EMISE': 'Emise',
                'PAYEE': 'Payée',
                'ANNULEE': 'Annulée'
            };
            return labels[statut] || statut;
        }

        function isOverdue(invoice) {
            if (invoice.statut !== 'EMISE') return false;
            const echeance = new Date(invoice.date_echeance);
            const today = new Date();
            return echeance < today && invoice.montant_restant > 0;
        }

        function showError(message) {
            alert(message);
        }
    </script>

    <!-- Scripts JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="js/sidebar.js"></script>
    <!-- SessionManager pour la gestion centralisée des sessions -->
    <script src="js/session-manager.js"></script>
</body>

</html>