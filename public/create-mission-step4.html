<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cr√©ation de Mission - √âtape 4</title>
    
    <!-- CSS Bootstrap et FontAwesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/modern-sidebar.css">
    
    
    <!-- Import de la configuration des devises -->
    <script src="/js/currency-config.js" defer></script>
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #f8f9fa;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
        }
        
        .page-wrapper {
            display: flex;
            min-height: 100vh;
        }

        .main-content-area {
            flex-grow: 1;
            padding: 2rem;
            background-color: var(--light-bg);
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }
        
        .step {
            display: flex;
            align-items: center;
            margin: 0 1rem;
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 0.5rem;
        }
        
        .step-number.active {
            background-color: var(--success-color);
        }
        
        .step-number.completed {
            background-color: var(--success-color);
        }
        
        .btn-next {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-next:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
            color: white;
        }
        
        .btn-next:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-prev {
            background: var(--secondary-color);
            border: none;
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-prev:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
            color: white;
        }
        
        .info-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .form-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .form-section h6 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            font-weight: 600;
        }
        
        .task-card {
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        .task-card.selected {
            border-color: var(--success-color);
            background-color: #e8f5e8;
        }
        
        .task-card.obligatory {
            border-left: 4px solid var(--warning-color);
            background-color: #fff3cd;
        }
        
        .task-card.obligatory.selected {
            border-color: #ffc107;
            background-color: #fff3cd;
            box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25);
        }
        
        .task-card.optional {
            border-left: 4px solid var(--secondary-color);
        }
        
        .alert-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        .collaborateurs-selection {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            background-color: #f8f9fa;
        }
        
        .collaborateur-heures {
            background-color: #f8f9fa;
            border-radius: 0.375rem;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .collaborateur-heures .row {
            display: flex !important;
            flex-direction: row !important;
        }
        
                        .collaborateur-heures-row {
                    display: flex;
                    flex-direction: row;
                    align-items: center;
                    background-color: #f8f9fa;
                    border-radius: 0.375rem;
                    padding: 0.75rem;
                    margin-bottom: 0.5rem;
                    gap: 1rem;
                }
                
                .collaborateur-heures-row.hidden {
                    display: none !important;
                }
        
        .collaborateur-info {
            flex: 0 0 25% !important;
            min-width: 200px;
        }
        
        .collaborateur-taux {
            flex: 0 0 20% !important;
            min-width: 150px;
        }
        
        .collaborateur-heures {
            flex: 0 0 20% !important;
            min-width: 120px;
        }
        
        .collaborateur-cout {
            flex: 0 0 20% !important;
            min-width: 150px;
        }
        
        .heures-par-collaborateur {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .assignment-row {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .budget-calculator {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .budget-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .budget-item:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.2rem;
        }

        /* Styles sp√©cifiques pour la sidebar (si non g√©r√©s par modern-sidebar.css) */
        .sidebar-container {
            width: 300px; /* Largeur fixe pour la sidebar */
            flex-shrink: 0; /* Emp√™che la sidebar de r√©tr√©cir */
        }

        /* Ajustements pour les petits √©crans */
        @media (max-width: 768px) {
            .page-wrapper {
                flex-direction: column; /* Empile la sidebar et le contenu */
            }
            .sidebar-container {
                width: 100%; /* La sidebar prend toute la largeur */
                height: auto; /* Hauteur automatique */
            }
            .main-content-area {
                padding: 1rem;
            }
        }
    
        /* Styles pour la sidebar unifi√©e */
        .main-content-wrapper {
            margin-left: 300px;
            transition: margin-left 0.3s ease;
            min-height: 100vh;
            padding: 0;
        }
        
        .main-content {
            padding: 2rem;
        }
        
        @media (max-width: 768px) {
            .main-content-wrapper {
                margin-left: 0;
            }
            
            .sidebar-container {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .sidebar-container.open {
                transform: translateX(0);
            }
            
            .main-content {
                padding: 1rem;
            }
        }
    </style>
    <!-- Scripts pour la top bar EBVISION 2.0 -->
    
    
    
    <!-- Script pour la gestion utilisateur -->
    <script src="js/user-header.js"></script>
    <script src="js/menu-permissions.js"></script>
    <script src="js/profile-menu.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/tasks.js"></script>

    <!-- CSS des variables de branding dynamiques -->
    <link rel="stylesheet" href="/config/themes/brand-variables.css">
    
    <!-- Scripts de branding -->
    <script src="js/branding-loader.js"></script>
    <script src="js/sidebar-branding.js"></script>
</head>
<body>
    <!-- Bouton toggle sidebar mobile -->
    <button class="sidebar-toggle d-md-none">
        <i class="fas fa-bars"></i>
    </button>
    <div class="page-wrapper">
        <!-- Sidebar Container -->
        <div class="sidebar-container">
            <!-- La sidebar sera g√©n√©r√©e par JavaScript -->
        </div>

        <!-- Main Content Area -->
        <div class="main-content-area">
            <div class="container-fluid">

                <!-- Indicateur d'√©tapes -->
                <div class="step-indicator">
                    <div class="step">
                        <div class="step-number completed">1</div>
                        <span>S√©lection Opportunit√© & Type</span>
                    </div>
                    <div class="step">
                        <div class="step-number completed">2</div>
                        <span>Configuration Mission</span>
                    </div>
                    <div class="step">
                        <div class="step-number completed">3</div>
                        <span>Configuration Financi√®re</span>
                    </div>
                    <div class="step">
                        <div class="step-number active">4</div>
                        <span>Planification</span>
                    </div>
                </div>

                <!-- En-t√™te -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-calendar-alt me-2"></i>Planification - √âtape 4</h2>
                    <a href="create-mission-step3.html" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Retour √† l'√âtape 3
                    </a>
                </div>

                <!-- R√©sum√© de la mission -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-info-circle me-2"></i>R√©sum√© de la Mission
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <h6><i class="fas fa-tasks me-2"></i>Mission</h6>
                                <div id="mission-summary">
                                    <div class="info-badge mb-2">Chargement...</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h6><i class="fas fa-trophy me-2"></i>Opportunit√© Source</h6>
                                <div id="opportunity-summary">
                                    <div class="info-badge mb-2">Chargement...</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h6><i class="fas fa-euro-sign me-2"></i>Budget</h6>
                                <div id="budget-summary">
                                    <div class="info-badge mb-2">Chargement...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- S√©lection des t√¢ches -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-list-check me-2"></i>S√©lection des T√¢ches
                        </h5>
                        <button type="button" class="btn btn-success btn-sm" onclick="openCreateTaskModal()">
                            <i class="fas fa-plus me-2"></i>Cr√©er une nouvelle t√¢che
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="tasks-container">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Chargement...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Affectation du personnel -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-users me-2"></i>Affectation du Personnel
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="assignments-container">
                            <p class="text-muted">S√©lectionnez d'abord les t√¢ches pour voir les affectations disponibles.</p>
                        </div>
                    </div>
                </div>

                <!-- Calculateur de budget -->
                <div class="budget-calculator">
                    <h5 class="mb-3"><i class="fas fa-calculator me-2"></i>Budget Pr√©visionnel d'Ex√©cution</h5>
                    <div id="budget-calculator-content">
                        <div class="budget-item">
                            <span>Budget Total (Honoraires + D√©bours):</span>
                            <span id="budget-total">‚Ç¨0.00</span>
                        </div>
                        <div class="budget-item">
                            <span>Budget Honoraires:</span>
                            <span id="budget-honoraires">‚Ç¨0.00</span>
                        </div>
                        <div class="budget-item">
                            <span>Co√ªt Personnel:</span>
                            <span id="budget-personnel">‚Ç¨0.00</span>
                        </div>
                        <div class="budget-item">
                            <span>Marge (Honoraires - Personnel):</span>
                            <span id="budget-marge">‚Ç¨0.00</span>
                        </div>
                        <div class="budget-item">
                            <span>Total Heures:</span>
                            <span id="budget-heures-total">0</span>
                        </div>
                        <div class="budget-item">
                            <span>Taux Horaire Moyen:</span>
                            <span id="budget-taux-moyen">‚Ç¨0.00</span>
                        </div>
                    </div>
                </div>

                <!-- Boutons de navigation -->
                <div class="text-center mt-4">
                    <button id="btn-prev" class="btn btn-prev me-3">
                        <i class="fas fa-arrow-left me-2"></i>Retour √† l'√âtape 3
                    </button>
                    <button id="btn-create" class="btn btn-success">
                        <i class="fas fa-check me-2"></i>Cr√©er la Mission
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/auth.js" defer></script>
    <script src="/js/sidebar.js" defer></script>
    <script>
        // Variables globales
        let selectedOpportunity = null;
        let selectedMissionType = null;
        let missionData = null;
        let financialData = null;
        let tasks = [];
        let collaborateurs = [];
        let selectedTasks = [];
        let assignments = {};

        // Fonction utilitaire pour les appels API authentifi√©s
        async function authenticatedFetch(url, options = {}) {
            const token = localStorage.getItem('authToken');
            const defaultHeaders = {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
            
            return fetch(url, {
                ...options,
                headers: {
                    ...defaultHeaders,
                    ...options.headers
                }
            });
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Page create-mission-step4.html charg√©e');
            await loadData();
            setupEventListeners();
        });

        // Charger les donn√©es
        async function loadData() {
            try {
                // R√©cup√©rer les donn√©es depuis sessionStorage
                const opportunityData = sessionStorage.getItem('selectedOpportunity');
                const missionTypeData = sessionStorage.getItem('selectedMissionType');
                const missionDataStr = sessionStorage.getItem('missionData');
                const financialDataStr = sessionStorage.getItem('financialData');

                if (!opportunityData || !missionTypeData || !missionDataStr || !financialDataStr) {
                    console.error('‚ùå Donn√©es manquantes');
                    alert('Veuillez retourner √† l\'√©tape 1 pour recommencer');
                    window.location.href = 'create-mission-step1.html';
                    return;
                }

                selectedOpportunity = JSON.parse(opportunityData);
                selectedMissionType = JSON.parse(missionTypeData);
                missionData = JSON.parse(missionDataStr);
                financialData = JSON.parse(financialDataStr);

                console.log('‚úÖ Donn√©es charg√©es:', { selectedOpportunity, selectedMissionType, missionData, financialData });
                console.log('üîç V√©rification selectedMissionType:', {
                    exists: !!selectedMissionType,
                    id: selectedMissionType?.id,
                    libelle: selectedMissionType?.libelle
                });

                // Afficher les r√©sum√©s
                displaySummaries();
                
                // Charger les collaborateurs d'abord, puis les t√¢ches
                await loadCollaborateurs();
                await loadTasks();

            } catch (error) {
                console.error('‚ùå Erreur lors du chargement des donn√©es:', error);
            }
        }

        // Afficher les r√©sum√©s
        function displaySummaries() {
            // R√©sum√© de la mission
            const missionSummary = document.getElementById('mission-summary');
            missionSummary.innerHTML = `
                <div class="info-badge mb-2">${missionData.code}</div>
                <p class="mb-1"><strong>Nom:</strong> ${missionData.nom}</p>
                <p class="mb-1"><strong>P√©riode:</strong> ${formatDate(missionData.date_debut)} - ${formatDate(missionData.date_fin_prevue)}</p>
            `;

            // R√©sum√© de l'opportunit√©
            const opportunitySummary = document.getElementById('opportunity-summary');
            opportunitySummary.innerHTML = `
                <div class="info-badge mb-2">${selectedOpportunity.nom}</div>
                <p class="mb-1"><strong>Client:</strong> ${selectedOpportunity.client_nom}</p>
                <p class="mb-1"><strong>Business Unit:</strong> ${selectedOpportunity.business_unit_nom || 'N/A'}</p>
            `;

            // R√©sum√© du budget
            const budgetSummary = document.getElementById('budget-summary');
            const totalBudget = financialData.honoraires_montant + financialData.debours_montant;
            budgetSummary.innerHTML = `
                <div class="info-badge mb-2">${formatCurrency(totalBudget)}</div>
                <p class="mb-1"><strong>Honoraires:</strong> ${formatCurrency(financialData.honoraires_montant, financialData.honoraires_devise)}</p>
                <p class="mb-1"><strong>D√©bours:</strong> ${formatCurrency(financialData.debours_montant, financialData.debours_devise)}</p>
            `;
        }

        // Charger les t√¢ches
        async function loadTasks() {
            try {
                console.log('üìã Chargement des t√¢ches...');
                const response = await authenticatedFetch(`/api/tasks/by-mission-type/${selectedMissionType.id}`);
                const data = await response.json();
                
                if (data.success) {
                    tasks = data.data.tasks;
                    console.log(`‚úÖ ${tasks.length} t√¢ches charg√©es`);
                    displayTasks();
                } else {
                    console.error('‚ùå Erreur lors du chargement des t√¢ches:', data.error);
                }
            } catch (error) {
                console.error('‚ùå Erreur lors du chargement des t√¢ches:', error);
            }
        }

        // Charger les collaborateurs
        async function loadCollaborateurs() {
            try {
                console.log('üë• Chargement des collaborateurs...');
                const response = await authenticatedFetch('/api/collaborateurs');
                const data = await response.json();
                
                if (data.success) {
                    // L'API retourne directement data.data (tableau de collaborateurs)
                    console.log('üìä Donn√©es brutes des collaborateurs:', data.data);
                    console.log('üìä Statuts des collaborateurs:', data.data.map(c => ({ nom: c.nom, statut: c.statut })));
                    
                    // Filtrer seulement les collaborateurs actifs
                    collaborateurs = data.data.filter(collab => collab.statut === 'ACTIF');
                    console.log(`‚úÖ ${collaborateurs.length} collaborateurs actifs charg√©s`);
                    console.log('Collaborateurs actifs:', collaborateurs);
                    console.log('üìä Taux horaires des collaborateurs:', collaborateurs.map(c => ({ 
                        nom: c.nom, 
                        taux_horaire: c.taux_horaire,
                        grade: c.grade_nom,
                        business_unit: c.business_unit_nom
                    })));
                } else {
                    console.error('‚ùå Erreur lors du chargement des collaborateurs:', data.error);
                }
            } catch (error) {
                console.error('‚ùå Erreur lors du chargement des collaborateurs:', error);
            }
        }

        // Afficher les t√¢ches
        function displayTasks() {
            const container = document.getElementById('tasks-container');
            
            if (tasks.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <h5>Aucune t√¢che disponible</h5>
                        <p>Aucune t√¢che n'est associ√©e √† ce type de mission.</p>
                    </div>
                `;
                return;
            }

            // S√©lectionner automatiquement les t√¢ches obligatoires
            tasks.forEach(task => {
                if (task.obligatoire && !selectedTasks.includes(task.id)) {
                    selectedTasks.push(task.id);
                    assignments[task.id] = {
                        task: task,
                        collaborateurs: {},
                        totalHeures: 0
                    };
                }
            });

            const tasksHtml = tasks.map(task => `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card task-card ${task.obligatoire ? 'obligatory' : 'optional'} ${selectedTasks.includes(task.id) ? 'selected' : ''}" 
                         onclick="${task.obligatoire ? '' : `toggleTask('${task.id}')`}" 
                         data-task-id="${task.id}"
                         style="${task.obligatoire ? 'cursor: not-allowed;' : ''}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title">${task.code}</h6>
                                <span class="badge ${task.obligatoire ? 'bg-warning' : 'bg-info'}">
                                    ${task.obligatoire ? 'Obligatoire' : 'Optionnel'}
                                </span>
                            </div>
                            <p class="card-text">${task.libelle}</p>
                            ${task.obligatoire ? '<div class="alert alert-warning alert-sm mb-2"><i class="fas fa-lock me-1"></i>T√¢che obligatoire - s√©lectionn√©e automatiquement</div>' : ''}
                            <div class="row">
                                <div class="col-6">
                                    <small class="text-muted">Dur√©e</small><br>
                                    <strong>${task.duree_estimee || 'N/A'} h</strong>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Priorit√©</small><br>
                                    <strong>${task.priorite || 'N/A'}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = `
                <div class="row">
                    ${tasksHtml}
                </div>
            `;
            
            // Mettre √† jour l'affichage des affectations apr√®s avoir s√©lectionn√© les t√¢ches obligatoires
            displayAssignments();
            updateBudgetCalculator();
        }

        // Basculer la s√©lection d'une t√¢che
        function toggleTask(taskId) {
            const taskCard = document.querySelector(`[data-task-id="${taskId}"]`);
            const task = tasks.find(t => t.id === taskId);
            
            // Emp√™cher la d√©s√©lection des t√¢ches obligatoires
            if (task.obligatoire && selectedTasks.includes(taskId)) {
                console.log('‚ö†Ô∏è Impossible de d√©s√©lectionner une t√¢che obligatoire');
                return;
            }
            
            if (selectedTasks.includes(taskId)) {
                // D√©s√©lectionner (seulement pour les t√¢ches non obligatoires)
                selectedTasks = selectedTasks.filter(id => id !== taskId);
                taskCard.classList.remove('selected');
                delete assignments[taskId];
            } else {
                // S√©lectionner
                selectedTasks.push(taskId);
                taskCard.classList.add('selected');
                assignments[taskId] = {
                    task: task,
                    collaborateurs: {},
                    totalHeures: 0
                };
            }
            
            displayAssignments();
            updateBudgetCalculator();
        }

        // Afficher les affectations
        function displayAssignments() {
            const container = document.getElementById('assignments-container');
            
            console.log('üîç Debug displayAssignments:');
            console.log('  - selectedTasks:', selectedTasks);
            console.log('  - collaborateurs:', collaborateurs);
            console.log('  - collaborateurs.length:', collaborateurs.length);
            console.log('  - assignments:', assignments);
            
            if (selectedTasks.length === 0) {
                container.innerHTML = '<p class="text-muted">S√©lectionnez d\'abord les t√¢ches pour voir les affectations disponibles.</p>';
                return;
            }

            const assignmentsHtml = selectedTasks.map(taskId => {
                const assignment = assignments[taskId];
                const task = assignment.task;
                
                console.log(`üîç Debug taskId ${taskId}:`);
                console.log(`  - assignment:`, assignment);
                console.log(`  - assignment.collaborateurs:`, assignment ? assignment.collaborateurs : 'undefined');
                
                return `
                    <div class="assignment-row">
                        <h6 class="mb-3">
                            <i class="fas fa-tasks me-2"></i>${task.code} - ${task.libelle}
                            ${task.obligatoire ? '<span class="badge bg-warning ms-2">Obligatoire</span>' : ''}
                        </h6>
                        
                        <!-- S√©lection des collaborateurs -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <label class="form-label">Collaborateurs assign√©s</label>
                                                                 <div class="collaborateurs-selection">
                                     ${collaborateurs.length > 0 ? 
                                         collaborateurs.map(collab => {
                                             // V√©rifier si ce collaborateur est d√©j√† assign√© √† cette t√¢che
                                             const isAssigned = assignment && assignment.collaborateurs && assignment.collaborateurs[collab.id] !== undefined;
                                             console.log(`üîç Debug collab ${collab.id} (${collab.nom}): isAssigned = ${isAssigned}`);
                                             return `
                                                 <div class="form-check form-check-inline mb-2">
                                                     <input class="form-check-input" type="checkbox" 
                                                            id="collab_${taskId}_${collab.id}" 
                                                            value="${collab.id}"
                                                            ${isAssigned ? 'checked' : ''}
                                                            onchange="updateCollaborateurAssignment('${taskId}', '${collab.id}', this.checked)">
                                                     <label class="form-check-label" for="collab_${taskId}_${collab.id}">
                                                         <strong>${collab.nom} ${collab.prenom}</strong><br>
                                                         <small class="text-muted">${collab.grade_nom || 'N/A'} - ${collab.business_unit_nom || 'N/A'}</small>
                                                     </label>
                                                 </div>
                                             `;
                                         }).join('') : 
                                         '<div class="alert alert-warning">Aucun collaborateur actif disponible</div>'
                                     }
                                 </div>
                                <div class="form-text">Cochez les collaborateurs √† assigner √† cette t√¢che</div>
                            </div>
                        </div>
                        
                        <!-- Heures et co√ªts par collaborateur -->
                        <div class="row">
                            <div class="col-12">
                                <label class="form-label">Heures et co√ªts par collaborateur</label>
                                <div class="heures-par-collaborateur">
                                    ${collaborateurs.map(collab => {
                                        // V√©rifier si ce collaborateur est d√©j√† assign√© √† cette t√¢che
                                        const isAssigned = assignment && assignment.collaborateurs && assignment.collaborateurs[collab.id] !== undefined;
                                        console.log(`üîç Debug collab ${collab.id} (${collab.nom}) heures row: isAssigned = ${isAssigned}, hidden class = ${!isAssigned}`);
                                        return `
                                            <div class="collaborateur-heures-row ${isAssigned ? '' : 'hidden'}" id="heures_${taskId}_${collab.id}">
                                                <div class="collaborateur-info">
                                                    <strong>${collab.nom} ${collab.prenom}</strong><br>
                                                    <small class="text-muted">${collab.grade_nom || 'N/A'}</small>
                                                </div>
                                                <div class="collaborateur-taux">
                                                    <label class="form-label small mb-1">Taux horaire</label>
                                                    <div class="input-group input-group-sm">
                                                        <input type="number" class="form-control" 
                                                               value="${collab.taux_horaire || 0}" 
                                                               readonly
                                                               title="Taux horaire">
                                                        <span class="input-group-text">‚Ç¨/h</span>
                                                    </div>
                                                </div>
                                                <div class="collaborateur-heures">
                                                    <label class="form-label small mb-1">Heures</label>
                                                    <input type="number" class="form-control form-control-sm" 
                                                           placeholder="Heures" min="0" step="0.5"
                                                           value="${isAssigned ? (assignment.collaborateurs[collab.id].heures || 0) : ''}"
                                                           onchange="updateCollaborateurHeures('${taskId}', '${collab.id}', this.value)"
                                                           title="Heures">
                                                </div>
                                                <div class="collaborateur-cout">
                                                    <label class="form-label small mb-1">Co√ªt total</label>
                                                    <div class="form-control form-control-sm bg-light" id="cout_${taskId}_${collab.id}" title="Co√ªt total">
                                                        ${isAssigned ? formatCurrency(assignment.collaborateurs[collab.id].cout || 0) : formatCurrency(0)}
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Total des heures et co√ªt pour cette t√¢che -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <strong>Total des heures pour cette t√¢che:</strong> 
                                            <span id="total_heures_${taskId}">0</span> heures
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Co√ªt total de cette t√¢che:</strong> 
                                            <span id="total_cout_${taskId}">${formatCurrency(0)}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = assignmentsHtml;
            
            // Debug apr√®s g√©n√©ration du HTML
            console.log('üîç Debug apr√®s g√©n√©ration HTML:');
            selectedTasks.forEach(taskId => {
                collaborateurs.forEach(collab => {
                    const heuresDiv = document.getElementById(`heures_${taskId}_${collab.id}`);
                    const checkbox = document.getElementById(`collab_${taskId}_${collab.id}`);
                    if (heuresDiv) {
                        console.log(`üîç Element heures_${taskId}_${collab.id}:`, heuresDiv);
                        console.log(`üîç Style display:`, heuresDiv.style.display);
                        console.log(`üîç Computed style:`, window.getComputedStyle(heuresDiv).display);
                    }
                    if (checkbox) {
                        console.log(`üîç Checkbox collab_${taskId}_${collab.id}:`, checkbox);
                        console.log(`üîç Checked:`, checkbox.checked);
                    }
                });
            });
        }

        // Mettre √† jour l'affectation d'un collaborateur
        function updateCollaborateurAssignment(taskId, collaborateurId, isChecked) {
            console.log('üîç Debug updateCollaborateurAssignment:');
            console.log(`  - taskId: ${taskId}`);
            console.log(`  - collaborateurId: ${collaborateurId}`);
            console.log(`  - isChecked: ${isChecked}`);
            console.log(`  - assignments[${taskId}] before:`, assignments[taskId]);
            
            if (!assignments[taskId]) {
                assignments[taskId] = {
                    task: tasks.find(t => t.id === taskId),
                    collaborateurs: {},
                    totalHeures: 0,
                    totalCout: 0
                };
                console.log(`  - Created new assignment for taskId ${taskId}:`, assignments[taskId]);
            }
            
            if (isChecked) {
                // Ajouter le collaborateur
                const collaborateur = collaborateurs.find(c => c.id === collaborateurId);
                assignments[taskId].collaborateurs[collaborateurId] = {
                    id: collaborateurId,
                    heures: 0,
                    taux_horaire: collaborateur.taux_horaire || 0,
                    cout: 0
                };
                console.log(`  - Added collaborateur ${collaborateurId} to task ${taskId}`);
            } else {
                // Retirer le collaborateur
                delete assignments[taskId].collaborateurs[collaborateurId];
                console.log(`  - Removed collaborateur ${collaborateurId} from task ${taskId}`);
            }
            
            console.log(`  - assignments[${taskId}] after:`, assignments[taskId]);
            console.log(`  - assignments[${taskId}].collaborateurs after:`, assignments[taskId].collaborateurs);
            
            // Mettre √† jour l'affichage bas√© sur l'√©tat des assignments
            displayAssignments(); // Recr√©er les √©l√©ments DOM d'abord
            // Attendre un peu que les √©l√©ments DOM soient cr√©√©s
            setTimeout(() => {
                updateCollaborateurHeuresDisplay(); // Puis mettre √† jour l'affichage
                updateBudgetCalculator();
            }, 100);
        }
        
        // Mettre √† jour les heures d'un collaborateur
        function updateCollaborateurHeures(taskId, collaborateurId, heures) {
            if (assignments[taskId] && assignments[taskId].collaborateurs[collaborateurId]) {
                const heuresValue = parseFloat(heures) || 0;
                const tauxHoraire = assignments[taskId].collaborateurs[collaborateurId].taux_horaire || 0;
                const cout = heuresValue * tauxHoraire;
                
                assignments[taskId].collaborateurs[collaborateurId].heures = heuresValue;
                assignments[taskId].collaborateurs[collaborateurId].cout = cout;
                
                // Mettre √† jour l'affichage du co√ªt en temps r√©el
                const coutDiv = document.getElementById(`cout_${taskId}_${collaborateurId}`);
                if (coutDiv) {
                    coutDiv.textContent = formatCurrency(cout);
                }
                
                updateTaskTotalHeures(taskId);
                updateBudgetCalculator();
            }
        }
        
        // Mettre √† jour l'affichage des heures par collaborateur
        function updateCollaborateurHeuresDisplay() {
            console.log('üîç Debug updateCollaborateurHeuresDisplay:');
            console.log('  - selectedTasks:', selectedTasks);
            console.log('  - assignments:', assignments);
            
            selectedTasks.forEach(taskId => {
                console.log(`üîç Debug taskId ${taskId}:`);
                console.log(`  - assignments[${taskId}]:`, assignments[taskId]);
                console.log(`  - assignments[${taskId}].collaborateurs:`, assignments[taskId] ? assignments[taskId].collaborateurs : 'undefined');
                
                collaborateurs.forEach(collab => {
                    const heuresDiv = document.getElementById(`heures_${taskId}_${collab.id}`);
                    const checkbox = document.getElementById(`collab_${taskId}_${collab.id}`);
                    const coutDiv = document.getElementById(`cout_${taskId}_${collab.id}`);
                    
                    console.log(`üîç Debug collab ${collab.id} (${collab.nom}):`);
                    console.log(`  - heuresDiv:`, heuresDiv);
                    console.log(`  - checkbox:`, checkbox);
                    console.log(`  - checkbox.checked:`, checkbox ? checkbox.checked : 'N/A');
                    
                    if (heuresDiv && checkbox) {
                        // V√©rifier si le collaborateur est assign√© dans les assignments
                        const isAssigned = assignments[taskId] && assignments[taskId].collaborateurs && assignments[taskId].collaborateurs[collab.id] !== undefined;
                        
                        console.log(`  - isAssigned:`, isAssigned);
                        console.log(`  - assignments[${taskId}].collaborateurs[${collab.id}]:`, assignments[taskId] && assignments[taskId].collaborateurs ? assignments[taskId].collaborateurs[collab.id] : 'undefined');
                        
                        if (isAssigned) {
                            console.log(`  - Removing 'hidden' class for ${collab.nom}`);
                            heuresDiv.classList.remove('hidden');
                            // Mettre √† jour l'affichage du co√ªt
                            if (coutDiv) {
                                const cout = assignments[taskId].collaborateurs[collab.id].cout || 0;
                                coutDiv.textContent = formatCurrency(cout);
                            }
                        } else {
                            console.log(`  - Adding 'hidden' class for ${collab.nom}`);
                            heuresDiv.classList.add('hidden');
                        }
                        
                        console.log(`  - Has 'hidden' class:`, heuresDiv.classList.contains('hidden'));
                        console.log(`  - Computed display style:`, window.getComputedStyle(heuresDiv).display);
                    } else {
                        console.log(`  - Missing elements: heuresDiv=${!!heuresDiv}, checkbox=${!!checkbox}`);
                    }
                });
            });
        }
        
        // Mettre √† jour le total des heures et co√ªt pour une t√¢che
        function updateTaskTotalHeures(taskId) {
            if (assignments[taskId]) {
                let totalHeures = 0;
                let totalCout = 0;
                
                Object.values(assignments[taskId].collaborateurs).forEach(collab => {
                    totalHeures += collab.heures || 0;
                    totalCout += collab.cout || 0;
                });
                
                assignments[taskId].totalHeures = totalHeures;
                assignments[taskId].totalCout = totalCout;
                
                const totalHeuresSpan = document.getElementById(`total_heures_${taskId}`);
                const totalCoutSpan = document.getElementById(`total_cout_${taskId}`);
                
                if (totalHeuresSpan) {
                    totalHeuresSpan.textContent = totalHeures;
                }
                if (totalCoutSpan) {
                    totalCoutSpan.textContent = formatCurrency(totalCout);
                }
            }
        }

        // Mettre √† jour le calculateur de budget
        function updateBudgetCalculator() {
            let totalPersonnel = 0;
            let totalHeures = 0;
            let totalCoutCollaborateurs = 0;
            
            // Calculer le co√ªt personnel
            Object.values(assignments).forEach(assignment => {
                if (assignment.collaborateurs) {
                    Object.values(assignment.collaborateurs).forEach(collab => {
                        const heures = collab.heures || 0;
                        const cout = collab.cout || 0;
                        totalPersonnel += cout;
                        totalHeures += heures;
                        totalCoutCollaborateurs += cout;
                    });
                }
            });
            
            // Calculer le taux horaire moyen
            const tauxHoraireMoyen = totalHeures > 0 ? totalCoutCollaborateurs / totalHeures : 0;
            
            // Budget total honoraires (seulement les honoraires)
            const budgetTotalHonoraires = financialData.honoraires_montant;
            
            // Marge bas√©e sur les honoraires seulement
            const marge = budgetTotalHonoraires - totalPersonnel;
            
            // Budget total (honoraires + d√©bours)
            const budgetTotal = budgetTotalHonoraires + financialData.debours_montant;
            
            document.getElementById('budget-total').textContent = formatCurrency(budgetTotal);
            document.getElementById('budget-honoraires').textContent = formatCurrency(budgetTotalHonoraires);
            document.getElementById('budget-personnel').textContent = formatCurrency(totalPersonnel);
            document.getElementById('budget-marge').textContent = formatCurrency(marge);
            document.getElementById('budget-heures-total').textContent = totalHeures;
            document.getElementById('budget-taux-moyen').textContent = formatCurrency(tauxHoraireMoyen);
        }

        // Configuration des √©v√©nements
        function setupEventListeners() {
            // Bouton retour
            document.getElementById('btn-prev').addEventListener('click', function() {
                window.location.href = 'create-mission-step3.html';
            });

            // Bouton cr√©er la mission
            document.getElementById('btn-create').addEventListener('click', function() {
                if (validateForm()) {
                    createMission();
                }
            });
        }

        // Validation du formulaire
        function validateForm() {
            if (selectedTasks.length === 0) {
                alert('Veuillez s√©lectionner au moins une t√¢che');
                return false;
            }
            
            // V√©rifier que toutes les t√¢ches obligatoires sont s√©lectionn√©es
            const obligatoryTasks = tasks.filter(t => t.obligatoire).map(t => t.id);
            const selectedObligatoryTasks = obligatoryTasks.filter(id => selectedTasks.includes(id));
            
            if (selectedObligatoryTasks.length !== obligatoryTasks.length) {
                alert('Veuillez s√©lectionner toutes les t√¢ches obligatoires');
                return false;
            }
            
            return true;
        }

        // Cr√©er la mission
        async function createMission() {
            try {
                console.log('üöÄ Cr√©ation de la mission...');
                
                // Pr√©parer les donn√©es de la mission
                const missionPayload = {
                    // Donn√©es de base de la mission
                    code: missionData.code,
                    nom: missionData.nom, // Utiliser 'nom' au lieu de 'titre' pour correspondre √† la base de donn√©es
                    description: missionData.description,
                    client_id: selectedOpportunity.client_id, // Utiliser le client_id de l'opportunit√©
                    opportunity_id: selectedOpportunity.id,
                    mission_type_id: selectedMissionType.id,
                    date_debut: missionData.date_debut,
                    date_fin_prevue: missionData.date_fin_prevue,
                    budget_prevue: missionData.budget_prevue,
                    taux_horaire_moyen: missionData.taux_horaire_moyen,
                    division_id: missionData.division_id,
                    responsable_id: missionData.responsable_id,
                    priorite: missionData.priorite || 'MOYENNE', // Valeur par d√©faut en majuscules
                    statut: missionData.statut || 'PLANIFIEE',
                    notes: missionData.notes,
                    
                    // Configuration financi√®re
                    montant_honoraires: financialData.honoraires_montant,
                    devise: financialData.honoraires_devise, // Devise unifi√©e de la mission
                    description_honoraires: financialData.honoraires_description,
                    montant_debours: financialData.debours_montant,
                    description_debours: financialData.debours_description,
                    conditions_paiement: financialData.conditions_paiement,
                    pourcentage_avance: financialData.pourcentage_avance,
                    
                    // T√¢ches et affectations
                    tasks: selectedTasks.map(taskId => {
                        const task = tasks.find(t => t.id === taskId);
                        const taskAssignment = assignments[taskId] || { collaborateurs: {} };
                        
                        // Convertir les collaborateurs assign√©s en tableau
                        const assignmentsArray = Object.values(taskAssignment.collaborateurs || {}).map(collab => ({
                            collaborateur_id: collab.id,
                            heures_prevues: collab.heures || 0,
                            taux_horaire: collab.taux_horaire || 0,
                            montant_prevue: collab.cout || 0,
                            date_debut: missionData.date_debut,
                            date_fin: missionData.date_fin_prevue,
                            statut: 'planifie'
                        }));
                        
                        return {
                            task_id: taskId,
                            nom: task.libelle,
                            description: task.description || task.libelle,
                            priorite: task.priorite || 'MOYENNE',
                            date_debut_prevue: missionData.date_debut,
                            date_fin_prevue: missionData.date_fin_prevue,
                            heures_prevues: task.duree_estimee || 0,
                            statut: 'en_cours',
                            assignments: assignmentsArray
                        };
                    })
                };
                
                console.log('üì¶ Donn√©es de mission:', missionPayload);
                console.log('üîç D√©tails des donn√©es:', {
                    missionData: missionData,
                    financialData: financialData,
                    selectedOpportunity: selectedOpportunity,
                    selectedMissionType: selectedMissionType
                });
                
                // Appel API pour cr√©er la mission
                const response = await authenticatedFetch('/api/missions', {
                    method: 'POST',
                    body: JSON.stringify(missionPayload)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('‚úÖ Mission cr√©√©e avec succ√®s!', result.data);
                    
                    // Afficher un message de succ√®s
                    alert('Mission cr√©√©e avec succ√®s!');
                    
                    // Rediriger vers la page des missions
                    window.location.href = 'missions.html';
                } else {
                    console.error('‚ùå Erreur lors de la cr√©ation de la mission:', result.error);
                    alert(`Erreur lors de la cr√©ation de la mission: ${result.error}`);
                }
                
            } catch (error) {
                console.error('‚ùå Erreur lors de la cr√©ation de la mission:', error);
                alert('Erreur lors de la cr√©ation de la mission');
            }
        }

        // Fonction utilitaire pour formater les montants
        function formatCurrency(amount, currencyCode = null) {
            if (!amount) {
                if (currencyCode) {
                    return CURRENCY_CONFIG.formatCurrency(0, currencyCode);
                }
                return CURRENCY_CONFIG.formatCurrency(0, 'XAF'); // Devise par d√©faut XAF
            }
            
            // Si une devise sp√©cifique est fournie, l'utiliser
            if (currencyCode) {
                return CURRENCY_CONFIG.formatCurrency(amount, currencyCode);
            }
            
            // Sinon, essayer de r√©cup√©rer la devise depuis financialData
            try {
                const financialDataStr = sessionStorage.getItem('financialData');
                if (financialDataStr) {
                    const financialData = JSON.parse(financialDataStr);
                    // Utiliser la devise des honoraires par d√©faut
                    return CURRENCY_CONFIG.formatCurrency(amount, financialData.honoraires_devise || 'XAF');
                }
            } catch (error) {
                console.warn('Erreur lors de la r√©cup√©ration de la devise:', error);
            }
            
            // Fallback vers XAF par d√©faut
            return CURRENCY_CONFIG.formatCurrency(amount, 'XAF');
        }

        // Fonction utilitaire pour formater les dates
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR');
        }

        // Fonction pour ouvrir le modal de cr√©ation de t√¢che
        function openCreateTaskModal() {
            console.log('üîß Ouverture du modal de cr√©ation de t√¢che');
            console.log('üîß selectedMissionType:', selectedMissionType);
            
            if (!selectedMissionType || !selectedMissionType.id) {
                alert('Erreur: Type de mission non s√©lectionn√©');
                return;
            }
            
            // Pr√©-remplir le type de mission
            document.getElementById('createMissionType').value = selectedMissionType.id;
            document.getElementById('createMissionTypeText').textContent = selectedMissionType.libelle;
            document.getElementById('createMissionTypeDisplay').value = selectedMissionType.libelle;
            
            // R√©initialiser le formulaire
            document.getElementById('createTaskForm').reset();
            document.getElementById('createCode').value = '';
            document.getElementById('createDuree').value = '0';
            document.getElementById('createPriority').value = 'MOYENNE';
            
            // Afficher le modal
            const modal = new bootstrap.Modal(document.getElementById('createTaskModal'));
            modal.show();
        }

        // Fonction pour g√©n√©rer un code de t√¢che
        function generateTaskCode() {
            const libelle = document.getElementById('createLibelle').value;
            if (libelle) {
                let code = libelle
                    .toUpperCase()
                    .replace(/[^A-Z0-9]/g, '')
                    .substring(0, 8);
                
                // S'assurer qu'on a au moins 3 caract√®res
                if (code.length < 3) {
                    code = code + 'TASK';
                }
                
                // Ajouter un timestamp pour l'unicit√©
                const timestamp = Date.now().toString().slice(-3);
                code = code + timestamp;
                
                document.getElementById('createCode').value = code;
            }
        }

        // Fonction pour cr√©er une nouvelle t√¢che
        async function createNewTask() {
            try {
                // Validation des champs requis
                const code = document.getElementById('createCode').value.trim();
                const libelle = document.getElementById('createLibelle').value.trim();
                
                if (!code) {
                    alert('Le code de la t√¢che est requis');
                    document.getElementById('createCode').focus();
                    return;
                }
                
                if (!libelle) {
                    alert('Le libell√© de la t√¢che est requis');
                    document.getElementById('createLibelle').focus();
                    return;
                }
                
                if (!selectedMissionType || !selectedMissionType.id) {
                    console.error('‚ùå selectedMissionType manquant:', selectedMissionType);
                    alert('Erreur: Type de mission non s√©lectionn√©. Veuillez retourner √† l\'√©tape 1.');
                    return;
                }
                
                const formData = {
                    code: code,
                    libelle: libelle,
                    description: document.getElementById('createDescription').value,
                    duree_estimee: parseFloat(document.getElementById('createDuree').value) || 0,
                    priorite: document.getElementById('createPriority').value,
                    mission_type_id: selectedMissionType.id,
                    obligatoire: false // Les nouvelles t√¢ches sont toujours optionnelles
                };

                console.log('üìù Cr√©ation de nouvelle t√¢che:', formData);

                // V√©rifier l'authentification
                const token = localStorage.getItem('authToken');
                console.log('üîë Token pr√©sent:', !!token);
                if (!token) {
                    alert('Erreur: Token d\'authentification manquant. Veuillez vous reconnecter.');
                    return;
                }

                const response = await authenticatedFetch('/api/tasks', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });

                console.log('üì° R√©ponse brute:', response);
                console.log('üì° Status:', response.status);
                console.log('üì° Headers:', response.headers);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Erreur HTTP:', response.status, errorText);
                    alert(`Erreur HTTP ${response.status}: ${errorText}`);
                    return;
                }

                const result = await response.json();
                console.log('üì° R√©sultat pars√©:', result);
                console.log('üì° Type de result:', typeof result);
                console.log('üì° Cl√©s de result:', Object.keys(result));
                console.log('üì° result.success:', result.success);
                console.log('üì° result.data:', result.data);

                // V√©rifier si la cr√©ation a r√©ussi (format standard ou direct)
                if ((result.success && result.data) || (result.id && result.code)) {
                    const taskData = result.data || result;
                    console.log('‚úÖ T√¢che cr√©√©e avec succ√®s:', taskData);
                    
                    // Fermer le modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('createTaskModal'));
                    modal.hide();
                    
                    // Recharger les t√¢ches
                    await loadTasks();
                    
                    // Afficher un message de succ√®s
                    alert('T√¢che cr√©√©e avec succ√®s! Elle est maintenant disponible pour s√©lection.');
                } else {
                    console.error('‚ùå Erreur lors de la cr√©ation de la t√¢che:', result);
                    alert(`Erreur lors de la cr√©ation de la t√¢che: ${result.error || 'Erreur inconnue'}`);
                }
            } catch (error) {
                console.error('‚ùå Erreur lors de la cr√©ation de la t√¢che:', error);
                console.error('‚ùå Stack trace:', error.stack);
                alert(`Erreur lors de la cr√©ation de la t√¢che: ${error.message}`);
            }
        }
    </script>

    <!-- Modal de cr√©ation de t√¢che -->
    <div class="modal fade" id="createTaskModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plus me-2"></i>Cr√©er une nouvelle t√¢che
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createTaskForm">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Division:</strong> <span id="createMissionTypeText">Chargement...</span>
                            <br>
                            <small>Cette t√¢che sera cr√©√©e pour la division de la mission et sera automatiquement optionnelle.</small>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="createCode" class="form-label">Code *</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="createCode" required readonly>
                                        <button type="button" class="btn btn-outline-secondary" onclick="generateTaskCode()">
                                            <i class="fas fa-magic"></i>
                                        </button>
                                    </div>
                                    <small class="form-text text-muted">G√©n√©r√© automatiquement √† partir du libell√©</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="createPriority" class="form-label">Priorit√©</label>
                                    <select class="form-select" id="createPriority">
                                        <option value="MOYENNE">Moyenne</option>
                                        <option value="BASSE">Basse</option>
                                        <option value="HAUTE">Haute</option>
                                        <option value="CRITIQUE">Critique</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="createLibelle" class="form-label">Libell√© *</label>
                            <input type="text" class="form-control" id="createLibelle" required 
                                   oninput="generateTaskCode()">
                        </div>
                        
                        <div class="mb-3">
                            <label for="createDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="createDescription" rows="3" 
                                      placeholder="Description d√©taill√©e de la t√¢che..."></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="createDuree" class="form-label">Dur√©e estim√©e (heures)</label>
                                    <input type="number" class="form-control" id="createDuree" min="0" step="0.5" value="0">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Type de mission</label>
                                    <input type="hidden" id="createMissionType" value="">
                                    <input type="text" class="form-control" id="createMissionTypeDisplay" value="" readonly>
                                    <small class="form-text text-muted">Associ√©e automatiquement au type de mission de cette cr√©ation</small>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="createNewTask()">
                        <i class="fas fa-save me-2"></i>Cr√©er la t√¢che
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html> 