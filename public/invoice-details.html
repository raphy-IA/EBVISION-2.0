<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Détails Facture</title>

    <!-- CSS Bootstrap et FontAwesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/vendor/fontawesome/css/all.min.css" rel="stylesheet">

    <!-- CSS de la sidebar moderne -->
    <link rel="stylesheet" href="css/modern-sidebar.css">


    <style>
        .invoice-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-brouillon {
            background-color: #6c757d;
            color: white;
        }

        .status-emise {
            background-color: #17a2b8;
            color: white;
        }

        .status-payee {
            background-color: #28a745;
            color: white;
        }

        .status-annulee {
            background-color: #dc3545;
            color: white;
        }

        .status-en_attente_validation {
            background-color: #fd7e14;
            color: white;
        }

        .status-en_attente_approbation {
            background-color: #0dcaf0;
            color: white;
        }

        .status-en_attente_emission {
            background-color: #0d6efd;
            color: white;
        }

        .main-content-area {
            flex-grow: 1;
            padding: 20px;
            min-height: 100vh;
            background-color: #f8f9fa;
        }

        /* Timeline Styles */
        .timeline {
            border-left: 2px solid #e9ecef;
            margin-left: 15px;
            padding-left: 30px;
            position: relative;
        }

        .timeline-item {
            margin-bottom: 1.5rem;
            position: relative;
        }

        .timeline-badge {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            position: absolute;
            left: -39px;
            top: 4px;
            background-color: #e9ecef;
            border: 2px solid #fff;
            box-shadow: 0 0 0 1px #dee2e6;
            z-index: 1;
        }

        .timeline-date {
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 2px;
        }

        .timeline-title {
            font-weight: 600;
            color: #343a40;
            margin-bottom: 4px;
        }

        .timeline-user {
            font-size: 0.9rem;
            color: #495057;
        }

        /* Badge Colors */
        .badge-success {
            background-color: #28a745;
        }

        .badge-info {
            background-color: #17a2b8;
        }

        .badge-warning {
            background-color: #ffc107;
        }

        .badge-danger {
            background-color: #dc3545;
        }

        .badge-primary {
            background-color: #0d6efd;
        }

        .badge-secondary {
            background-color: #6c757d;
        }

        /* Garantir l'agencement côte à côte sidebar + contenu */
        .page-wrapper {
            display: flex;
            min-height: 100vh;
        }

        .sidebar-container {
            width: 300px;
            flex-shrink: 0;
        }
    </style>
    <!-- Scripts pour la top bar EBVISION 2.0 -->



    <!-- Script pour la gestion utilisateur -->
    <script src="js/user-header.js"></script>
    <script src="js/menu-permissions.js"></script>
    <script src="/js/page-permissions.js"></script>
    <script src="js/profile-menu.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/tasks.js"></script>

    <!-- CSS des variables de branding dynamiques -->
    <link rel="stylesheet" href="/config/themes/brand-variables.css">

    <!-- Scripts de branding -->
    <script src="js/branding-loader.js"></script>
    <script src="js/sidebar-branding.js"></script>
</head>

<body>
    <!-- Bouton toggle sidebar mobile -->
    <button class="sidebar-toggle d-md-none">
        <i class="fas fa-bars"></i>
    </button>
    <div class="page-wrapper">
        <!-- Sidebar unifiée -->
        <div class="sidebar-container"></div>

        <!-- Zone de contenu principale -->
        <div class="main-content-area">
            <div class="container-fluid">
                <!-- Contenu existant -->

                <div class="row">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div>
                                <h2 id="invoiceTitle">Détails de la facture</h2>
                                <p class="text-muted" id="invoiceSubtitle">Chargement...</p>
                            </div>
                            <div>
                                <div id="workflowActions" class="d-inline-block me-2">
                                    <!-- Boutons injectés par JS -->
                                </div>
                                <button class="btn btn-outline-secondary me-2" onclick="goBack()">
                                    <i class="fas fa-arrow-left me-2"></i>Retour
                                </button>
                                <button class="btn btn-primary" onclick="printInvoice()">
                                    <i class="fas fa-print me-2"></i>Imprimer
                                </button>
                            </div>
                        </div>

                        <!-- Informations de la facture -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5>Informations générales</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>Numéro:</strong> <span id="invoiceNumber">...</span></p>
                                        <p><strong>Statut:</strong> <span id="invoiceStatus">...</span></p>
                                        <p><strong>Date d'émission:</strong> <span id="invoiceEmissionDate">...</span>
                                        </p>
                                        <p><strong>Date d'échéance:</strong> <span id="invoiceDueDate">...</span></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Client:</strong> <span id="invoiceClient">...</span></p>
                                        <p><strong>Mission:</strong> <span id="invoiceMission">...</span></p>
                                        <p><strong>Unité d'affaires:</strong> <span id="invoiceBU">...</span></p>
                                        <p><strong>TVA:</strong> <span id="invoiceTVARate">...</span></p>
                                        <p><strong>Créé par:</strong> <span id="invoiceCreatedBy">...</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Montants -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h6>Montant HT</h6>
                                        <h4 id="invoiceHT">...</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h6>Montant TVA</h6>
                                        <h4 id="invoiceTVAAmount">...</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h6>Montant TTC</h6>
                                        <h4 id="invoiceTTC">...</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h6>Montant payé</h6>
                                        <h4 id="invoicePaid">...</h4>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Onglets -->
                        <ul class="nav nav-tabs" id="invoiceTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="items-tab" data-bs-toggle="tab"
                                    data-bs-target="#items" type="button" role="tab">
                                    <i class="fas fa-list me-2"></i>Lignes de facture
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="payments-tab" data-bs-toggle="tab"
                                    data-bs-target="#payments" type="button" role="tab">
                                    <i class="fas fa-credit-card me-2"></i>Paiements
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history"
                                    type="button" role="tab">
                                    <i class="fas fa-history me-2"></i>Historique
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content" id="invoiceTabContent">
                            <!-- Onglet Lignes de facture -->
                            <div class="tab-pane fade show active" id="items" role="tabpanel">
                                <div class="card mt-3">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">
                                            <i class="fas fa-list"></i> Lignes de facture
                                        </h5>
                                        <div>
                                            <button class="btn btn-sm btn-outline-primary" onclick="addInvoiceItem()">
                                                <i class="fas fa-plus"></i> Ajouter une ligne
                                            </button>
                                            <button class="btn btn-sm btn-outline-secondary"
                                                onclick="regenerateItems()">
                                                <i class="fas fa-sync"></i> Régénérer depuis la mission
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div id="invoiceItems">Chargement des lignes...</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Onglet Paiements -->
                            <div class="tab-pane fade" id="payments" role="tabpanel">
                                <div class="card mt-3">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">
                                            <i class="fas fa-credit-card"></i> Paiements
                                        </h5>
                                        <!-- Bouton ajouter retiré car géré via le module Paiements -->
                                    </div>
                                    <div class="card-body">
                                        <div id="invoicePayments">Chargement des paiements...</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Onglet Historique -->
                            <div class="tab-pane fade" id="history" role="tabpanel">
                                <div class="card mt-3">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="fas fa-history"></i> Historique des actions</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="timeline" id="invoiceTimeline">
                                            <!-- Timeline content generated by JS -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour ajouter/modifier une ligne -->
    <div class="modal fade" id="itemModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="itemModalTitle">Ajouter une ligne</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="itemForm">
                        <input type="hidden" id="itemId">
                        <div class="mb-3">
                            <label for="itemDescription" class="form-label">Description</label>
                            <input type="text" class="form-control" id="itemDescription" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="itemQuantity" class="form-label">Quantité</label>
                                    <input type="number" class="form-control" id="itemQuantity" value="1" min="0"
                                        step="0.01" required>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="itemUnit" class="form-label">Unité</label>
                                        <select class="form-control" id="itemUnit">
                                            <option value="heure">Heure</option>
                                            <option value="jour">Jour</option>
                                            <option value="forfait">Forfait</option>
                                            <option value="piece">Pièce</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="itemUnitPrice" class="form-label">Prix unitaire</label>
                                        <input type="number" class="form-control" id="itemUnitPrice" min="0" step="0.01"
                                            required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="itemTaxRate" class="form-label">Taux TVA (%)</label>
                                        <input type="number" class="form-control" id="itemTaxRate" value="19.25" min="0"
                                            step="0.01" required>
                                    </div>
                                </div>
                            </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="saveInvoiceItem()">Enregistrer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour rejet -->
    <div class="modal fade" id="rejectModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Motif du rejet</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Motif du rejet</label>
                        <textarea class="form-control" id="rejectReason" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-danger" onclick="confirmReject()">Rejeter</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/auth.js" defer></script>
    <script src="/js/sidebar.js" defer></script>
    <script>
        let currentInvoice = null;
        let invoiceId = null;

        // Fonction utilitaire pour les appels API authentifiés
        async function authenticatedFetch(url, options = {}) {
            const token = localStorage.getItem('authToken');
            const defaultHeaders = {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };

            return fetch(url, {
                ...options,
                headers: {
                    ...defaultHeaders,
                    ...options.headers
                }
            });
        }

        // Fonction utilitaire pour formater les montants
        function formatCurrency(amount, currency = 'XAF') {
            return new Intl.NumberFormat('fr-FR', {
                style: 'currency',
                currency: currency
            }).format(amount || 0);
        }

        // Fonction utilitaire pour formater les dates
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString('fr-FR');
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URLSearchParams(window.location.search);
            invoiceId = urlParams.get('id');

            if (invoiceId) {
                loadInvoiceDetails(invoiceId);
            } else {
                showError('ID de facture manquant');
            }
        });

        // Bouton retour robuste
        function goBack() {
            try {
                if (document.referrer && document.referrer !== '' && document.referrer.indexOf(window.location.hostname) !== -1) {
                    window.history.back();
                } else {
                    window.location.href = '/invoices.html';
                }
            } catch (e) {
                window.location.href = '/invoices.html';
            }
        }

        // Chargement des détails de la facture
        async function loadInvoiceDetails(id) {
            try {
                const response = await authenticatedFetch(`/api/invoices/${id}`);
                if (response.ok) {
                    const data = await response.json();
                    currentInvoice = data.data;
                    displayInvoiceDetails();
                    await renderHistory(currentInvoice);
                } else {
                    showError('Erreur lors du chargement de la facture');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showError('Erreur de connexion');
            }
        }

        // Affichage des détails de la facture
        function displayInvoiceDetails() {
            if (!currentInvoice) return;

            // Titre et sous-titre
            document.getElementById('invoiceTitle').textContent = `Facture ${currentInvoice.numero_facture}`;
            document.getElementById('invoiceSubtitle').textContent = `Créée le ${formatDate(currentInvoice.created_at)}`;

            // Informations générales
            document.getElementById('invoiceNumber').textContent = currentInvoice.numero_facture;
            document.getElementById('invoiceStatus').innerHTML = `<span class="badge status-${currentInvoice.statut.toLowerCase()}">${currentInvoice.statut}</span>`;
            document.getElementById('invoiceEmissionDate').textContent = formatDate(currentInvoice.date_emission);
            document.getElementById('invoiceDueDate').textContent = formatDate(currentInvoice.date_echeance);
            document.getElementById('invoiceClient').textContent = currentInvoice.client_nom || 'N/A';
            document.getElementById('invoiceMission').textContent = currentInvoice.mission_nom || 'N/A';
            document.getElementById('invoiceBU').textContent = currentInvoice.business_unit_nom || currentInvoice.business_unit_code || 'N/A';
            document.getElementById('invoiceTVARate').textContent = `${currentInvoice.taux_tva}%`;
            document.getElementById('invoiceCreatedBy').textContent = currentInvoice.created_by_prenom ?
                `${currentInvoice.created_by_prenom} ${currentInvoice.created_by_nom}` : 'N/A';

            // Montants
            document.getElementById('invoiceHT').textContent = formatCurrency(currentInvoice.montant_ht);
            document.getElementById('invoiceTVAAmount').textContent = formatCurrency(currentInvoice.montant_tva);
            document.getElementById('invoiceTTC').textContent = formatCurrency(currentInvoice.montant_ttc);
            document.getElementById('invoicePaid').textContent = formatCurrency(currentInvoice.montant_paye);

            // Charger les lignes et paiements
            displayInvoiceItems();
            displayInvoicePayments();

            // Mise à jour de l'UI selon le workflow
            updateWorkflowUI();
        }

        function updateWorkflowUI() {
            const actionsDiv = document.getElementById('workflowActions');
            const status = currentInvoice.statut;
            let buttons = '';

            // TODO: Ajouter vérification des rôles ici si nécessaire via user.roles

            if (status === 'BROUILLON') {
                buttons += `
                    <button class="btn btn-success me-2" onclick="updateWorkflow('submit')">
                        <i class="fas fa-paper-plane me-2"></i>Soumettre
                    </button>
                `;
            } else if (status === 'EN_ATTENTE_VALIDATION') {
                buttons += `
                    <button class="btn btn-success me-2" onclick="updateWorkflow('validate')">
                        <i class="fas fa-check me-2"></i>Valider
                    </button>
                    <button class="btn btn-danger me-2" onclick="openRejectModal()">
                        <i class="fas fa-times me-2"></i>Rejeter
                    </button>
                `;
            } else if (status === 'EN_ATTENTE_APPROBATION') {
                buttons += `
                    <button class="btn btn-success me-2" onclick="updateWorkflow('approve')">
                        <i class="fas fa-check-double me-2"></i>Approuver
                    </button>
                    <button class="btn btn-danger me-2" onclick="openRejectModal()">
                        <i class="fas fa-times me-2"></i>Rejeter
                    </button>
                `;
            } else if (status === 'EN_ATTENTE_EMISSION') {
                buttons += `
                    <button class="btn btn-primary me-2" onclick="updateWorkflow('emit')">
                        <i class="fas fa-file-invoice me-2"></i>Émettre
                    </button>
                `;
            }

            actionsDiv.innerHTML = buttons;

            // Verrouillage UI si pas brouillon
            const isEditable = status === 'BROUILLON';

            // Masquer boutons d'édition/ajout
            if (!isEditable) {
                const addBtns = document.querySelectorAll('button[onclick^="add"], button[onclick^="edit"], button[onclick^="delete"], button[onclick^="regenerate"]');
                addBtns.forEach(btn => btn.style.display = 'none');

                // Exception: le bouton edit n'existe pas en tant que tel au niveau global, 
                // mais on désactive les actions sur les lignes.
                // Note: La suppression de paiement (désallocation) reste possible même après émission
                // car cela concerne la gestion des paiements, pas le contenu de la facture elle-même.
                // MAIS si on veut strict :
                // const unallocBtns = document.querySelectorAll('button[onclick^="deletePayment"]');
                // unallocBtns.forEach(btn => btn.style.display = 'none'); 
            }
        }

        async function updateWorkflow(action, body = {}) {
            if (!confirm(`Confirmer l'action : ${action} ?`)) return;

            try {
                const response = await authenticatedFetch(`/api/invoices/${invoiceId}/workflow/${action}`, {
                    method: 'POST',
                    body: JSON.stringify(body)
                });

                if (response.ok) {
                    const data = await response.json();
                    alert(data.message);
                    await loadInvoiceDetails(invoiceId);
                } else {
                    const error = await response.json();
                    showError(error.error || 'Erreur workflow');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showError('Erreur de connexion');
            }
        }

        function openRejectModal() {
            new bootstrap.Modal(document.getElementById('rejectModal')).show();
        }

        async function confirmReject() {
            const reason = document.getElementById('rejectReason').value;
            if (!reason) {
                alert('Le motif est obligatoire');
                return;
            }

            await updateWorkflow('reject', { reason });
            bootstrap.Modal.getInstance(document.getElementById('rejectModal')).hide();
        }

        // Affichage des lignes de facture
        function displayInvoiceItems() {
            if (!currentInvoice.items || currentInvoice.items.length === 0) {
                document.getElementById('invoiceItems').innerHTML = `
                    <div class="text-muted">
                        <i class="fas fa-info-circle me-2"></i>
                        Aucune ligne de facture trouvée
                    </div>
                `;
                return;
            }

            const itemsHtml = `
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Quantité</th>
                                <th>Budget</th>
                                <th>Montant HT</th>
                                <th>TVA</th>
                                <th>Montant TTC</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${currentInvoice.items.map(item => `
                                <tr>
                                    <td>${item.description}</td>
                                    <td>${item.quantite && !isNaN(item.quantite)
                    ? (item.quantite < 1
                        // FEES template: afficher en pourcentage
                        ? (Number.isInteger(parseFloat(item.quantite * 100))
                            ? parseInt(item.quantite * 100)
                            : parseFloat(item.quantite * 100).toFixed(2)) + '%'
                        // STANDARD template: afficher quantité normale
                        : (Number.isInteger(parseFloat(item.quantite))
                            ? parseInt(item.quantite)
                            : parseFloat(item.quantite).toFixed(2)) + ' ' + (item.unite || 'unité'))
                    : item.quantite
                }</td>
                                    <td>${formatCurrency(item.prix_unitaire)}</td>
                                    <td>${formatCurrency(item.montant_ht)}</td>
                                    <td>${formatCurrency(item.montant_tva)}</td>
                                    <td>${formatCurrency(item.montant_ttc)}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" onclick="editInvoiceItem('${item.id}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteInvoiceItem('${item.id}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('invoiceItems').innerHTML = itemsHtml;
        }

        // Affichage des paiements
        function displayInvoicePayments() {
            if (!currentInvoice.payments || currentInvoice.payments.length === 0) {
                document.getElementById('invoicePayments').innerHTML = `
                    <div class="text-muted">
                        <i class="fas fa-info-circle me-2"></i>
                        Aucun paiement enregistré
                    </div>
                `;
                return;
            }

            const paymentsHtml = `
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Montant Alloué</th>
                                <th>Mode</th>
                                <th>Référence</th>
                                <th>Notes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${currentInvoice.payments.map(payment => `
                                <tr>
                                    <td>${formatDate(payment.payment_date)}</td>
                                    <td>${formatCurrency(payment.montant)}</td>
                                    <td><span class="badge bg-secondary">${payment.payment_mode}</span></td>
                                    <td>${payment.reference || 'N/A'}</td>
                                    <td>${payment.notes || ''}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deletePayment('${payment.id}')" title="Désallouer">
                                            <i class="fas fa-unlink"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('invoicePayments').innerHTML = paymentsHtml;
        }

        // Fonction pour imprimer la facture
        function printInvoice() {
            window.print();
        }

        // Fonction pour afficher les erreurs
        function showError(message) {
            alert(message);
        }

        // Fonction pour ajouter une ligne de facture
        function addInvoiceItem() {
            document.getElementById('itemModalTitle').textContent = 'Ajouter une ligne';
            document.getElementById('itemId').value = '';
            document.getElementById('itemDescription').value = '';
            document.getElementById('itemQuantity').value = '1';
            document.getElementById('itemUnit').value = 'forfait';
            document.getElementById('itemUnitPrice').value = '';
            document.getElementById('itemTaxRate').value = '19.25';

            const modal = new bootstrap.Modal(document.getElementById('itemModal'));
            modal.show();
        }

        // Fonction pour éditer une ligne de facture
        function editInvoiceItem(itemId) {
            const item = currentInvoice.items.find(i => i.id === itemId);
            if (!item) return;

            document.getElementById('itemModalTitle').textContent = 'Modifier une ligne';
            document.getElementById('itemId').value = item.id;
            document.getElementById('itemDescription').value = item.description;
            document.getElementById('itemQuantity').value = item.quantite;
            document.getElementById('itemUnit').value = item.unite;
            document.getElementById('itemUnitPrice').value = item.prix_unitaire;
            document.getElementById('itemTaxRate').value = item.taux_tva;

            const modal = new bootstrap.Modal(document.getElementById('itemModal'));
            modal.show();
        }

        // Fonction pour sauvegarder une ligne de facture
        async function saveInvoiceItem() {
            const itemId = document.getElementById('itemId').value;
            const itemData = {
                description: document.getElementById('itemDescription').value,
                quantite: parseFloat(document.getElementById('itemQuantity').value),
                unite: document.getElementById('itemUnit').value,
                prix_unitaire: parseFloat(document.getElementById('itemUnitPrice').value),
                taux_tva: parseFloat(document.getElementById('itemTaxRate').value)
            };

            try {
                let response;
                if (itemId) {
                    // Modification
                    response = await authenticatedFetch(`/api/invoices/${invoiceId}/items/${itemId}`, {
                        method: 'PUT',
                        body: JSON.stringify(itemData)
                    });
                } else {
                    // Ajout
                    response = await authenticatedFetch(`/api/invoices/${invoiceId}/items`, {
                        method: 'POST',
                        body: JSON.stringify(itemData)
                    });
                }

                if (response.ok) {
                    // Fermer le modal et recharger les données
                    const modal = bootstrap.Modal.getInstance(document.getElementById('itemModal'));
                    modal.hide();
                    await loadInvoiceDetails(invoiceId);
                } else {
                    const errorData = await response.json();
                    showError(`Erreur: ${errorData.error}`);
                }
            } catch (error) {
                console.error('Erreur:', error);
                showError('Erreur de connexion');
            }
        }

        // Fonction pour supprimer une ligne de facture
        async function deleteInvoiceItem(itemId) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer cette ligne ?')) {
                return;
            }

            try {
                const response = await authenticatedFetch(`/api/invoices/${invoiceId}/items/${itemId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    await loadInvoiceDetails(invoiceId);
                } else {
                    const errorData = await response.json();
                    showError(`Erreur: ${errorData.error}`);
                }
            } catch (error) {
                console.error('Erreur:', error);
                showError('Erreur de connexion');
            }
        }

        async function renderHistory(invoice) {
            const container = document.getElementById('invoiceTimeline');
            let events = [];

            // 1. Creation
            if (invoice.created_at) {
                events.push({
                    date: new Date(invoice.created_at),
                    title: 'Facture Créée',
                    user: `${invoice.created_by_prenom || ''} ${invoice.created_by_nom || ''}`.trim() || 'Système',
                    color: 'secondary',
                    icon: 'fa-file-invoice'
                });
            }

            // 2. Soumission
            if (invoice.submitted_for_validation_at) {
                events.push({
                    date: new Date(invoice.submitted_for_validation_at),
                    title: 'Soumise pour Validation',
                    user: `${invoice.submitted_by_prenom || ''} ${invoice.submitted_by_nom || ''}`.trim(),
                    color: 'warning',
                    icon: 'fa-paper-plane'
                });
            }

            // 3. Validation
            if (invoice.validated_at) {
                events.push({
                    date: new Date(invoice.validated_at),
                    title: 'Validée (Prête pour Approbation)',
                    user: `${invoice.validated_by_prenom || ''} ${invoice.validated_by_nom || ''}`.trim(),
                    color: 'info',
                    icon: 'fa-check'
                });
            }

            // 4. Approbation (Emission Validated)
            if (invoice.emission_validated_at) {
                events.push({
                    date: new Date(invoice.emission_validated_at),
                    title: 'Approuvée (Prête pour Émission)',
                    user: `${invoice.approved_by_prenom || ''} ${invoice.approved_by_nom || ''}`.trim(),
                    color: 'primary',
                    icon: 'fa-check-double'
                });
            }

            // 5. Emission
            if (invoice.emitted_at) {
                events.push({
                    date: new Date(invoice.emitted_at),
                    title: 'Émise',
                    user: `${invoice.emitted_by_prenom || ''} ${invoice.emitted_by_nom || ''}`.trim(),
                    color: 'success',
                    icon: 'fa-envelope'
                });
            }

            // 6. Rejet (Dernier)
            if (invoice.rejected_at) {
                events.push({
                    date: new Date(invoice.rejected_at),
                    title: 'Rejetée',
                    user: `${invoice.rejected_by_prenom || ''} ${invoice.rejected_by_nom || ''}`.trim(),
                    color: 'danger',
                    icon: 'fa-times-circle',
                    notes: `Motif: ${invoice.rejection_reason}`
                });
            }

            // 7. Paiements (Fetch via API)
            try {
                // Utiliser l'API payments existante ou celle des factures
                const pRes = await authenticatedFetch(`/api/billing/invoices/${invoice.id}/payments`);
                // Note: Vérifier si cette route existe ou utiliser /api/payments?invoice_id=...
                // Si la route n'existe pas, on tente via la collection payments
                if (pRes.ok) {
                    const pData = await pRes.json();
                    const payments = pData.data || [];
                    payments.forEach(p => {
                        events.push({
                            date: new Date(p.date_paiement),
                            title: `Paiement Reçu (${formatCurrency(p.montant)})`,
                            user: 'Comptabilité',
                            color: 'success',
                            icon: 'fa-money-bill-wave'
                        });
                    });
                }
            } catch (e) { console.warn('Erreur historique paiements', e); }

            // Trier par date décroissante
            events.sort((a, b) => b.date - a.date);

            // Render
            if (events.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">Aucun historique disponible.</p>';
                return;
            }

            container.innerHTML = events.map(e => `
                <div class="timeline-item">
                    <div class="timeline-badge badge-${e.color}"></div>
                    <div class="timeline-content">
                        <div class="timeline-date">${e.date.toLocaleString('fr-FR')}</div>
                        <div class="timeline-title">${e.title}</div>
                        <div class="timeline-user"><i class="fas fa-user-circle"></i> ${e.user}</div>
                        ${e.notes ? `<div class="text-danger small mt-1">${e.notes}</div>` : ''}
                    </div>
                </div>
             `).join('');
        }

        // Fonction pour régénérer les lignes depuis la mission
        async function regenerateItems() {
            if (!confirm('Cela va remplacer toutes les lignes actuelles. Continuer ?')) {
                return;
            }

            try {
                const response = await authenticatedFetch(`/api/invoices/${invoiceId}/generate-items`, {
                    method: 'POST'
                });

                if (response.ok) {
                    await loadInvoiceDetails(invoiceId);
                    alert('Lignes régénérées avec succès !');
                } else {
                    const errorData = await response.json();
                    showError(`Erreur: ${errorData.error}`);
                }
            } catch (error) {
                console.error('Erreur:', error);
                showError('Erreur de connexion');
            }
        }

        // Fonction pour désallouer un paiement
        async function deletePayment(paymentId) {
            if (!confirm('Voulez-vous vraiment désallouer ce paiement de la facture ?\n(Le paiement restera disponible dans la liste globale)')) {
                return;
            }

            try {
                const response = await authenticatedFetch(`/api/invoices/${invoiceId}/payments/${paymentId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    await loadInvoiceDetails(invoiceId);
                } else {
                    const errorData = await response.json();
                    showError(`Erreur: ${errorData.error}`);
                }
            } catch (error) {
                console.error('Erreur:', error);
                showError('Erreur de connexion');
            }
        }
    </script>

    <!-- SessionManager pour la gestion centralisée des sessions -->
    <script src="js/session-manager.js"></script>
</body>

</html>