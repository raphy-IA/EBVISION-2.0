<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Opportunit√©s - EBVISION 2.0</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/modern-sidebar.css">
    
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #f8f9fa;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            overflow-x: hidden; /* Emp√™che le d√©filement horizontal */
        }
        
        /* Le conteneur principal de la page qui contient la sidebar et le contenu */
        .page-wrapper {
            display: flex;
            min-height: 100vh;
        }

        /* Styles pour le contenu principal */
        .main-content-area {
            flex-grow: 1; /* Prend l'espace restant */
            padding: 2rem;
            background-color: var(--light-bg);
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .stat-card.success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .stat-card.warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .stat-card.info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
        }
        
        .table thead th {
            background-color: var(--primary-color);
            color: white;
        }
        
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-saisie { background-color: #e3f2fd; color: #1976d2; }
        .status-soumise { background-color: #fff3e0; color: #f57c00; }
        .status-validee { background-color: #e8f5e8; color: #388e3c; }
        .status-rejetee { background-color: #ffebee; color: #d32f2f; }
        
        .collaborateur-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8rem;
        }
        
        .progress {
            background-color: #f8f9fa;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-bar {
            transition: width 0.3s ease;
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        .table td {
            vertical-align: middle;
            padding: 0.75rem;
        }
        
        .table th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
        }
        
        .btn-group-sm .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        /* Styles pour le modal d'opportunit√© */
        .opportunity-steps {
            display: flex;
            justify-content: center;
            align-items: center;
            background: #f8f9fa;
            padding: 1rem;
            border-bottom: 1px solid #dee2e6;
        }

        .step {
            display: flex;
            align-items: center;
            margin: 0 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .step.active {
            color: var(--primary-color);
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e9ecef;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 0.5rem;
            transition: all 0.3s ease;
        }

        .step.active .step-number {
            background: var(--primary-color);
            color: white;
        }

        .step-label {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .step-content {
            display: none;
            padding: 2rem;
        }

        .step-content.active {
            display: block;
        }

        .form-section {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary-color);
        }

        .section-title {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .info-panel, .summary-panel {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
            height: fit-content;
        }

        .panel-title {
            font-weight: 600;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .tip-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
        }

        .tip-item i {
            margin-right: 0.5rem;
            font-size: 0.8rem;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .summary-item:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .probability-slider-container {
            position: relative;
            padding: 1rem 0;
        }

        .form-range {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #e9ecef;
            outline: none;
            -webkit-appearance: none;
        }

        .form-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
        }

        .probability-display {
            text-align: center;
            margin-top: 0.5rem;
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--primary-color);
        }

        .validation-summary {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .validation-item {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 8px;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .validation-item.valid {
            background: #d4edda;
            color: #155724;
        }

        .validation-item.valid i {
            color: #28a745 !important;
        }

        .validation-item i {
            margin-right: 0.75rem;
            font-size: 1.1rem;
        }

        .form-control-lg, .form-select-lg {
            font-size: 1rem;
            padding: 0.75rem 1rem;
        }

        .input-group-lg .form-control,
        .input-group-lg .form-select {
            font-size: 1rem;
            padding: 0.75rem 1rem;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Styles sp√©cifiques pour la sidebar (si non g√©r√©s par modern-sidebar.css) */
        .sidebar-container {
            width: 300px; /* Largeur fixe pour la sidebar */
            flex-shrink: 0; /* Emp√™che la sidebar de r√©tr√©cir */
        }

        /* Ajustements pour les petits √©crans */
        @media (max-width: 768px) {
            .page-wrapper {
                flex-direction: column; /* Empile la sidebar et le contenu */
            }
            .sidebar-container {
                width: 100%; /* La sidebar prend toute la largeur */
                height: auto; /* Hauteur automatique */
            }
            .main-content-area {
                padding: 1rem;
            }
        }
    
        /* Styles pour la sidebar unifi√©e */
        .main-content-wrapper {
            margin-left: 300px;
            transition: margin-left 0.3s ease;
            min-height: 100vh;
            padding: 0;
        }
        
        .main-content {
            padding: 2rem;
        }
        
        @media (max-width: 768px) {
            .main-content-wrapper {
                margin-left: 0;
            }
            
            .sidebar-container {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .sidebar-container.open {
                transform: translateX(0);
            }
            
            .main-content {
                padding: 1rem;
            }
        }
    </style>
    <!-- Scripts pour la top bar EBVISION 2.0 -->
    
    
    
    <!-- Script pour la gestion utilisateur -->
    <script src="js/user-header.js"></script>
    <script src="js/profile-menu.js"></script>
</head>
<body>
    <div class="page-wrapper">
        <div class="sidebar-container">
            </div>

        <div class="main-content-area">
            <div id="opportunities-section">
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <h2><i class="fas fa-lightbulb me-2"></i>Gestion des Opportunit√©s</h2>
                            <button class="btn btn-primary" onclick="newOpportunity()">
                                <i class="fas fa-plus me-1"></i>
                                Nouvelle Opportunit√©
                            </button>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <div class="card stat-card">
                            <div class="card-body text-center">
                                <h3 class="text-white" id="total-opportunities">0</h3>
                                <p class="text-white mb-0">Total Opportunit√©s</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card stat-card success">
                            <div class="card-body text-center">
                                <h3 class="text-white" id="open-opportunities">0</h3>
                                <p class="text-white mb-0">Ouvertes</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card stat-card warning">
                            <div class="card-body text-center">
                                <h3 class="text-white" id="won-opportunities">0</h3>
                                <p class="text-white mb-0">Gagn√©es</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card stat-card danger">
                            <div class="card-body text-center">
                                <h3 class="text-white" id="lost-opportunities">0</h3>
                                <p class="text-white mb-0">Perdues</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <input type="text" class="form-control" 
                                       id="search-input" placeholder="Rechercher par nom, client..."
                                       onkeyup="filterOpportunities()">
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" id="status-filter" onchange="filterOpportunities()">
                                    <option value="">Tous les statuts</option>
                                    <option value="EN_COURS">En Cours</option>
                                    <option value="GAGNEE">Gagn√©e</option>
                                    <option value="PERDUE">Perdue</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" id="business-unit-filter" onchange="filterOpportunities()">
                                    <option value="">Toutes les BU</option>
                                </select>
                        </div>
                            <div class="col-md-2">
                                <select class="form-select" id="type-filter" onchange="filterOpportunities()">
                                    <option value="">Tous les types</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" id="probability-filter" onchange="filterOpportunities()">
                                    <option value="">Toutes probabilit√©s</option>
                                    <option value="high">√âlev√©e (80%+)</option>
                                    <option value="medium">Moyenne (40-79%)</option>
                                    <option value="low">Faible (<40%)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-list me-2"></i>
                            Liste des Opportunit√©s
                        </h5>
                        <button class="btn btn-outline-primary btn-sm" onclick="loadOpportunities()">
                            <i class="fas fa-sync-alt me-1"></i>
                            Actualiser
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="opportunities-loading" class="loading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Chargement...</span>
                            </div>
                        </div>
                        <div id="opportunities-content" style="display: none;">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Nom</th>
                                            <th>Client</th>
                                            <th>Responsable</th>
                                            <th>Business Unit</th>
                                            <th>Type</th>
                                            <th>Montant</th>
                                            <th>Probabilit√©</th>
                                            <th>Date Fermeture</th>
                                            <th>Statut</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="opportunities-table">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="opportunityModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="opportunityModalTitle">
                        <i class="fas fa-lightbulb me-2"></i>
                        Nouvelle Opportunit√©
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <form id="opportunityForm">
                        <input type="hidden" id="opportunityId">
                        
                        <div class="opportunity-steps mb-4">
                            <div class="step active" data-step="1">
                                <div class="step-number">1</div>
                                <div class="step-label">Informations G√©n√©rales</div>
                            </div>
                            <div class="step" data-step="2">
                                <div class="step-number">2</div>
                                <div class="step-label">D√©tails Commerciaux</div>
                            </div>
                            <div class="step" data-step="3">
                                <div class="step-number">3</div>
                                <div class="step-label">Validation</div>
                            </div>
                        </div>

                        <div class="step-content active" id="step-1">
                            <div class="container-fluid">
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="form-section">
                                            <h6 class="section-title">
                                                <i class="fas fa-info-circle me-2 text-primary"></i>
                                                Informations de Base
                                            </h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                                    <label for="opportunityName" class="form-label">
                                                        <i class="fas fa-tag me-1"></i>Nom de l'Opportunit√© *
                                                    </label>
                                                    <input type="text" class="form-control form-control-lg" 
                                                           id="opportunityName" required 
                                                           placeholder="Ex: D√©veloppement application mobile">
                        </div>
                                                <div class="col-md-6 mb-3">
                                                    <label for="opportunitySource" class="form-label">
                                                        <i class="fas fa-search me-1"></i>Source
                                                    </label>
                                                    <select class="form-select form-select-lg" id="opportunitySource">
                                                        <option value="">S√©lectionner une source</option>
                                                        <option value="Site Web">Site Web</option>
                                                        <option value="R√©seaux Sociaux">R√©seaux Sociaux</option>
                                                        <option value="Recommandation">Recommandation</option>
                                                        <option value="Salon/√âv√©nement">Salon/√âv√©nement</option>
                                                        <option value="Prospection">Prospection</option>
                                                        <option value="Presse/Journal">Presse/Journal</option>
                                                        <option value="Radio/T√©l√©">Radio/T√©l√©</option>
                                                        <option value="Contact de proximit√©">Contact de proximit√©</option>
                                                        <option value="Besoin direct">Besoin direct</option>
                                                        <option value="Suivi √©v√©nement/s√©minaire">Suivi √©v√©nement/s√©minaire</option>
                                                        <option value="R√©union business">R√©union business</option>
                                                        <option value="Autre">Autre</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="form-section">
                                            <h6 class="section-title">
                                                <i class="fas fa-users me-2 text-primary"></i>
                                                Parties Prenantes
                                            </h6>
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="opportunityClient" class="form-label">
                                                        <i class="fas fa-building me-1"></i>Client *
                                                    </label>
                                                    <select class="form-select form-select-lg" id="opportunityClient" required>
                                <option value="">S√©lectionner un client</option>
                            </select>
                        </div>
                                                <div class="col-md-6 mb-3">
                                                    <label for="opportunityCollaborator" class="form-label">
                                                        <i class="fas fa-user-tie me-1"></i>Responsable *
                                                    </label>
                                                    <select class="form-select form-select-lg" id="opportunityCollaborator" required>
                                <option value="">S√©lectionner un collaborateur</option>
                            </select>
                        </div>
                                            </div>
                                        </div>

                                        <div class="form-section">
                                            <h6 class="section-title">
                                                <i class="fas fa-sitemap me-2 text-primary"></i>
                                                Organisation
                                            </h6>
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="opportunityBusinessUnit" class="form-label">
                                                        <i class="fas fa-briefcase me-1"></i>Business Unit *
                                                    </label>
                                                    <select class="form-select form-select-lg" id="opportunityBusinessUnit" required>
                                <option value="">S√©lectionner une Business Unit</option>
                            </select>
                        </div>
                                                <div class="col-md-6 mb-3">
                                                    <label for="opportunityType" class="form-label">
                                                        <i class="fas fa-layer-group me-1"></i>Type d'Opportunit√© *
                                                    </label>
                                                    <select class="form-select form-select-lg" id="opportunityType" required>
                                                        <option value="">S√©lectionner un type</option>
                            </select>
                        </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <div class="info-panel">
                                            <h6 class="panel-title">
                                                <i class="fas fa-lightbulb me-2"></i>
                                                Conseils
                                            </h6>
                                            <div class="tip-item">
                                                <i class="fas fa-check-circle text-success"></i>
                                                <span>Donnez un nom clair et descriptif</span>
                                            </div>
                                            <div class="tip-item">
                                                <i class="fas fa-check-circle text-success"></i>
                                                <span>S√©lectionnez le bon responsable</span>
                                            </div>
                                            <div class="tip-item">
                                                <i class="fas fa-check-circle text-success"></i>
                                                <span>Identifiez la source de l'opportunit√©</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="step-content" id="step-2">
                            <div class="container-fluid">
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="form-section">
                                            <h6 class="section-title">
                                                <i class="fas fa-chart-line me-2 text-primary"></i>
                                                Informations Commerciales
                                            </h6>
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="opportunityAmount" class="form-label">
                                                        <i class="fas fa-euro-sign me-1"></i>Montant Estim√©
                                                    </label>
                                                    <div class="input-group input-group-lg">
                                                        <input type="number" class="form-control" 
                                                               id="opportunityAmount" min="0" step="0.01" 
                                                               placeholder="0.00">
                                                        <select class="form-select" id="opportunityCurrency" style="max-width: 100px;">
                                                            <option value="EUR">EUR</option>
                                                            <option value="USD">USD</option>
                                                            <option value="XAF">XAF</option> <option value="GBP">GBP</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label for="opportunityProbability" class="form-label">
                                                        <i class="fas fa-percentage me-1"></i>Probabilit√© de Succ√®s
                                                    </label>
                                                    <div class="probability-slider-container">
                                                        <input type="range" class="form-range" 
                                                               id="opportunityProbability" min="0" max="100" value="50">
                                                        <div class="probability-display">
                                                            <span id="probabilityValue">50%</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="form-section">
                                            <h6 class="section-title">
                                                <i class="fas fa-calendar-alt me-2 text-primary"></i>
                                                Planning
                                            </h6>
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="opportunityCloseDate" class="form-label">
                                                        <i class="fas fa-calendar-check me-1"></i>Date de Fermeture Pr√©vue
                                                    </label>
                                                    <input type="date" class="form-control form-control-lg" 
                                                           id="opportunityCloseDate">
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label for="opportunityStatus" class="form-label">
                                                        <i class="fas fa-flag me-1"></i>Statut Actuel *
                                                    </label>
                                                    <select class="form-select form-select-lg" id="opportunityStatus" required>
                                <option value="">S√©lectionner un statut</option>
                                <option value="EN_COURS">En Cours</option>
                                <option value="GAGNEE">Gagn√©e</option>
                                <option value="PERDUE">Perdue</option>
                            </select>
                        </div>
                        </div>
                        </div>

                                        <div class="form-section">
                                            <h6 class="section-title">
                                                <i class="fas fa-sticky-note me-2 text-primary"></i>
                                                Description et Notes
                                            </h6>
                        <div class="mb-3">
                                                <label for="opportunityNotes" class="form-label">
                                                    <i class="fas fa-edit me-1"></i>Description D√©taill√©e
                                                </label>
                                                <textarea class="form-control" id="opportunityNotes" rows="4" 
                                                          placeholder="D√©crivez l'opportunit√©, les besoins du client, les enjeux..."></textarea>
                        </div>
                        </div>
                        </div>

                                    <div class="col-md-4">
                                        <div class="summary-panel">
                                            <h6 class="panel-title">
                                                <i class="fas fa-calculator me-2"></i>
                                                R√©sum√©
                                            </h6>
                                            <div class="summary-item">
                                                <span class="label">Montant:</span>
                                                <span class="value" id="summaryAmount">-</span>
                                            </div>
                                            <div class="summary-item">
                                                <span class="label">Probabilit√©:</span>
                                                <span class="value" id="summaryProbability">-</span>
                                            </div>
                                            <div class="summary-item">
                                                <span class="label">Valeur Esp√©r√©e:</span>
                                                <span class="value" id="summaryExpectedValue">-</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="step-content" id="step-3">
                            <div class="container-fluid">
                                <div class="validation-summary">
                                    <h6 class="section-title">
                                        <i class="fas fa-check-circle me-2 text-success"></i>
                                        Validation des Informations
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="validation-item" id="validation-name">
                                                <i class="fas fa-times-circle text-danger"></i>
                                                <span>Nom de l'opportunit√©</span>
                                            </div>
                                            <div class="validation-item" id="validation-client">
                                                <i class="fas fa-times-circle text-danger"></i>
                                                <span>Client s√©lectionn√©</span>
                                            </div>
                                            <div class="validation-item" id="validation-collaborator">
                                                <i class="fas fa-times-circle text-danger"></i>
                                                <span>Responsable assign√©</span>
                                            </div>
                                            <div class="validation-item" id="validation-businessunit">
                                                <i class="fas fa-times-circle text-danger"></i>
                                                <span>Business Unit</span>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="validation-item" id="validation-type">
                                                <i class="fas fa-times-circle text-danger"></i>
                                                <span>Type d'opportunit√©</span>
                                            </div>
                                            <div class="validation-item" id="validation-status">
                                                <i class="fas fa-times-circle text-danger"></i>
                                                <span>Statut</span>
                                            </div>
                                            <div class="validation-item" id="validation-amount">
                                                <i class="fas fa-times-circle text-danger"></i>
                                                <span>Montant estim√©</span>
                                            </div>
                                            <div class="validation-item" id="validation-probability">
                                                <i class="fas fa-times-circle text-danger"></i>
                                                <span>Probabilit√©</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="previousStep()" id="prevBtn" style="display: none;">
                        <i class="fas fa-arrow-left me-1"></i>Pr√©c√©dent
                    </button>
                    <button type="button" class="btn btn-primary" onclick="nextStep()" id="nextBtn">
                        Suivant<i class="fas fa-arrow-right ms-1"></i>
                    </button>
                    <button type="button" class="btn btn-success" onclick="saveOpportunity()" id="saveBtn" style="display: none;">
                        <i class="fas fa-save me-1"></i>Enregistrer
                    </button>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/auth.js" defer></script>
    <script src="/js/sidebar.js" defer></script>
    <script>
        const API_BASE_URL = '/api';
        // Fonction utilitaire pour les appels API authentifi√©s
        async function authenticatedFetch(url, options = {}) {
            const token = localStorage.getItem('authToken');
            const defaultHeaders = {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
            
            return fetch(url, {
                ...options,
                headers: {
                    ...defaultHeaders,
                    ...options.headers
                }
            });
        }

        let opportunities = [];
        let filteredOpportunities = [];

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Page opportunities.html charg√©e');
            loadOpportunities();
            loadClients();
            loadBusinessUnits(); // Load once for both form and filter
            loadOpportunityTypes(); // Load once for both form and filter
            setupEventListeners(); // Setup event listeners for the form
        });

        async function loadOpportunities() {
            showLoading(true);
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/opportunities`);
                const data = await response.json();
                if (data.success) {
                    opportunities = data.data.opportunities;
                    filteredOpportunities = [...opportunities];
                    displayOpportunities();
                    updateStatistics();
                } else {
                    showAlert('Erreur lors du chargement des opportunit√©s: ' + (data.error || data.message), 'danger');
                }
            } catch (error) {
                console.error('Erreur lors du chargement des opportunit√©s:', error);
                showAlert('Erreur de connexion lors du chargement des opportunit√©s', 'danger');
            } finally {
                showLoading(false);
            }
        }

        async function loadClients() {
            try {
                console.log('üîÑ Chargement des clients...');
                const response = await authenticatedFetch(`${API_BASE_URL}/clients`);
                const data = await response.json();
                console.log('üìä R√©ponse clients:', data);
                
                if (data.success) {
                    const select = document.getElementById('opportunityClient');
                    if (!select) {
                        console.error('‚ùå √âl√©ment opportunityClient non trouv√©');
                        return;
                    }
                    
                    select.innerHTML = '<option value="">S√©lectionner un client</option>';
                    
                    const clients = data.data?.clients || data.data || [];
                    console.log('üë• Clients trouv√©s:', clients.length);
                    
                    clients.forEach(client => {
                        const option = document.createElement('option');
                        option.value = client.id;
                        option.textContent = client.nom || client.raison_sociale || 'Client sans nom';
                        select.appendChild(option);
                    });
                    
                    console.log('‚úÖ Clients charg√©s dans le select');
                } else {
                    console.error('‚ùå Erreur API clients:', data);
                    showAlert('Erreur lors du chargement des clients: ' + (data.error || data.message), 'danger');
                }
            } catch (error) {
                console.error('‚ùå Erreur lors du chargement des clients:', error);
                showAlert('Erreur de connexion lors du chargement des clients', 'danger');
            }
        }

        async function loadCollaborators() {
            try {
                console.log('üîÑ Chargement des collaborateurs...');
                const response = await authenticatedFetch(`${API_BASE_URL}/collaborateurs`);
                const data = await response.json();
                console.log('üìä R√©ponse collaborateurs:', data);
                
                if (data.success) {
                    const select = document.getElementById('opportunityCollaborator');
                    if (!select) {
                        console.error('‚ùå √âl√©ment opportunityCollaborator non trouv√©');
                        return;
                    }
                    
                    select.innerHTML = '<option value="">S√©lectionner un collaborateur</option>';
                    
                    const collaborateurs = data.data?.collaborateurs || data.data || [];
                    console.log('üë• Collaborateurs trouv√©s:', collaborateurs.length);
                    
                    collaborateurs.forEach(collaborator => {
                        const option = document.createElement('option');
                        option.value = collaborator.id;
                        option.textContent = `${collaborator.nom || ''} ${collaborator.prenom || ''}`.trim();
                        select.appendChild(option);
                    });
                    
                    console.log('‚úÖ Collaborateurs charg√©s dans le select');
                } else {
                    console.error('‚ùå Erreur API collaborateurs:', data);
                    showAlert('Erreur lors du chargement des collaborateurs: ' + (data.error || data.message), 'danger');
                }
            } catch (error) {
                console.error('‚ùå Erreur lors du chargement des collaborateurs:', error);
                showAlert('Erreur de connexion lors du chargement des collaborateurs', 'danger');
            }
        }

        async function loadBusinessUnits() {
            try {
                console.log('üîÑ Chargement des Business Units...');
                const response = await authenticatedFetch(`${API_BASE_URL}/business-units`);
                const data = await response.json();
                console.log('üìä R√©ponse Business Units:', data);
                
                if (data.success) {
                    const formSelect = document.getElementById('opportunityBusinessUnit');
                    const filterSelect = document.getElementById('business-unit-filter');

                    if (!formSelect || !filterSelect) {
                        console.error('‚ùå Un ou plusieurs √©l√©ments Business Unit (form ou filter) non trouv√©s');
                        return;
                    }
                    
                    formSelect.innerHTML = '<option value="">S√©lectionner une Business Unit</option>';
                    filterSelect.innerHTML = '<option value="">Toutes les BU</option>';
                    
                    const businessUnits = data.data || [];
                    console.log('üè¢ Business Units trouv√©es:', businessUnits.length);
                    
                    businessUnits.forEach(bu => {
                        const optionForm = document.createElement('option');
                        optionForm.value = bu.id;
                        optionForm.textContent = bu.nom || bu.name || 'Business Unit sans nom';
                        formSelect.appendChild(optionForm);

                        const optionFilter = document.createElement('option');
                        optionFilter.value = bu.id;
                        optionFilter.textContent = bu.nom || bu.name || 'Business Unit sans nom';
                        filterSelect.appendChild(optionFilter);
                    });
                    
                    console.log('‚úÖ Business Units charg√©es dans les selects');
                } else {
                    console.error('‚ùå Erreur API Business Units:', data);
                    showAlert('Erreur lors du chargement des Business Units: ' + (data.error || data.message), 'danger');
                }
            } catch (error) {
                console.error('‚ùå Erreur lors du chargement des Business Units:', error);
                showAlert('Erreur de connexion lors du chargement des Business Units', 'danger');
            }
        }

        async function loadOpportunityTypes() {
            try {
                console.log('üîÑ Chargement des types d\'opportunit√©s...');
                const response = await authenticatedFetch(`${API_BASE_URL}/opportunity-types`);
                const data = await response.json();
                console.log('üìä R√©ponse types d\'opportunit√©s:', data);
                
                if (data.success) {
                    const formSelect = document.getElementById('opportunityType');
                    const filterSelect = document.getElementById('type-filter');

                    if (!formSelect || !filterSelect) {
                        console.error('‚ùå Un ou plusieurs √©l√©ments Type d\'Opportunit√© (form ou filter) non trouv√©s');
                        return;
                    }
                    
                    formSelect.innerHTML = '<option value="">S√©lectionner un type</option>';
                    filterSelect.innerHTML = '<option value="">Tous les types</option>';
                    
                    const types = data.data?.opportunityTypes || data.data || [];
                    console.log('üìã Types trouv√©s:', types.length);
                    
                    types.forEach(type => {
                        const optionForm = document.createElement('option');
                        optionForm.value = type.id;
                        optionForm.textContent = type.nom || type.name || 'Type sans nom';
                        formSelect.appendChild(optionForm);

                        const optionFilter = document.createElement('option');
                        optionFilter.value = type.id;
                        optionFilter.textContent = type.nom || type.name || 'Type sans nom';
                        filterSelect.appendChild(optionFilter);
                    });
                    
                    console.log('‚úÖ Types d\'opportunit√©s charg√©s dans les selects');
                } else {
                    console.error('‚ùå Erreur API types d\'opportunit√©s:', data);
                    showAlert('Erreur lors du chargement des types d\'opportunit√©s: ' + (data.error || data.message), 'danger');
                }
            } catch (error) {
                console.error('‚ùå Erreur lors du chargement des types d\'opportunit√©s:', error);
                showAlert('Erreur de connexion lors du chargement des types d\'opportunit√©s', 'danger');
            }
        }

        function displayOpportunities() {
            const tbody = document.getElementById('opportunities-table');
            tbody.innerHTML = '';

            if (filteredOpportunities.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" class="text-center">Aucune opportunit√© trouv√©e</td></tr>`;
                return;
            }

            filteredOpportunities.forEach(opp => {
                const row = document.createElement('tr');
                
                // Formatage des donn√©es
                const montant = opp.montant_estime ? formatCurrency(opp.montant_estime, opp.devise) : '-';
                const probabilite = opp.probabilite !== undefined && opp.probabilite !== null ? `${opp.probabilite}%` : '-';
                const dateFermeture = opp.date_fermeture_prevue ? new Date(opp.date_fermeture_prevue).toLocaleDateString('fr-FR') : '-';
                const responsable = opp.collaborateur_nom || opp.collaborateur_prenom ? `${opp.collaborateur_nom || ''} ${opp.collaborateur_prenom || ''}`.trim() : '-';
                const businessUnit = opp.business_unit_nom || '-';
                const type = opp.opportunity_type_nom || '-';
                
                // Badge de statut avec couleur
                const statusClass = getStatusClass(opp.statut);
                const statusLabel = getStatusLabel(opp.statut);
                
                row.innerHTML = `
                    <td>
                        <strong>${opp.nom}</strong>
                        ${opp.source ? `<br><small class="text-muted">Source: ${opp.source}</small>` : ''}
                    </td>
                    <td>${opp.client_nom || '-'}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="collaborateur-avatar me-2">
                                ${getInitials(opp.collaborateur_nom || '', opp.collaborateur_prenom || '')}
                            </div>
                            <div>
                                <div class="fw-bold">${responsable}</div>
                                ${opp.collaborateur_email ? `<small class="text-muted">${opp.collaborateur_email}</small>` : ''}
                            </div>
                        </div>
                    </td>
                    <td>${businessUnit}</td>
                    <td>${type}</td>
                    <td>
                        <div class="fw-bold">${montant}</div>
                        ${opp.devise ? `<small class="text-muted">${opp.devise}</small>` : ''}
                    </td>
                    <td>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar ${getProgressBarClass(opp.probabilite)}" 
                                 style="width: ${opp.probabilite || 0}%" 
                                 role="progressbar">
                                ${probabilite}
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="d-flex flex-column">
                            <span class="fw-bold">${dateFermeture}</span>
                            ${opp.date_fermeture_prevue ? `<small class="text-muted">${getDaysUntil(opp.date_fermeture_prevue)}</small>` : ''}
                        </div>
                    </td>
                    <td><span class="status-badge ${statusClass}">${statusLabel}</span></td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-info" onclick="viewOpportunity(${opp.id})" title="Voir">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-warning" onclick="editOpportunity(${opp.id})" title="Modifier">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteOpportunity(${opp.id})" title="Supprimer">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateStatistics() {
            document.getElementById('total-opportunities').textContent = opportunities.length;
            document.getElementById('open-opportunities').textContent = opportunities.filter(o => o.statut === 'EN_COURS').length;
            document.getElementById('won-opportunities').textContent = opportunities.filter(o => o.statut === 'GAGNEE').length;
            document.getElementById('lost-opportunities').textContent = opportunities.filter(o => o.statut === 'PERDUE').length;
        }

        function filterOpportunities() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const statusFilter = document.getElementById('status-filter').value;
            const businessUnitFilter = document.getElementById('business-unit-filter').value;
            const typeFilter = document.getElementById('type-filter').value;
            const probabilityFilter = document.getElementById('probability-filter').value;

            filteredOpportunities = opportunities.filter(opp => {
                // Recherche par nom, client ou responsable
                const matchesSearch = !searchTerm || 
                    (opp.nom && opp.nom.toLowerCase().includes(searchTerm)) || 
                    (opp.client_nom && opp.client_nom.toLowerCase().includes(searchTerm)) ||
                    (opp.collaborateur_nom && opp.collaborateur_nom.toLowerCase().includes(searchTerm)) ||
                    (opp.collaborateur_prenom && opp.collaborateur_prenom.toLowerCase().includes(searchTerm));
                
                // Filtre par statut
                const matchesStatus = !statusFilter || opp.statut === statusFilter;
                
                // Filtre par business unit
                const matchesBusinessUnit = !businessUnitFilter || String(opp.business_unit_id) === businessUnitFilter;
                
                // Filtre par type d'opportunit√©
                const matchesType = !typeFilter || String(opp.opportunity_type_id) === typeFilter;
                
                // Filtre par probabilit√©
                let matchesProbability = true;
                if (probabilityFilter) {
                    const prob = opp.probabilite || 0;
                    switch (probabilityFilter) {
                        case 'high':
                            matchesProbability = prob >= 80;
                            break;
                        case 'medium':
                            matchesProbability = prob >= 40 && prob < 80;
                            break;
                        case 'low':
                            matchesProbability = prob < 40;
                            break;
                    }
                }
                
                return matchesSearch && matchesStatus && matchesBusinessUnit && matchesType && matchesProbability;
            });

            displayOpportunities();
        }

        let currentStep = 1;
        const totalSteps = 3;

        function newOpportunity() {
            console.log('üéØ Ouverture du modal nouvelle opportunit√©');
            document.getElementById('opportunityForm').reset();
            document.getElementById('opportunityId').value = '';
            document.getElementById('opportunityModalTitle').innerText = 'Nouvelle Opportunit√©';
            currentStep = 1;
            showStep(1);
            
            // Recharger les donn√©es des selects si n√©cessaire (clients, collaborateurs)
            loadClients();
            loadCollaborators();
            // Business units and opportunity types are loaded once on DOMContentLoaded
            
            // Reset validation states
            document.querySelectorAll('.validation-item').forEach(item => {
                item.classList.remove('valid');
                const icon = item.querySelector('i');
                if (icon) {
                    icon.className = 'fas fa-times-circle text-danger';
                }
            });
            
            // Show the modal
            bootstrap.Modal.getOrCreateInstance(document.getElementById('opportunityModal')).show();
            console.log('‚úÖ Modal nouvelle opportunit√© affich√©');
        }


        function setupEventListeners() {
            console.log('üîó Configuration des √©v√©nements...');
            
            // Probabilit√© slider
            const probabilitySlider = document.getElementById('opportunityProbability');
            const probabilityValue = document.getElementById('probabilityValue');
            
            if (probabilitySlider && probabilityValue) {
                probabilitySlider.addEventListener('input', function() {
                    probabilityValue.textContent = this.value + '%';
                    updateSummary();
                    validateField({ target: probabilitySlider }); // Trigger validation for probability
                    console.log('üìä Probabilit√© mise √† jour:', this.value + '%');
                });
            }

            // Montant input
            const amountInput = document.getElementById('opportunityAmount');
            if (amountInput) {
                amountInput.addEventListener('input', function() {
                    updateSummary();
                    validateField({ target: amountInput }); // Trigger validation for amount
                    console.log('üí∞ Montant mis √† jour:', this.value);
                });
            }

            // All form inputs/selects for real-time validation
            const inputs = document.querySelectorAll('#opportunityForm input, #opportunityForm select, #opportunityForm textarea');
            inputs.forEach(input => {
                input.addEventListener('change', validateField);
                input.addEventListener('blur', validateField);
                // For immediate feedback when opening an existing opportunity
                if (input.value !== '' && input.value !== null) {
                    validateField({ target: input });
                }
            });
            
            console.log('‚úÖ √âv√©nements configur√©s');
        }

        function showStep(step) {
            // Masquer toutes les √©tapes
            document.querySelectorAll('.step-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Afficher l'√©tape actuelle
            document.getElementById(`step-${step}`).classList.add('active');
            
            // Mettre √† jour les indicateurs d'√©tapes
            document.querySelectorAll('.step').forEach(stepEl => {
                stepEl.classList.remove('active');
            });
            document.querySelector(`[data-step="${step}"]`).classList.add('active');
            
            // Mettre √† jour les boutons
            updateButtons();
            
            // Si on arrive √† l'√©tape 3, forcer la validation
            if (step === 3) {
                console.log('üîÑ Arriv√©e √† l\'√©tape 3 - Validation forc√©e');
                validateAllFields();
            }
        }

        function nextStep() {
            if (validateCurrentStep()) {
                if (currentStep < totalSteps) {
                    currentStep++;
                    showStep(currentStep);
                }
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
            }
        }

        function updateButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const saveBtn = document.getElementById('saveBtn');
            
            if (prevBtn) prevBtn.style.display = currentStep > 1 ? 'inline-block' : 'none';
            if (nextBtn) nextBtn.style.display = currentStep < totalSteps ? 'inline-block' : 'none';
            if (saveBtn) saveBtn.style.display = currentStep === totalSteps ? 'inline-block' : 'none';
        }

        function validateCurrentStep() {
            let isValid = true;
            
            switch (currentStep) {
                case 1:
                    isValid = validateStep1();
                    break;
                case 2:
                    isValid = validateStep2();
                    break;
                case 3:
                    // Validation for step 3 is handled by validateAllFields
                    isValid = validateAllFields();
                    break;
            }
            
            if (!isValid) {
                showAlert('Veuillez remplir tous les champs obligatoires de l\'√©tape actuelle.', 'warning');
            }
            
            return isValid;
        }

        function validateStep1() {
            const requiredFields = ['opportunityName', 'opportunityClient', 'opportunityCollaborator', 'opportunityBusinessUnit', 'opportunityType'];
            let allFieldsValid = true;
            requiredFields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                let isValid = false;
                if (element) {
                    if (element.tagName === 'SELECT') {
                        isValid = element.value !== null && element.value.trim() !== '';
                    } else {
                        isValid = element.value.trim() !== '';
                    }
                    // Trigger validation for display
                    validateField({ target: element });
                }
                if (!isValid) allFieldsValid = false;
            });
            return allFieldsValid;
        }

        function validateStep2() {
            const requiredFields = ['opportunityStatus'];
            let allFieldsValid = true;
            requiredFields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                let isValid = false;
                if (element) {
                    if (element.tagName === 'SELECT') {
                        isValid = element.value !== null && element.value.trim() !== '';
                    } else {
                        isValid = element.value.trim() !== '';
                    }
                    // Trigger validation for display
                    validateField({ target: element });
                }
                if (!isValid) allFieldsValid = false;
            });
            return allFieldsValid;
        }

        function validateField(event) {
            const field = event.target;
            const fieldName = field.id;
            console.log('üîç Validation du champ:', fieldName, 'Valeur:', field.value);
            
            let validationId;
            switch (fieldName) {
                case 'opportunityName': validationId = 'validation-name'; break;
                case 'opportunityClient': validationId = 'validation-client'; break;
                case 'opportunityCollaborator': validationId = 'validation-collaborator'; break;
                case 'opportunityBusinessUnit': validationId = 'validation-businessunit'; break; // Corrected ID
                case 'opportunityType': validationId = 'validation-type'; break;
                case 'opportunityStatus': validationId = 'validation-status'; break;
                case 'opportunityAmount': validationId = 'validation-amount'; break;
                case 'opportunityProbability': validationId = 'validation-probability'; break;
                default: return; // Not a field we validate in the summary
            }
            
            const validationItem = document.getElementById(validationId);
            
            if (validationItem) {
                let isValid = false;
                if (field.tagName === 'SELECT') {
                    isValid = field.value && field.value.trim() !== '';
                } else if (field.type === 'number') {
                    isValid = field.value !== '' && !isNaN(parseFloat(field.value)) && parseFloat(field.value) >= 0;
                } else {
                    isValid = field.value.trim() !== '';
                }
                
                if (fieldName === 'opportunityProbability') {
                    isValid = field.value !== '' && !isNaN(parseInt(field.value)) && parseInt(field.value) >= 0 && parseInt(field.value) <= 100;
                }

                if (isValid) {
                    validationItem.classList.add('valid');
                    const icon = validationItem.querySelector('i');
                    if (icon) {
                        icon.className = 'fas fa-check-circle text-success';
                    }
                } else {
                    validationItem.classList.remove('valid');
                    const icon = validationItem.querySelector('i');
                    if (icon) {
                        icon.className = 'fas fa-times-circle text-danger';
                    }
                }
            } else {
                console.warn('‚ùå √âl√©ment de validation non trouv√© pour:', validationId);
            }
        }

        function validateAllFields() {
            console.log('üîç Validation compl√®te de tous les champs...');
            
            const fieldsToValidate = [
                'opportunityName', 'opportunityClient', 'opportunityCollaborator', 
                'opportunityBusinessUnit', 'opportunityType', 'opportunityStatus',
                'opportunityAmount', 'opportunityProbability'
            ];
            
            let allValid = true;
            
            fieldsToValidate.forEach(fieldName => {
                const field = document.getElementById(fieldName);
                if (field) {
                    const event = { target: field };
                    validateField(event); // Trigger validation for each field
                    const validationItem = document.getElementById(getValidationIdFromFieldName(fieldName));
                    if (validationItem && !validationItem.classList.contains('valid')) {
                        allValid = false;
                    }
                } else {
                    console.warn(`‚ö†Ô∏è Champ ${fieldName} non trouv√© dans le formulaire.`);
                    allValid = false; // Mark as invalid if a required element is missing
                }
            });
            
            console.log('üìä R√©sultat validation finale:', allValid ? 'Tous valides' : 'Certains invalides');
            return allValid;
        }

        function getValidationIdFromFieldName(fieldName) {
             switch (fieldName) {
                case 'opportunityName': return 'validation-name';
                case 'opportunityClient': return 'validation-client';
                case 'opportunityCollaborator': return 'validation-collaborator';
                case 'opportunityBusinessUnit': return 'validation-businessunit';
                case 'opportunityType': return 'validation-type';
                case 'opportunityStatus': return 'validation-status';
                case 'opportunityAmount': return 'validation-amount';
                case 'opportunityProbability': return 'validation-probability';
                default: return null;
            }
        }

        function updateSummary() {
            const amountInput = document.getElementById('opportunityAmount');
            const probabilitySlider = document.getElementById('opportunityProbability');
            const currencySelect = document.getElementById('opportunityCurrency');

            const amount = parseFloat(amountInput.value) || 0;
            const probability = parseInt(probabilitySlider.value) || 0;
            const currency = currencySelect.value;
            
            console.log('üìä Mise √† jour du r√©sum√©:', { amount, probability, currency });
            
            const summaryAmount = document.getElementById('summaryAmount');
            const summaryProbability = document.getElementById('summaryProbability');
            const summaryExpectedValue = document.getElementById('summaryExpectedValue');
            
            if (summaryAmount) summaryAmount.textContent = formatCurrency(amount, currency);
            if (summaryProbability) summaryProbability.textContent = probability + '%';
            if (summaryExpectedValue) summaryExpectedValue.textContent = formatCurrency(amount * (probability / 100), currency);
        }

        async function saveOpportunity() {
            console.log('üíæ Sauvegarde de l\'opportunit√©...');
            
            if (!validateAllFields()) {
                showAlert('Veuillez corriger les erreurs dans le formulaire avant de sauvegarder.', 'danger');
                showStep(1); // Go back to step 1 to show errors if needed
                return;
            }

            const id = document.getElementById('opportunityId').value;
            const url = id ? `${API_BASE_URL}/opportunities/${id}` : `${API_BASE_URL}/opportunities`;
            const method = id ? 'PUT' : 'POST';

            // Ensure amount is handled as number, set to null if empty or invalid
            let estimatedAmount = parseFloat(document.getElementById('opportunityAmount').value);
            if (isNaN(estimatedAmount) || estimatedAmount < 0) {
                estimatedAmount = null;
            }

            const opportunityData = {
                nom: document.getElementById('opportunityName').value.trim(),
                client_id: document.getElementById('opportunityClient').value || null,
                collaborateur_id: document.getElementById('opportunityCollaborator').value || null,
                business_unit_id: document.getElementById('opportunityBusinessUnit').value || null,
                opportunity_type_id: document.getElementById('opportunityType').value || null,
                statut: document.getElementById('opportunityStatus').value || 'EN_COURS',
                source: document.getElementById('opportunitySource').value || null,
                probabilite: parseInt(document.getElementById('opportunityProbability').value) || 0,
                montant_estime: estimatedAmount,
                devise: document.getElementById('opportunityCurrency').value || 'EUR',
                date_fermeture_prevue: document.getElementById('opportunityCloseDate').value || null,
                description: document.getElementById('opportunityNotes').value || null
            };

            console.log('üìä Donn√©es √† sauvegarder:', opportunityData);

            // Display loading indicator
            const saveBtn = document.getElementById('saveBtn');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Enregistrement...';
            saveBtn.disabled = true;

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(opportunityData)
                });
                
                const data = await response.json();
                console.log('üì§ R√©ponse du serveur:', data);
                
                if (data.success) {
                    showAlert('Opportunit√© sauvegard√©e avec succ√®s', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('opportunityModal')).hide();
                    
                    // R√©initialiser le formulaire
                    document.getElementById('opportunityForm').reset();
                    currentStep = 1;
                    showStep(1);
                    
                    // Recharger les donn√©es
                    await loadOpportunities();
                } else {
                    showAlert(`Erreur lors de la sauvegarde: ${data.error || data.message || 'Erreur inconnue'}`, 'danger');
                }
            } catch (error) {
                console.error('‚ùå Erreur lors de la sauvegarde:', error);
                showAlert('Erreur de connexion lors de la sauvegarde', 'danger');
            } finally {
                // Restaurer le bouton
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        }

        async function editOpportunity(id) {
            console.log('‚úèÔ∏è √âdition de l\'opportunit√©:', id);
            
            try {
                // Load detailed opportunity data
                const response = await authenticatedFetch(`${API_BASE_URL}/opportunities/${id}`);
                const data = await response.json();
                
                if (data.success) {
                    const opp = data.data.opportunity;
                    console.log('üìã Donn√©es de l\'opportunit√©:', opp);
                    
                    // Populate the form
                    document.getElementById('opportunityId').value = opp.id;
                    document.getElementById('opportunityName').value = opp.nom || '';
                    // Populate selects after they are loaded
                    document.getElementById('opportunityClient').value = opp.client_id || '';
                    document.getElementById('opportunityCollaborator').value = opp.collaborateur_id || '';
                    document.getElementById('opportunityBusinessUnit').value = opp.business_unit_id || '';
                    document.getElementById('opportunityType').value = opp.opportunity_type_id || '';
                    document.getElementById('opportunityStatus').value = opp.statut || 'EN_COURS';
                    document.getElementById('opportunitySource').value = opp.source || '';
                    document.getElementById('opportunityProbability').value = opp.probabilite !== undefined && opp.probabilite !== null ? opp.probabilite : 50;
                    document.getElementById('opportunityAmount').value = opp.montant_estime || '';
                    document.getElementById('opportunityCurrency').value = opp.devise || 'EUR';
                    document.getElementById('opportunityCloseDate').value = opp.date_fermeture_prevue ? opp.date_fermeture_prevue.split('T')[0] : '';
                    document.getElementById('opportunityNotes').value = opp.description || '';
                    
                    // Update probability display immediately
                    document.getElementById('probabilityValue').textContent = `${document.getElementById('opportunityProbability').value}%`;

                    // Update modal title
                    document.getElementById('opportunityModalTitle').innerText = 'Modifier l\'Opportunit√©';
                    
                    // Reset steps and show step 1
                    currentStep = 1;
                    showStep(1);
                    
                    // Validate all fields after a short delay to allow DOM to update
                    setTimeout(() => {
                        validateAllFields();
                        updateSummary();
                    }, 100);
                    
                    // Show the modal
                    bootstrap.Modal.getOrCreateInstance(document.getElementById('opportunityModal')).show();
                    console.log('‚úÖ Modal de modification affich√©');
                } else {
                    showAlert(`Erreur lors du chargement: ${data.error || 'Opportunit√© non trouv√©e'}`, 'danger');
                }
            } catch (error) {
                console.error('‚ùå Erreur lors du chargement de l\'opportunit√©:', error);
                showAlert('Erreur de connexion lors du chargement', 'danger');
            }
        }

        async function deleteOpportunity(id) {
            console.log('üóëÔ∏è Suppression de l\'opportunit√©:', id);
            
            // Confirmation with Bootstrap modal
            const confirmModalHtml = `
                <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title text-danger" id="deleteConfirmModalLabel">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    Confirmer la suppression
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <p>√ätes-vous s√ªr de vouloir supprimer cette opportunit√© ?</p>
                                <p class="text-muted">Cette action est irr√©versible.</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-1"></i>Annuler
                                </button>
                                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                                    <i class="fas fa-trash me-1"></i>Supprimer
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('deleteConfirmModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add the new modal HTML to the body
            document.body.insertAdjacentHTML('beforeend', confirmModalHtml);
            
            const deleteModalElement = document.getElementById('deleteConfirmModal');
            const deleteBootstrapModal = new bootstrap.Modal(deleteModalElement);

            // Set up the click handler for the confirm button *after* the modal is in the DOM
            document.getElementById('confirmDeleteBtn').onclick = async () => {
                await confirmDeleteOpportunity(id);
                deleteBootstrapModal.hide(); // Hide the modal after confirmation
            };
            
            // Show the modal
            deleteBootstrapModal.show();
        }

        async function confirmDeleteOpportunity(id) {
            console.log('‚úÖ Confirmation de suppression:', id);
            
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/opportunities/${id}`, { 
                    method: 'DELETE' 
                });
                
                const data = await response.json();
                console.log('üì§ R√©ponse suppression:', data);
                
                if (data.success) {
                    showAlert('Opportunit√© supprim√©e avec succ√®s', 'success');
                    await loadOpportunities(); // Reload data after deletion
                } else {
                    showAlert(`Erreur lors de la suppression: ${data.error || data.message || 'Erreur inconnue'}`, 'danger');
                }
            } catch (error) {
                console.error('‚ùå Erreur lors de la suppression:', error);
                showAlert('Erreur de connexion lors de la suppression', 'danger');
            }
        }

        function showLoading(show) {
            const loadingElement = document.getElementById('opportunities-loading');
            const contentElement = document.getElementById('opportunities-content');
            
            if (loadingElement) loadingElement.style.display = show ? 'flex' : 'none';
            if (contentElement) contentElement.style.display = show ? 'none' : 'block';
        }

        function formatCurrency(value, currency = 'EUR') {
            return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: currency }).format(value);
        }

        function getStatusClass(status) {
            const classes = {
                'EN_COURS': 'status-saisie',
                'GAGNEE': 'status-validee',
                'PERDUE': 'status-rejetee'
            };
            return classes[status] || 'status-saisie'; // Default to 'status-saisie' if status is unknown
        }

        function getStatusLabel(status) {
            const labels = {
                'EN_COURS': 'En Cours',
                'GAGNEE': 'Gagn√©e',
                'PERDUE': 'Perdue'
            };
            return labels[status] || status; // Return the status itself if label is not defined
        }

        function getProgressBarClass(probability) {
            if (probability >= 80) return 'bg-success';
            if (probability >= 60) return 'bg-info';
            if (probability >= 40) return 'bg-warning';
            return 'bg-danger';
        }

        function getInitials(nom, prenom) {
            if (!nom && !prenom) return '';
            const firstInitial = nom ? nom.charAt(0) : '';
            const lastInitial = prenom ? prenom.charAt(0) : '';
            return `${firstInitial}${lastInitial}`.toUpperCase();
        }

        function getDaysUntil(dateString) {
            const date = new Date(dateString);
            const today = new Date();
            // Reset time to 00:00:00 for accurate day difference
            date.setHours(0, 0, 0, 0);
            today.setHours(0, 0, 0, 0);

            const diffTime = date.getTime() - today.getTime(); // Use getTime() for milliseconds
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays > 0) {
                return `Dans ${diffDays} jour${diffDays > 1 ? 's' : ''}`;
            } else if (diffDays === 0) {
                return 'Aujourd\'hui';
            } else {
                return `Il y a ${Math.abs(diffDays)} jour${Math.abs(diffDays) > 1 ? 's' : ''}`;
            }
        }

        function viewOpportunity(id) {
            const opp = opportunities.find(o => o.id === id);
            if (opp) {
                const formattedAmount = opp.montant_estime ? formatCurrency(opp.montant_estime, opp.devise) : 'Non renseign√©';
                const formattedProbability = opp.probabilite !== undefined && opp.probabilite !== null ? `${opp.probabilite}%` : 'Non renseign√©e';
                const formattedCloseDate = opp.date_fermeture_prevue ? new Date(opp.date_fermeture_prevue).toLocaleDateString('fr-FR') : 'Non renseign√©e';
                const clientName = opp.client_nom || 'Non renseign√©';
                const responsibleName = opp.collaborateur_nom || opp.collaborateur_prenom ? `${opp.collaborateur_nom || ''} ${opp.collaborateur_prenom || ''}`.trim() : 'Non assign√©';
                const businessUnitName = opp.business_unit_nom || 'Non assign√©e';
                const opportunityTypeName = opp.opportunity_type_nom || 'Non renseign√©';
                const sourceName = opp.source || 'Non renseign√©e';
                const statusBadge = `<span class="status-badge ${getStatusClass(opp.statut)}">${getStatusLabel(opp.statut)}</span>`;


                const modal = `
                    <div class="modal fade" id="viewOpportunityModal" tabindex="-1" aria-labelledby="viewOpportunityModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="viewOpportunityModalLabel">
                                        <i class="fas fa-eye me-2"></i>
                                        D√©tails de l'Opportunit√©
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6 class="text-primary">Informations G√©n√©rales</h6>
                                            <p><strong>Nom :</strong> ${opp.nom}</p>
                                            <p><strong>Client :</strong> ${clientName}</p>
                                            <p><strong>Responsable :</strong> ${responsibleName}</p>
                                            <p><strong>Business Unit :</strong> ${businessUnitName}</p>
                                            <p><strong>Type :</strong> ${opportunityTypeName}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <h6 class="text-primary">Informations Commerciales</h6>
                                            <p><strong>Montant :</strong> ${formattedAmount}</p>
                                            <p><strong>Probabilit√© :</strong> ${formattedProbability}</p>
                                            <p><strong>Date de fermeture :</strong> ${formattedCloseDate}</p>
                                            <p><strong>Source :</strong> ${sourceName}</p>
                                            <p><strong>Statut :</strong> ${statusBadge}</p>
                                        </div>
                                    </div>
                                    ${opp.description ? `
                                    <div class="row mt-3">
                                        <div class="col-12">
                                            <h6 class="text-primary">Description</h6>
                                            <p>${opp.description}</p>
                                        </div>
                                    </div>
                                    ` : ''}
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                                    <button type="button" class="btn btn-warning" onclick="editOpportunity(${opp.id})">
                                        <i class="fas fa-edit me-1"></i>Modifier
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remove existing modal if any
                const oldModal = document.getElementById('viewOpportunityModal');
                if (oldModal) oldModal.remove();
                
                // Add the new modal HTML to the body
                document.body.insertAdjacentHTML('beforeend', modal);
                
                // Show the modal
                new bootstrap.Modal(document.getElementById('viewOpportunityModal')).show();
            } else {
                showAlert('D√©tails de l\'opportunit√© non trouv√©s.', 'danger');
            }
        }

        function refreshData() {
            console.log('üîÑ Actualisation des donn√©es...');
            loadOpportunities();
            // Re-load filter options in case new BUs/Types were added
            loadBusinessUnits(); 
            loadOpportunityTypes();
            showAlert('Donn√©es actualis√©es', 'success');
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'danger' ? 'times-circle' : 'info-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const container = document.querySelector('.main-content-area');
            if (container) {
                // Insert at the top of the main content area
                container.insertBefore(alertDiv, container.firstChild);
            } else {
                // Fallback if main-content-area is not found
                document.body.appendChild(alertDiv);
            }
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                const bsAlert = bootstrap.Alert.getInstance(alertDiv);
                if (bsAlert) {
                    bsAlert.dispose();
                } else if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>