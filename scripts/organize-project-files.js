#!/usr/bin/env node

/**
 * Script pour organiser tous les fichiers du projet
 * - D√©placer tous les scripts vers le dossier scripts/
 * - D√©placer les fichiers non utilis√©s vers Old_files/
 * Usage: node scripts/organize-project-files.js
 */

const fs = require('fs');
const path = require('path');

console.log('üóÇÔ∏è  ORGANISATION DES FICHIERS DU PROJET');
console.log('=======================================\n');

class ProjectFileOrganizer {
    constructor() {
        this.rootDir = path.join(__dirname, '..');
        this.scriptsDir = path.join(this.rootDir, 'scripts');
        this.oldFilesDir = path.join(this.rootDir, 'Old_files');
        this.filesToMove = [];
        this.scriptsToMove = [];
        this.unusedFiles = [];
        this.usedFiles = new Set();
    }

    async organize() {
        try {
            // 1. Cr√©er les dossiers n√©cessaires
            this.createDirectories();
            
            // 2. Analyser les fichiers utilis√©s
            this.analyzeUsedFiles();
            
            // 3. Identifier les scripts √† d√©placer
            this.identifyScriptsToMove();
            
            // 4. Identifier les fichiers non utilis√©s
            this.identifyUnusedFiles();
            
            // 5. D√©placer les fichiers
            this.moveFiles();
            
            // 6. Afficher le rapport final
            this.showFinalReport();
            
        } catch (error) {
            console.error('‚ùå Erreur lors de l\'organisation:', error);
        }
    }

    createDirectories() {
        console.log('üìÅ Cr√©ation des dossiers...');
        
        if (!fs.existsSync(this.oldFilesDir)) {
            fs.mkdirSync(this.oldFilesDir, { recursive: true });
            console.log('‚úÖ Dossier Old_files cr√©√©');
        } else {
            console.log('‚úÖ Dossier Old_files existe d√©j√†');
        }
        
        if (!fs.existsSync(this.scriptsDir)) {
            fs.mkdirSync(this.scriptsDir, { recursive: true });
            console.log('‚úÖ Dossier scripts cr√©√©');
        } else {
            console.log('‚úÖ Dossier scripts existe d√©j√†');
        }
    }

    analyzeUsedFiles() {
        console.log('\nüîç Analyse des fichiers utilis√©s...');
        
        // Fichiers principaux toujours utilis√©s
        const alwaysUsed = [
            'server.js',
            'package.json',
            'package-lock.json',
            'ecosystem.config.js',
            'docker-compose.yml',
            'Dockerfile',
            'env.example',
            '.env',
            'README.md',
            'README-PRODUCTION.md'
        ];
        
        alwaysUsed.forEach(file => this.usedFiles.add(file));
        
        // Analyser les routes dans server.js
        this.analyzeServerRoutes();
        
        // Analyser les imports dans les fichiers JS
        this.analyzeJavaScriptImports();
        
        // Analyser les r√©f√©rences dans les fichiers HTML
        this.analyzeHTMLReferences();
        
        console.log(`‚úÖ ${this.usedFiles.size} fichiers identifi√©s comme utilis√©s`);
    }

    analyzeServerRoutes() {
        try {
            const serverPath = path.join(this.rootDir, 'server.js');
            if (fs.existsSync(serverPath)) {
                const content = fs.readFileSync(serverPath, 'utf8');
                
                // Extraire les routes
                const routeMatches = content.match(/app\.use\(['"`]\/[^'"`]*['"`]/g) || [];
                routeMatches.forEach(match => {
                    const route = match.match(/['"`]([^'"`]+)['"`]/)[1];
                    this.usedFiles.add(`src/routes/${route.replace('/', '')}.js`);
                });
                
                // Extraire les imports
                const importMatches = content.match(/require\(['"`][^'"`]+['"`]\)/g) || [];
                importMatches.forEach(match => {
                    const importPath = match.match(/['"`]([^'"`]+)['"`]/)[1];
                    if (importPath.startsWith('./') || importPath.startsWith('../')) {
                        this.usedFiles.add(importPath);
                    }
                });
            }
        } catch (error) {
            console.warn('‚ö†Ô∏è  Erreur lors de l\'analyse de server.js:', error.message);
        }
    }

    analyzeJavaScriptImports() {
        const jsFiles = this.getAllFiles(this.rootDir, ['.js'], ['node_modules', '.git']);
        
        jsFiles.forEach(file => {
            try {
                const content = fs.readFileSync(file, 'utf8');
                const importMatches = content.match(/require\(['"`][^'"`]+['"`]\)/g) || [];
                
                importMatches.forEach(match => {
                    const importPath = match.match(/['"`]([^'"`]+)['"`]/)[1];
                    if (importPath.startsWith('./') || importPath.startsWith('../')) {
                        const resolvedPath = path.resolve(path.dirname(file), importPath);
                        const relativePath = path.relative(this.rootDir, resolvedPath);
                        this.usedFiles.add(relativePath);
                    }
                });
            } catch (error) {
                // Ignorer les erreurs de lecture
            }
        });
    }

    analyzeHTMLReferences() {
        const htmlFiles = this.getAllFiles(path.join(this.rootDir, 'public'), ['.html']);
        
        htmlFiles.forEach(file => {
            try {
                const content = fs.readFileSync(file, 'utf8');
                
                // Extraire les r√©f√©rences CSS et JS
                const refMatches = content.match(/<link[^>]+href=['"`]([^'"`]+)['"`]/g) || [];
                const scriptMatches = content.match(/<script[^>]+src=['"`]([^'"`]+)['"`]/g) || [];
                
                [...refMatches, ...scriptMatches].forEach(match => {
                    const refPath = match.match(/['"`]([^'"`]+)['"`]/)[1];
                    if (refPath.startsWith('./') || refPath.startsWith('../') || !refPath.startsWith('http')) {
                        this.usedFiles.add(`public/${refPath}`);
                    }
                });
            } catch (error) {
                // Ignorer les erreurs de lecture
            }
        });
    }

    identifyScriptsToMove() {
        console.log('\nüîç Identification des scripts √† d√©placer...');
        
        const rootFiles = fs.readdirSync(this.rootDir);
        
        rootFiles.forEach(file => {
            const filePath = path.join(this.rootDir, file);
            const stat = fs.statSync(filePath);
            
            if (stat.isFile()) {
                // Scripts shell
                if (file.endsWith('.sh') || file.endsWith('.ps1')) {
                    this.scriptsToMove.push({
                        source: filePath,
                        destination: path.join(this.scriptsDir, file),
                        type: 'script'
                    });
                }
                
                // Scripts JavaScript
                if (file.endsWith('.js') && !file.startsWith('server') && !file.startsWith('package')) {
                    this.scriptsToMove.push({
                        source: filePath,
                        destination: path.join(this.scriptsDir, file),
                        type: 'script'
                    });
                }
            }
        });
        
        console.log(`‚úÖ ${this.scriptsToMove.length} scripts identifi√©s √† d√©placer`);
    }

    identifyUnusedFiles() {
        console.log('\nüîç Identification des fichiers non utilis√©s...');
        
        const rootFiles = fs.readdirSync(this.rootDir);
        
        rootFiles.forEach(file => {
            const filePath = path.join(this.rootDir, file);
            const stat = fs.statSync(filePath);
            
            if (stat.isFile()) {
                // V√©rifier si le fichier est utilis√©
                const isUsed = this.usedFiles.has(file) || 
                              this.usedFiles.has(`./${file}`) ||
                              this.usedFiles.has(`../${file}`);
                
                // Fichiers √† ignorer
                const ignoreFiles = [
                    'server.js', 'package.json', 'package-lock.json',
                    'ecosystem.config.js', 'docker-compose.yml', 'Dockerfile',
                    'env.example', '.env', 'README.md', 'README-PRODUCTION.md',
                    '.gitignore', '.gitattributes'
                ];
                
                if (!isUsed && !ignoreFiles.includes(file) && !file.startsWith('.')) {
                    this.unusedFiles.push({
                        source: filePath,
                        destination: path.join(this.oldFilesDir, file),
                        type: 'unused'
                    });
                }
            }
        });
        
        console.log(`‚úÖ ${this.unusedFiles.length} fichiers non utilis√©s identifi√©s`);
    }

    moveFiles() {
        console.log('\nüì¶ D√©placement des fichiers...');
        
        let movedScripts = 0;
        let movedUnused = 0;
        let errors = 0;
        
        // D√©placer les scripts
        this.scriptsToMove.forEach(file => {
            try {
                fs.renameSync(file.source, file.destination);
                console.log(`‚úÖ Script d√©plac√©: ${path.basename(file.source)} ‚Üí scripts/`);
                movedScripts++;
            } catch (error) {
                console.error(`‚ùå Erreur lors du d√©placement de ${file.source}:`, error.message);
                errors++;
            }
        });
        
        // D√©placer les fichiers non utilis√©s
        this.unusedFiles.forEach(file => {
            try {
                fs.renameSync(file.source, file.destination);
                console.log(`‚úÖ Fichier non utilis√© d√©plac√©: ${path.basename(file.source)} ‚Üí Old_files/`);
                movedUnused++;
            } catch (error) {
                console.error(`‚ùå Erreur lors du d√©placement de ${file.source}:`, error.message);
                errors++;
            }
        });
        
        console.log(`\nüìä R√©sum√© du d√©placement:`);
        console.log(`‚úÖ Scripts d√©plac√©s: ${movedScripts}`);
        console.log(`‚úÖ Fichiers non utilis√©s d√©plac√©s: ${movedUnused}`);
        console.log(`‚ùå Erreurs: ${errors}`);
    }

    getAllFiles(dir, extensions = [], ignoreDirs = []) {
        let files = [];
        
        try {
            const items = fs.readdirSync(dir);
            
            items.forEach(item => {
                const itemPath = path.join(dir, item);
                const stat = fs.statSync(itemPath);
                
                if (stat.isDirectory()) {
                    if (!ignoreDirs.includes(item)) {
                        files = files.concat(this.getAllFiles(itemPath, extensions, ignoreDirs));
                    }
                } else if (stat.isFile()) {
                    if (extensions.length === 0 || extensions.some(ext => item.endsWith(ext))) {
                        files.push(itemPath);
                    }
                }
            });
        } catch (error) {
            // Ignorer les erreurs d'acc√®s
        }
        
        return files;
    }

    showFinalReport() {
        console.log('\nüìä RAPPORT FINAL D\'ORGANISATION');
        console.log('=================================');
        console.log(`üìÅ Scripts d√©plac√©s vers scripts/: ${this.scriptsToMove.length}`);
        console.log(`üìÅ Fichiers non utilis√©s d√©plac√©s vers Old_files/: ${this.unusedFiles.length}`);
        console.log(`üìÅ Fichiers utilis√©s conserv√©s: ${this.usedFiles.size}`);
        
        console.log('\nüéØ STRUCTURE FINALE:');
        console.log('üìÅ scripts/ - Tous les scripts du projet');
        console.log('üìÅ Old_files/ - Fichiers non utilis√©s (sauvegarde)');
        console.log('üìÅ src/ - Code source de l\'application');
        console.log('üìÅ public/ - Fichiers publics (HTML, CSS, JS)');
        console.log('üìÅ database/ - Scripts de base de donn√©es');
        console.log('üìÅ docs/ - Documentation');
        
        console.log('\nüí° RECOMMANDATIONS:');
        console.log('1. ‚úÖ V√©rifier que tous les scripts fonctionnent depuis scripts/');
        console.log('2. ‚úÖ Mettre √† jour les r√©f√©rences dans la documentation');
        console.log('3. ‚úÖ Tester l\'application apr√®s r√©organisation');
        console.log('4. ‚úÖ Conserver Old_files/ comme sauvegarde');
        
        console.log('\nüóÇÔ∏è  Organisation termin√©e !');
    }
}

// Ex√©cuter l'organisation
const organizer = new ProjectFileOrganizer();
organizer.organize();


